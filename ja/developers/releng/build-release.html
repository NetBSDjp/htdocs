<html>
<head>
<!-- Copyright (c) 1998, 1999 The NetBSD Foundation, Inc.
     ALL RIGHTS RESERVED. -->
<link rev="made" href="mailto:www@JP.NetBSD.ORG">
<title>NetBSD開発者ドキュメント: リリースの構築とパッケージング</title>
</head>
<body bgcolor="#FFFFFF" text="#000000">

<h2> NetBSD開発者ドキュメント: リリース工学:</h2>
<h2> リリースの構築とパッケージング </h2>

<p> ここからの説明は、ソースツリーからリリースを含む.tgzファイルの
セットを作成するまでに踏む段階をカバーしています。
もちろんスナップショットであることを明確に記すべきですが、
この方法でスナップショットも作成できます。 </p>

<p><strong>注意: スナップショットをアップロードするとき、
<a href="../features/index.html">機能一覧</a>をアップロードし忘れないでください。</strong></p>

<p> .tgzファイルは二つの段階を踏んで構築されます。
まず初めに輸出可能なシステムを構築します。
このシステムは<b>src/domestic</b>以下のソースを構築しません。
なぜなら、このソースはアメリカ合衆国やカナダから輸出できないからです。
(このステップはアメリカ合衆国やカナダ以外の構築者が踏む唯一のステップです。)
二つ目のステップで自国用のソースを含んだ状態でツリーを再構築し、
最終構築から変更のあったアイテムを<b>secr.tgz</b>セットへパッケージングします。
次に挙げる段階は全て、NetBSDソースツリーのルートへたどり着くように、
`src`に変更を加えていると仮定しています。</p>

<p> リリースを構築し、パッケージ化するステップは以下の通りです。</p>

<h3> I. 輸出可能な基本システムの構築 </h3>

<ol>

<li> 構築に必要な変数を設定します。
環境の中で設定されていなければいけない<b>DESTDIR</b>を除き、
以下に挙げる全ての変数を環境の中か<b>/etc/mk.conf</b>で設定します。
<blockquote><pre>
# ソースツリーの場所。
BSDSRCDIR=/home/cjs/netbsd/src
# 構築で作られるオブジェクトファイルの場所。
BSDOBJDIR=/home/cjs/netbsd/obj
# 最初の構築用に、アメリカ合衆国やカナダから輸出できない極秘のファイルを
# 含みません。
EXPORTABLE_SYSTEM=1
# これら二つは実際には必要ありません; あとで再構築する際に
# 楽になります。
BUILD=1
UPDATE=1

# 以下の変数は環境で設定されなければなりません;
# /etc/mk.conf ではだめです!

# インストールされたファイルが置かれる場所。
DESTDIR=/usr/home/cjs/netbsd/install
# リリースが置かれる場所 (もちろんリリース (7) フォーマットで)。
RELEASEDIR=/usr/home/cjs/netbsd/release
</pre></blockquote>
</li>

<li> ソースのあるディレクトリーに移動して、リリースを構築します。
<blockquote> <pre>
cd src
make obj
make release
</pre> </blockquote>

</ol>

<p> この処理はセットリストが最新のものであると仮定することに注意して下さい。
セットリストが最新であるかチェックしたいかもしれません。
もしまだ`make release' 段階を経験したことがないならば、
配布物リストをチェックできるところまで行って、以下のことのみする必要があります。

<blockquote> <pre>
cd src
make obj
# オブジェクトコードを構築し、インストールする。
make build
# 配布物のうち最後のものをインストールします。
cd src/etc && make distribution
</pre> </blockquote>
</p>

<p> セットリストが正確であるかチェックし、適切にアップデートして、
セット用のtarファイルを作るために、以下のようにします: 
<blockquote> <pre>
cd src/distrib/sets
sh ./checkflist
# 必要ならば、lists/*/* を編集します。
cd src/etc
make INSTALL_DONE=1 release
</pre> </blockquote>
</p>

<h3> II. 自国用システムの構築 </h3>

<p> もしアメリカ合衆国かカナダにお住まいでしたら、自国用 (非輸出用) セットを
作る必要があります。<b>EXPORTABLE_SYSTEM=1</b>の行を削除するか
コメントアウトして、/etc/mk.conf ファイルを編集します
(あるいは、もし環境の中で設定されていれば、設定を外すだけです) 。
timestampファイルを編集し、再構築します:
<blockquote><pre>
touch /tmp/export.build
cd src
make build
</pre></blockquote>
</p>

<p> いったん自国用配布物が構築されたら、<b>secr.tgz</b>セットのみ
つくります。これは自国用の素材のみを含んでいます:
<blockquote><pre>
cd $DESTDIR
find . -newer /tmp/export.build | pax -w -d |¥
    gzip -9 &gt; $RELEASEDIR/binary/security/secr.tgz
</pre></blockquote>
</p>


<h3> III. Xの構築 </h3>

<p> Xのセットを構築しパッケージングする情報は、上記主要セットと同じですが、
もう少し詳しく説明しなければいけません。
Xのセットを構築し、インストールして、以下のコマンドを使用するのが
一番始めやすいと思います。
<pre>sh src/distrib/maketars -x -s src/distrib/sets -t $RELEASEDIR -d /</pre>
</p>

<h3> IV. インストールする素材の構築 </h3>

<p>一般にアーキテクチャーに依存し、src/distrib/<i>arch</i>の下で行われ、
(たとえばブートフロッピーを作るなど) かならず行う必要があることがあります;
これらはまだ文書化されていません。
作られたものは (<i>リリース</i>(7) のマニュアルページに一覧表示されている
決まりに従って) 手動で$RELEASEDIRに入れる必要があります。
また、結局`make release' のターゲットはインストールする素材全てを
構築すべきです。 </p>

<h3> <a name="alter"> V. 代わりの構築アプローチ </a></h3>
<h4> V(A). 論理的根拠 </h4>
<table align=right cellpadding=7 border=1 width="27%">
<tr><td><i>	コメント? 5章はCurtの要求でRoss Harvey, <a href="mailto:ross@netbsd.org">
		ross@netbsd.org</a>によって寄稿されました。
	</i>
</table>
私は``find . -newer" のトリックや一般的なリリース構築についていくらか関心があり、
トップレベルのMakefileによくある実験や変更にも興味があります。
<ul>
<li>	<code> find . -newer </code>はヘッダーのインストールのように、
	一度しか書き込まないものではないのかと思います。
<li>	現在の設定に敏感になっているのかもしれません。
<li>	動作させていないリリースを配布しないのも重要だが、
	歴史のあるヒエラルキーからではなく、むしろセットがパッケージされるように
	全く新しいヒエラルキーから空のディレクトリーへインストールすることも重要です。
<li>	これを試すため、絶え間ないかき回しやひねりがsrc やsrc/domestic にある
	トップレベルのMakefile に対して繰り返し行われています。
	結果、難度も構築システムを理解し直すという難しい仕事に直面しなければならず、
	スナップショットやリリースを構築する人の仕事を更に困難にしています。
<li>	構築システムでもう一つよく見られる実験や引っかき回しの原因には、
	依存を回避しようとする完全に運命づけられた試みも含みます。
	結果、さらに複雑になり、些細なバグが多くなりますが、
	実際には自動的に依存関係を解決する方法は見つかっていません。
  <ul>	<li>
	<table align=right cellpadding=7 border=1 width="27%">
		<tr><td><i>なぜ依存を回避することが不可能なのか?</i>
				なぜなら、問題の複雑さが良くて二次的なもの、
				悪くてソースモジュールやファイルの数の工場機能だからです。
	</table>
	<i>(toolchainを含んだ) 500万行のコードにある依存関係を回避するのは
	不可能です。</i>
	依存解決のためにさらに複雑にしている各開発者は、
	価値あることに貢献していると考え、更なる複雑化は仕方がないと感じています。
	しかし、構築時間の犠牲、構築システムの複雑化、完全に考慮されていない
	ほかの現在、未来の開発者全員の学習が遠回りになるという事実があります。
	<li>
	構築システムを単純にし続け、常にまず始めに/ (DESTDIRを無効にするか
	DESTDIR=/ にするかして) 構築するのが、よりよい選択肢です。
	開発者は概して、とにかく回避されていない依存を手塩をかけて
	解決しなければならないので、依存を解決している間は
	何が起こっているのか少なくとも簡単に理解できるように、
	シンプルにしておくのがよいです。
	ここでのポイントは、いい意味での開発者が、手塩にかけて依存関係を解決し、
	手塩にかけてしてきた特定の構築前システムを自動化するトップレベルの
	Makefileに口を出し、磨きをかけることです。
	<li>
	<i>しかし: </i> また<i>ほかの</i> 依存が出てくるでしょうし、
	恩恵のない新しいトップレベルのMakefileの複雑さやバグに永遠に
	引きずり回されるでしょう。
	一方、単純さがいつも報われるのです。
  </ul>
</ul>
ここに私の手順があります。これにはここでお話ししたことがすべて記載されていて、
過去にトップレベルのMakefileのバージョンのほとんどで正常に動作しています。
お願いです: <i>これらに変更を加えるのをやめてください!</i>

	<table align=right cellpadding=7 border=1 width="27%">
		<tr><td><i>動的依存について:</i>
		古いソースツリーを進めるために、
		Alan Smitheeは面白いトリックを提案しています:
		まず静的リンクをすべて構築し、
		その後で通常の動的イメージを使って再構築します。
	</table>

<h4> V(B). 手順 </h4>

<h5> V(B)1. 概略 </h5>

輸出可能なシステムはいったん/ に構築され、インストールされます。
secr コードもいったん/ に構築され、インストールされます。
輸出可能なシステムは二回目にははじめは空になっている<code> /usr/obj/dist
</code>にインストールされます。
secr コードは二回目にははじめ空になっている<code> /usr/obj/secr</code> に
インストールされます。

<h5> V(B)2. 詳細 </h5>

<ol compact>
	<li> <code>unset DESTDIR</code>
	<li> <code>make build EXPORTABLE_SYSTEM=1</code>
	<li> <code>cd domestic && make build</code>
	<li> <code>cd /usr/obj && rm -rf dist secr && mkdir dist secr</code>
	<li> <code>cd /usr/src/etc</code>
        <li> <code>DESTDIR=/usr/obj/secr make distrib-dirs </code>
        <li> <code>DESTDIR=/usr/obj/dist make EXPORTABLE_SYSTEM=1 distribution 
		</code><i>(これによって、</i><code>make includes</code><i>
				と </i><code>/usr/src</code><i>にある
				</i><code>make install</code><i> が実行されます。)</i>
        <li> <code>cd /usr/src/domestic</code>
        <li> <code>DESTDIR=/usr/obj/secr make includes install</code>
		<br>さあ、whatis.db ファイルをsecr.tgz用に結びつけましょう。
        <li> <code>cd /usr/src/share/man</code>
        <li> <code>/usr/obj/dist/usr/libexec/makewhatis /usr/obj/secr/usr/share/man</code>
        <li> <code>cd /usr/obj/secr/usr/share/man</code>
        <li> <code>cat /usr/obj/dist/usr/share/man/whatis.db &gt;&gt; whatis.db</code>
        <li> <code>sort -u whatis.db -o whatis.db</code>
</ol>

<h5> V(B)3. コマンドファイル </h5>

この手順のうち、構築されたものを/ に移動させる部分を一つにする
コマンドファイルが必要でしたら、こちらを参照してください:
	<a href="rsnap"> <code>rsnap</code> スクリプト</a>.

<hr>

<p> このページは非常に役に立ちます。
このページへのコメントや更新は<a href="mailto:cjs@netbsd.org">
cjs@netbsd.org</a>まで送ってください。</p>

<hr>
<table width="100%" cols="2" border=0 cellspacing=8 cellpadding=0>
<tr>
  <td width="50%">
    <table><tr>
      <td>
	<a href="../../index.html">
	<img src="../../images/NetBSD-banner.gif" alt=""></a>
      </td><td>
	<a href="../../index.html">
	<img src="../../images/empty.gif"
		alt="NetBSD " border=0>ホームページ</a>
      </td>
    </tr></table>
  </td>
  <td width="50%">
    <table><tr>
      <td>
	<a href="index.html">
	<img src="../../images/NetBSD-banner.gif"
		alt=""></a>
      </td><td>
	<a href="index.html">
	<img src="../../images/empty.gif"
		alt="NetBSD " border=0>リリース工学ドキュメント</a>
      </td>
    </tr></table>
  </td>
</tr></table>

<hr>
<address>
  www@JP.NetBSD.ORG<br>
  $NetBSD: build-release.html,v 1.16 1999/08/01 19:54:35 abs Exp $<br>
  <a href="../../Misc/disclaimer.html">Copyright &copy; 1998, 1999
    The NetBSD Foundation, Inc.  ALL RIGHTS RESERVED.</a>
</address>
</body>
</html>
