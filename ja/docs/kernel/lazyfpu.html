<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="Website XSL Stylesheet V2.6.0">
<link rel="home" href="../../../." title="Welcome to The NetBSD Project: Of course it runs NetBSD.">
<link rel="up" href="../../../ja/docs/kernel/." title="NetBSD ドキュメンテーション: カーネル">
<link rel="previous" href="../../../ja/docs/kernel/." title="NetBSD ドキュメンテーション: カーネル">
<link rel="next" href="../../../ja/docs/kernel/kgdb.html" title="NetBSD ドキュメンテーション: GDB を使い NetBSD カーネルをデバッグする HOWTO">
<link rel="last" href="../../../ja/docs/kernel/elf-notes.html" title="NetBSD ドキュメンテーション: ベンダー特有の ELF 記号要素(Note Elements)">
<link rel="stylesheet" href="../../../global.css" type="text/css">
    
    <title>NetBSD ドキュメンテーション: どのように lazy FPU コンテキストスイッチは動作するのか</title>
  </head>
<body class="website"><div class="webpage">
<a name="ja-docs-kernel-lazyfpu"></a><div id="top"><a href="#mainContent" class="doNotDisplay doNotPrint">本文へ飛ぶ。</a></div>
<div id="header">
<div class="topNavigation">
<span>» </span><a href="../../../docs/guide/en/">
	  ガイド</a> |
	<a href="http://man.NetBSD.org/">マニュアルページ</a> |
	<a href="../../../ja/mailinglists/">
	  メーリングリスト</a>と
	<a href="http://mail-index.NetBSD.org/">記事</a> |
	<a href="http://cvsweb.NetBSD.org/">CVS リポジトリー</a> |
	バグの<a href="http://www.NetBSD.org/cgi-bin/sendpr.cgi?gndb=netbsd">報告</a>
	と
	<a href="../../../ja/support/query-pr.html">
	 照会</a> |
	<a href="../../../ja/docs/software/packages.html">
	  ソフトウェアパッケージ
	</a>
</div>
<div class="centralHeader">
<a href="../../../ja/"><img alt='NetBSD プロジェクト "Of course it runs NetBSD"' width="506" height="90" src="../../../images/NetBSD-headerlogo.png"></a><div class="headerTools"><div id="headerSearch">
<div id="header-cse-search-form" style="width: 24%;">Google custom search</div>
<script src="http://www.google.com/jsapi" type="text/javascript"></script><script type="text/javascript"> 
                  google.load('search', '1', {language : 'en'});
                  google.setOnLoadCallback(function() {
                    var header_customSearchControl = new google.search.CustomSearchControl('006277936787196004968:mbdhrauy1wm');
                    header_customSearchControl.setResultSetSize(google.search.Search.FILTERED_CSE_RESULTSET);
                    var header_options = new google.search.DrawOptions();
                    header_options.enableSearchboxOnly("http://google.com/cse?cx=006277936787196004968:mbdhrauy1wm");    
                    header_customSearchControl.draw('header-cse-search-form', header_options);
                  }, true);
                </script><link rel="stylesheet" href="http://www.google.com/cse/style/look/default.css" type="text/css">
</div></div>
</div>
<div class="navBar">
<span class="doNotDisplay">
	  案内:
	</span><a href="../../../ja/">
	  ホーム</a> | 
	<a href="../../../ja/about/">
	  概要</a> | 
	<a href="../../../ja/gallery/">
	  展示室</a> | 
	<a href="../../../ja/releases/">
	  ダウンロード</a> | 
	<a href="../../../ja/docs/">
	  ドキュメンテーション</a> | 
	<a href="../../../ja/support/">
	  サポート</a> | 
	<a href="../../../ja/community/">
	  コミュニティー</a> | 
	<a href="../../../ja/ports/">
	  機種</a>
</div>
</div>
<div id="content"><div class="fullWidth"><div class="rowOfBoxes">
<h1>NetBSD ドキュメンテーション: どのように lazy FPU コンテキストスイッチは動作するのか</h1>
<div class="sect1">
<div class="titlepage"></div>
    <div class="blockquote"><blockquote class="blockquote">
      <p>どのようにlazy FPU コンテキストスイッチは動作するのかについて説明します。</p>
      <p>Tohru Nishimura - Nara Insititute of Science and Technology</p>
    </blockquote></div>

    <p>FPU ハードウェアは一般的に、現在の FPU コンテキストを保持するための
      ハードウェアレジスター一式を持っています。各プロセスは、
      そのプロセスが実行されていない間、プロセスの状態を保持するために、
      プロセス毎の予約済みのメモリー領域 (NetBSD/mips では u_pcb の中にあります)
      を持っています。コンテキストスイッチの度に FPU
      コンテキストの保存と再ロードをすることは、著しい CPU サイクルを消費します。</p>
    
    <p>最近の CPU は、FP インストラクションを実行できなくする
      方法を提供しています。 CPU が FP インストラクションを
      実行しようとすると例外が投げられ、オペレーティングシステム
      は実行中のプロセスに「FPU がつかえないよ」ハンドラーの
      処理を開始します。それは、プロセスが FPU を使えるように
      チェック、準備し、それからそのプロセスを
      例外を発生させた FP インストラクションから再実行させます。今度は、
      FP インストラクションは通常通りに実行され、後で他のプロセスが、この
      プロセスから FPU を奪うまで、「FPU が使用不可能」という状況は
      発生しません。</p>

    <p>すべてのプロセスは、FPU の所有権無しで生成され、かつ FPU の使用を
      禁じられています。プロセスが FP インストラクションを実行しなけ
      れば、何も特別な事はおこらず、そのプロセスの実行中に FPU
      には手出しされません。</p>

    <p>もし、FPU の使用を禁止されたプロセスが、FP インストラクションを
      実行しようとすると、CPU は、「使用不可能」例外を投げます。グロー
      バルな変数 fpcurprocはどのプロセスが FPU を所有しているかを示します。
      「使用不可能」例外が発生した時、FPU ハードウェアはその所有プロセスの
      状況を持っています。これは、例外を投げた curproc とは異なります。
      使用不可能ハンドラーは、 FPU ハードウェアコンテキストを fpcurproc
      の予約された領域へ保存します。そして、curproc の FPU コンテキストを
      FPU レジスターにロードします。プロセスの FPU コンテキストが最初
      にロードされるときは、FPU 全体がクリアーされます。このように、
      他のプロセスが FPU の使用を要求するまで、FPU コンテキストスイッチ
      は延期されます。大多数のプログラムは、 FP インストラクションを
      一切実行しないため、延期された lazy FPU コンテキストスイッチは、
      高コストな FPU の保存/ロードの回数を大幅に減らします。</p>

    <p><span class="emphasis"><em>fpcurproc が指すプロセスが終了するときに、lazy に割り当てられ
	ている FP context を、正しく解放するように注意しなければいけないこ
	とを Matt Thomas が指摘してくれました。</em></span></p>

    <p>この厄介な FPU コンテキストスイッチシンドロームは、MMU がプロセス
      コンテキストスイッチに直面した時の状況に似ています。
      MMU はかなり複雑なデバイスです。これは、プロセスのアドレス空間を表現す
      るための複雑な内部「状態」、あるいはもっと稀には、 CPU ハードウェアに
      基づいて定義される、プロセスの本質と特徴(nature and feature)であるとこ
      ろの実行環境の「タスク表現」を保持します。いくつかの MMU には、プロセスのアドレス
      空間を示すメモリー領域を指定する、専用のレジスターがあります。このような場合、
      複数のメモリー領域を持ち、専用の MMU インストラクションを実行して
      そのレジスターを更新することでメモリー領域を切り替えることにより、
      MMU コンテキストスイッチにかかるコストを下げることができます。
      ある種の CPU デザインは、MMU コンテキストスイッチ
      のためにさわがしい見せ物のような方式をおこなうことで有名です。おどろ
      くべき長さの CPU サイクルを消費して、多数のレジスターを保存/ロード
      し、新しいプロセスの実行コンテキストを確立するためにメモリー領域をいった
      りきたりします。ハードウェアによるコンテキストスイッチ機能
      のサポートは非常にコストが高く、実際問題めったに使われることはありません。
      そして、多くの人は、それは CISC 風、あるいはシリコンの浪費だと考えています。</p>
  </div>
<hr>
<em><a href=".">NetBSD ドキュメンテーション: カーネル</a></em> に戻る</div></div></div>
<div class="navfoot"></div>
<div id="footer"><center>
<span class="footfeed"><a href="http://www.NetBSD.org/cgi-bin/feedback.cgi">
	  連絡</a> |
      </span><span class="footcopy"><a href="../../../ja/about/disclaimer.html">
      免責事項</a> |

      <span class="copyright">Copyright © 1994-2012 The NetBSD Foundation, Inc. </span>ALL RIGHTS RESERVED.<br>NetBSD<sup>®</sup> は The NetBSD
	Foundation, Inc. の登録商標です。</span>
</center></div>
</div></body>
</html>
