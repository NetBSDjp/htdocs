<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="Website XSL Stylesheet V2.6.0">
<link rel="home" href="../../../." title="Welcome to The NetBSD Project: Of course it runs NetBSD.">
<link rel="up" href="../../../ja/docs/kernel/." title="NetBSD ドキュメンテーション: カーネル">
<link rel="previous" href="../../../ja/docs/kernel/uvm.html" title="NetBSD ドキュメンテーション: UVM、新しい仮想メモリーシステム">
<link rel="next" href="../../../ja/docs/kernel/porting-freebsd-net.html" title="FreeBSD のネットワークドライバーを NetBSD に移植するためのメモ">
<link rel="first" href="../../../ja/docs/kernel/lazyfpu.html" title="NetBSD ドキュメンテーション: どのように lazy FPU コンテキストスイッチは動作するのか">
<link rel="last" href="../../../ja/docs/kernel/elf-notes.html" title="NetBSD ドキュメンテーション: ベンダー特有の ELF 記号要素(Note Elements)">
<link rel="stylesheet" href="../../../global.css" type="text/css">



<title>NetBSD ドキュメンテーション: なぜ伝統的な vfork()を実装したのか</title>
</head>
<body class="website"><div class="webpage">
<a name="ja-docs-kernel-vfork"></a><div id="top"><a href="#mainContent" class="doNotDisplay doNotPrint">本文へ飛ぶ。</a></div>
<div id="header">
<div class="topNavigation">
<span>» </span><a href="../../../docs/guide/en/">
	  ガイド</a> |
	<a href="http://man.NetBSD.org/">マニュアルページ</a> |
	<a href="../../../ja/mailinglists/">
	  メーリングリスト</a>と
	<a href="http://mail-index.NetBSD.org/">記事</a> |
	<a href="http://cvsweb.NetBSD.org/">CVS リポジトリー</a> |
	バグの<a href="http://www.NetBSD.org/cgi-bin/sendpr.cgi?gndb=netbsd">報告</a>
	と
	<a href="../../../ja/support/query-pr.html">
	 照会</a> |
	<a href="../../../ja/docs/software/packages.html">
	  ソフトウェアパッケージ
	</a>
</div>
<div class="centralHeader">
<a href="../../../ja/"><img alt='NetBSD プロジェクト "Of course it runs NetBSD"' width="506" height="90" src="../../../images/NetBSD-headerlogo.png"></a><div class="headerTools"><div id="headerSearch"><form method="get" action="http://www.google.com/custom">
<input class="whiteOnBlack" type="text" name="q" onfocus="if(this.value==this.defaultValue ) this.value='';" size="12" maxlength="255" value="Search"><input type="hidden" name="cof" value="L:http://www.NetBSD.org/images/NetBSD-smaller.png;LH:200;LW:200;AH:center;AWFID:4f6b0499f0f58d2c;"><input type="hidden" name="domains" value="NetBSD.org"><input type="hidden" name="sitesearch" value="www.NetBSD.org"><input type="submit" value="検索">
</form></div></div>
</div>
<div class="navBar">
<span class="doNotDisplay">
	  案内:
	</span><a href="../../../ja/">
	  ホーム</a> | 
	<a href="../../../ja/about/">
	  概要</a> | 
	<a href="../../../ja/gallery/">
	  展示室</a> | 
	<a href="../../../ja/releases/">
	  ダウンロード</a> | 
	<a href="../../../ja/docs/">
	  ドキュメンテーション</a> | 
	<a href="../../../ja/support/">
	  サポート</a> | 
	<a href="../../../ja/community/">
	  コミュニティー</a> | 
	<a href="../../../ja/ports/">
	  機種</a>
</div>
</div>
<div id="content"><div class="fullWidth"><div class="rowOfBoxes">
<h1>NetBSD ドキュメンテーション: なぜ伝統的な vfork()を実装したのか</h1>
<h3 class="title"><a name="vfork"></a></h3>
<ul>
<li><a href="#intro">序</a></li>
<li><a href="#4bsd-vfork-cow">4.4BSDの vfork()/exec() を使った
vfork() と COW の処理</a></li>
<li><a href="#3bsd-vfork">アドレス空間共有を用いた
3.0BSD/NetBSD の vfork() の処理</a></li>
</ul>
<hr>
<h3 class="title"></h3>
<h4 class="title">
<a name="intro"></a>序 (<a href="#vfork">top</a>)
  </h4>
<p><code class="function">vfork()</code>
は、子プロセスがいずれ他のプログラムを <code class="function">exec()</code>し、
かつ親プロセスはそれが起きるまで待っているという、特別な状況で
用いるために設計されたものです。
伝統的な <code class="function">fork()</code> では、子プロセスに親プロセスの
すべてのページを複製するという著しいオーバーヘッドが生じます。</p>

<p>
COW (コピーオンライト)が追加された
Mach VM システムでは
<code class="function">fork()</code> の負荷が大変軽くなり、
BSD 4.4では <code class="function">vfork()</code>は <code class="function">fork()</code> と
同義のものとされました。
NetBSD 1.3 以降では、伝統的な <code class="function">vfork()</code> が再実装されました。</p>

<p><a class="ulink" href="uvm.html" target="_top"><span class="bold"><strong>UVM</strong></span></a>で COW を
よりよいものにするために多大な努力がおこなわれました。
しかしアドレス空間を共有する <code class="function">vfork()</code>が <span class="emphasis"><em>いまだに</em></span>
勝ることが分かったのです。
これにより、200MHz PPro での libcのビルドの所要時間を
数秒削ることができます。</p>

<h4 class="title">
<a name="4bsd-vfork-cow"></a>4.4BSDの <code class="function">vfork()</code>/<code class="function">exec()</code> を使った
<code class="function">vfork()</code> と COW の処理 (<a href="#vfork">top</a>)
  </h4>

<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>親の vm_map をたどって、アドレス空間の書き込み可能な部分を
        COW とマークする。これは、 pmapを呼び出し、 PTEを修正し、
        TLBをフラッシュすることを意味します。</p></li>
<li class="listitem"><p>子プロセスの vm_map を生成し、親の vm_map エントリーを子の vm_mapにコピーします。
        場合によっては、 pmapを呼び出して親のページテーブルから
        このページテーブルに PTE をコピーします。</p></li>
<li class="listitem"><p>親をブロックします。</p></li>
<li class="listitem"><p>子が走ります。 PTEがコピー <span class="emphasis"><em>されてない</em></span>場合には、
        ページフォルトが起きて現在プログラムカウンタのあるテキストページの物理マッピングが得られます。</p></li>
<li class="listitem"><p>子は exec し、そして 作られたばかりのアドレス空間全体を unmapして
        新しく作ります。
        これは、親の vm_mapを辿って COWとマークされた部分を
        非COWにする作業を伴います。</p></li>
<li class="listitem"><p>親のブロックを解きます。</p></li>
<li class="listitem"><p>親が走り、以前には R/W であって COWにするために R/Oとマークしたデータを
        変更するとページフォルトを起こします。この時点ではデータのコピーは行なわれません。</p></li>
</ul></div>

<h4 class="title">
<a name="3bsd-vfork"></a>アドレス空間共有を用いた
3.0BSD/NetBSD の <code class="function">vfork()</code> の処理 (<a href="#vfork">top</a>)
  </h4>

<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>親プロセスの vmspace構造体への参照を得ます。</p></li>
<li class="listitem"><p>親をブロックします。</p></li>
<li class="listitem"><p>子が走ります。 親のページテーブルが用いられるので、 PTEは既に
        有効でありページフォルトは起こりません。</p></li>
<li class="listitem"><p>子が exec し、親の vmspace構造体に対して持っていた参照を削除し、
	新しいものを作ります。</p></li>
<li class="listitem"><p>親のブロックを解きます。</p></li>
<li class="listitem"><p>親が走ります。(親の vm_mapは変更されていないので、
        ページフォルトは起こりません。)</p></li>
</ul></div>

<p>
このように、fork してさらに execするような場合には、
明らかに後者がより高速です。
たとえ良い COWアルゴリズムを使っているとしても、仮想空間を共有する
場合と比べて大変多くの作業を行なわねばなりません!
</p>
<hr>
<em><a href="./">NetBSD ドキュメンテーション: カーネル</a></em> に戻る</div></div></div>
<div class="navfoot"></div>
<div id="footer"><center>
<span class="footfeed"><a href="http://www.NetBSD.org/cgi-bin/feedback.cgi">
	  連絡</a> |
      </span><span class="footcopy"><a href="../../../ja/about/disclaimer.html">
      免責事項</a> |

      <span class="copyright">Copyright © 1994-2011 The NetBSD Foundation, Inc. </span>ALL RIGHTS RESERVED.<br>NetBSD<sup>®</sup> は The NetBSD
	Foundation, Inc. の登録商標です。</span>
</center></div>
</div></body>
</html>
