<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="Website XSL Stylesheet V2.6.0">
<link rel="home" href="../../../." title="Welcome to The NetBSD Project: Of course it runs NetBSD.">
<link rel="up" href="../../../ja/docs/." title="NetBSD ドキュメンテーション">
<link rel="previous" href="../../../ja/docs/network/." title="The NetBSD Network FAQ">
<link rel="next" href="../../../ja/docs/software/." title="NetBSDのためのアプリケーションソフトウェア">
<link rel="first" href="../../../ja/docs/Hardware/." title="ハードウェアドキュメンテーション">
<link rel="last" href="../../../ja/docs/x/." title="NetBSD ドキュメンテーション: X Window System">
<link rel="stylesheet" href="../../../global.css" type="text/css">

  

    <title>NetBSD ドキュメンテーション: 電源管理</title>
  </head>
<body class="website"><div class="webpage">
<a name="ja-docs-power-mgmt-index"></a><div id="top"><a href="#mainContent" class="doNotDisplay doNotPrint">本文へ飛ぶ。</a></div>
<div id="header">
<div class="topNavigation">
<span>» </span><a href="../../../docs/guide/en/">
	  ガイド</a> |
	<a href="http://man.NetBSD.org/">マニュアルページ</a> |
	<a href="../../../ja/mailinglists/">
	  メーリングリスト</a>と
	<a href="http://mail-index.NetBSD.org/">記事</a> |
	<a href="http://cvsweb.NetBSD.org/">CVS リポジトリー</a> |
	バグの<a href="http://www.NetBSD.org/cgi-bin/sendpr.cgi?gndb=netbsd">報告</a>
	と
	<a href="../../../ja/support/query-pr.html">
	 照会</a> |
	<a href="../../../ja/docs/software/packages.html">
	  ソフトウェアパッケージ
	</a>
</div>
<div class="centralHeader">
<a href="../../../ja/"><img alt='NetBSD プロジェクト "Of course it runs NetBSD"' width="506" height="90" src="../../../images/NetBSD-headerlogo.png"></a><div class="headerTools"><div id="headerSearch">
<div id="header-cse-search-form" style="width: 24%;">Google custom search</div>
<script src="http://www.google.com/jsapi" type="text/javascript"></script><script type="text/javascript"> 
                  google.load('search', '1', {language : 'en'});
                  google.setOnLoadCallback(function() {
                    var header_customSearchControl = new google.search.CustomSearchControl('006277936787196004968:mbdhrauy1wm');
                    header_customSearchControl.setResultSetSize(google.search.Search.FILTERED_CSE_RESULTSET);
                    var header_options = new google.search.DrawOptions();
                    header_options.enableSearchboxOnly("http://google.com/cse?cx=006277936787196004968:mbdhrauy1wm");    
                    header_customSearchControl.draw('header-cse-search-form', header_options);
                  }, true);
                </script><link rel="stylesheet" href="http://www.google.com/cse/style/look/default.css" type="text/css">
</div></div>
</div>
<div class="navBar">
<span class="doNotDisplay">
	  案内:
	</span><a href="../../../ja/">
	  ホーム</a> | 
	<a href="../../../ja/about/">
	  概要</a> | 
	<a href="../../../ja/gallery/">
	  展示室</a> | 
	<a href="../../../ja/releases/">
	  ダウンロード</a> | 
	<a href="../../../ja/docs/">
	  ドキュメンテーション</a> | 
	<a href="../../../ja/support/">
	  サポート</a> | 
	<a href="../../../ja/community/">
	  コミュニティー</a> | 
	<a href="../../../ja/ports/">
	  機種</a>
</div>
</div>
<div id="content"><div class="fullWidth"><div class="rowOfBoxes">
<h1>NetBSD ドキュメンテーション: 電源管理</h1>
<h3 class="title"><a name="power_management">ラップトップのための電源管理</a></h3>
<ul>
<li><a href="#introduction">導入</a></li>
<li><a href="#basics">電源管理の基本</a></li>
<li><a href="#configuring">NetBSD APMサポートの設定</a></li>
<li><a href="#hints">電源管理のヒントとトリック</a></li>
<li><a href="#squid">Squid がラップトップのディスクを回転させてしまう</a></li>
<li><a href="#syslog">syslog がディスクを回転させるのを防ぐ</a></li>
</ul>
<hr>
<h3 class="title">ラップトップのための電源管理</h3>
        <h4 class="title">
<a name="introduction"></a>導入 (<a href="#power_management">top</a>)
  </h4>

	<p>このドキュメンテーションは NetBSD に用意されている電源管理機能の一部と、
	  殆どの今時のラップトップ・コンピューターに備わっている
	  Advanced Power Management (APM)を含めて説明しています。</p>

	<p>現時点では、このページの殆どはi386に特定な情報です。
	  NetBSD がさらに多くのラップトップのアーキテクチャーのサポートを始めるときに、
	  それらのアーキテクチャーの電源管理機能をカバーする様に、
	  このドキュメンテーションは拡充されるでしょう。</p>
      
        <h4 class="title">
<a name="basics"></a>電源管理の基本 (<a href="#power_management">top</a>)
  </h4>

	<p>ラップトップの電源管理はAdvanced Power Management、
	  略してAPMが中心となります。
	  APMはラップトップのハードウェアの電源管理機能へのインターフェースを提供
	  する、BIOSに用意されたサービス・ルーチンの集合です。
	  このインターフェースを経由して、
	  NetBSD は(サスペンド要求といった)APMのイベントを受け取ったり、
	  電源管理の要求や(現在のバッテリー容量といった)問い合わせを行います。</p>

	<p>APMは2つの異なる電源の節約状態、
	  すなわちスタンバイとサスペンドを規定しています。
	  APMが実際にハードウェアのレベルで行うことは、
	  使用する特定のラップトップに依存します。
	  一般的に<span class="quote">“<span class="quote">スタンバイ</span>”</span>は軽い眠りの状態を意味していて、
	  <span class="quote">“<span class="quote">サスペンド</span>”</span>の状態より多くの電力を消費し、より速い復帰ができます。
	  スタンバイとサスペンドの状態へのAPMタイマーは、
	  マシンのBIOSで設定されるのが一般的です。
	  マシンが特定の期間に渡って<span class="quote">“<span class="quote">アイドル</span>”</span>と判断されると、
	  BIOSはそれに応じた電源節約モードへの移行をオペレーティングシステムに
	  要求します。</p>

	<p>NetBSD のレベルでは、3つのAPMをサポートするための要素があります。
	  カーネル・ドライバーはAPM BIOSへのインターフェースを取ります。
	  apmデーモンの <span class="application">apmd</span> はAPMカーネルとのインターフェースを取り、
	  ユーザーランドのイベント処理のスクリプトを起動します。
	  コマンド行のプログラム <span class="command"><strong>apm</strong></span> は
	  <span class="application">apmd</span> とのインターフェースを取り、
	  バッテリー容量問い合わせやシステムのサスペンドの開始に使用できます。</p>

	<p>一般的な電源管理のイベントの流れは、以下の手順を踏みます。</p>

	<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem">APM BIOSはマシンが特定の時間にアイドルな状態を続けたと判断すると、
	    スタンバイまたはサスペンドの要求をキューに入れます。</li>
<li class="listitem">APMのカーネル・ドライバーは(一般的に1秒に一度といった)ポーリングを
	    APM BIOSに対して行って、要求のイベントを取得します。そして、
	    スタンバイまたはサスペンドの要求をapmデーモンへのキューに入れます。</li>
<li class="listitem">APMデーモンは、現在の電源の状態やデーモンの設定をもとに、
	    要求を受け付けるかどうかを決定します。
	    要求を受け付けた場合、
	    apmデーモンはスタンバイまたはサスペンドの動作を実行して、
	    カーネル・ドライバーに受け付けまたは拒否したかの通知を送ります。</li>
<li class="listitem">カーネル・ドライバーは受け付けまたは拒否したかを、
	    APM BIOSに通知を送ります。</li>
<li class="listitem">イベントの要求が受け付けられたなら、
	    APM BIOSはハードウェアを指示されたモードに置きます。</li>
</ol></div>
      
        <h4 class="title">
<a name="configuring"></a>NetBSD APMサポートの設定 (<a href="#power_management">top</a>)
  </h4>

	<p>まず始めに、APMドライバーを有効にしたカーネルをコンパイルする必要があります。
	  使用しているカーネルの構成ファイルの次の行を追加、
	  またはコメントを外してください。</p>

	<pre class="programlisting">
	apm0	at mainbus0	# Advanced power management</pre>

	<p>自分のカーネルを作成する方法の詳細は、
	  <a class="ulink" href="../../../docs/guide/en/chap-kernel.html" target="_top">
	  カーネルの作り方</a>を参照してください。</p>

	<p>APMカーネル・ドライバーを組み込んだカーネルができたなら、
	  APMデーモン(<span class="application">apmd</span>)をブート時に起動させるために、
	  <code class="filename">/etc/rc.conf</code> の変数 <code class="code">apmd</code> を <code class="code">YES</code> にセットして下さい。</p>

	<p>これら両方の段階を行うと、
	  <span class="application">apm</span>
	  ユーティリティーを使用してAPMシステムとやりとりできるようになります。例えば、</p>
	<pre class="programlisting">
% apm
Battery charge state: high
Battery remaining: 98 percent
A/C adapter state: not connected
Power management enabled</pre>

        <p>APMサポートの使用方法への、より詳細な情報は
	  <a href="http://netbsd.gw.com/cgi-bin/man-cgi?apm+8+NetBSD-5.1+i386">apm(8)</a> と <a href="http://netbsd.gw.com/cgi-bin/man-cgi?apmd+8+NetBSD-5.1+i386">apmd(8)</a>
	  を参照してください。</p>

      
        <h4 class="title">
<a name="hints"></a>電源管理のヒントとトリック (<a href="#power_management">top</a>)
  </h4>

	<p>電源管理のイベントの基本的なインターフェースは<code class="filename">/etc/apm</code>以下の、
	  <code class="filename">standby</code>、<code class="filename">suspend</code>、
	  <code class="filename">resume</code>のスクリプトです。
	  <code class="filename">apmd</code>は対応したAPMイベントを受け取ると、
	  適切なスクリプトを動作させます。</p>

	<p><code class="filename">standby</code>や<code class="filename">suspend</code>スクリプトで、
	  実行させたいことには以下のものがあります。</p>

	<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem">ネットワーク・インターフェース・カードの電源を切断。
	    PCMCIAのネットワーク・インターフェース・カードを使用している場合は、
	    <code class="code">ifconfig &lt;interface&gt;
	    down</code>を実行することで達成できます。</li>
<li class="listitem">ネットワーク・ファイルシステムのアンマウント
	    (そのファイルシステムをアクセスできないところで、
	    ラップトップをリジュームする予定がある場合)。</li>
<li class="listitem">稼働中の<span class="command"><strong>dhclient</strong></span>や
	    <span class="command"><strong>pppd</strong></span>を停止。</li>
</ul></div>

	<p>逆に、<code class="filename">resume</code>スクリプトで、
	  スタンバイやサスペンドさせたときに行ったこと、
	  すべてを取り消す適切なコマンドを実行することができます。</p>

	<p>NetBSD 1.4に新しい<span class="command"><strong>atactl</strong></span>コマンドがあります。
	  このコマンドを使用して、(IDEとしてより広く知られている)
	  ATAデバイスの電源管理機能を制御することができます。
	  <span class="command"><strong>atactl</strong></span>の<code class="option">setidle</code>オプションを使用して、
	  ディスクの回転低下を制御するスタンバイ・タイマーを設定できます。
	  より明確な情報は、
	  <a href="http://netbsd.gw.com/cgi-bin/man-cgi?atactl+8+NetBSD-5.1+i386">atactl(8)</a> を参照して下さい。</p>

	<p>ATAスタンバイ・タイマーへ設定する値に疑問があるなら、
	  以下の文献を読むことをお勧めします。</p>

	<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem">
	    <span class="quote">“<span class="quote">A Quantitative Analysis of Disk Drive Power
	      Management in Portable Computers</span>”</span>, Kester Li,
	      Roger Kumpf, Paul Horton, Thomas Anderson, Computer
	      Science Division, University of California, Berkeley,
	      Winter 1994 Usenix.
	  </li>
<li class="listitem">
	    <span class="quote">“<span class="quote">Thwarting the Power-Hungry Disk</span>”</span>, Fred
	      Douglas, P. Krishnan, Brian Marsh, Matsushita
	      Information Technology Laboratory, Winter 1994
	      Usenix.
	  </li>
</ul></div>

	<p>これらの文献の両方で、スタンバイ・タイマーには低い値、
	  2から8秒のレートを推奨しています。</p>

	<p>低い値をスタンバイ・タイマーに設定することによる1つの問題があります。
	  それは NetBSD はデフォルトでは、絶えず(少なくとも30秒に1度、
	  すなわち<span class="command"><strong>update</strong></span>が動作するたび)
	  ディスクを回転開始状態にさせるのに十分な頻度でディスクへ書き込むことです。
	  この書き込みのもっとも共通な原因は、ファイルシステムで
	  ファイルの最終アクセス時刻と(仮想ターミナルといった)
	  デバイス特殊型ファイルの最終更新時刻の更新であることが判明しました。
	  これらの動作は、
	  <a href="http://netbsd.gw.com/cgi-bin/man-cgi?mount+8+NetBSD-5.1+i386">mount(8)</a> の
	  オプション<code class="option">noatime</code>と(NetBSD 1.4で新しい)
	  <code class="option">nodevmtime</code>で抑止できます。
	  これを行おうと決めた場合、
	  <span class="application">cron</span>から起動される<span class="command"><strong>atrun</strong></span>を変更するか、
	  完全に停止したくなるでしょう。デフォルトでは、10分間隔に実行されて、
	  <span class="application">cron</span>のログファイルにエントリーを書き込み、
	  ディスクを回転させます。</p>

	<p>また、電源がAC電源かバッテリーかによって、
	  電源管理を異なる設定や
	  完全に電源管理を無効とすることが望ましい状況があります。
	  NetBSD 1.4での新しい機能に、2つの新しい<span class="application">apmd</span>のスクリプト、
	  <code class="filename">line</code>と<code class="filename">battery</code>があります。
	  これらのスクリプトはAPMが電源の供給元が変わったことを検出したときに、
	  <span class="application">apmd</span>から実行されます。
	  <code class="filename">line</code>スクリプトは電灯線/AC電源へ移行したときに、
	  <code class="filename">battery</code>スクリプトはバッテリー電源に移行したときに実行されます。
	  また、現在の電源の供給元に対応したスクリプトは、
	  <span class="application">apmd</span>が最初に起動されたときにも実行されます。</p>

	<p>これらのスクリプトの中にコマンドを記述して、
	  バッテリーか電灯線を使用したときに応じた電源管理の設定に変更することができます。
	  ここにスクリプトの例があります。</p>

	<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem">
	    <code class="filename">/etc/apm/line</code>
	    <pre class="programlisting">
#!/bin/sh

mount -u /
mount -u /usr
atactl wd0 setidle 0</pre>
          </li>
<li class="listitem">
	    <code class="filename">/etc/apm/battery</code>
	    <pre class="programlisting">
#!/bin/sh

mount -u -o async,noatime,nodevmtime /
mount -u -o async,noatime /usr
atactl wd0 setidle 5</pre>
          </li>
</ul></div>

	<p>ネットワークインターフェース等の設定にも使われるスクリプトの例については、
	  <code class="filename">/usr/share/examples/apm/script</code> もあわせて参照してください。</p>

	<p>他の便利な機能に、
	  <span class="command"><strong>apmd</strong></span>の<code class="option">-a</code>フラグがあります。
	  これを指定すると、
	  <span class="application">apmd</span>はマシンが電灯線の電源に接続されている場合は、
	  スタンバイやサスペンドのイベントを無視します。</p>

      
        <h4 class="title">
<a name="squid"></a>Squid がラップトップのディスクを回転させてしまう (<a href="#power_management">top</a>)
  </h4>

	<p>Squid は 15 秒ごとにキャッシュディレクトリーのひとつを検査します。
	  デフォルトでは、キャッシュ構築のため、第 1 階層のディレクトリー 16 個、
	  第 2 階層 256 個が使われます。簡単な計算によれば:</p>

	<p><code class="code">16 * 256 * 8k(ブロックサイズ) = ~32mb</code></p>

	<p>バッファーキャッシュにないディレクトリーを新たに読んだ場合、
	  Squid の動作は非常に遅くなります。 <code class="filename">squid.conf</code> をいじって
	  このディレクトリー数を減らすことで、ラップトップのディスクが回転する
	  問題を修正できるはずです。</p>

      
        <h4 class="title">
<a name="syslog"></a>syslog がディスクを回転させるのを防ぐ (<a href="#power_management">top</a>)
  </h4>

	<p>
	  ディスクを回転させないようにしようとした場合に問題となるのは、
	  たとえば <a href="http://netbsd.gw.com/cgi-bin/man-cgi?syslogd+8+NetBSD-5.1+i386">syslogd(8)</a> が、
	  定期的にディスクに書き込もうとしてディスクを回転させてしまうことです。
	</p>

	<p>
	  この問題のうまい回避策は、syslog の出力をすべて、
	  ディスクではなく仮想コンソールに振り替えることです。
	  そうするためには、以下の内容を
	  <code class="filename">/etc/syslog.conf</code> に書きます。
	</p>

	<pre class="programlisting">
*.*		/dev/ttyE3
	</pre>

	<p>
	  もちろん、<code class="filename">/dev/ttyE3</code> 以外の、
	  都合のよい仮想コンソールを自由に選んでかまいません。
	</p>

      <hr>
<em><a href="../">NetBSD ドキュメンテーション</a></em> に戻る</div></div></div>
<div class="navfoot"></div>
<div id="footer"><center>
<span class="footfeed"><a href="http://www.NetBSD.org/cgi-bin/feedback.cgi">
	  連絡</a> |
      </span><span class="footcopy"><a href="../../../ja/about/disclaimer.html">
      免責事項</a> |

      <span class="copyright">Copyright © 1994-2012 The NetBSD Foundation, Inc. </span>ALL RIGHTS RESERVED.<br>NetBSD<sup>®</sup> は The NetBSD
	Foundation, Inc. の登録商標です。</span>
</center></div>
</div></body>
</html>
