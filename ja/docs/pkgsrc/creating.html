<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Chapter 10. Creating a new pkgsrc package from scratch</title>
<link rel="stylesheet" type="text/css" href="/global.css">
<meta name="generator" content="DocBook XSL Stylesheets VX.X.X">
<link rel="home" href="index.html" title="The pkgsrc guide">
<link rel="up" href="developers-guide.html" title="Part II. The pkgsrc developer's guide">
<link rel="prev" href="developers-guide.html" title="Part II. The pkgsrc developer's guide">
<link rel="next" href="components.html" title="Chapter 11. Package components - files, directories and contents">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">Chapter 10. Creating a new pkgsrc package from scratch</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="developers-guide.html">Prev</a> </td>
<th width="60%" align="center">Part II. The pkgsrc developer's guide</th>
<td width="20%" align="right"> <a accesskey="n" href="components.html">Next</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="chapter" title="Chapter 10. Creating a new pkgsrc package from scratch">
<div class="titlepage"><div><div><h2 class="title">
<a name="creating"></a>Chapter 10. Creating a new pkgsrc package from scratch</h2></div></div></div>
<div class="toc">
<p><b>Table of Contents</b></p>
<dl>
<dt><span class="sect1"><a href="creating.html#creating.common">10.1. Common types of packages</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="creating.html#creating.perl-module">10.1.1. Perl modules</a></span></dt>
<dt><span class="sect2"><a href="creating.html#creating.kde-app">10.1.2. KDE applications</a></span></dt>
<dt><span class="sect2"><a href="creating.html#creating.python-module">10.1.3. Python modules and programs</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="creating.html#creating.examples">10.2. Examples</a></span></dt>
<dd><dl><dt><span class="sect2"><a href="creating.html#creating.nvu">10.2.1. How the www/nvu package came into pkgsrc</a></span></dt></dl></dd>
</dl>
</div>
<p>When you find a package that is not yet in pkgsrc, you
most likely have a URL from where you can download the source
code. Starting with this URL, creating a package involves only a
few steps.</p>
<div class="procedure"><ol class="procedure" type="1">
<li class="step" title="Step 1"><p>First, install the packages <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/pkgtools/url2pkg/README.html" target="_top"><code class="filename">pkgtools/url2pkg</code></a> and <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/pkgtools/pkglint/README.html" target="_top"><code class="filename">pkgtools/pkglint</code></a>.</p></li>
<li class="step" title="Step 2"><p>Then, choose one of the top-level directories as the
category in which you want to place your package. You can also create a
directory of your own (maybe called <code class="filename">local</code>). In that
category directory, create another directory for your package and change
into it.</p></li>
<li class="step" title="Step 3"><p>Run the program <span class="command"><strong>url2pkg</strong></span>, which will ask
you for a URL. Enter the URL of the distribution file (in most cases a
<code class="filename">.tar.gz</code> file) and watch how the basic ingredients
of your package are created automatically. The distribution file is
extracted automatically to fill in some details in the
<code class="filename">Makefile</code> that would otherwise have to be done
manually.</p></li>
<li class="step" title="Step 4">
<p>Examine the extracted files to determine the dependencies of
your package. Ideally, this is mentioned in some
<code class="filename">README</code> file, but things may differ. For each of
these dependencies, look where it exists in pkgsrc, and if there is a
file called <code class="filename">buildlink3.mk</code> in that directory, add a
line to your package <code class="filename">Makefile</code> which includes that
file just before the last line. If the
<code class="filename">buildlink3.mk</code> file does not exist, it must be
created first. The <code class="filename">buildlink3.mk</code> file makes sure that the package's include files and libraries are provided.</p>
<p>If you just need binaries from a package, add a
<code class="varname">DEPENDS</code> line to the Makefile, which specifies the
version of the dependency and where it can be found in pkgsrc. This line
should be placed in the third paragraph. If the dependency is only
needed for building the package, but not when using it, use
<code class="varname">BUILD_DEPENDS</code> instead of <code class="varname">DEPENDS</code>.
Your package may then look like this:</p>
<pre class="programlisting">
[...]

BUILD_DEPENDS+= lua&gt;=5.0:../../lang/lua
DEPENDS+=       screen-[0-9]*:../../misc/screen
DEPENDS+=       screen&gt;=4.0:../../misc/screen

[...]

.include "../../<em class="replaceable"><code>category</code></em>/<em class="replaceable"><code>package</code></em>/buildlink3.mk"
.include "../../devel/glib2/buildlink3.mk"
.include "../../mk/bsd.pkg.mk"
</pre>
</li>
<li class="step" title="Step 5"><p>Run <span class="command"><strong>pkglint</strong></span> to see what things still need
to be done to make your package a <span class="quote">&#8220;<span class="quote">good</span>&#8221;</span> one. If you don't
know what pkglint's warnings want to tell you, try <span class="command"><strong>pkglint
--explain</strong></span> or <span class="command"><strong>pkglint
-e</strong></span>, which outputs additional
explanations.</p></li>
<li class="step" title="Step 6"><p>In many cases the package is not yet ready to build. You can
find instructions for the most common cases in the next section, <a class="xref" href="creating.html#creating.common" title="10.1. Common types of packages">Section 10.1, &#8220;Common types of packages&#8221;</a>. After you have followed the instructions
over there, you can hopefully continue here.</p></li>
<li class="step" title="Step 7"><p>Run <span class="command"><strong>bmake clean</strong></span> to clean the working
directory from the extracted files. Besides these files, a lot of cache
files and other system information has been saved in the working
directory, which may become wrong after you edited the
<code class="filename">Makefile</code>.</p></li>
<li class="step" title="Step 8"><p>Now, run <span class="command"><strong>bmake</strong></span> to build the package. For
the various things that can go wrong in this phase, consult <a class="xref" href="fixes.html" title="Chapter 19. Making your package work">Chapter 19, <i>Making your package work</i></a>.</p></li>
<li class="step" title="Step 9"><p>When the package builds fine, the next step is to install
the package. Run <span class="command"><strong>bmake install</strong></span> and hope that
everything works.</p></li>
<li class="step" title="Step 10"><p>Up to now, the file <code class="filename">PLIST</code>, which
contains a list of the files that are installed by the package, is
nearly empty. Run <span class="command"><strong>bmake print-PLIST
&gt;PLIST</strong></span> to generate a probably correct list. Check
the file using your preferred text editor to see if the list of
files looks plausible.</p></li>
<li class="step" title="Step 11"><p>Run <span class="command"><strong>pkglint</strong></span> again to see if the generated
<code class="filename">PLIST</code> contains garbage or not.</p></li>
<li class="step" title="Step 12"><p>When you ran <span class="command"><strong>bmake install</strong></span>, the package
has been registered in the database of installed files, but with an
empty list of files. To fix this, run <span class="command"><strong>bmake deinstall</strong></span>
and <span class="command"><strong>bmake install</strong></span> again. Now the package is
registered with the list of files from
<code class="filename">PLIST</code>.</p></li>
<li class="step" title="Step 13"><p>Run <span class="command"><strong>bmake package</strong></span> to create a binary
package from the set of installed files.</p></li>
</ol></div>
<div class="sect1" title="10.1. Common types of packages">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="creating.common"></a>10.1. Common types of packages</h2></div></div></div>
<div class="sect2" title="10.1.1. Perl modules">
<div class="titlepage"><div><div><h3 class="title">
<a name="creating.perl-module"></a>10.1.1. Perl modules</h3></div></div></div>
<p>Simple Perl modules are handled automatically by
<span class="command"><strong>url2pkg</strong></span>, including dependencies.</p>
</div>
<div class="sect2" title="10.1.2. KDE applications">
<div class="titlepage"><div><div><h3 class="title">
<a name="creating.kde-app"></a>10.1.2. KDE applications</h3></div></div></div>
<p>KDE applications should always include
<code class="filename">meta-pkgs/kde3/kde3.mk</code>, which contains numerous
settings that are typical of KDE packages.</p>
</div>
<div class="sect2" title="10.1.3. Python modules and programs">
<div class="titlepage"><div><div><h3 class="title">
<a name="creating.python-module"></a>10.1.3. Python modules and programs</h3></div></div></div>
<p>Python modules and programs packages are easily created using a
set of predefined variables.</p>
<p>Most Python packages use either <span class="quote">&#8220;<span class="quote">distutils</span>&#8221;</span> or
easy-setup (<span class="quote">&#8220;<span class="quote">eggs</span>&#8221;</span>).
If the software uses <span class="quote">&#8220;<span class="quote">distutils</span>&#8221;</span>, set the
<code class="varname">PYDISTUTILSPKG</code> variable to <span class="quote">&#8220;<span class="quote">yes</span>&#8221;</span> so
pkgsrc will make use of this framework.
<span class="quote">&#8220;<span class="quote">distutils</span>&#8221;</span> uses a script called <code class="filename">setup.py</code>,
if the <span class="quote">&#8220;<span class="quote">distutils</span>&#8221;</span> driver is not called
<code class="filename">setup.py</code>, set the <code class="varname">PYSETUP</code> variable
to the name of the script.</p>
<p>
If the default Python versions are not supported by the software, set the
<code class="varname">PYTHON_VERSIONS_ACCEPTED</code> variable to the Python versions
the software is known to work with, from the most recent to the older
one, e.g.
</p>
<pre class="programlisting">
PYTHON_VERSIONS_ACCEPTED=       25 24
</pre>
<p>
If the packaged software is a Python module, include
<span class="quote">&#8220;<span class="quote"><code class="filename">../../lang/python/extension.mk</code></span>&#8221;</span>.
In this case, the package directory should be called
<span class="quote">&#8220;<span class="quote">py-software</span>&#8221;</span> and <code class="varname">PKGNAME</code> should be set to
<span class="quote">&#8220;<span class="quote">${PYPKGPREFIX}-${DISTNAME}</span>&#8221;</span>, e.g.
</p>
<pre class="programlisting">
DISTNAME=   foopymodule-1.2.10
PKGNAME=    ${PYPKGPREFIX}-${DISTNAME}
</pre>
<p>If it is an application, also include
<span class="quote">&#8220;<span class="quote"><code class="filename">../../lang/python/application.mk</code></span>&#8221;</span>
before <span class="quote">&#8220;<span class="quote">extension.mk</span>&#8221;</span>.</p>
<p>If the packaged software, either it is an application or a module, is
egg-aware, you only need to include
<span class="quote">&#8220;<span class="quote"><code class="filename">../../lang/python/egg.mk</code></span>&#8221;</span>.</p>
<p>In order to correctly set the path to the Python interpreter, use the
<code class="varname">REPLACE_PYTHON</code> variable and set it to the list of files
that must be corrected. For example :
</p>
<pre class="programlisting">
REPLACE_PYTHON=   ${WRKSRC}/*.py
</pre>
</div>
</div>
<div class="sect1" title="10.2. Examples">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="creating.examples"></a>10.2. Examples</h2></div></div></div>
<div class="sect2" title="10.2.1. How the www/nvu package came into pkgsrc">
<div class="titlepage"><div><div><h3 class="title">
<a name="creating.nvu"></a>10.2.1. How the www/nvu package came into pkgsrc</h3></div></div></div>
<div class="sect3" title="10.2.1.1. The initial package">
<div class="titlepage"><div><div><h4 class="title">
<a name="creating.nvu.init"></a>10.2.1.1. The initial package</h4></div></div></div>
<p>Looking at the file <code class="filename">pkgsrc/doc/TODO</code>, I saw
that the <span class="quote">&#8220;<span class="quote">nvu</span>&#8221;</span> package has not yet been imported into
pkgsrc. As the description says it has to do with the web, the obvious
choice for the category is <span class="quote">&#8220;<span class="quote">www</span>&#8221;</span>.</p>
<pre class="programlisting">
<code class="prompt">$</code> mkdir www/nvu
<code class="prompt">$</code> cd www/nvu
</pre>
<p>The web site says that the sources are available as a tar file, so
I fed that URL to the <span class="command"><strong>url2pkg</strong></span> program:</p>
<pre class="programlisting">
<code class="prompt">$</code> url2pkg http://cvs.nvu.com/download/nvu-1.0-sources.tar.bz2
</pre>
<p>My editor popped up, and I added a <code class="varname">PKGNAME</code> line
below the <code class="varname">DISTNAME</code> line, as the package name should
not have the word <span class="quote">&#8220;<span class="quote">sources</span>&#8221;</span> in it. I also filled in the
<code class="varname">MAINTAINER</code>, <code class="varname">HOMEPAGE</code> and
<code class="varname">COMMENT</code> fields. Then the package
<code class="filename">Makefile</code> looked like that:</p>
<pre class="programlisting">
# $NetBSD: creating.html,v 1.29 2011/10/30 22:05:36 wiz Exp $
#

DISTNAME=       nvu-1.0-sources
PKGNAME=        nvu-1.0
CATEGORIES=     www
MASTER_SITES=   http://cvs.nvu.com/download/
EXTRACT_SUFX=   .tar.bz2

MAINTAINER=     rillig@NetBSD.org
HOMEPAGE=       http://cvs.nvu.com/
COMMENT=        Web Authoring System

# url2pkg-marker (please do not remove this line.)
.include "../../mk/bsd.pkg.mk"
</pre>
<p>Then, I quit the editor and watched pkgsrc downloading a large
source archive:</p>
<pre class="programlisting">
url2pkg&gt; Running "make makesum" ...
=&gt; Required installed package digest&gt;=20010302: digest-20060826 found
=&gt; Fetching nvu-1.0-sources.tar.bz2
Requesting http://cvs.nvu.com/download/nvu-1.0-sources.tar.bz2
100% |*************************************| 28992 KB  150.77 KB/s00:00 ETA
29687976 bytes retrieved in 03:12 (150.77 KB/s)
url2pkg&gt; Running "make extract" ...
=&gt; Required installed package digest&gt;=20010302: digest-20060826 found
=&gt; Checksum SHA1 OK for nvu-1.0-sources.tar.bz2
=&gt; Checksum RMD160 OK for nvu-1.0-sources.tar.bz2
work.bacc -&gt; /tmp/roland/pkgsrc/www/nvu/work.bacc
===&gt; Installing dependencies for nvu-1.0
===&gt; Overriding tools for nvu-1.0
===&gt; Extracting for nvu-1.0
url2pkg&gt; Adjusting the Makefile.

Remember to correct CATEGORIES, HOMEPAGE, COMMENT, and DESCR when you're done!

Good luck! (See pkgsrc/doc/pkgsrc.txt for some more help :-)
</pre>
</div>
<div class="sect3" title="10.2.1.2. Fixing all kinds of problems to make the package work">
<div class="titlepage"><div><div><h4 class="title">
<a name="creating.nvu.problems"></a>10.2.1.2. Fixing all kinds of problems to make the package work</h4></div></div></div>
<p>Now that the package has been extracted, let's see what's inside
it. The package has a <code class="filename">README.txt</code>, but that only
says something about mozilla, so it's probably useless for seeing what
dependencies this package has. But since there is a GNU configure script
in the package, let's hope that it will complain about everything it
needs.</p>
<pre class="programlisting">
<code class="prompt">$</code> bmake
=&gt; Required installed package digest&gt;=20010302: digest-20060826 found
=&gt; Checksum SHA1 OK for nvu-1.0-sources.tar.bz2
=&gt; Checksum RMD160 OK for nvu-1.0-sources.tar.bz2
===&gt; Patching for nvu-1.0
===&gt; Creating toolchain wrappers for nvu-1.0
===&gt; Configuring for nvu-1.0
[...]
configure: error: Perl 5.004 or higher is required.
[...]
WARNING: Please add USE_TOOLS+=perl to the package Makefile.
[...]
</pre>
<p>That worked quite well. So I opened the package Makefile in my
editor, and since it already has a <code class="varname">USE_TOOLS</code> line, I
just appended <span class="quote">&#8220;<span class="quote">perl</span>&#8221;</span> to it. Since the dependencies of the
package have changed now, and since a perl wrapper is automatically
installed in the <span class="quote">&#8220;<span class="quote">tools</span>&#8221;</span> phase, I need to build the package
from scratch.</p>
<pre class="programlisting">
<code class="prompt">$</code> bmake clean
===&gt; Cleaning for nvu-1.0
<code class="prompt">$</code> bmake
[...]
*** /tmp/roland/pkgsrc/www/nvu/work.bacc/.tools/bin/make is not \
GNU Make.  You will not be able to build Mozilla without GNU Make.
[...]
</pre>
<p>So I added <span class="quote">&#8220;<span class="quote">gmake</span>&#8221;</span> to the
<code class="varname">USE_TOOLS</code> line and tried again (from scratch).</p>
<pre class="programlisting">
[...]
checking for GTK - version &gt;= 1.2.0... no
*** Could not run GTK test program, checking why...
[...]
</pre>
<p>Now to the other dependencies. The first question is: Where is the
GTK package hidden in pkgsrc?</p>
<pre class="programlisting">
<code class="prompt">$</code> echo ../../*/gtk*
[many packages ...]
<code class="prompt">$</code> echo ../../*/gtk
../../x11/gtk
<code class="prompt">$</code> echo ../../*/gtk2
../../x11/gtk2
<code class="prompt">$</code> echo ../../*/gtk2/bui*
../../x11/gtk2/buildlink3.mk
</pre>
<p>The first try was definitely too broad. The second one had exactly
one result, which is very good. But there is one pitfall with GNOME
packages. Before GNOME 2 had been released, there were already many
GNOME 1 packages in pkgsrc. To be able to continue to use these
packages, the GNOME 2 packages were imported as separate packages, and
their names usually have a <span class="quote">&#8220;<span class="quote">2</span>&#8221;</span> appended. So I checked
whether this was the case here, and indeed it was.</p>
<p>Since the GTK2 package has a <code class="filename">buildlink3.mk</code>
file, adding the dependency is very easy. I just inserted an
<code class="literal">.include</code> line before the last line of the package
<code class="filename">Makefile</code>, so that it now looks like this:</p>
<pre class="programlisting">
[...]
.include "../../x11/gtk2/buildlink3.mk"
.include "../../mk/bsd.pkg.mk
</pre>
<p>After another <span class="command"><strong>bmake clean &amp;&amp; bmake</strong></span>, the answer
was:</p>
<pre class="programlisting">
[...]
checking for gtk-config... /home/roland/pkg/bin/gtk-config
checking for GTK - version &gt;= 1.2.0... no
*** Could not run GTK test program, checking why...
*** The test program failed to compile or link. See the file config.log for the
*** exact error that occured. This usually means GTK was incorrectly installed
*** or that you have moved GTK since it was installed. In the latter case, you
*** may want to edit the gtk-config script: /home/roland/pkg/bin/gtk-config
configure: error: Test for GTK failed.
[...]
</pre>
<p>In this particular case, the assumption that <span class="quote">&#8220;<span class="quote">every package
prefers GNOME 2</span>&#8221;</span> had been wrong. The first of the lines above
told me that this package really wanted to have the GNOME 1 version of
GTK. If the package had looked for GTK2, it would have looked for
<span class="command"><strong>pkg-config</strong></span> instead of <span class="command"><strong>gtk-config</strong></span>.
So I changed the <code class="literal">x11/gtk2</code> to
<code class="literal">x11/gtk</code> in the package <code class="filename">Makefile</code>,
and tried again.</p>
<pre class="programlisting">
[...]
cc -o xpidl.o -c -DOSTYPE=\"NetBSD3\" -DOSARCH=\"NetBSD\"   -I../../../dist/include/xpcom -I../../../dist/include -I/tmp/roland/pkgsrc/www/nvu/work.bacc/mozilla/dist/include/nspr -I/usr/X11R6/include   -fPIC -DPIC -I/home/roland/pkg/include -I/usr/include  -I/usr/X11R6/include -Wall -W -Wno-unused -Wpointer-arith -Wcast-align -Wno-long-long -pedantic -O2 -I/home/roland/pkg/include -I/usr/include -Dunix -pthread -pipe  -DDEBUG -D_DEBUG -DDEBUG_roland -DTRACING -g -I/home/roland/pkg/include/glib/glib-1.2 -I/home/roland/pkg/lib/glib/include -I/usr/pkg/include/orbit-1.0   -I/home/roland/pkg/include -I/usr/include  -I/usr/X11R6/include -include ../../../mozilla-config.h -DMOZILLA_CLIENT -Wp,-MD,.deps/xpidl.pp xpidl.c
In file included from xpidl.c:42:
xpidl.h:53:24: libIDL/IDL.h: No such file or directory
In file included from xpidl.c:42:
xpidl.h:132: error: parse error before "IDL_ns"
[...]
</pre>
<p>The package still does not find all of its dependencies. Now the
question is: Which package provides the
<code class="filename">libIDL/IDL.h</code> header file?</p>
<pre class="programlisting">
<code class="prompt">$</code> echo ../../*/*idl*
../../devel/py-idle ../../wip/idled ../../x11/acidlaunch
<code class="prompt">$</code> echo ../../*/*IDL*
../../net/libIDL
</pre>
<p>Let's take the one from the second try. So I included the
<code class="filename">../../net/libIDL/buildlink3.mk</code> file and tried
again. But the error didn't change. After digging through some of the
code, I concluded that the build process of the package was broken and
couldn't have ever worked, but since the Mozilla source tree is quite
large, I didn't want to fix it. So I added the following to the package
<code class="filename">Makefile</code> and tried again:</p>
<pre class="programlisting">
CPPFLAGS+=              -I${BUILDLINK_PREFIX.libIDL}/include/libIDL-2.0
BUILDLINK_TRANSFORM+=   -l:IDL:IDL-2
</pre>
<p>The latter line is needed because the package expects the library
<code class="filename">libIDL.so</code>, but only
<code class="filename">libIDL-2.so</code> is available. So I told the compiler
wrapper to rewrite that on the fly.</p>
<p>The next problem was related to a recent change of the FreeType
interface. I looked up in <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/www/seamonkey/README.html" target="_top"><code class="filename">www/seamonkey</code></a>
which patch files were relevant for this issue and copied them to the
<code class="filename">patches</code> directory. Then I retried, fixed the
patches so that they applied cleanly and retried again. This time,
everything worked.</p>
</div>
<div class="sect3" title="10.2.1.3. Installing the package">
<div class="titlepage"><div><div><h4 class="title">
<a name="creating.nvu.inst"></a>10.2.1.3. Installing the package</h4></div></div></div>
<pre class="programlisting">
<code class="prompt">$</code> bmake CHECK_FILES=no install
[...]
<code class="prompt">$</code> bmake print-PLIST &gt;PLIST
<code class="prompt">$</code> bmake deinstall
<code class="prompt">$</code> bmake install
</pre>
</div>
</div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="developers-guide.html">Prev</a> </td>
<td width="20%" align="center"><a accesskey="u" href="developers-guide.html">Up</a></td>
<td width="40%" align="right"> <a accesskey="n" href="components.html">Next</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">Part II. The pkgsrc developer's guide </td>
<td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td>
<td width="40%" align="right" valign="top"> Chapter 11. Package components - files, directories and contents</td>
</tr>
</table>
</div>
</body>
</html>
