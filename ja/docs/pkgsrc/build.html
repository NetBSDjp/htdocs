<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Chapter 17. The build process</title>
<link rel="stylesheet" type="text/css" href="/global.css">
<meta name="generator" content="DocBook XSL Stylesheets VX.X.X">
<link rel="home" href="index.html" title="The pkgsrc guide">
<link rel="up" href="developers-guide.html" title="Part II. The pkgsrc developer's guide">
<link rel="prev" href="options.html" title="Chapter 16. Options handling">
<link rel="next" href="tools.html" title="Chapter 18. Tools needed for building or running">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">Chapter 17. The build process</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="options.html">Prev</a> </td>
<th width="60%" align="center">Part II. The pkgsrc developer's guide</th>
<td width="20%" align="right"> <a accesskey="n" href="tools.html">Next</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="chapter" title="Chapter 17. The build process">
<div class="titlepage"><div><div><h2 class="title">
<a name="build"></a>Chapter 17. The build process</h2></div></div></div>
<div class="toc">
<p><b>Table of Contents</b></p>
<dl>
<dt><span class="sect1"><a href="build.html#build.intro">17.1. Introduction</a></span></dt>
<dt><span class="sect1"><a href="build.html#build.prefix">17.2. Program location</a></span></dt>
<dt><span class="sect1"><a href="build.html#build.builddirs">17.3. Directories used during the build process</a></span></dt>
<dt><span class="sect1"><a href="build.html#build.running">17.4. Running a phase</a></span></dt>
<dt><span class="sect1"><a href="build.html#build.fetch">17.5. The <span class="emphasis"><em>fetch</em></span> phase</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="build.html#build.fetch.what">17.5.1. What to fetch and where to get it from</a></span></dt>
<dt><span class="sect2"><a href="build.html#build.fetch.how">17.5.2. How are the files fetched?</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="build.html#build.checksum">17.6. The <span class="emphasis"><em>checksum</em></span> phase</a></span></dt>
<dt><span class="sect1"><a href="build.html#build.extract">17.7. The <span class="emphasis"><em>extract</em></span> phase</a></span></dt>
<dt><span class="sect1"><a href="build.html#build.patch">17.8. The <span class="emphasis"><em>patch</em></span> phase</a></span></dt>
<dt><span class="sect1"><a href="build.html#build.tools">17.9. The <span class="emphasis"><em>tools</em></span> phase</a></span></dt>
<dt><span class="sect1"><a href="build.html#build.wrapper">17.10. The <span class="emphasis"><em>wrapper</em></span> phase</a></span></dt>
<dt><span class="sect1"><a href="build.html#build.configure">17.11. The <span class="emphasis"><em>configure</em></span> phase</a></span></dt>
<dt><span class="sect1"><a href="build.html#build.build">17.12. The <span class="emphasis"><em>build</em></span> phase</a></span></dt>
<dt><span class="sect1"><a href="build.html#build.test">17.13. The <span class="emphasis"><em>test</em></span> phase</a></span></dt>
<dt><span class="sect1"><a href="build.html#build.install">17.14. The <span class="emphasis"><em>install</em></span> phase</a></span></dt>
<dt><span class="sect1"><a href="build.html#build.package">17.15. The <span class="emphasis"><em>package</em></span> phase</a></span></dt>
<dt><span class="sect1"><a href="build.html#build.clean">17.16. Cleaning up</a></span></dt>
<dt><span class="sect1"><a href="build.html#build.helpful-targets">17.17. Other helpful targets</a></span></dt>
</dl>
</div>
<div class="sect1" title="17.1. Introduction">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="build.intro"></a>17.1. Introduction</h2></div></div></div>
<p>This chapter gives a detailed description on how a package is
    built. Building a package is separated into different
    <span class="emphasis"><em>phases</em></span> (for example <code class="varname">fetch</code>,
    <code class="varname">build</code>, <code class="varname">install</code>), all of which are
    described in the following sections. Each phase is split into
    so-called <span class="emphasis"><em>stages</em></span>, which take the name of the
    containing phase, prefixed by one of <code class="varname">pre-</code>,
    <code class="varname">do-</code> or <code class="varname">post-</code>. (Examples are
    <code class="varname">pre-configure</code>, <code class="varname">post-build</code>.) Most
    of the actual work is done in the <code class="varname">do-*</code> stages.</p>
<p>Never override the regular targets (like
    <code class="varname">fetch</code>), if you have to, override the
    <code class="varname">do-*</code> ones instead.</p>
<p>The basic steps for building a program are always the same.  First
    the program's source (<span class="emphasis"><em>distfile</em></span>) must be brought to
    the local system and then extracted. After any pkgsrc-specific patches
    to compile properly are applied, the software can be configured, then
    built (usually by compiling), and finally the generated binaries, etc.
    can be put into place on the system.</p>
<p>To get more details about what is happening at each step,
    you can set the <code class="varname">PKG_VERBOSE</code> variable, or the
    <code class="varname">PATCH_DEBUG</code> variable if you are just interested
    in more details about the <span class="emphasis"><em>patch</em></span> step.</p>
</div>
<div class="sect1" title="17.2. Program location">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="build.prefix"></a>17.2. Program location</h2></div></div></div>
<p>Before outlining the process performed by the NetBSD package system in
    the next section, here's a brief discussion on where programs are
    installed, and which variables influence this.</p>
<p>The automatic variable <code class="varname">PREFIX</code> indicates
    where all files of the final program shall be installed. It is
    usually set to <code class="varname">LOCALBASE</code>
    (<code class="filename">/usr/pkg</code>), or <code class="varname">CROSSBASE</code>
    for pkgs in the <code class="filename">cross</code> category.  The value of
    <code class="varname">PREFIX</code> needs to be put
    into the various places in the program's source where paths to
    these files are encoded.  See <a class="xref" href="components.html#components.patches" title="11.3. patches/*">Section 11.3, &#8220;patches/*&#8221;</a> and <a class="xref" href="fixes.html#fixes.libtool" title="19.3.1. Shared libraries - libtool">Section 19.3.1, &#8220;Shared libraries - libtool&#8221;</a> for more details.</p>
<p>When choosing which of these variables to use,
    follow the following rules:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p><code class="varname">PREFIX</code> always points to the location
	where the current pkg will be installed.  When referring to a
	pkg's own installation path, use
	<span class="quote">&#8220;<span class="quote">${PREFIX}</span>&#8221;</span>.</p></li>
<li class="listitem"><p><code class="varname">LOCALBASE</code> is where all non-X11 pkgs
	are installed.  If you need to construct a -I or -L argument
	to the compiler to find includes and libraries installed by
	another non-X11 pkg, use <span class="quote">&#8220;<span class="quote">${LOCALBASE}</span>&#8221;</span>. The name
	<code class="varname">LOCALBASE</code> stems from FreeBSD, which
	installed all packages in <code class="filename">/usr/local</code>. As
	pkgsrc leaves <code class="filename">/usr/local</code> for the system
	administrator, this variable is a misnomer.</p></li>
<li class="listitem"><p><code class="varname">X11BASE</code> is where the actual X11
	distribution (from xsrc, etc.) is installed. When looking for
	<span class="emphasis"><em>standard</em></span> X11 includes (not those
	installed by a package), use <span class="quote">&#8220;<span class="quote">${X11BASE}</span>&#8221;</span>.</p></li>
<li class="listitem">
<p>X11-based packages are special in that they may be
	installed in either <code class="varname">X11BASE</code> or
	<code class="varname">LOCALBASE</code>.</p>
<p>Usually, X11 packages should be installed under
	<code class="varname">LOCALBASE</code> whenever possible.  Note that you
	will need to include
	<code class="filename">../../mk/x11.buildlink3.mk</code> in them to
	request the presence of X11 and to get the right compilation
	flags.</p>
<p>Even though, there are some packages that cannot be installed
	under <code class="varname">LOCALBASE</code>: those that come with app-defaults
	files. These packages are special and they must be placed under
	<code class="varname">X11BASE</code>. To accomplish this, set either
	<code class="varname">USE_X11BASE</code> or <code class="varname">USE_IMAKE</code> in
	your package.</p>
<p>Some notes: If you need
	to find includes or libraries installed by a pkg that has
	<code class="varname">USE_IMAKE</code> or <code class="varname">USE_X11BASE</code> in
	its pkg <code class="filename">Makefile</code>, you need to look in
	<span class="emphasis"><em>both</em></span> <code class="filename">${X11BASE}</code> and
	<code class="filename">${LOCALBASE}</code>. To force installation of
	all X11 packages in <code class="varname">LOCALBASE</code>, the
	<a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/pkgtools/xpkgwedge/README.html" target="_top"><code class="filename">pkgtools/xpkgwedge</code></a> package
	is enabled by default.</p>
</li>
<li class="listitem"><p><code class="varname">X11PREFIX</code> should be used to refer to
	the installed location of an X11
	package. <code class="varname">X11PREFIX</code> will be set to
	<code class="varname">X11BASE</code> if xpkgwedge is not installed, and
	to <code class="varname">LOCALBASE</code> if xpkgwedge is
	installed.</p></li>
<li class="listitem">
<p>If xpkgwedge is installed, it is possible to have some
	packages installed in <code class="varname">X11BASE</code> and some in
	<code class="varname">LOCALBASE</code>.  To determine the prefix of an
	installed package, the <code class="varname">EVAL_PREFIX</code>
	definition can be used. It takes pairs in the format
	<span class="quote">&#8220;<span class="quote">DIRNAME=&lt;package&gt;</span>&#8221;</span>, and the <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?make+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">make</span>(1)</span></a>
	variable <code class="varname">DIRNAME</code> will be set to the prefix
	of the installed package &lt;package&gt;, or
	<span class="quote">&#8220;<span class="quote">${X11PREFIX}</span>&#8221;</span> if the package is not
	installed.</p>
<p>This is best illustrated by example.</p>
<p>The following lines are taken from
	<code class="filename">pkgsrc/wm/scwm/Makefile</code>:</p>
<pre class="programlisting">
EVAL_PREFIX+=           GTKDIR=gtk+
CONFIGURE_ARGS+=        --with-guile-prefix=${LOCALBASE:Q}
CONFIGURE_ARGS+=        --with-gtk-prefix=${GTKDIR:Q}
CONFIGURE_ARGS+=        --enable-multibyte
</pre>
<p>Specific defaults can be defined for the packages
	evaluated using <code class="varname">EVAL_PREFIX</code>, by using a
	definition of the form:</p>
<pre class="programlisting">
GTKDIR_DEFAULT= ${LOCALBASE}
</pre>
<p>where <code class="varname">GTKDIR</code> corresponds
	to the first definition in
	the <code class="varname">EVAL_PREFIX</code> pair.</p>
</li>
<li class="listitem"><p>Within <code class="filename">${PREFIX}</code>, packages should
	install files according to <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?hier+7+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">hier</span>(7)</span></a>, with the exception that
	manual pages go into <code class="filename">${PREFIX}/man</code>, not
	<code class="filename">${PREFIX}/share/man</code>.</p></li>
</ul></div>
</div>
<div class="sect1" title="17.3. Directories used during the build process">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="build.builddirs"></a>17.3. Directories used during the build process</h2></div></div></div>
<p>When building a package, various directories are used to store
    source files, temporary files, pkgsrc-internal files, and so on. These
    directories are explained here.</p>
<p>Some of the directory variables contain relative pathnames. There
    are two common base directories for these relative directories:
    <code class="varname">PKGSRCDIR/PKGPATH</code> is used for directories that are
    pkgsrc-specific. <code class="varname">WRKSRC</code> is used for directories
    inside the package itself.</p>
<div class="variablelist"><dl>
<dt><span class="term"><code class="varname">PKGSRCDIR</code></span></dt>
<dd><p>This is an absolute pathname that points to the pkgsrc
      root directory. Generally, you don't need
      it.</p></dd>
<dt><span class="term"><code class="varname">PKGDIR</code></span></dt>
<dd><p>This is an absolute pathname that points to the
      current package.</p></dd>
<dt><span class="term"><code class="varname">PKGPATH</code></span></dt>
<dd><p>This is a pathname relative to
      <code class="varname">PKGSRCDIR</code> that points to the current
      package.</p></dd>
<dt><span class="term"><code class="varname">WRKDIR</code></span></dt>
<dd><p>This is an absolute pathname pointing to the directory
      where all work takes place. The distfiles are extracted to this
      directory. It also contains temporary directories and log files used by
      the various pkgsrc frameworks, like <span class="emphasis"><em>buildlink</em></span> or
      the <span class="emphasis"><em>wrappers</em></span>.</p></dd>
<dt><span class="term"><code class="varname">WRKSRC</code></span></dt>
<dd><p>This is an absolute pathname pointing to the directory
      where the distfiles are extracted. It is usually a direct subdirectory
      of <code class="varname">WRKDIR</code>, and often it's the only directory entry
      that isn't hidden. This variable may be changed by a package
      <code class="filename">Makefile</code>.</p></dd>
</dl></div>
<p>The <code class="varname">CREATE_WRKDIR_SYMLINK</code> definition takes either
    the value <span class="emphasis"><em>yes</em></span> or <span class="emphasis"><em>no</em></span> and defaults
    to <span class="emphasis"><em>no</em></span>. It indicates whether a symbolic link to the
    <code class="varname">WRKDIR</code> is to be created in the pkgsrc entry's directory.
    If users would like to have their pkgsrc trees behave in a
    read-only manner, then the value of
    <code class="varname">CREATE_WRKDIR_SYMLINK</code> should be set to
    <span class="emphasis"><em>no</em></span>.</p>
</div>
<div class="sect1" title="17.4. Running a phase">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="build.running"></a>17.4. Running a phase</h2></div></div></div>
<p>You can run a particular phase by typing <span class="command"><strong>make
    phase</strong></span>, where <span class="emphasis"><em>phase</em></span> is the name of the
    phase. This will automatically run all phases that are required for this
    phase. The default phase is <code class="varname">build</code>, that is, when you
    run <span class="command"><strong>make</strong></span> without parameters in a package directory,
    the package will be built, but not installed.</p>
</div>
<div class="sect1" title="17.5. The fetch phase">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="build.fetch"></a>17.5. The <span class="emphasis"><em>fetch</em></span> phase</h2></div></div></div>
<p>The first step in building a package is to fetch the
    distribution files (distfiles) from the sites that are providing
    them. This is the task of the <span class="emphasis"><em>fetch</em></span>
    phase.</p>
<div class="sect2" title="17.5.1. What to fetch and where to get it from">
<div class="titlepage"><div><div><h3 class="title">
<a name="build.fetch.what"></a>17.5.1. What to fetch and where to get it from</h3></div></div></div>
<p>In simple cases, <code class="varname">MASTER_SITES</code>
      defines all URLs from where the distfile, whose name is
      derived from the <code class="varname">DISTNAME</code> variable, is
      fetched. The more complicated cases are described
      below.</p>
<p>The variable <code class="varname">DISTFILES</code> specifies
      the list of distfiles that have to be fetched. Its value
      defaults to <code class="literal">${DISTNAME}${EXTRACT_SUFX}</code>,
      so that most packages don't need to define it at all.
      <code class="varname">EXTRACT_SUFX</code> is
      <code class="literal">.tar.gz</code> by default, but can be changed
      freely. Note that if your package requires additional
      distfiles to the default one, you cannot just append the
      additional filenames using the <code class="literal">+=</code>
      operator, but you have write for example:</p>
<pre class="programlisting">
DISTFILES=      ${DISTNAME}${EXTRACT_SUFX} additional-files.tar.gz
</pre>
<p>Each distfile is fetched from a list of sites, usually
      <code class="varname">MASTER_SITES</code>. If the package has multiple
      <code class="varname">DISTFILES</code> or multiple
      <code class="varname">PATCHFILES</code> from different sites, you can
      set
      <code class="varname">SITES.<em class="replaceable"><code>distfile</code></em></code>
      to the list of URLs where the file
      <code class="filename"><em class="replaceable"><code>distfile</code></em></code>
      (including the suffix) can be found.</p>
<pre class="programlisting">
DISTFILES=      ${DISTNAME}${EXTRACT_SUFX}
DISTFILES+=     foo-file.tar.gz
SITES.foo-file.tar.gz= \
http://www.somewhere.com/somehow/ \
http://www.somewhereelse.com/mirror/somehow/
</pre>
<p>When actually fetching the distfiles, each item from
      <code class="varname">MASTER_SITES</code> or
      <code class="varname">SITES.*</code> gets the name of each distfile
      appended to it, without an intermediate slash. Therefore,
      all site values have to end with a slash or other separator
      character. This allows for example to set
      <code class="varname">MASTER_SITES</code> to a URL of a CGI script
      that gets the name of the distfile as a parameter. In this
      case, the definition would look like:</p>
<pre class="programlisting">
MASTER_SITES=   http://www.example.com/download.cgi?file=
</pre>
<p> The exception to this rule are URLs starting with a dash.
      In that case the URL is taken as is, fetched and the result stored
      under the name of the distfile.</p>
<p>There are some predefined values for
      <code class="varname">MASTER_SITES</code>, which can be used in
      packages.  The names of the variables should speak for
      themselves.</p>
<pre class="programlisting">
${MASTER_SITE_APACHE}
${MASTER_SITE_BACKUP}
${MASTER_SITE_CYGWIN}
${MASTER_SITE_DEBIAN}
${MASTER_SITE_FREEBSD}
${MASTER_SITE_FREEBSD_LOCAL}
${MASTER_SITE_GENTOO}
${MASTER_SITE_GNOME}
${MASTER_SITE_GNU}
${MASTER_SITE_GNUSTEP}
${MASTER_SITE_IFARCHIVE}
${MASTER_SITE_KDE}
${MASTER_SITE_MOZILLA}
${MASTER_SITE_MYSQL}
${MASTER_SITE_OPENOFFICE}
${MASTER_SITE_PERL_CPAN}
${MASTER_SITE_PGSQL}
${MASTER_SITE_R_CRAN}
${MASTER_SITE_SOURCEFORGE}
${MASTER_SITE_SOURCEFORGE_JP}
${MASTER_SITE_SUNSITE}
${MASTER_SITE_SUSE}
${MASTER_SITE_TEX_CTAN}
${MASTER_SITE_XCONTRIB}
${MASTER_SITE_XEMACS}
</pre>
<p>Some explanations for the less self-explaining ones:
      <code class="varname">MASTER_SITE_BACKUP</code> contains backup sites
      for packages that are maintained in <a class="ulink" href="ftp://ftp.NetBSD.org/pub/pkgsrc/distfiles/%24%7BDIST_SUBDIR%7D" target="_top">ftp://ftp.NetBSD.org/pub/pkgsrc/distfiles/${DIST_SUBDIR}</a>.  <code class="varname">MASTER_SITE_LOCAL</code> contains local
      package source distributions that are maintained in <a class="ulink" href="ftp://ftp.NetBSD.org/pub/pkgsrc/distfiles/LOCAL_PORTS/" target="_top">ftp://ftp.NetBSD.org/pub/pkgsrc/distfiles/LOCAL_PORTS/</a>.</p>
<p>If you choose one of these predefined sites, you may
      want to specify a subdirectory of that site. Since these
      macros may expand to more than one actual site, you
      <span class="emphasis"><em>must</em></span> use the following construct to
      specify a subdirectory:</p>
<pre class="programlisting">
MASTER_SITES=   ${MASTER_SITE_GNU:=subdirectory/name/}
MASTER_SITES=   ${MASTER_SITE_SOURCEFORGE:=project_name/}
</pre>
<p>Note the trailing slash after the subdirectory
      name.</p>
</div>
<div class="sect2" title="17.5.2. How are the files fetched?">
<div class="titlepage"><div><div><h3 class="title">
<a name="build.fetch.how"></a>17.5.2. How are the files fetched?</h3></div></div></div>
<p>The <span class="emphasis"><em>fetch</em></span> phase makes sure that
      all the distfiles exist in a local directory
      (<code class="varname">DISTDIR</code>, which can be set by the pkgsrc
      user). If the files do not exist, they are fetched using
      commands of the form</p>
<pre class="programlisting">
${FETCH_CMD} ${FETCH_BEFORE_ARGS} ${site}${file} ${FETCH_AFTER_ARGS}
</pre>
<p>where <code class="literal">${site}</code> varies through
      several possibilities in turn: first,
      <code class="varname">MASTER_SITE_OVERRIDE</code> is tried, then the
      sites specified in either <code class="varname">SITES.file</code> if
      defined, else <code class="varname">MASTER_SITES</code> or
      <code class="varname">PATCH_SITES</code>, as applies, then finally the
      value of <code class="varname">MASTER_SITE_BACKUP</code>. The order of
      all except the first and the last can be optionally sorted
      by the user, via setting either
      <code class="varname">MASTER_SORT_RANDOM</code>, and
      <code class="varname">MASTER_SORT_AWK</code> or
      <code class="varname">MASTER_SORT_REGEX</code>.</p>
<p> The specific command and arguments used depend on the
      <code class="varname">FETCH_USING</code> parameter. The example above is
      for <code class="literal">FETCH_USING=custom</code>.</p>
<p>The distfiles mirror run by the NetBSD Foundation uses the
      <span class="emphasis"><em>mirror-distfiles</em></span> target to mirror the
      distfiles, if they are freely distributable.  Packages setting
      <code class="varname">NO_SRC_ON_FTP</code> (usually to
      <span class="quote">&#8220;<span class="quote">${RESTRICTED}</span>&#8221;</span>) will not have their distfiles
      mirrored.</p>
</div>
</div>
<div class="sect1" title="17.6. The checksum phase">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="build.checksum"></a>17.6. The <span class="emphasis"><em>checksum</em></span> phase</h2></div></div></div>
<p>After the distfile(s) are fetched, their checksum is
    generated and compared with the checksums stored in the
    distinfo file. If the checksums don't match, the build is
    aborted. This is to ensure the same distfile is used for
    building, and that the distfile wasn't changed, e.g. by some
    malign force, deliberately changed distfiles on the master
    distribution site or network lossage.</p>
</div>
<div class="sect1" title="17.7. The extract phase">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="build.extract"></a>17.7. The <span class="emphasis"><em>extract</em></span> phase</h2></div></div></div>
<p>When the distfiles are present on the local system, they
    need to be extracted, as they usually come in the form of some
    compressed archive format.</p>
<p>By default, all <code class="varname">DISTFILES</code> are
    extracted. If you only need some of them, you can set the
    <code class="varname">EXTRACT_ONLY</code> variable to the list of those
    files.</p>
<p>Extracting the files is usually done by a little
    program, <code class="filename">mk/extract/extract</code>, which
    already knows how to extract various archive formats, so most
    likely you will not need to change anything here. But if you
    need, the following variables may help you:</p>
<div class="variablelist"><dl>
<dt><span class="term"><code class="varname">EXTRACT_OPTS_{BIN,LHA,PAX,RAR,TAR,ZIP,ZOO}</code></span></dt>
<dd><p>Use these variables to override the default
      options for an extract command, which are defined in
      <code class="filename">mk/extract/extract</code>.</p></dd>
<dt><span class="term"><code class="varname">EXTRACT_USING</code></span></dt>
<dd><p>This variable can be set to
      <code class="literal">bsdtar</code>, <code class="literal">gtar</code>, <code class="literal">nbtar</code>
      (which is the default value), <code class="literal">pax</code>, or an
      absolute pathname pointing to the command with which tar
      archives should be extracted.  It is preferred to choose bsdtar over gtar
      if NetBSD's pax-as-tar is not good enough.</p></dd>
</dl></div>
<p>If the <code class="filename">extract</code> program doesn't
    serve your needs, you can also override the
    <code class="varname">EXTRACT_CMD</code> variable, which holds the
    command used for extracting the files. This command is
    executed in the <code class="filename">${WRKSRC}</code>
    directory. During execution of this command, the shell
    variable <code class="varname">extract_file</code> holds the absolute
    pathname of the file that is going to be extracted.</p>
<p>And if that still does not suffice, you can override the
    <code class="varname">do-extract</code> target in the package
    Makefile.</p>
</div>
<div class="sect1" title="17.8. The patch phase">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="build.patch"></a>17.8. The <span class="emphasis"><em>patch</em></span> phase</h2></div></div></div>
<p>After extraction, all the patches named by the
    <code class="varname">PATCHFILES</code>, those present in the patches
    subdirectory of the package as well as in
    $LOCALPATCHES/$PKGPATH (e.g.
    <code class="filename">/usr/local/patches/graphics/png</code>) are
    applied.  Patchfiles ending in <code class="filename">.Z</code> or
    <code class="filename">.gz</code> are uncompressed before they are
    applied, files ending in <code class="filename">.orig</code> or
    <code class="filename">.rej</code> are ignored. Any special options to
    <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?patch+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">patch</span>(1)</span></a> can be handed in
    <code class="varname">PATCH_DIST_ARGS</code>.  See <a class="xref" href="components.html#components.patches" title="11.3. patches/*">Section 11.3, &#8220;patches/*&#8221;</a> for more details.</p>
<p>By default <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?patch+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">patch</span>(1)</span></a> is given special args to make
    it fail if the patches apply with some lines of fuzz. Please
    fix (regen) the patches so that they apply cleanly. The
    rationale behind this is that patches that don't apply cleanly
    may end up being applied in the wrong place, and cause severe
    harm there.</p>
</div>
<div class="sect1" title="17.9. The tools phase">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="build.tools"></a>17.9. The <span class="emphasis"><em>tools</em></span> phase</h2></div></div></div>
<p>This is covered in <a class="xref" href="tools.html" title="Chapter 18. Tools needed for building or running">Chapter 18, <i>Tools needed for building or running</i></a>.
    </p>
</div>
<div class="sect1" title="17.10. The wrapper phase">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="build.wrapper"></a>17.10. The <span class="emphasis"><em>wrapper</em></span> phase</h2></div></div></div>
<p>This phase creates wrapper programs for the compilers and
    linkers. The following variables can be used to tweak the
    wrappers.</p>
<div class="variablelist"><dl>
<dt><span class="term"><code class="varname">ECHO_WRAPPER_MSG</code></span></dt>
<dd><p>The command used to print progress
      messages. Does nothing by default. Set to
      <code class="literal">${ECHO}</code> to see the progress
      messages.</p></dd>
<dt><span class="term"><code class="varname">WRAPPER_DEBUG</code></span></dt>
<dd><p>This variable can be set to
      <code class="literal">yes</code> (default) or <code class="literal">no</code>,
      depending on whether you want additional information in the
      wrapper log file.</p></dd>
<dt><span class="term"><code class="varname">WRAPPER_UPDATE_CACHE</code></span></dt>
<dd><p>This variable can be set to
      <code class="literal">yes</code> or <code class="literal">no</code>, depending
      on whether the wrapper should use its cache, which will
      improve the speed. The default value is
      <code class="literal">yes</code>, but is forced to
      <code class="literal">no</code> if the platform does not support
      it.</p></dd>
<dt><span class="term"><code class="varname">WRAPPER_REORDER_CMDS</code></span></dt>
<dd><p>A list of reordering commands. A reordering
      command has the form
      <code class="literal">reorder:l:<em class="replaceable"><code>lib1</code></em>:<em class="replaceable"><code>lib2</code></em></code>.
      It ensures that that
      <code class="literal">-l<em class="replaceable"><code>lib1</code></em></code> occurs
      before <code class="literal">-l<em class="replaceable"><code>lib2</code></em></code>.
      </p></dd>
<dt><span class="term"><code class="varname">WRAPPER_TRANSFORM_CMDS</code></span></dt>
<dd><p>A list of transformation commands. [TODO:
      investigate further]</p></dd>
</dl></div>
</div>
<div class="sect1" title="17.11. The configure phase">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="build.configure"></a>17.11. The <span class="emphasis"><em>configure</em></span> phase</h2></div></div></div>
<p>Most pieces of software need information on the header
    files, system calls, and library routines which are available
    on the platform they run on. The process of determining this
    information is known as configuration, and is usually
    automated. In most cases, a script is supplied with the
    distfiles, and its invocation results in generation of header
    files, Makefiles, etc.</p>
<p>If the package contains a configure script, this can be
    invoked by setting <code class="varname">HAS_CONFIGURE</code> to
    <span class="quote">&#8220;<span class="quote">yes</span>&#8221;</span>. If the configure script is a GNU autoconf
    script, you should set <code class="varname">GNU_CONFIGURE</code> to
    <span class="quote">&#8220;<span class="quote">yes</span>&#8221;</span> instead. What happens in the
    <span class="emphasis"><em>configure</em></span> phase is roughly:</p>
<pre class="programlisting">
.for d in ${CONFIGURE_DIRS}
        cd ${WRKSRC} \
        &amp;&amp; cd ${d} \
        &amp;&amp; env ${CONFIGURE_ENV} ${CONFIGURE_SCRIPT} ${CONFIGURE_ARGS}
.endfor
</pre>
<p><code class="varname">CONFIGURE_DIRS</code> (default:
    <span class="quote">&#8220;<span class="quote">.</span>&#8221;</span>) is a list of pathnames relative to
    <code class="varname">WRKSRC</code>. In each of these directories, the
    configure script is run with the environment
    <code class="varname">CONFIGURE_ENV</code> and arguments
    <code class="varname">CONFIGURE_ARGS</code>. The variables
    <code class="varname">CONFIGURE_ENV</code>,
    <code class="varname">CONFIGURE_SCRIPT</code> (default:
    <span class="quote">&#8220;<span class="quote">./configure</span>&#8221;</span>) and
    <code class="varname">CONFIGURE_ARGS</code> may all be changed by the
    package.</p>
<p>If the program uses an <code class="filename">Imakefile</code>
    for configuration, the appropriate steps can be invoked by
    setting <code class="varname">USE_IMAKE</code> to
    <span class="quote">&#8220;<span class="quote">yes</span>&#8221;</span>. (If you only want the package installed in
    <code class="varname">${X11PREFIX}</code> but xmkmf not being run, set
    <code class="varname">USE_X11BASE</code> instead.)  You can add variables to
    xmkmf's environment by adding them to the
    <code class="varname">SCRIPTS_ENV</code> variable.</p>
<p>If the program uses <code class="filename">cmake</code>
    for configuration, the appropriate steps can be invoked by
    setting <code class="varname">USE_CMAKE</code> to <span class="quote">&#8220;<span class="quote">yes</span>&#8221;</span>.
    You can add variables to cmake's environment by adding them to the
    <code class="varname">CONFIGURE_ENV</code> variable and arguments to cmake
    by adding them to the <code class="varname">CMAKE_ARGS</code> variable.
    The top directory argument is given by the
    <code class="varname">CMAKE_ARG_PATH</code> variable, that defaults to
    <span class="quote">&#8220;<span class="quote">.</span>&#8221;</span> (relative to <code class="varname">CONFIGURE_DIRS</code>)</p>
<p>If there is no configure step at all, set
    <code class="varname">NO_CONFIGURE</code> to <span class="quote">&#8220;<span class="quote">yes</span>&#8221;</span>.</p>
</div>
<div class="sect1" title="17.12. The build phase">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="build.build"></a>17.12. The <span class="emphasis"><em>build</em></span> phase</h2></div></div></div>
<p>For building a package, a rough equivalent of the
    following code is executed.</p>
<pre class="programlisting">
.for d in ${BUILD_DIRS}
        cd ${WRKSRC} \
        &amp;&amp; cd ${d} \
        &amp;&amp; env ${MAKE_ENV} \
            ${MAKE_PROGRAM} ${BUILD_MAKE_FLAGS} \
                -f ${MAKE_FILE} \
                ${BUILD_TARGET}
.endfor
</pre>
<p><code class="varname">BUILD_DIRS</code> (default:
    <span class="quote">&#8220;<span class="quote">.</span>&#8221;</span>) is a list of pathnames relative to
    <code class="varname">WRKSRC</code>. In each of these directories,
    <code class="varname">MAKE_PROGRAM</code> is run with the environment
    <code class="varname">MAKE_ENV</code> and arguments
    <code class="varname">BUILD_MAKE_FLAGS</code>. The variables
    <code class="varname">MAKE_ENV</code>,
    <code class="varname">BUILD_MAKE_FLAGS</code>,
    <code class="varname">MAKE_FILE</code> and
    <code class="varname">BUILD_TARGET</code> may all be changed by the
    package.</p>
<p>The default value of <code class="varname">MAKE_PROGRAM</code> is
    <span class="quote">&#8220;<span class="quote">gmake</span>&#8221;</span> if <code class="varname">USE_TOOLS</code> contains
    <span class="quote">&#8220;<span class="quote">gmake</span>&#8221;</span>, <span class="quote">&#8220;<span class="quote">make</span>&#8221;</span> otherwise. The
    default value of <code class="varname">MAKE_FILE</code> is
    <span class="quote">&#8220;<span class="quote">Makefile</span>&#8221;</span>, and <code class="varname">BUILD_TARGET</code>
    defaults to <span class="quote">&#8220;<span class="quote">all</span>&#8221;</span>.</p>
<p>If there is no build step at all, set
    <code class="varname">NO_BUILD</code> to <span class="quote">&#8220;<span class="quote">yes</span>&#8221;</span>.</p>
</div>
<div class="sect1" title="17.13. The test phase">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="build.test"></a>17.13. The <span class="emphasis"><em>test</em></span> phase</h2></div></div></div>
<p>[TODO]</p>
</div>
<div class="sect1" title="17.14. The install phase">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="build.install"></a>17.14. The <span class="emphasis"><em>install</em></span> phase</h2></div></div></div>
<p>Once the build stage has completed, the final step is to
    install the software in public directories, so users can
    access the programs and files.</p>
<p>In the <span class="emphasis"><em>install</em></span> phase, a rough
    equivalent of the following code is executed. Additionally,
    before and after this code, much magic is performed to do
    consistency checks, registering the package, and so on.</p>
<pre class="programlisting">
.for d in ${INSTALL_DIRS}
        cd ${WRKSRC} \
        &amp;&amp; cd ${d} \
        &amp;&amp; env ${MAKE_ENV} \
            ${MAKE_PROGRAM} ${INSTALL_MAKE_FLAGS} \
                -f ${MAKE_FILE} \
                ${INSTALL_TARGET}
.endfor
</pre>
<p>The variable's meanings are analogous to the ones in the
    <span class="emphasis"><em>build</em></span> phase.
    <code class="varname">INSTALL_DIRS</code> defaults to
    <code class="varname">BUILD_DIRS</code>. <code class="varname">INSTALL_TARGET</code>
    is <span class="quote">&#8220;<span class="quote">install</span>&#8221;</span> by default, plus
    <span class="quote">&#8220;<span class="quote">install.man</span>&#8221;</span> if <code class="varname">USE_IMAKE</code> is
    defined and <code class="varname">NO_INSTALL_MANPAGES</code> is not
    defined.</p>
<p>In the <span class="emphasis"><em>install</em></span> phase, the following
    variables are useful. They are all variations of the
    <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?install+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">install</span>(1)</span></a> command that have the owner, group and
    permissions preset. <code class="varname">INSTALL</code> is the plain
    install command. The specialized variants, together with their
    intended use, are:</p>
<div class="variablelist"><dl>
<dt><span class="term"><code class="varname">INSTALL_PROGRAM_DIR</code></span></dt>
<dd><p>directories that contain
      binaries</p></dd>
<dt><span class="term"><code class="varname">INSTALL_SCRIPT_DIR</code></span></dt>
<dd><p>directories that contain
      scripts</p></dd>
<dt><span class="term"><code class="varname">INSTALL_LIB_DIR</code></span></dt>
<dd><p>directories that contain shared and static
      libraries</p></dd>
<dt><span class="term"><code class="varname">INSTALL_DATA_DIR</code></span></dt>
<dd><p>directories that contain data
      files</p></dd>
<dt><span class="term"><code class="varname">INSTALL_MAN_DIR</code></span></dt>
<dd><p>directories that contain man
      pages</p></dd>
<dt><span class="term"><code class="varname">INSTALL_PROGRAM</code></span></dt>
<dd><p>binaries that can be stripped from debugging
      symbols</p></dd>
<dt><span class="term"><code class="varname">INSTALL_SCRIPT</code></span></dt>
<dd><p>binaries that cannot be
      stripped</p></dd>
<dt><span class="term"><code class="varname">INSTALL_GAME</code></span></dt>
<dd><p>game
      binaries</p></dd>
<dt><span class="term"><code class="varname">INSTALL_LIB</code></span></dt>
<dd><p>shared and static
      libraries</p></dd>
<dt><span class="term"><code class="varname">INSTALL_DATA</code></span></dt>
<dd><p>data files</p></dd>
<dt><span class="term"><code class="varname">INSTALL_GAME_DATA</code></span></dt>
<dd><p>data files for
      games</p></dd>
<dt><span class="term"><code class="varname">INSTALL_MAN</code></span></dt>
<dd><p>man pages</p></dd>
</dl></div>
<p>Some other variables are:</p>
<div class="variablelist"><dl>
<dt><span class="term"><code class="varname">INSTALLATION_DIRS</code></span></dt>
<dd><p>A list of directories relative to
      <code class="varname">PREFIX</code> that are created by pkgsrc at the
      beginning of the <span class="emphasis"><em>install</em></span> phase.
      The package is supposed to create all needed directories itself
      before installing files to it and list all other directories here.
      </p></dd>
</dl></div>
<p>In the rare cases that a package shouldn't install anything,
    set <code class="varname">NO_INSTALL</code> to <span class="quote">&#8220;<span class="quote">yes</span>&#8221;</span>. This is
    mostly relevant for packages in the <code class="filename">regress</code>
    category.</p>
</div>
<div class="sect1" title="17.15. The package phase">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="build.package"></a>17.15. The <span class="emphasis"><em>package</em></span> phase</h2></div></div></div>
<p>Once the install stage has completed, a binary package of
    the installed files can be built.  These binary packages can be
    used for quick installation without previous compilation, e.g. by
    the <span class="command"><strong>make bin-install</strong></span> or by using
    <span class="command"><strong>pkg_add</strong></span>.</p>
<p>By default, the binary packages are created in
    <code class="filename">${PACKAGES}/All</code> and symlinks are created in
    <code class="filename">${PACKAGES}/<em class="replaceable"><code>category</code></em></code>,
    one for each category in the <code class="varname">CATEGORIES</code>
    variable.  <code class="varname">PACKAGES</code> defaults to
    <code class="filename">pkgsrc/packages</code>.</p>
</div>
<div class="sect1" title="17.16. Cleaning up">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="build.clean"></a>17.16. Cleaning up</h2></div></div></div>
<p>Once you're finished with a package, you can clean the work
    directory by running <span class="command"><strong>make clean</strong></span>.  If you want
    to clean the work directories of all dependencies too, use
    <span class="command"><strong>make clean-depends</strong></span>.</p>
</div>
<div class="sect1" title="17.17. Other helpful targets">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="build.helpful-targets"></a>17.17. Other helpful targets</h2></div></div></div>
<div class="variablelist"><dl>
<dt><span class="term">pre/post-*</span></dt>
<dd><p>For any of the main targets described in the
	  previous section, two auxiliary targets exist with
	  <span class="quote">&#8220;<span class="quote">pre-</span>&#8221;</span> and <span class="quote">&#8220;<span class="quote">post-</span>&#8221;</span> used as a
	  prefix for the main target's name.  These targets are
	  invoked before and after the main target is called,
	  allowing extra configuration or installation steps be
	  performed from a package's Makefile, for example, which
	  a program's configure script or install target
	  omitted.</p></dd>
<dt><span class="term">do-*</span></dt>
<dd><p>Should one of the main targets do the wrong thing,
	  and should there be no variable to fix this, you can
	  redefine it with the do-* target.  (Note that redefining
	  the target itself instead of the do-* target is a bad
	  idea, as the pre-* and post-* targets won't be called
	  anymore, etc.) You will not usually need to do
	  this.</p></dd>
<dt><span class="term">reinstall</span></dt>
<dd>
<p>If you did a <span class="command"><strong>make install</strong></span> and
	  you noticed some file was not installed properly, you
	  can repeat the installation with this target, which will
	  ignore the <span class="quote">&#8220;<span class="quote">already installed</span>&#8221;</span> flag.</p>
<p>This is the default value of
	  <code class="varname">DEPENDS_TARGET</code> except in the case of
	  <span class="command"><strong>make update</strong></span> and <span class="command"><strong>make
	  package</strong></span>, where the defaults are
	  <span class="quote">&#8220;<span class="quote">package</span>&#8221;</span> and <span class="quote">&#8220;<span class="quote">update</span>&#8221;</span>,
	  respectively.</p>
</dd>
<dt><span class="term">deinstall</span></dt>
<dd>
<p>This target does a <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?pkg_delete+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">pkg_delete</span>(1)</span></a> in the
	  current directory, effectively de-installing the
	  package. The following variables can be used to tune the
	  behaviour:</p>
<div class="variablelist"><dl>
<dt><span class="term"><code class="varname">PKG_VERBOSE</code></span></dt>
<dd><p>Add a "-v" to the <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?pkg_delete+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">pkg_delete</span>(1)</span></a> command.</p></dd>
<dt><span class="term"><code class="varname">DEINSTALLDEPENDS</code></span></dt>
<dd><p>Remove all packages that require (depend on)
		the given package.  This can be used to remove any
		packages that may have been pulled in by a given
		package, e.g. if <span class="command"><strong>make deinstall
		DEINSTALLDEPENDS=1</strong></span> is done in
		<code class="filename">pkgsrc/x11/kde</code>, this is
		likely to remove whole KDE. Works by adding
		<span class="quote">&#8220;<span class="quote">-R</span>&#8221;</span> to the <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?pkg_delete+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">pkg_delete</span>(1)</span></a>
		command line.</p></dd>
</dl></div>
</dd>
<dt><span class="term">bin-install</span></dt>
<dd><p>Install a binary package from local disk and via FTP
	  from a list of sites (see the
	  <code class="varname">BINPKG_SITES</code> variable), and do a
	  <span class="command"><strong>make package</strong></span> if no binary package is
	  available anywhere.  The arguments given to
	  <span class="command"><strong>pkg_add</strong></span> can be set via
	  <code class="varname">BIN_INSTALL_FLAGS</code> e.g., to do verbose
	  operation, etc.</p></dd>
<dt><span class="term">update</span></dt>
<dd>
<p>This target causes the current package to be
	  updated to the latest version.  The package and all
	  depending packages first get de-installed, then current
	  versions of the corresponding packages get compiled and
	  installed.  This is similar to manually noting which
	  packages are currently installed, then performing a
	  series of <span class="command"><strong>make deinstall</strong></span> and
	  <span class="command"><strong>make install</strong></span> (or whatever
	  <code class="varname">UPDATE_TARGET</code> is set to) for these
	  packages.</p>
<p>You can use the <span class="quote">&#8220;<span class="quote">update</span>&#8221;</span> target to
	  resume package updating in case a previous <span class="command"><strong>make
	  update</strong></span> was interrupted for some reason.
	  However, in this case, make sure you don't call
	  <span class="command"><strong>make clean</strong></span> or otherwise remove the
	  list of dependent packages in <code class="varname">WRKDIR</code>.
	  Otherwise, you lose the ability to automatically update
	  the current package along with the dependent packages
	  you have installed.</p>
<p>Resuming an interrupted <span class="command"><strong>make
	  update</strong></span> will only work as long as the package
	  tree remains unchanged.  If the source code for one of
	  the packages to be updated has been changed, resuming
	  <span class="command"><strong>make update</strong></span> will most certainly
	  fail!</p>
<p>The following variables can be used either on the
	  command line or in <a class="link" href="configuring.html#mk.conf"><code class="filename">mk.conf</code></a> to
	  alter the behaviour of <span class="command"><strong>make
	  update</strong></span>:</p>
<div class="variablelist"><dl>
<dt><span class="term"><code class="varname">UPDATE_TARGET</code></span></dt>
<dd><p>Install target to recursively use for the
		updated package and the dependent packages.
		Defaults to <code class="varname">DEPENDS_TARGET</code> if
		set, <span class="quote">&#8220;<span class="quote">install</span>&#8221;</span> otherwise for
		<span class="command"><strong>make update</strong></span>.  Other good
		targets are <span class="quote">&#8220;<span class="quote">package</span>&#8221;</span> or
		<span class="quote">&#8220;<span class="quote">bin-install</span>&#8221;</span>.  Do not set this to
		<span class="quote">&#8220;<span class="quote">update</span>&#8221;</span> or you will get stuck in an
		endless loop!</p></dd>
<dt><span class="term"><code class="varname">NOCLEAN</code></span></dt>
<dd><p>Don't clean up after updating.  Useful if
		you want to leave the work sources of the updated
		packages around for inspection or other purposes.
		Be sure you eventually clean up the source tree
		(see the <span class="quote">&#8220;<span class="quote">clean-update</span>&#8221;</span> target below)
		or you may run into troubles with old source code
		still lying around on your next
		<span class="command"><strong>make</strong></span> or <span class="command"><strong>make
		update</strong></span>.</p></dd>
<dt><span class="term"><code class="varname">REINSTALL</code></span></dt>
<dd><p>Deinstall each package before installing
		(making <code class="varname">DEPENDS_TARGET</code>). This
		may be necessary if the
		<span class="quote">&#8220;<span class="quote">clean-update</span>&#8221;</span> target (see below) was
		called after interrupting a running <span class="command"><strong>make
		update</strong></span>.</p></dd>
<dt><span class="term"><code class="varname">DEPENDS_TARGET</code></span></dt>
<dd><p>Allows you to disable recursion and hardcode
		the target for packages.  The default is
		<span class="quote">&#8220;<span class="quote">update</span>&#8221;</span> for the update target,
		facilitating a recursive update of prerequisite
		packages.  Only set
		<code class="varname">DEPENDS_TARGET</code> if you want to
		disable recursive updates. Use
		<code class="varname">UPDATE_TARGET</code> instead to just
		set a specific target for each package to be
		installed during <span class="command"><strong>make update</strong></span>
		(see above).</p></dd>
</dl></div>
</dd>
<dt><span class="term">clean-update</span></dt>
<dd>
<p>Clean the source tree for all packages that would
	  get updated if <span class="command"><strong>make update</strong></span> was called
	  from the current directory.  This target should not be
	  used if the current package (or any of its depending
	  packages) have already been de-installed (e.g., after
	  calling <span class="command"><strong>make update</strong></span>) or you may lose
	  some packages you intended to update. As a rule of
	  thumb: only use this target <span class="emphasis"><em>before</em></span>
	  the first time you run <span class="command"><strong>make update</strong></span>
	  and only if you have a dirty package tree (e.g., if you
	  used <code class="varname">NOCLEAN</code>).</p>
<p>If you are unsure about whether your tree is
	  clean, you can either perform a <span class="command"><strong>make
	  clean</strong></span> at the top of the tree, or use the
	  following sequence of commands from the directory of the
	  package you want to update (<span class="emphasis"><em>before</em></span>
	  running <span class="command"><strong>make update</strong></span> for the first
	  time, otherwise you lose all the packages you wanted to
	  update!):</p>
<pre class="screen">
<code class="prompt">#</code> <strong class="userinput"><code>make clean-update</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make clean CLEANDEPENDS=YES</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make update</code></strong>
	  </pre>
<p>The following variables can be used either on the
	  command line or in <a class="link" href="configuring.html#mk.conf"><code class="filename">mk.conf</code></a> to alter the behaviour of
	  <span class="command"><strong>make clean-update</strong></span>:</p>
<div class="variablelist"><dl>
<dt><span class="term"><code class="varname">CLEAR_DIRLIST</code></span></dt>
<dd><p>After <span class="command"><strong>make clean</strong></span>, do not
		reconstruct the list of directories to update for
		this package.  Only use this if <span class="command"><strong>make
		update</strong></span> successfully installed all
		packages you wanted to update.  Normally, this is
		done automatically on <span class="command"><strong>make
		update</strong></span>, but may have been suppressed by
		the <code class="varname">NOCLEAN</code> variable (see
		above).</p></dd>
</dl></div>
</dd>
<dt><span class="term">replace</span></dt>
<dd>
<p>Update the installation of the current package.  This
	  differs from update in that it does not replace dependent
	  packages.  You will need to install <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/pkgtools/pkg_tarup/README.html" target="_top"><code class="filename">pkgtools/pkg_tarup</code></a> for this
	  target to work.</p>
<p><span class="emphasis"><em>Be careful when using this
	  target!</em></span> There are no guarantees that dependent
	  packages will still work, in particular they will most
	  certainly break if you <span class="command"><strong>make replace</strong></span> a
	  library package whose shared library major version changed
	  between your installed version and the new one.  For this
	  reason, this target is not officially supported and only
	  recommended for advanced users.</p>
</dd>
<dt><span class="term">info</span></dt>
<dd><p>This target invokes <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?pkg_info+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">pkg_info</span>(1)</span></a> for the current
	  package. You can use this to check which version of a
	  package is installed.</p></dd>
<dt><span class="term">index</span></dt>
<dd>
<p>This is a top-level command, i.e. it should be used in
	  the <code class="filename">pkgsrc</code> directory.  It creates a
	  database of all packages in the local pkgsrc tree, including
	  dependencies, comment, maintainer, and some other useful
	  information.  Individual entries are created by running
	  <span class="command"><strong>make describe</strong></span> in the packages'
	  directories.  This index file is saved as
	  <code class="filename">pkgsrc/INDEX</code>.  It can be displayed in
	  verbose format by running <span class="command"><strong>make
	  print-index</strong></span>.  You can search in it with
	  <span class="command"><strong>make search
	  key=<em class="replaceable"><code>something</code></em></strong></span>.  You can
	  extract a list of all packages that depend on a particular
	  one by running <span class="command"><strong>make show-deps
	  PKG=<em class="replaceable"><code>somepackage</code></em></strong></span>.</p>
<p>Running this command takes a very long time, some
	  hours even on fast machines!</p>
</dd>
<dt><span class="term">readme</span></dt>
<dd>
<p>This target generates a
	  <code class="filename">README.html</code> file, which can be
	  viewed using a browser such as <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/www/firefox/README.html" target="_top"><code class="filename">www/firefox</code></a> or <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/www/links/README.html" target="_top"><code class="filename">www/links</code></a>.  The generated files
	  contain references to any packages which are in the
	  <code class="varname">PACKAGES</code> directory on the local
	  host. The generated files can be made to refer to URLs
	  based on <code class="varname">FTP_PKG_URL_HOST</code> and
	  <code class="varname">FTP_PKG_URL_DIR</code>. For example, if I
	  wanted to generate <code class="filename">README.html</code>
	  files which pointed to binary packages on the local
	  machine, in the directory
	  <code class="filename">/usr/packages</code>, set
	  <code class="varname">FTP_PKG_URL_HOST=file://localhost</code> and
	  <code class="varname">FTP_PKG_URL_DIR=/usr/packages</code>. The
	  <code class="varname">${PACKAGES}</code> directory and its
	  subdirectories will be searched for all the binary
	  packages.</p>
<p>The target can be run at the toplevel or in category
	  directories, in which case it descends recursively.</p>
</dd>
<dt><span class="term">readme-all</span></dt>
<dd><p>This is a top-level command, run it in
	  <code class="filename">pkgsrc</code>.  Use this target to create a
	  file <code class="filename">README-all.html</code> which contains a
	  list of all packages currently available in the NetBSD
	  Packages Collection, together with the category they belong
	  to and a short description. This file is compiled from the
	  <code class="filename">pkgsrc/*/README.html</code> files, so be sure
	  to run this <span class="emphasis"><em>after</em></span> a <span class="command"><strong>make
	  readme</strong></span>.</p></dd>
<dt><span class="term">cdrom-readme</span></dt>
<dd><p>This is very much the same as the
	  <span class="quote">&#8220;<span class="quote">readme</span>&#8221;</span> target (see above), but is to be
	  used when generating a pkgsrc tree to be written to a
	  CD-ROM.  This target also produces
	  <code class="filename">README.html</code> files, and can be made
	  to refer to URLs based on
	  <code class="varname">CDROM_PKG_URL_HOST</code> and
	  <code class="varname">CDROM_PKG_URL_DIR</code>.</p></dd>
<dt><span class="term">show-distfiles</span></dt>
<dd><p>This target shows which distfiles and patchfiles
	  are needed to build the package
	  (<code class="varname">ALLFILES</code>, which contains all
	  <code class="varname">DISTFILES</code> and
	  <code class="varname">PATCHFILES</code>, but not
	  <code class="filename">patches/*</code>).</p></dd>
<dt><span class="term">show-downlevel</span></dt>
<dd><p>This target shows nothing if the package is not
	  installed. If a version of this package is installed,
	  but is not the version provided in this version of
	  pkgsrc, then a warning message is displayed. This target
	  can be used to show which of your installed packages are
	  downlevel, and so the old versions can be deleted, and
	  the current ones added.</p></dd>
<dt><span class="term">show-pkgsrc-dir</span></dt>
<dd><p>This target shows the directory in the pkgsrc
	  hierarchy from which the package can be built and
	  installed. This may not be the same directory as the one
	  from which the package was installed. This target is
	  intended to be used by people who may wish to upgrade
	  many packages on a single host, and can be invoked from
	  the top-level pkgsrc Makefile by using the
	  <span class="quote">&#8220;<span class="quote">show-host-specific-pkgs</span>&#8221;</span> target.</p></dd>
<dt><span class="term">show-installed-depends</span></dt>
<dd><p>This target shows which installed packages match
	  the current package's <code class="varname">DEPENDS</code>. Useful
	  if out of date dependencies are causing build
	  problems.</p></dd>
<dt><span class="term">check-shlibs</span></dt>
<dd><p>After a package is installed, check all its
	  binaries and (on ELF platforms) shared libraries to see
	  if they find the shared libs they need.  Run by default
	  if <code class="varname">PKG_DEVELOPER</code> is set in <a class="link" href="configuring.html#mk.conf"><code class="filename">mk.conf</code></a>.</p></dd>
<dt><span class="term">print-PLIST</span></dt>
<dd>
<p>After a <span class="quote">&#8220;<span class="quote">make install</span>&#8221;</span> from a new or
	  upgraded pkg, this prints out an attempt to generate a
	  new <code class="filename">PLIST</code> from a <span class="command"><strong>find
	  -newer work/.extract_done</strong></span>.  An attempt is made
	  to care for shared libs etc., but it is
	  <span class="emphasis"><em>strongly</em></span> recommended to review the
	  result before putting it into
	  <code class="filename">PLIST</code>. On upgrades, it's useful to
	  diff the output of this command against an already
	  existing <code class="filename">PLIST</code> file.</p>
<p>If the package installs files via <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?tar+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">tar</span>(1)</span></a> or
	  other methods that don't update file access times, be
	  sure to add these files manually to your
	  <code class="filename">PLIST</code>, as the <span class="quote">&#8220;<span class="quote">find
	  -newer</span>&#8221;</span> command used by this target won't catch
	  them!</p>
<p>See <a class="xref" href="plist.html#print-PLIST" title="13.3. Tweaking output of make print-PLIST">Section 13.3, &#8220;Tweaking output of <span class="command"><strong>make print-PLIST</strong></span>&#8221;</a> for more
	  information on this target.</p>
</dd>
<dt><span class="term">bulk-package</span></dt>
<dd>
<p>Used to do bulk builds. If an appropriate binary
	  package already exists, no action is taken. If not, this
	  target will compile, install and package it (and its
	  depends, if <code class="varname">PKG_DEPENDS</code> is set
	  properly. See <a class="xref" href="bulk.html#binary.configuration" title="7.3.1. Configuration">Section 7.3.1, &#8220;Configuration&#8221;</a>).
	  After creating the binary package, the sources, the
	  just-installed package and its required packages are
	  removed, preserving free disk space.</p>
<p><span class="emphasis"><em>Beware that this target may deinstall
	  all packages installed on a system!</em></span></p>
</dd>
<dt><span class="term">bulk-install</span></dt>
<dd>
<p>Used during bulk-installs to install required
	  packages. If an up-to-date binary package is available,
	  it will be installed via <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?pkg_add+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">pkg_add</span>(1)</span></a>. If not,
	  <span class="command"><strong>make bulk-package</strong></span> will be executed,
	  but the installed binary won't be removed.</p>
<p>A binary package is considered
	  <span class="quote">&#8220;<span class="quote">up-to-date</span>&#8221;</span> to be installed via
	  <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?pkg_add+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">pkg_add</span>(1)</span></a> if:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>None of the package's files
	      (<code class="filename">Makefile</code>, ...) were modified
	      since it was built.</p></li>
<li class="listitem"><p>None of the package's required (binary)
	      packages were modified since it was built.</p></li>
</ul></div>
<p><span class="emphasis"><em>Beware that this target may deinstall
	  all packages installed on a system!</em></span></p>
</dd>
</dl></div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="options.html">Prev</a> </td>
<td width="20%" align="center"><a accesskey="u" href="developers-guide.html">Up</a></td>
<td width="40%" align="right"> <a accesskey="n" href="tools.html">Next</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">Chapter 16. Options handling </td>
<td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td>
<td width="40%" align="right" valign="top"> Chapter 18. Tools needed for building or running</td>
</tr>
</table>
</div>
</body>
</html>
