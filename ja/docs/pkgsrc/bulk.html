<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Chapter 7. Creating binary packages for everything in pkgsrc (bulk builds)</title>
<link rel="stylesheet" type="text/css" href="/global.css">
<meta name="generator" content="DocBook XSL Stylesheets VX.X.X">
<link rel="home" href="index.html" title="The pkgsrc guide">
<link rel="up" href="users-guide.html" title="Part I. The pkgsrc user's guide">
<link rel="prev" href="binary.html" title="Chapter 6. Creating binary packages">
<link rel="next" href="files.html" title="Chapter 8. Directory layout of the installed files">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">Chapter 7. Creating binary packages for everything in pkgsrc (bulk
builds)</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="binary.html">Prev</a> </td>
<th width="60%" align="center">Part I. The pkgsrc user's guide</th>
<td width="20%" align="right"> <a accesskey="n" href="files.html">Next</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="chapter" title="Chapter 7. Creating binary packages for everything in pkgsrc (bulk builds)">
<div class="titlepage"><div><div><h2 class="title">
<a name="bulk"></a>Chapter 7. Creating binary packages for everything in pkgsrc (bulk
builds)</h2></div></div></div>
<div class="toc">
<p><b>Table of Contents</b></p>
<dl>
<dt><span class="sect1"><a href="bulk.html#bulk.pre">7.1. Think first, build later</a></span></dt>
<dt><span class="sect1"><a href="bulk.html#bulk.req">7.2. Requirements of a bulk build</a></span></dt>
<dt><span class="sect1"><a href="bulk.html#bulk.old">7.3. Running an old-style bulk build</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="bulk.html#binary.configuration">7.3.1. Configuration</a></span></dt>
<dt><span class="sect2"><a href="bulk.html#other-environmental-considerations">7.3.2. Other environmental considerations</a></span></dt>
<dt><span class="sect2"><a href="bulk.html#operation">7.3.3. Operation</a></span></dt>
<dt><span class="sect2"><a href="bulk.html#what-it-does">7.3.4. What it does</a></span></dt>
<dt><span class="sect2"><a href="bulk.html#disk-space-requirements">7.3.5. Disk space requirements</a></span></dt>
<dt><span class="sect2"><a href="bulk.html#setting-up-a-sandbox">7.3.6. Setting up a sandbox for chrooted builds</a></span></dt>
<dt><span class="sect2"><a href="bulk.html#building-a-partial-set">7.3.7. Building a partial set of packages</a></span></dt>
<dt><span class="sect2"><a href="bulk.html#bulk-upload">7.3.8. Uploading results of a bulk build</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="bulk.html#bulk.pbulk">7.4. Running a pbulk-style bulk build</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="bulk.html#bulk.pbulk.prepare">7.4.1. Preparation</a></span></dt>
<dt><span class="sect2"><a href="bulk.html#bulk.pbulk.conf">7.4.2. Configuration</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="bulk.html#creating-cdroms">7.5. Creating a multiple CD-ROM packages collection</a></span></dt>
<dd><dl><dt><span class="sect2"><a href="bulk.html#cdpack-example">7.5.1. Example of cdpack</a></span></dt></dl></dd>
</dl>
</div>
<p>When you have multiple machines that should run the same packages,
it is wasted time if they all build their packages themselves from
source. There are two ways of getting a set of binary packages: The old
bulk build system, or the new (as of 2007) parallel bulk build (pbulk)
system. This chapter describes how to set them up so that the packages
are most likely to be usable later.</p>
<div class="sect1" title="7.1. Think first, build later">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="bulk.pre"></a>7.1. Think first, build later</h2></div></div></div>
<p>Since a bulk build takes several days or even weeks to finish, you
should think about the setup before you start everything. Pay attention
to at least the following points:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem">
<p>If you want to upload the binary packages to
ftp.NetBSD.org, make sure the setup complies to the requirements for binary
packages:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="circle">
<li class="listitem"><p>To end up on ftp.NetBSD.org, the packages must be built
by a NetBSD developer on a trusted machine (that is, where you and only
you have root access).</p></li>
<li class="listitem"><p>Packages on ftp.NetBSD.org should only be created from
the stable branches (like 2009Q1), so that users browsing the available
collections can see at a glance how old the packages
are.</p></li>
<li class="listitem"><p>The packages must be built as root, since some packages
require set-uid binaries at runtime, and creating those packages as
unprivileged user doesn't work well at the moment.</p></li>
</ul></div>
</li>
<li class="listitem"><p>Make sure that the bulk build cannot break anything in
your system. Most bulk builds run as root, so they should be run at least
in a chroot environment or something even more restrictive, depending on
what the operating system provides. There have been numerous cases where
certain packages tried to install files outside the
<code class="filename">LOCALBASE</code> or wanted to edit some files in
<code class="filename">/etc</code>. Furthermore, the bulk builds install and
deinstall packages in <code class="filename">/usr/pkg</code> (or whatever
<code class="filename">LOCALBASE</code> is) during their operation, so be sure
that you don't need any package during the build.</p></li>
</ul></div>
</div>
<div class="sect1" title="7.2. Requirements of a bulk build">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="bulk.req"></a>7.2. Requirements of a bulk build</h2></div></div></div>
<p>A complete bulk build requires lots of disk space. Some of the
disk space can be read-only, some other must be writable. Some can be on
remote filesystems (such as NFS) and some should be local. Some can be
temporary filesystems, others must survive a sudden reboot.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>10 GB for the distfiles (read-write, remote, temporary)</p></li>
<li class="listitem"><p>10 GB for the binary packages (read-write, remote, permanent)</p></li>
<li class="listitem"><p>400 MB for the pkgsrc tree (read-only, remote, permanent)</p></li>
<li class="listitem"><p>5 GB for <code class="filename">LOCALBASE</code> (read-write, local, temporary for pbulk, permanent for old-bulk)</p></li>
<li class="listitem"><p>5 GB for the log files (read-write, remote, permanent)</p></li>
<li class="listitem"><p>5 GB for temporary files (read-write, local, temporary)</p></li>
</ul></div>
</div>
<div class="sect1" title="7.3. Running an old-style bulk build">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="bulk.old"></a>7.3. Running an old-style bulk build</h2></div></div></div>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;">
<h3 class="title">Note</h3>
<p>There are two ways of doing a bulk build. The old-style
one and the new-style <span class="quote">&#8220;<span class="quote">pbulk</span>&#8221;</span>. The latter is the recommended
way.</p>
</div>
<div class="sect2" title="7.3.1. Configuration">
<div class="titlepage"><div><div><h3 class="title">
<a name="binary.configuration"></a>7.3.1. Configuration</h3></div></div></div>
<div class="sect3" title="7.3.1.1. build.conf">
<div class="titlepage"><div><div><h4 class="title">
<a name="binary.bulk.build.conf"></a>7.3.1.1. <code class="filename">build.conf</code>
</h4></div></div></div>
<p>The <code class="filename">build.conf</code> file is the main
	configuration file for bulk builds. You can configure how your
	copy of pkgsrc is kept up to date, how the distfiles are
	downloaded, how the packages are built and how the report is
	generated. You can find an annotated example file in
	<code class="filename">pkgsrc/mk/bulk/build.conf-example</code>. To use
	it, copy <code class="filename">build.conf-example</code> to
	<code class="filename">build.conf</code> and edit it, following the
	comments in that file.</p>
</div>
<div class="sect3" title="7.3.1.2. mk.conf">
<div class="titlepage"><div><div><h4 class="title">
<a name="binary.mk.conf"></a>7.3.1.2. <a class="link" href="configuring.html#mk.conf"><code class="filename">mk.conf</code></a>
</h4></div></div></div>
<p>You may want to set variables in <a class="link" href="configuring.html#mk.conf"><code class="filename">mk.conf</code></a>.
	Look at <code class="filename">pkgsrc/mk/defaults/mk.conf</code> for
	details of the default settings. You will want to ensure that
	<code class="varname">ACCEPTABLE_LICENSES</code> meet your local policy.
	As used in this example, <code class="varname">SKIP_LICENSE_CHECK=yes</code>
	completely bypasses the license check.</p>
<pre class="programlisting">
PACKAGES?=      ${_PKGSRCDIR}/packages/${MACHINE_ARCH}
WRKOBJDIR?=     /usr/tmp/pkgsrc   # build here instead of in pkgsrc
BSDSRCDIR=      /usr/src
BSDXSRCDIR=     /usr/xsrc         # for x11/xservers
OBJHOSTNAME?=   yes               # use work.`hostname`
FAILOVER_FETCH= yes               # insist on the correct checksum
PKG_DEVELOPER?= yes
SKIP_LICENSE_CHECK=    yes
</pre>
<p>Some options that are especially useful for bulk builds
	can be found at the top lines of the file
	<code class="filename">mk/bulk/bsd.bulk-pkg.mk</code>. The most useful
	options of these are briefly described here.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>If you are on a slow machine, you may want to
	  set <code class="varname">USE_BULK_BROKEN_CHECK</code> to
	  <span class="quote">&#8220;<span class="quote">no</span>&#8221;</span>.</p></li>
<li class="listitem"><p>If you are doing bulk builds from a read-only
	  copy of pkgsrc, you have to set <code class="varname">BULKFILESDIR</code>
	  to the directory where all log files are created. Otherwise the
	  log files are created in the pkgsrc directory.</p></li>
<li class="listitem"><p>Another important variable is
	  <code class="varname">BULK_PREREQ</code>, which is a list of packages that
	  should be always available while building other
	  packages.</p></li>
</ul></div>
<p>Some other options are scattered in the pkgsrc
	infrastructure:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p><code class="varname">ALLOW_VULNERABLE_PACKAGES</code>
	  should be set to <code class="literal">yes</code>. The purpose of the
	  bulk builds is creating binary packages, no matter if they
	  are vulnerable or not. Leaving this variable unset would
	  prevent the bulk build system from even trying to build
	  them, so possible building errors would not show
	  up.</p></li>
<li class="listitem"><p><code class="varname">CHECK_FILES</code>
	  (<code class="filename">pkgsrc/mk/check/check-files.mk</code>) can be set to
	  <span class="quote">&#8220;<span class="quote">yes</span>&#8221;</span> to check that the installed set of files
	  matches the <code class="filename">PLIST</code>.</p></li>
<li class="listitem"><p><code class="varname">CHECK_INTERPRETER</code>
	  (<code class="filename">pkgsrc/mk/check/check-interpreter.mk</code>) can be set to
	  <span class="quote">&#8220;<span class="quote">yes</span>&#8221;</span> to check that the installed
	  <span class="quote">&#8220;<span class="quote">#!</span>&#8221;</span>-scripts will find their
	  interpreter.</p></li>
<li class="listitem"><p><code class="varname">PKGSRC_RUN_TEST</code> can be
	  set to <span class="quote">&#8220;<span class="quote"><code class="literal">yes</code></span>&#8221;</span> to run each
	  package's self-test before installing it. Note that some
	  packages make heavy use of <span class="quote">&#8220;<span class="quote">good</span>&#8221;</span> random
	  numbers, so you need to assure that the machine on which you
	  are doing the bulk builds is not completely idle. Otherwise
	  some test programs will seem to hang, while they are just
	  waiting for new random data to be
	  available.</p></li>
</ul></div>
</div>
<div class="sect3" title="7.3.1.3. pre-build.local">
<div class="titlepage"><div><div><h4 class="title">
<a name="pre-build.local"></a>7.3.1.3. <code class="filename">pre-build.local</code>
</h4></div></div></div>
<p>It is possible to configure the bulk build to perform
	certain site-specific tasks at the end of the pre-build
	stage.  If the file
	<code class="filename">pre-build.local</code> exists in
	<code class="filename">/usr/pkgsrc/mk/bulk</code>, it will be executed
	(as a <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?sh+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a> script) at the end of the usual pre-build
	stage.  An example use of
	<code class="filename">pre-build.local</code> is to have the line:</p>
<pre class="screen">echo "I do not have enough disk space to build this pig." \
	&gt; misc/openoffice/$BROKENF</pre>
<p>to prevent the system from trying to build a particular package
	which requires nearly 3 GB of disk space.</p>
</div>
</div>
<div class="sect2" title="7.3.2. Other environmental considerations">
<div class="titlepage"><div><div><h3 class="title">
<a name="other-environmental-considerations"></a>7.3.2. Other environmental considerations</h3></div></div></div>
<p>As <code class="filename">/usr/pkg</code> will be completely
      deleted at the start of bulk builds, make sure your login
      shell is placed somewhere else. Either drop it into
      <code class="filename">/usr/local/bin</code> (and adjust your login
      shell in the passwd file), or (re-)install it via
      <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?pkg_add+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">pkg_add</span>(1)</span></a> from <code class="filename">/etc/rc.local</code>, so
      you can login after a reboot (remember that your current
      process won't die if the package is removed, you just can't
      start any new instances of the shell any more).  Also, if you
      use NetBSD earlier than 1.5, or you still want to use the pkgsrc
      version of ssh for some reason, be sure to install ssh before
      starting it from <code class="filename">rc.local</code>:</p>
<pre class="programlisting">
(cd /usr/pkgsrc/security/ssh &amp;&amp; make bulk-install)
if [ -f /usr/pkg/etc/rc.d/sshd ]; then
  /usr/pkg/etc/rc.d/sshd
fi
</pre>
<p>Not doing so will result in you being not able to log in
      via ssh after the bulk build is finished or if the machine
      gets rebooted or crashes. You have been warned! :)</p>
</div>
<div class="sect2" title="7.3.3. Operation">
<div class="titlepage"><div><div><h3 class="title">
<a name="operation"></a>7.3.3. Operation</h3></div></div></div>
<p>Make sure you don't need any of the packages still
      installed.</p>
<div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;">
<h3 class="title">Warning</h3>
<p>During the bulk build, <span class="emphasis"><em>all packages, their
	configuration files and some more files from
	<code class="filename">/var</code>, <code class="filename">/home</code> and
	possibly other locations will be removed! So don't run a bulk
	build with privileges that might harm your
	system.</em></span></p>
</div>
<p>Be sure to remove all other things that might
      interfere with builds, like some libs installed in
      <code class="filename">/usr/local</code>, etc. then become root and type:</p>
<pre class="screen">
<code class="prompt">#</code> <strong class="userinput"><code>cd /usr/pkgsrc</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>sh mk/bulk/build</code></strong>
      </pre>
<p>If for some reason your last build didn't complete (power
      failure, system panic, ...), you can continue it by
      running:</p>
<pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>sh mk/bulk/build restart</code></strong></pre>
<p>At the end of the bulk build, you will get a summary via mail,
      and find build logs in the directory specified by
      <code class="varname">FTP</code> in the <code class="filename">build.conf</code>
      file.</p>
</div>
<div class="sect2" title="7.3.4. What it does">
<div class="titlepage"><div><div><h3 class="title">
<a name="what-it-does"></a>7.3.4. What it does</h3></div></div></div>
<p>The bulk builds consist of three steps:</p>
<div class="variablelist"><dl>
<dt><span class="term">1. pre-build</span></dt>
<dd><p>The script updates your pkgsrc tree via (anon)cvs, then
	    cleans out any broken distfiles, and removes all
	    packages installed.</p></dd>
<dt><span class="term">2. the bulk build</span></dt>
<dd><p>This is basically <span class="quote">&#8220;<span class="quote">make bulk-package</span>&#8221;</span> with
	    an optimised order in which packages will be
	    built. Packages that don't require other packages will
	    be built first, and packages with many dependencies will
	    be built later.</p></dd>
<dt><span class="term">3. post-build</span></dt>
<dd><p>Generates a report that's placed in the directory
	    specified in the <code class="filename">build.conf</code> file
	    named <code class="filename">broken.html</code>, a short version
	    of that report will also be mailed to the build's
	    admin.</p></dd>
</dl></div>
<p>During the build, a list of broken packages will be compiled
      in <code class="filename">/usr/pkgsrc/.broken</code> (or
      <code class="filename">.../.broken.${MACHINE}</code> if
      <code class="varname">OBJMACHINE</code> is set), individual build logs
      of broken builds can be found in the package's
      directory. These files are used by the bulk-targets to mark
      broken builds to not waste time trying to rebuild them, and
      they can be used to debug these broken package builds
      later.</p>
</div>
<div class="sect2" title="7.3.5. Disk space requirements">
<div class="titlepage"><div><div><h3 class="title">
<a name="disk-space-requirements"></a>7.3.5. Disk space requirements</h3></div></div></div>
<p>Currently, roughly the following requirements are valid for
      NetBSD 2.0/i386:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>10 GB - distfiles (NFS ok)</p></li>
<li class="listitem"><p>8 GB - full set of all binaries (NFS ok)</p></li>
<li class="listitem"><p>5 GB - temp space for compiling (local disk recommended)</p></li>
</ul></div>
<p>Note that all pkgs will be de-installed as soon as they are
      turned into a binary package, and that sources are removed,
      so there is no excessively huge demand to disk
      space. Afterwards, if the package is needed again, it will
      be installed via <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?pkg_add+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">pkg_add</span>(1)</span></a> instead of building again, so
      there are no cycles wasted by recompiling.</p>
</div>
<div class="sect2" title="7.3.6. Setting up a sandbox for chrooted builds">
<div class="titlepage"><div><div><h3 class="title">
<a name="setting-up-a-sandbox"></a>7.3.6. Setting up a sandbox for chrooted builds</h3></div></div></div>
<p>If you don't want all the packages nuked from a machine
      (rendering it useless for anything but pkg compiling), there
      is the possibility of doing the package bulk build inside a
      chroot environment.</p>
<p>The first step is to set up a chroot sandbox,
      e.g. <code class="filename">/usr/sandbox</code>.  This can be done by
      using null mounts, or manually.</p>
<p>There is a shell script called
      <code class="filename">pkgsrc/mk/bulk/mksandbox</code> which will set
      up the sandbox environment using null mounts. It will also
      create a script called <code class="filename">sandbox</code> in the
      root of the sandbox environment, which will allow the null
      mounts to be activated using the <span class="command"><strong>sandbox
      mount</strong></span> command and deactivated using the
      <span class="command"><strong>sandbox umount</strong></span> command.</p>
<p>To set up a sandbox environment by hand, after extracting all
      the sets from a NetBSD installation or doing a <span class="command"><strong>make
      distribution DESTDIR=/usr/sandbox</strong></span> in
      <code class="filename">/usr/src/etc</code>, be sure the following items
      are present and properly configured:</p>
<div class="procedure"><ol class="procedure" type="1">
<li class="step" title="Step 1">
<p>Kernel</p>
<pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cp /netbsd /usr/sandbox</code></strong></pre>
</li>
<li class="step" title="Step 2">
<p><code class="filename">/dev/*</code></p>
<pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/sandbox/dev ; sh MAKEDEV all</code></strong></pre>
</li>
<li class="step" title="Step 3">
<p><code class="filename">/etc/resolv.conf</code> (for <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/security/smtpd/README.html" target="_top"><code class="filename">security/smtpd</code></a> and mail):</p>
<pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cp /etc/resolv.conf /usr/sandbox/etc</code></strong></pre>
</li>
<li class="step" title="Step 4">
<p>Working(!) mail config (hostname, sendmail.cf):</p>
<pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cp /etc/mail/sendmail.cf /usr/sandbox/etc/mail</code></strong></pre>
</li>
<li class="step" title="Step 5">
<p><code class="filename">/etc/localtime</code> (for <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/security/smtpd/README.html" target="_top"><code class="filename">security/smtpd</code></a>):</p>
<pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ln -sf /usr/share/zoneinfo/UTC /usr/sandbox/etc/localtime</code></strong></pre>
</li>
<li class="step" title="Step 6">
<p><code class="filename">/usr/src</code> (system sources,
	  e.&nbsp;g. for <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/sysutils/aperture/README.html" target="_top"><code class="filename">sysutils/aperture</code></a>):</p>
<pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ln -s ../disk1/cvs .</code></strong>
	  <code class="prompt">#</code> <strong class="userinput"><code>ln -s cvs/src-2.0 src</code></strong></pre>
</li>
<li class="step" title="Step 7">
<p>Create <code class="filename">/var/db/pkg</code> (not part of default install):</p>
<pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mkdir /usr/sandbox/var/db/pkg</code></strong></pre>
</li>
<li class="step" title="Step 8">
<p>Create <code class="filename">/usr/pkg</code> (not part of default install):</p>
<pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mkdir /usr/sandbox/usr/pkg</code></strong></pre>
</li>
<li class="step" title="Step 9">
<p>Checkout pkgsrc via cvs into
	  <code class="filename">/usr/sandbox/usr/pkgsrc</code>:</p>
<pre class="screen">
<code class="prompt">#</code> <strong class="userinput"><code>cd /usr/sandbox/usr</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>cvs -d anoncvs@anoncvs.NetBSD.org:/cvsroot checkout -d -P pkgsrc</code></strong>
	  </pre>
<p>Do not mount/link this to the copy of your pkgsrc tree
	  you do development in, as this will likely cause problems!</p>
</li>
<li class="step" title="Step 10"><p>Make
	  <code class="filename">/usr/sandbox/usr/pkgsrc/packages</code> and
	  <code class="filename">.../distfiles</code> point somewhere
	  appropriate. NFS- and/or nullfs-mounts may come in handy!</p></li>
<li class="step" title="Step 11"><p>Edit <a class="link" href="configuring.html#mk.conf"><code class="filename">mk.conf</code></a>, see <a class="xref" href="bulk.html#binary.mk.conf" title="7.3.1.2. mk.conf">Section 7.3.1.2, &#8220;<code class="filename">mk.conf</code>&#8221;</a>.</p></li>
<li class="step" title="Step 12"><p>Adjust <code class="filename">mk/bulk/build.conf</code> to suit your needs.</p></li>
</ol></div>
<p>When the chroot sandbox is set up, you can start
      the build with the following steps:</p>
<pre class="screen">
<code class="prompt">#</code> <strong class="userinput"><code>cd /usr/sandbox/usr/pkgsrc</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>sh mk/bulk/do-sandbox-build</code></strong>
      </pre>
<p>This will just jump inside the sandbox and start building.  At
	the end of the build, mail will be sent with the results of
	the build. Created binary pkgs will be in
	<code class="filename">/usr/sandbox/usr/pkgsrc/packages</code>
      (wherever that points/mounts to/from).</p>
</div>
<div class="sect2" title="7.3.7. Building a partial set of packages">
<div class="titlepage"><div><div><h3 class="title">
<a name="building-a-partial-set"></a>7.3.7. Building a partial set of packages</h3></div></div></div>
<p>In addition to building a complete set of all packages in
      pkgsrc, the <code class="filename">pkgsrc/mk/bulk/build</code> script
      may be used to build a subset of the packages contained in
      pkgsrc.  By setting <code class="varname">SPECIFIC_PKGS</code>
      in <a class="link" href="configuring.html#mk.conf"><code class="filename">mk.conf</code></a>, the variables</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>SITE_SPECIFIC_PKGS</p></li>
<li class="listitem"><p>HOST_SPECIFIC_PKGS</p></li>
<li class="listitem"><p>GROUP_SPECIFIC_PKGS</p></li>
<li class="listitem"><p>USER_SPECIFIC_PKGS</p></li>
</ul></div>
<p>will define the set of packages which should be built.
      The bulk build code will also include any packages which are
      needed as dependencies for the explicitly listed packages.</p>
<p>One use of this is to do a bulk build with
      <code class="varname">SPECIFIC_PKGS</code> in a chroot sandbox
      periodically to have a complete set of the binary packages
      needed for your site available without the overhead of
      building extra packages that are not needed.</p>
</div>
<div class="sect2" title="7.3.8. Uploading results of a bulk build">
<div class="titlepage"><div><div><h3 class="title">
<a name="bulk-upload"></a>7.3.8. Uploading results of a bulk build</h3></div></div></div>
<p>This section describes how pkgsrc developers can upload binary
      pkgs built by bulk builds to ftp.NetBSD.org.</p>
<p>If you would like to automatically create checksum files for the
      binary packages you intend to upload, remember to set
      <code class="varname">MKSUMS=yes</code> in your
      <code class="filename">mk/bulk/build.conf</code>.</p>
<p>If you would like to PGP sign the checksum files (highly
      recommended!), remember to set
      <code class="varname">SIGN_AS=username@NetBSD.org</code> in your
      <code class="filename">mk/bulk/build.conf</code>.  This will prompt you for
      your GPG password to sign the files before uploading everything.</p>
<p>Then, make sure that you have <code class="varname">RSYNC_DST</code>
      set properly in your <code class="filename">mk/bulk/build.conf</code>
      file, i.e. adjust it to something like one of the following:</p>
<pre class="screen">RSYNC_DST=ftp.NetBSD.org:/pub/pkgsrc/packages/NetBSD/arch/a.b.c-20xxQy/upload</pre>
<p>Please use appropriate values for "20xxQy" (the branch),
      "a.b.c" (the OS version) and "arch" here. If your login on ftp.NetBSD.org
      is different from your local login, write your login directly
      into the variable, e.g. my local account is "feyrer", but for my
      login "hubertf", I use:</p>
<pre class="screen">RSYNC_DST=hubertf@ftp.NetBSD.org:/pub/pkgsrc/packages/NetBSD/arch/a.b.c-20xxQy/upload</pre>
<p>A separate <code class="filename">upload</code> directory is used
      here to allow "closing" the directory during upload. To do
      so, run the following command on ftp.NetBSD.org next:</p>
<pre class="screen">nbftp% <strong class="userinput"><code>mkdir -p -m 750 /pub/pkgsrc/packages/NetBSD/arch/a.b.c-20xxQy/upload</code></strong></pre>
<p>Before uploading the binary pkgs, ssh authentication needs
      to be set up. This example shows how to set up temporary keys
      for the root account <span class="emphasis"><em>inside the sandbox</em></span>
      (assuming that no keys should be present there usually):</p>
<pre class="screen">
<code class="prompt">#</code> <strong class="userinput"><code>chroot /usr/sandbox</code></strong>
chroot-<code class="prompt">#</code> <strong class="userinput"><code>rm $HOME/.ssh/id-dsa*</code></strong>
chroot-<code class="prompt">#</code> <strong class="userinput"><code>ssh-keygen -t rsa</code></strong>
chroot-<code class="prompt">#</code> <strong class="userinput"><code>cat $HOME/.ssh/id-rsa.pub</code></strong>
      </pre>
<p>Now take the output of <code class="filename">id-rsa.pub</code> and
      append it to your <code class="filename">~/.ssh/authorized_keys</code>
      file on ftp.NetBSD.org. You should remove the key after the
      upload is done!</p>
<p>Next, test if your ssh connection really works:</p>
<pre class="screen">chroot-<code class="prompt">#</code> <strong class="userinput"><code>ssh ftp.NetBSD.org date</code></strong> </pre>
<p>Use "-l yourNetBSDlogin" here as appropriate!</p>
<p>Now after all this works, you can exit the sandbox and start
      the upload:</p>
<pre class="screen">
chroot-<code class="prompt">#</code> <strong class="userinput"><code>exit</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>cd /usr/sandbox/usr/pkgsrc</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>sh mk/bulk/do-sandbox-upload</code></strong>
      </pre>
<p>The upload process may take quite some time. Use <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?ls+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">ls</span>(1)</span></a> or
      <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?du+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">du</span>(1)</span></a> on the FTP server to monitor progress of the
      upload. The upload script will take care of not uploading
      restricted packages.</p>
<p>After the upload has ended, first thing is to revoke ssh access:</p>
<pre class="screen">nbftp% <strong class="userinput"><code>vi ~/.ssh/authorized_keys</code></strong>
      Gdd:x! </pre>
<p>Use whatever is needed to remove the key you've entered
      before! Last, move the uploaded packages out of the
      <code class="filename">upload</code> directory to have them accessible
      to everyone:</p>
<pre class="screen">
nbftp% <strong class="userinput"><code>cd /pub/pkgsrc/packages/NetBSD/arch/a.b.c-20xxQy</code></strong>
nbftp% <strong class="userinput"><code>mv upload/* .</code></strong>
nbftp% <strong class="userinput"><code>rmdir upload</code></strong>
nbftp% <strong class="userinput"><code>chgrp -R netbsd .</code></strong>
nbftp% <strong class="userinput"><code>find . -type d | xargs chmod 775</code></strong>
      </pre>
</div>
</div>
<div class="sect1" title="7.4. Running a pbulk-style bulk build">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="bulk.pbulk"></a>7.4. Running a pbulk-style bulk build</h2></div></div></div>
<p>Running a pbulk-style bulk build works roughly as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>First, build the pbulk infrastructure in a fresh pkgsrc location.</p></li>
<li class="listitem"><p>Then, build each of the packages from a clean installation directory using the infrastructure.</p></li>
</ul></div>
<div class="sect2" title="7.4.1. Preparation">
<div class="titlepage"><div><div><h3 class="title">
<a name="bulk.pbulk.prepare"></a>7.4.1. Preparation</h3></div></div></div>
<p>First, you need to create a pkgsrc installation for the pbulk infrastructure. No matter on which platform you are (even on NetBSD), you should bootstrap into its own directory. Let's take the directory <code class="filename">/usr/pbulk</code> or <code class="filename">$HOME/pbulk</code> for it. This installation will be bootstrapped and all the tools that are required for the bulk build will be installed there.</p>
<pre class="screen">
$ <strong class="userinput"><code>cd /usr/pkgsrc</code></strong>
$ <strong class="userinput"><code>./bootstrap/bootstrap --prefix=/usr/pbulk --varbase=/usr/pbulk/var --workdir=/tmp/pbulk-bootstrap</code></strong>
$ <strong class="userinput"><code>rm -rf /tmp/pbulk-bootstrap</code></strong>
</pre>
<p>Now the basic environment for the pbulk infrastructure is installed. The specific tools are still missing. This is a good time to edit the pkgsrc configuration file <code class="filename">/usr/pbulk/etc/mk.conf</code> to fit your needs. Typical things you might set now are:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p><code class="literal"><code class="varname">PKG_DEVELOPER</code>=yes</code>, to enable many consistency checks,</p></li>
<li class="listitem"><p><code class="literal"><code class="varname">WRKOBJDIR</code>=/tmp/pbulk-outer</code>, to keep <code class="filename">/usr/pkgsrc</code> free from any modifications,</p></li>
<li class="listitem"><p><code class="literal"><code class="varname">DISTDIR</code>=/distfiles</code>, to have only one directory in which all distfiles (for the infrastructure and for the actual packages) are downloaded,</p></li>
<li class="listitem"><p><code class="literal"><code class="varname">ACCEPTABLE_LICENSES</code>+=...</code>, to select some licenses additional to the usual Free/Open Source licenses that are acceptable to you,</p></li>
<li class="listitem"><p><code class="literal"><code class="varname">SKIP_LICENSE_CHECK</code>=yes</code>, to bypass the license checks.</p></li>
</ul></div>
<p>Now you are ready to build the rest of the pbulk infrastructure.</p>
<pre class="screen">
$ <strong class="userinput"><code>cd pkgtools/pbulk</code></strong>
$ <strong class="userinput"><code>/usr/pbulk/bin/bmake install</code></strong>
$ <strong class="userinput"><code>rm -rf /tmp/pbulk-outer</code></strong>
</pre>
<p>Now the pbulk infrastructure is built and installed. It still needs to be configured, and after some more preparation, we will be able to start the real bulk build.</p>
</div>
<div class="sect2" title="7.4.2. Configuration">
<div class="titlepage"><div><div><h3 class="title">
<a name="bulk.pbulk.conf"></a>7.4.2. Configuration</h3></div></div></div>
<p>TODO; see pkgsrc/doc/HOWTO-pbulk for more information.</p>
<p>TODO: continue writing</p>
</div>
</div>
<div class="sect1" title="7.5. Creating a multiple CD-ROM packages collection">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="creating-cdroms"></a>7.5. Creating a multiple CD-ROM packages collection</h2></div></div></div>
<p>After your pkgsrc bulk-build has completed, you may wish to
    create a CD-ROM set of the resulting binary packages to assist
    in installing packages on other machines.  The
    <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/pkgtools/cdpack/README.html" target="_top"><code class="filename">pkgtools/cdpack</code></a> package provides
    a simple tool for creating the ISO 9660 images.
    <span class="command"><strong>cdpack</strong></span> arranges the packages on the CD-ROMs in a
    way that keeps all the dependencies for a given package on the same
    CD as that package.</p>
<div class="sect2" title="7.5.1. Example of cdpack">
<div class="titlepage"><div><div><h3 class="title">
<a name="cdpack-example"></a>7.5.1. Example of cdpack</h3></div></div></div>
<p>Complete documentation for cdpack is found in the cdpack(1)
      man page. The following short example assumes that the binary
      packages are left in
      <code class="filename">/usr/pkgsrc/packages/All</code> and that
      sufficient disk space exists in <code class="filename">/u2</code> to
      hold the ISO 9660 images.</p>
<pre class="screen">
<code class="prompt">#</code> <strong class="userinput"><code>mkdir /u2/images</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>pkg_add /usr/pkgsrc/packages/All/cdpack</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>cdpack /usr/pkgsrc/packages/All /u2/images</code></strong>
      </pre>
<p>If you wish to include a common set of files
      (<code class="filename">COPYRIGHT</code>, <code class="filename">README</code>,
      etc.) on each CD in the collection, then you need to create a
      directory which contains these files. e.g.</p>
<pre class="screen">
<code class="prompt">#</code> <strong class="userinput"><code>mkdir /tmp/common</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>echo "This is a README" &gt; /tmp/common/README</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>echo "Another file" &gt; /tmp/common/COPYING</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mkdir /tmp/common/bin</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>echo "#!/bin/sh" &gt; /tmp/common/bin/myscript</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>echo "echo Hello world" &gt;&gt; /tmp/common/bin/myscript</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>chmod 755 /tmp/common/bin/myscript</code></strong>
      </pre>
<p>Now create the images:</p>
<pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cdpack -x /tmp/common /usr/pkgsrc/packages/All /u2/images</code></strong></pre>
<p>Each image will contain <code class="filename">README</code>,
      <code class="filename">COPYING</code>, and <code class="filename">bin/myscript</code>
      in their root directories.</p>
</div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="binary.html">Prev</a> </td>
<td width="20%" align="center"><a accesskey="u" href="users-guide.html">Up</a></td>
<td width="40%" align="right"> <a accesskey="n" href="files.html">Next</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">Chapter 6. Creating binary packages </td>
<td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td>
<td width="40%" align="right" valign="top"> Chapter 8. Directory layout of the installed files</td>
</tr>
</table>
</div>
</body>
</html>
