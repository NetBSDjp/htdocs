<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Chapter 16. Options handling</title>
<link rel="stylesheet" type="text/css" href="/global.css">
<meta name="generator" content="DocBook XSL Stylesheets VX.X.X">
<link rel="home" href="index.html" title="The pkgsrc guide">
<link rel="up" href="developers-guide.html" title="Part II. The pkgsrc developer's guide">
<link rel="prev" href="pkginstall.html" title="Chapter 15. The pkginstall framework">
<link rel="next" href="build.html" title="Chapter 17. The build process">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">Chapter 16. Options handling</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="pkginstall.html">Prev</a> </td>
<th width="60%" align="center">Part II. The pkgsrc developer's guide</th>
<td width="20%" align="right"> <a accesskey="n" href="build.html">Next</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="chapter" title="Chapter 16. Options handling">
<div class="titlepage"><div><div><h2 class="title">
<a name="options"></a>Chapter 16. Options handling</h2></div></div></div>
<div class="toc">
<p><b>Table of Contents</b></p>
<dl>
<dt><span class="sect1"><a href="options.html#global-default-options">16.1. Global default options</a></span></dt>
<dt><span class="sect1"><a href="options.html#converting-to-options">16.2. Converting packages to use <code class="filename">bsd.options.mk</code></a></span></dt>
<dt><span class="sect1"><a href="options.html#option-names">16.3. Option Names</a></span></dt>
<dt><span class="sect1"><a href="options.html#option-build">16.4. Determining the options of dependencies</a></span></dt>
</dl>
</div>
<p>Many packages have the ability to be built to support different
sets of features.  <code class="filename">bsd.options.mk</code> is a framework
in pkgsrc that provides generic handling of those options that
determine different ways in which the packages can be built.  It's
possible for the user to specify exactly which sets of options will be
built into a package or to allow a set of global default options
apply.</p>
<p>There are two broad classes of behaviors that one might want to
control via options.  One is whether some particular feature is
enabled in a program that will be built anyway, often by including or
not including a dependency on some other package.  The other is
whether or not an additional program will be built as part of the
package.  Generally, it is better to make a split package for such
additional programs instead of using options, because it enables
binary packages to be built which can then be added separately.  For
example, the foo package might have minimal dependencies (those
packages without which foo doesn't make sense), and then the foo-gfoo
package might include the GTK frontend program gfoo.  This is better
than including a gtk option to foo that adds gfoo, because either that
option is default, in which case binary users can't get foo without
gfoo, or not default, in which case they can't get gfoo.  With split
packages, they can install foo without having GTK, and later decide to
install gfoo (pulling in GTK at that time).  This is an advantage to
source users too, avoiding the need for rebuilds.</p>
<p>Plugins with widely varying dependencies should usually be split
instead of options.</p>
<p>It is often more work to maintain split packages, especially if
the upstream package does not support this.  The decision of split
vs. option should be made based on the likelihood that users will want
or object to the various pieces, the size of the dependencies that are
included, and the amount of work.</p>
<p>A further consideration is licensing.  Non-free parts, or parts
that depend on non-free dependencies (especially plugins) should
almost always be split if feasible.</p>
<div class="sect1" title="16.1. Global default options">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="global-default-options"></a>16.1. Global default options</h2></div></div></div>
<p>Global default options are listed in
<code class="varname">PKG_DEFAULT_OPTIONS</code>, which is a list of the options
that should be built into every package if that option is supported.
This variable should be set in <a class="link" href="configuring.html#mk.conf"><code class="filename">mk.conf</code></a>.</p>
</div>
<div class="sect1" title="16.2. Converting packages to use bsd.options.mk">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="converting-to-options"></a>16.2. Converting packages to use <code class="filename">bsd.options.mk</code>
</h2></div></div></div>
<p>The following example shows how
<code class="filename">bsd.options.mk</code> should be used
by the hypothetical ``wibble'' package, either in the package
<code class="filename">Makefile</code>, or in a file,
e.g. <code class="filename">options.mk</code>, that is included by the
main package <code class="filename">Makefile</code>.</p>
<pre class="programlisting">
PKG_OPTIONS_VAR=                PKG_OPTIONS.wibble
PKG_SUPPORTED_OPTIONS=          wibble-foo ldap
PKG_OPTIONS_OPTIONAL_GROUPS=    database
PKG_OPTIONS_GROUP.database=     mysql pgsql
PKG_SUGGESTED_OPTIONS=          wibble-foo
PKG_OPTIONS_LEGACY_VARS+=       WIBBLE_USE_OPENLDAP:ldap
PKG_OPTIONS_LEGACY_OPTS+=       foo:wibble-foo

.include "../../mk/bsd.prefs.mk"

# this package was previously named wibble2
.if defined(PKG_OPTIONS.wibble2)
PKG_LEGACY_OPTIONS+=            ${PKG_OPTIONS.wibble2}
PKG_OPTIONS_DEPRECATED_WARNINGS+= \
        "Deprecated variable PKG_OPTIONS.wibble2 used, use ${PKG_OPTIONS_VAR} instead."
.endif

.include "../../mk/bsd.options.mk"

# Package-specific option-handling

###
### FOO support
###
.if !empty(PKG_OPTIONS:Mwibble-foo)
CONFIGURE_ARGS+=    --enable-foo
.endif

###
### LDAP support
###
.if !empty(PKG_OPTIONS:Mldap)
.  include "../../databases/openldap-client/buildlink3.mk"
CONFIGURE_ARGS+=    --enable-ldap=${BUILDLINK_PREFIX.openldap-client}
.endif

###
### database support
###
.if !empty(PKG_OPTIONS:Mmysql)
.  include "../../mk/mysql.buildlink3.mk"
.endif
.if !empty(PKG_OPTIONS:Mpgsql)
.  include "../../mk/pgsql.buildlink3.mk"
.endif
</pre>
<p>The first section contains the information about which build
options are supported by the package, and any default options settings
if needed.</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p><code class="varname">PKG_OPTIONS_VAR</code> is the name of the
<a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?make+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">make</span>(1)</span></a> variable that the user can set to override the default
options.  It should be set to
PKG_OPTIONS.<em class="replaceable"><code>pkgbase</code></em>. Do not set it to
PKG_OPTIONS.${PKGBASE}, since <code class="varname">PKGBASE</code> is not defined
at the point where the options are processed.</p></li>
<li class="listitem"><p><code class="varname">PKG_SUPPORTED_OPTIONS</code> is a list of
build options supported by the package.</p></li>
<li class="listitem"><p><code class="varname">PKG_OPTIONS_OPTIONAL_GROUPS</code> is a
list of names of groups of mutually exclusive options.  The options in
each group are listed in
<code class="varname">PKG_OPTIONS_GROUP.<em class="replaceable"><code>groupname</code></em></code>.
The most specific setting of any option from the group takes
precedence over all other options in the group.  Options from the
groups will be automatically added to
<code class="varname">PKG_SUPPORTED_OPTIONS</code>.</p></li>
<li class="listitem"><p><code class="varname">PKG_OPTIONS_REQUIRED_GROUPS</code> is like
<code class="varname">PKG_OPTIONS_OPTIONAL_GROUPS</code>, but building the
packages will fail if no option from the group is
selected.</p></li>
<li class="listitem"><p><code class="varname">PKG_OPTIONS_NONEMPTY_SETS</code> is a list
of names of sets of options.  At least one option from each set must
be selected.  The options in each set are listed in
<code class="varname">PKG_OPTIONS_SET.<em class="replaceable"><code>setname</code></em></code>.
Options from the sets will be automatically added to
<code class="varname">PKG_SUPPORTED_OPTIONS</code>.  Building the package will
fail if no option from the set is selected.</p></li>
<li class="listitem"><p><code class="varname">PKG_SUGGESTED_OPTIONS</code> is a list of
build options which are enabled by default.</p></li>
<li class="listitem"><p><code class="varname">PKG_OPTIONS_LEGACY_VARS</code> is a list
of
<span class="quote">&#8220;<span class="quote"><em class="replaceable"><code>USE_VARIABLE</code></em>:<em class="replaceable"><code>option</code></em></span>&#8221;</span>
pairs that map legacy <a class="link" href="configuring.html#mk.conf"><code class="filename">mk.conf</code></a> variables to
their option counterparts.  Pairs should be added with
<span class="quote">&#8220;<span class="quote">+=</span>&#8221;</span> to keep the listing of global legacy variables.  A
warning will be issued if the user uses a legacy
variable.</p></li>
<li class="listitem"><p><code class="varname">PKG_OPTIONS_LEGACY_OPTS</code> is a list
of
<span class="quote">&#8220;<span class="quote"><em class="replaceable"><code>old-option</code></em>:<em class="replaceable"><code>new-option</code></em></span>&#8221;</span>
pairs that map options that have been renamed to their new
counterparts.  Pairs should be added with <span class="quote">&#8220;<span class="quote">+=</span>&#8221;</span> to keep
the listing of global legacy options.  A warning will be issued if
the user uses a legacy option.</p></li>
<li class="listitem"><p><code class="varname">PKG_LEGACY_OPTIONS</code> is a list of
options implied by deprecated variables used.  This can be used for
cases that neither <code class="varname">PKG_OPTIONS_LEGACY_VARS</code> nor
<code class="varname">PKG_OPTIONS_LEGACY_OPTS</code> can handle, e. g. when
<code class="varname">PKG_OPTIONS_VAR</code> is renamed.</p></li>
<li class="listitem"><p><code class="varname">PKG_OPTIONS_DEPRECATED_WARNINGS</code> is
a list of warnings about deprecated variables or options used, and
what to use instead.</p></li>
</ol></div>
<p>A package should never modify
<code class="varname">PKG_DEFAULT_OPTIONS</code> or the variable named in
<code class="varname">PKG_OPTIONS_VAR</code>.  These are strictly user-settable.
To suggest a default set of options, use
<code class="varname">PKG_SUGGESTED_OPTIONS</code>.</p>
<p><code class="varname">PKG_OPTIONS_VAR</code> must be defined before
including <code class="filename">bsd.options.mk</code>.  If none of
<code class="varname">PKG_SUPPORTED_OPTIONS</code>,
<code class="varname">PKG_OPTIONS_OPTIONAL_GROUPS</code>, and
<code class="varname">PKG_OPTIONS_REQUIRED_GROUPS</code> are defined (as can
happen with platform-specific options if none of them is supported on
the current platform), <code class="varname">PKG_OPTIONS</code> is set to the
empty list and the package is otherwise treated as not using the
options framework.</p>
<p>After the inclusion of <code class="filename">bsd.options.mk</code>, the
variable <code class="varname">PKG_OPTIONS</code> contains the list of selected
build options, properly filtered to remove unsupported and duplicate
options.</p>
<p>The remaining sections contain the logic that is specific to
each option.  The correct way to check for an option is to check
whether it is listed in <code class="varname">PKG_OPTIONS</code>:</p>
<pre class="programlisting">
.if !empty(PKG_OPTIONS:M<em class="replaceable"><code>option</code></em>)
</pre>
</div>
<div class="sect1" title="16.3. Option Names">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="option-names"></a>16.3. Option Names</h2></div></div></div>
<p>Options that enable similar features in different packages (like
optional support for a library) should use a common name in all
packages that support it (like the name of the library).  If another
package already has an option with the same meaning, use the same
name.</p>
<p>Options that enable features specific to one package, where it's
unlikely that another (unrelated) package has the same (or a similar)
optional feature, should use a name prefixed with
<code class="varname"><em class="replaceable"><code>pkgname</code></em>-</code>.</p>
<p>If a group of related packages share an optional feature
specific to that group, prefix it with the name of the
<span class="quote">&#8220;<span class="quote">main</span>&#8221;</span> package
(e. g. <code class="varname">djbware-errno-hack</code>).</p>
<p>For new options, add a line to
<code class="filename">mk/defaults/options.description</code>.  Lines have two
fields, separated by tab.  The first field is the option name, the
second its description.  The description should be a whole sentence
(starting with an uppercase letter and ending with a period) that
describes what enabling the option does.  E. g. <span class="quote">&#8220;<span class="quote">Enable ispell
support.</span>&#8221;</span> The file is sorted by option names.</p>
</div>
<div class="sect1" title="16.4. Determining the options of dependencies">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="option-build"></a>16.4. Determining the options of dependencies</h2></div></div></div>
<p>When writing <a class="link" href="buildlink.html#buildlink3.mk"><code class="filename">buildlink3.mk</code></a> files, it is often necessary to list
different dependencies based on the options with which the package was
built. For querying these options, the file
<code class="filename">pkgsrc/mk/pkg-build-options.mk</code> should be used. A
typical example looks like this:</p>
<pre class="programlisting">
pkgbase := libpurple
.include "../../mk/pkg-build-options.mk"

.if !empty(PKG_BUILD_OPTIONS.libpurple:Mdbus)
...
.endif
</pre>
<p>Including <code class="filename">pkg-build-options.mk</code> here will set
the variable <code class="varname">PKG_BUILD_OPTIONS.libpurple</code> to the build
options of the libpurple package, which can then be queried like
<code class="varname">PKG_OPTIONS</code> in the <code class="filename">options.mk</code>
file. See the file <code class="filename">pkg-build-options.mk</code> for more
details.</p>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="pkginstall.html">Prev</a> </td>
<td width="20%" align="center"><a accesskey="u" href="developers-guide.html">Up</a></td>
<td width="40%" align="right"> <a accesskey="n" href="build.html">Next</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">Chapter 15. The pkginstall framework </td>
<td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td>
<td width="40%" align="right" valign="top"> Chapter 17. The build process</td>
</tr>
</table>
</div>
</body>
</html>
