<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Chapter 19. Making your package work</title>
<link rel="stylesheet" type="text/css" href="/global.css">
<meta name="generator" content="DocBook XSL Stylesheets VX.X.X">
<link rel="home" href="index.html" title="The pkgsrc guide">
<link rel="up" href="developers-guide.html" title="Part II. The pkgsrc developer's guide">
<link rel="prev" href="tools.html" title="Chapter 18. Tools needed for building or running">
<link rel="next" href="debug.html" title="Chapter 20. Debugging">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">Chapter 19. Making your package work</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="tools.html">Prev</a> </td>
<th width="60%" align="center">Part II. The pkgsrc developer's guide</th>
<td width="20%" align="right"> <a accesskey="n" href="debug.html">Next</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="chapter" title="Chapter 19. Making your package work">
<div class="titlepage"><div><div><h2 class="title">
<a name="fixes"></a>Chapter 19. Making your package work</h2></div></div></div>
<div class="toc">
<p><b>Table of Contents</b></p>
<dl>
<dt><span class="sect1"><a href="fixes.html#general-operation">19.1. General operation</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="fixes.html#portability-of-packages">19.1.1. Portability of packages</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#pulling-vars-from-etc-mk.conf">19.1.2. How to pull in user-settable variables from <code class="filename">mk.conf</code></a></span></dt>
<dt><span class="sect2"><a href="fixes.html#user-interaction">19.1.3. User interaction</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#handling-licenses">19.1.4. Handling licenses</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#restricted-packages">19.1.5. Restricted packages</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#dependencies">19.1.6. Handling dependencies</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#conflicts">19.1.7. Handling conflicts with other packages</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#not-building-packages">19.1.8. Packages that cannot or should not be built</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#undeletable-packages">19.1.9. Packages which should not be deleted, once installed</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#security-handling">19.1.10. Handling packages with security problems</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#bumping-pkgrevision">19.1.11. How to handle incrementing versions when fixing an existing package</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#fixes.subst">19.1.12. Substituting variable text in the package files (the SUBST framework)</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="fixes.html#fixes.fetch">19.2. Fixing problems in the <span class="emphasis"><em>fetch</em></span> phase</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="fixes.html#no-plain-download">19.2.1. Packages whose distfiles aren't available for plain downloading</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#modified-distfiles-same-name">19.2.2. How to handle modified distfiles with the 'old' name</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="fixes.html#fixes.configure">19.3. Fixing problems in the <span class="emphasis"><em>configure</em></span> phase</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="fixes.html#fixes.libtool">19.3.1. Shared libraries - libtool</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#using-libtool">19.3.2. Using libtool on GNU packages that already support libtool</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#autoconf-automake">19.3.3. GNU Autoconf/Automake</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="fixes.html#programming-languages">19.4. Programming languages</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="fixes.html#basic-programming-languages">19.4.1. C, C++, and Fortran</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#java-programming-language">19.4.2. Java</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#perl-scripts">19.4.3. Packages containing perl scripts</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#other-programming-languages">19.4.4. Other programming languages</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="fixes.html#fixes.build">19.5. Fixing problems in the <span class="emphasis"><em>build</em></span> phase</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="fixes.html#fixes.build.cpp">19.5.1. Compiling C and C++ code conditionally</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#compiler-bugs">19.5.2. How to handle compiler bugs</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#undefined-reference">19.5.3. Undefined reference to <span class="quote">&#8220;<span class="quote">...</span>&#8221;</span></a></span></dt>
<dt><span class="sect2"><a href="fixes.html#out-of-memory">19.5.4. Running out of memory</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="fixes.html#fixes.install">19.6. Fixing problems in the <span class="emphasis"><em>install</em></span> phase</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="fixes.html#install-scripts">19.6.1. Creating needed directories</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#where-to-install-documentation">19.6.2. Where to install documentation</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#installing-score-files">19.6.3. Installing highscore files</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#destdir-support">19.6.4. Adding DESTDIR support to packages</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#hardcoded-paths">19.6.5. Packages with hardcoded paths to other interpreters</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#perl-modules">19.6.6. Packages installing perl modules</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#faq.info-files">19.6.7. Packages installing info files</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#manpages">19.6.8. Packages installing man pages</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#gconf-data-files">19.6.9. Packages installing GConf data files</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#scrollkeeper-data-files">19.6.10. Packages installing scrollkeeper/rarian data files</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#x11-fonts">19.6.11. Packages installing X11 fonts</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#gtk2-modules">19.6.12. Packages installing GTK2 modules</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#sgml-xml-data">19.6.13. Packages installing SGML or XML data</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#mime-database">19.6.14. Packages installing extensions to the MIME database</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#intltool">19.6.15. Packages using intltool</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#startup-scripts">19.6.16. Packages installing startup scripts</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#tex-packages">19.6.17. Packages installing TeX modules</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#emulation-packages">19.6.18. Packages supporting running binaries in
    emulation</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#hicolor-theme">19.6.19. Packages installing hicolor theme icons</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#desktop-files">19.6.20. Packages installing desktop files</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="fixes.html#punting">19.7. Marking packages as having problems</a></span></dt>
</dl>
</div>
<div class="sect1" title="19.1. General operation">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="general-operation"></a>19.1. General operation</h2></div></div></div>
<div class="sect2" title="19.1.1. Portability of packages">
<div class="titlepage"><div><div><h3 class="title">
<a name="portability-of-packages"></a>19.1.1. Portability of packages</h3></div></div></div>
<p>One appealing feature of pkgsrc is that it runs on many
    different platforms. As a result, it is important to ensure,
    where possible, that packages in pkgsrc are portable. This
    chapter mentions some particular details you should pay
    attention to while working on pkgsrc.</p>
</div>
<div class="sect2" title="19.1.2. How to pull in user-settable variables from mk.conf">
<div class="titlepage"><div><div><h3 class="title">
<a name="pulling-vars-from-etc-mk.conf"></a>19.1.2. How to pull in user-settable variables from <a class="link" href="configuring.html#mk.conf"><code class="filename">mk.conf</code></a>
</h3></div></div></div>
<p>The pkgsrc user can configure pkgsrc by overriding several
    variables in the file pointed to by <code class="varname">MAKECONF</code>,
    which is <a class="link" href="configuring.html#mk.conf"><code class="filename">mk.conf</code></a> by default. When you
    want to use those variables in the preprocessor directives of
    <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?make+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">make</span>(1)</span></a> (for example <code class="literal">.if</code> or
    <code class="literal">.for</code>), you need to include the file
    <code class="filename">../../mk/bsd.prefs.mk</code> before, which in turn
    loads the user preferences.</p>
<p>But note that some variables may not be completely defined
    after <code class="filename">../../mk/bsd.prefs.mk</code> has been
    included, as they may contain references to variables that are
    not yet defined. In shell commands this is no problem, since
    variables are actually macros, which are only expanded when they
    are used. But in the preprocessor directives mentioned above and
    in dependency lines (of the form <code class="literal">target:
    dependencies</code>) the variables are expanded at load
    time.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;">
<h3 class="title">Note</h3>
<p>Currently there is no exhaustive list of all
    variables that tells you whether they can be used at load time
    or only at run time, but it is in preparation.</p>
</div>
</div>
<div class="sect2" title="19.1.3. User interaction">
<div class="titlepage"><div><div><h3 class="title">
<a name="user-interaction"></a>19.1.3. User interaction</h3></div></div></div>
<p>Occasionally, packages require interaction from the user,
    and this can be in a number of ways:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>When fetching the distfiles, some packages require user
	interaction such as entering username/password or accepting a
	license on a web page.</p></li>
<li class="listitem"><p>When extracting the distfiles, some packages may ask for
	passwords.</p></li>
<li class="listitem"><p>help to configure the package before it is built</p></li>
<li class="listitem"><p>help during the build process</p></li>
<li class="listitem"><p>help during the installation of a package</p></li>
</ul></div>
<p>The <code class="varname">INTERACTIVE_STAGE</code> definition is
    provided to notify the pkgsrc mechanism of an interactive stage
    which will be needed, and this should be set in the package's
    <code class="filename">Makefile</code>, e.g.:</p>
<pre class="programlisting">
INTERACTIVE_STAGE=      build
    </pre>
<p>Multiple interactive stages can be specified:</p>
<pre class="programlisting">
INTERACTIVE_STAGE=      configure install
    </pre>
<p>The user can then decide to skip this package by setting the
    <code class="varname">BATCH</code> variable.</p>
</div>
<div class="sect2" title="19.1.4. Handling licenses">
<div class="titlepage"><div><div><h3 class="title">
<a name="handling-licenses"></a>19.1.4. Handling licenses</h3></div></div></div>
<p>Authors of software can choose the licence under which
    software can be copied.  This is due to copyright law, and reasons
    for license choices are outside the scope of pkgsrc.  The pkgsrc
    system recognizes that there are a number of licenses which some
    users may find objectionable or difficult or impossible to comply
    with.  The Free Software Foundation has declared some licenses
    "Free", and the Open Source Initiative has a definition of "Open
    Source".  The pkgsrc system, as a policy choice, does not label
    packages which have licenses that are Free or Open Source.
    However, packages without a license meeting either of those tests
    are labeled with a license tag denoting the license.  Note that a
    package with no license to copy trivially does not meet either the
    Free or Open Source test.</p>
<p>For packages which are not Free or Open Source, pkgsrc will
    not build the package unless the user has indicated to pkgsrc that
    packages with that particular license may be built.  Note that
    this documentation avoids the term "accepted the license".  The
    pkgsrc system is merely providing a mechanism to avoid
    accidentally building a package with a non-free license;
    judgement and responsibility remain with the user.  (Installation
    of binary packages are not currently subject to this mechanism;
    this is a bug.)</p>
<p>One might want to only install packages with a BSD license,
    or the GPL, and not the other.  The free licenses are added to the 
    default <code class="varname">ACCEPTABLE_LICENSES</code> variable.  The
    user can override the default by setting the
    <code class="varname">ACCEPTABLE_LICENSES</code> variable with "=" instead
    of "+=".  The licenses accepted by default are:
    </p>
<pre class="programlisting">
    public-domain
    gnu-gpl-v2 gnu-lgpl-v2
    gnu-gpl-v3 gnu-lgpl-v3
    original-bsd modified-bsd
    x11
    apache-2.0
    cddl-1.0
    open-font-license
    </pre>
<p>
    </p>
<p>The license tag mechanism is intended to address
    copyright-related issues surrounding building, installing and
    using a package, and not to address redistribution issues (see
    <code class="varname">RESTRICTED</code> and
    <code class="varname">NO_SRC_ON_FTP</code>, etc.).  
    Packages with redistribution restrictions should set these
    tags.</p>
<p>Denoting that a package may be copied according to a
    particular license is done by placing the license in
    <code class="filename">pkgsrc/licenses</code> and setting the
    <code class="varname">LICENSE</code> variable to a string identifying the
    license, e.g. in <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/graphics/xv/README.html" target="_top"><code class="filename">graphics/xv</code></a>:</p>
<pre class="programlisting">
LICENSE=        xv-license
    </pre>
<p>When trying to build, the user will get a notice that the
    package is covered by a license which has not been placed in the
    <code class="varname">ACCEPTABLE_LICENSES</code> variable:</p>
<pre class="programlisting">
<code class="prompt">%</code> <strong class="userinput"><code>make</code></strong>
===&gt; xv-3.10anb9 has an unacceptable license: xv-license.
===&gt;     To view the license, enter "/usr/bin/make show-license".
===&gt;     To indicate acceptance, add this line to your /etc/mk.conf:
===&gt;     ACCEPTABLE_LICENSES+=xv-license
*** Error code 1
    </pre>
<p>The license can be viewed with <span class="command"><strong>make
    show-license</strong></span>, and if the user so chooses, the line
    printed above can be added to <a class="link" href="configuring.html#mk.conf"><code class="filename">mk.conf</code></a> to
    convey to pkgsrc that it should not in the future fail because of
    that license:</p>
<pre class="programlisting">
ACCEPTABLE_LICENSES+=xv-license
    </pre>
<p>When adding a package with a new license, the license text
    should be added to <code class="filename">pkgsrc/licenses</code> for
    displaying.  A list of known licenses can be seen in this
    directory.</p>
<p>When the license changes (in a way other than formatting),
    please make sure that the new license has a different name (e.g.,
    append the version number if it exists, or the date).  Just
    because a user told pkgsrc to build programs under a previous
    version of a license does not mean that pkgsrc should build
    programs under the new licenses.  The higher-level point is that
    pkgsrc does not evaluate licenses for reasonableness; the only
    test is a mechanistic test of whether a particular text has been
    approved by either of two bodies.</p>
<p>The use of <code class="varname">LICENSE=shareware</code>,
    <code class="varname">LICENSE=no-commercial-use</code>, and similar language
    is deprecated because it does not crisply refer to a particular
    license text.  Another problem with such usage is that it does not
    enable a user to tell pkgsrc to proceed for a single package
    without also telling pkgsrc to proceed for all packages with that
    tag.</p>
</div>
<div class="sect2" title="19.1.5. Restricted packages">
<div class="titlepage"><div><div><h3 class="title">
<a name="restricted-packages"></a>19.1.5. Restricted packages</h3></div></div></div>
<p>Some licenses restrict how software may be re-distributed.
    Because a license tag is required unless the package is Free or
    Open Source, all packages with restrictions should have license
    tags.  By declaring the restrictions, package tools can
    automatically refrain from e.g. placing binary packages on FTP
    sites.</p>
<p>There are four restrictions that may be encoded, which are
    the cross product of sources (distfiles) and binaries not being
    placed on FTP sites and CD-ROMs.  Because this is rarely the exact
    language in any license, and because non-Free licenses tend to be
    different from each other, pkgsrc adopts a definition of FTP and
    CD-ROM.  Pkgsrc uses "FTP" to mean that the source or binary file
    should not be made available over the Internet at no charge.
    Pkgsrc uses "CD-ROM" to mean that the source or binary may not be
    made available on some kind of media, together with other source
    and binary packages, and which is sold for a distribution charge.
    </p>
<p>In order to encode these restrictions, the package system
    defines five make variables that can be set to note these
    restrictions:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem">
<p><code class="varname">RESTRICTED</code></p>
<p>This variable should be set whenever a restriction
	exists (regardless of its kind).  Set this variable to a
	string containing the reason for the restriction.  It should
	be understood that those wanting to understand the restriction
	will have to read the license, and perhaps seek advice of
	counsel.</p>
</li>
<li class="listitem">
<p><code class="varname">NO_BIN_ON_CDROM</code></p>
<p>Binaries may not be placed on CD-ROM containing other
	binary packages, for which a distribution charge may be made.
	In this case, set this variable to
	<code class="varname">${RESTRICTED}</code>.</p>
</li>
<li class="listitem">
<p><code class="varname">NO_BIN_ON_FTP</code></p>
<p>Binaries may not made available on the Internet without
	charge.  In this case, set this variable to
	<code class="varname">${RESTRICTED}</code>.  If this variable is set,
	binary packages will not be included on ftp.NetBSD.org.</p>
</li>
<li class="listitem">
<p><code class="varname">NO_SRC_ON_CDROM</code></p>
<p>Distfiles may not be placed on CD-ROM, together with
	other distfiles, for which a fee may be charged.  In this
	case, set this variable to <code class="varname">${RESTRICTED}</code>.
	</p>
</li>
<li class="listitem">
<p><code class="varname">NO_SRC_ON_FTP</code></p>
<p>Distfiles may not made available via FTP at no charge.
	In this case, set this variable to
	<code class="varname">${RESTRICTED}</code>.  If this variable is set,
	the distfile(s) will not be mirrored on ftp.NetBSD.org.</p>
</li>
</ul></div>
</div>
<div class="sect2" title="19.1.6. Handling dependencies">
<div class="titlepage"><div><div><h3 class="title">
<a name="dependencies"></a>19.1.6. Handling dependencies</h3></div></div></div>
<p>Your package may depend on some other package being present
    - and there are various ways of expressing this dependency.
    pkgsrc supports the <code class="varname">BUILD_DEPENDS</code> and
    <code class="varname">DEPENDS</code> definitions, the
    <code class="varname">USE_TOOLS</code> definition, as well as dependencies
    via <code class="filename">buildlink3.mk</code>, which is the preferred way
    to handle dependencies, and which uses the variables named above.
    See <a class="xref" href="buildlink.html" title="Chapter 14. Buildlink methodology">Chapter 14, <i>Buildlink methodology</i></a> for more information.</p>
<p>The basic difference between the two variables is as
    follows: The <code class="varname">DEPENDS</code> definition registers
    that pre-requisite in the binary package so it will be pulled in
    when the binary package is later installed, whilst the
    <code class="varname">BUILD_DEPENDS</code> definition does not, marking a
    dependency that is only needed for building the package.</p>
<p>This means that if you only need a package present whilst
    you are building, it should be noted as a
    <code class="varname">BUILD_DEPENDS</code>.</p>
<p>The format for a <code class="varname">BUILD_DEPENDS</code> and a
    <code class="varname">DEPENDS</code> definition is:</p>
<pre class="programlisting">
&lt;pre-req-package-name&gt;:../../&lt;category&gt;/&lt;pre-req-package&gt;
    </pre>
<p>Please note that the <span class="quote">&#8220;<span class="quote">pre-req-package-name</span>&#8221;</span>
    may include any of the wildcard version numbers recognized by
    <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?pkg_info+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">pkg_info</span>(1)</span></a>.</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem">
<p>If your package needs another package's binaries or
	libraries to build or run, and if that package has a
	<code class="filename">buildlink3.mk</code> file available, use it:</p>
<pre class="programlisting">
.include "../../graphics/jpeg/buildlink3.mk"
	</pre>
</li>
<li class="listitem">
<p>If your package needs binaries from another package to build,
	use the <code class="varname">BUILD_DEPENDS</code> definition:</p>
<pre class="programlisting">
BUILD_DEPENDS+= scons-[0-9]*:../../devel/scons
	</pre>
</li>
<li class="listitem"><p>If your package needs a library with which to link and
	there is no <code class="filename">buildlink3.mk</code> file
	available, create one. Using
	<code class="varname">DEPENDS</code> won't be sufficient because the
	include files and libraries will be hidden from the compiler.</p></li>
<li class="listitem">
<p>If your package needs some executable to be able to run
	correctly and if there's no
	<code class="filename">buildlink3.mk</code> file, this is specified
	using the <code class="varname">DEPENDS</code> variable. The
	<a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/print/lyx/README.html" target="_top"><code class="filename">print/lyx</code></a> package needs to
	be able to execute the latex binary from the teTeX package
	when it runs, and that is specified:</p>
<pre class="programlisting">
DEPENDS+=        teTeX-[0-9]*:../../print/teTeX
	</pre>
</li>
<li class="listitem">
<p>You can use wildcards in package dependencies. Note that
	such wildcard dependencies are retained when creating binary
	packages. The dependency is checked when installing the binary
	package and any package which matches the pattern will be
	used. Wildcard dependencies should be used with care.</p>
<p>The <span class="quote">&#8220;<span class="quote">-[0-9]*</span>&#8221;</span> should be used instead of
	<span class="quote">&#8220;<span class="quote">-*</span>&#8221;</span> to avoid potentially ambiguous matches
	such as <span class="quote">&#8220;<span class="quote">tk-postgresql</span>&#8221;</span> matching a
	<span class="quote">&#8220;<span class="quote">tk-*</span>&#8221;</span> <code class="varname">DEPENDS</code>.</p>
<p>Wildcards can also be used to specify that a package
	will only build against a certain minimum version of a
	pre-requisite:</p>
<pre class="programlisting">
DEPENDS+=       ImageMagick&gt;=6.0:../../graphics/ImageMagick
	</pre>
<p>This means that the package will build using version 6.0
	of ImageMagick or newer. Such a dependency may be warranted
	if, for example, the command line options of an executable
	have changed.</p>
<p>If you need to depend on minimum versions of libraries,
	see the buildlink section of the pkgsrc guide.</p>
<p>For security fixes, please update the package
	vulnerabilities file. See <a class="xref" href="fixes.html#security-handling" title="19.1.10. Handling packages with security problems">Section 19.1.10, &#8220;Handling packages with security problems&#8221;</a> for more
	information.</p>
</li>
</ol></div>
<p>If your package needs files from another package to build,
    add the relevant distribution files to
    <code class="varname">DISTFILES</code>, so they will be extracted
    automatically. See the <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/print/ghostscript/README.html" target="_top"><code class="filename">print/ghostscript</code></a> package for an example.
    (It relies on the jpeg sources being present in source form
    during the build.)</p>
</div>
<div class="sect2" title="19.1.7. Handling conflicts with other packages">
<div class="titlepage"><div><div><h3 class="title">
<a name="conflicts"></a>19.1.7. Handling conflicts with other packages</h3></div></div></div>
<p>Your package may conflict with other packages a user might
    already have installed on his system, e.g. if your package
    installs the same set of files as another package in the pkgsrc
    tree.</p>
<p>In this case you can set <code class="varname">CONFLICTS</code> to a
    space-separated list of packages (including version string) your
    package conflicts with.</p>
<p>For example, <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/x11/Xaw3d/README.html" target="_top"><code class="filename">x11/Xaw3d</code></a>
    and <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/x11/Xaw-Xpm/README.html" target="_top"><code class="filename">x11/Xaw-Xpm</code></a>
    install the same shared library, thus you set in
    <code class="filename">pkgsrc/x11/Xaw3d/Makefile</code>:</p>
<pre class="programlisting">
CONFLICTS=      Xaw-Xpm-[0-9]*
    </pre>
<p>and in <code class="filename">pkgsrc/x11/Xaw-Xpm/Makefile</code>:</p>
<pre class="programlisting">
CONFLICTS=      Xaw3d-[0-9]*
    </pre>
<p>Packages will automatically conflict with other packages
    with the name prefix and a different version
    string. <span class="quote">&#8220;<span class="quote">Xaw3d-1.5</span>&#8221;</span> e.g. will automatically
    conflict with the older version <span class="quote">&#8220;<span class="quote">Xaw3d-1.3</span>&#8221;</span>.</p>
</div>
<div class="sect2" title="19.1.8. Packages that cannot or should not be built">
<div class="titlepage"><div><div><h3 class="title">
<a name="not-building-packages"></a>19.1.8. Packages that cannot or should not be built</h3></div></div></div>
<p>There are several reasons why a package might be
    instructed to not build under certain circumstances.  If the
    package builds and runs on most platforms, the exceptions
    should be noted with <code class="varname">NOT_FOR_PLATFORM</code>.  If
    the package builds and runs on a small handful of platforms,
    set <code class="varname">ONLY_FOR_PLATFORM</code> instead.
    Both <code class="varname">ONLY_FOR_PLATFORM</code> and
    <code class="varname">NOT_FOR_PLATFORM</code> are OS triples
    (OS-version-platform) that can use glob-style
    wildcards.</p>
<p>Some packages are tightly bound to a specific version of an
    operating system, e.g. LKMs or <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/sysutils/lsof/README.html" target="_top"><code class="filename">sysutils/lsof</code></a>.  Such binary packages are not
    backwards compatible with other versions of the OS, and should be
    uploaded to a version specific directory on the FTP server.  Mark
    these packages by setting <code class="varname">OSVERSION_SPECIFIC</code> to
    <span class="quote">&#8220;<span class="quote">yes</span>&#8221;</span>.  This variable is not currently used by any of
    the package system internals, but may be used in the
    future.</p>
<p>If the package should be skipped (for example, because it
    provides functionality already provided by the system), set
    <code class="varname">PKG_SKIP_REASON</code> to a descriptive message.  If
    the package should fail because some preconditions are not met,
    set <code class="varname">PKG_FAIL_REASON</code> to a descriptive
    message.</p>
</div>
<div class="sect2" title="19.1.9. Packages which should not be deleted, once installed">
<div class="titlepage"><div><div><h3 class="title">
<a name="undeletable-packages"></a>19.1.9. Packages which should not be deleted, once installed</h3></div></div></div>
<p>To ensure that a package may not be deleted, once it has been
    installed, the <code class="varname">PKG_PRESERVE</code> definition should
    be set in the package Makefile. This will be carried into any
    binary package that is made from this pkgsrc entry. A
    <span class="quote">&#8220;<span class="quote">preserved</span>&#8221;</span> package will
    not be deleted using <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?pkg_delete+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">pkg_delete</span>(1)</span></a> unless the
    <span class="quote">&#8220;<span class="quote">-f</span>&#8221;</span> option is used.</p>
</div>
<div class="sect2" title="19.1.10. Handling packages with security problems">
<div class="titlepage"><div><div><h3 class="title">
<a name="security-handling"></a>19.1.10. Handling packages with security problems</h3></div></div></div>
<p>When a vulnerability is found, this should be noted in
    <code class="filename">localsrc/security/advisories/pkg-vulnerabilities</code>,
    and after committing that file, use <span class="command"><strong>make upload</strong></span>
    in the same directory to update the file on ftp.NetBSD.org.</p>
<p>After fixing the vulnerability by a patch, its
    <code class="varname">PKGREVISION</code> should be increased (this
    is of course not necessary if the problem is fixed by using
    a newer release of the software).</p>
<p>Also, if the fix should be applied to the stable pkgsrc
    branch, be sure to submit a pullup request!</p>
<p>Binary packages already on ftp.NetBSD.org will be handled
    semi-automatically by a weekly cron job.</p>
</div>
<div class="sect2" title="19.1.11. How to handle incrementing versions when fixing an existing package">
<div class="titlepage"><div><div><h3 class="title">
<a name="bumping-pkgrevision"></a>19.1.11. How to handle incrementing versions when fixing an existing package</h3></div></div></div>
<p>When making fixes to an existing package it can be useful
    to change the version number in <code class="varname">PKGNAME</code>. To
    avoid conflicting with future versions by the original author, a
    <span class="quote">&#8220;<span class="quote">nb1</span>&#8221;</span>, <span class="quote">&#8220;<span class="quote">nb2</span>&#8221;</span>, ... suffix can be used
    on package versions by setting <code class="varname">PKGREVISION=1</code>
    (2, ...). The <span class="quote">&#8220;<span class="quote">nb</span>&#8221;</span> is treated like a
    <span class="quote">&#8220;<span class="quote">.</span>&#8221;</span> by the package tools. e.g.</p>
<pre class="programlisting">
DISTNAME=       foo-17.42
PKGREVISION=    9
    </pre>
<p>will result in a <code class="varname">PKGNAME</code> of
    <span class="quote">&#8220;<span class="quote">foo-17.42nb9</span>&#8221;</span>. If you want to use the original
    value of <code class="varname">PKGNAME</code> without the <span class="quote">&#8220;<span class="quote">nbX</span>&#8221;</span>
    suffix, e.g. for setting <code class="varname">DIST_SUBDIR</code>, use
    <code class="varname">PKGNAME_NOREV</code>.</p>
<p>When a new release of the package is released, the
    <code class="varname">PKGREVISION</code> should be removed, e.g. on a new
    minor release of the above package, things should be like:</p>
<pre class="programlisting">
DISTNAME=       foo-17.43
    </pre>
<p><code class="varname">PKGREVISION</code> should be incremented for any
    non-trivial change in the resulting binary package.  Without a
    <code class="varname">PKGREVISION</code> bump, someone with the previous
    version installed has no way of knowing that their package is out
    of date.  Thus, changes without increasing
    <code class="varname">PKGREVISION</code> are essentially labeled "this is so
    trivial that no reasonable person would want to upgrade", and this
    is the rough test for when increasing
    <code class="varname">PKGREVISION</code> is appropriate.  Examples of
    changes that do not merit increasing
    <code class="varname">PKGREVISION</code> are:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Changing <code class="varname">HOMEPAGE</code>,
      <code class="varname">MAINTAINER</code>, <code class="varname">OWNER</code>,
      or comments in Makefile.</p></li>
<li class="listitem"><p>
      Changing build variables if the resulting binary package is the same.</p></li>
<li class="listitem"><p>
      Changing <code class="filename">DESCR</code>.</p></li>
<li class="listitem"><p>
      Adding <code class="varname">PKG_OPTIONS</code> if the default options don't change.</p></li>
</ul></div>
<p>Examples of changes that do merit an increase to
    <code class="varname">PKGREVISION</code> include:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>
      Security fixes</p></li>
<li class="listitem"><p>
      Changes or additions to a patch file</p></li>
<li class="listitem"><p>
      Changes to the <code class="filename">PLIST</code></p></li>
<li class="listitem"><p>A dependency is changed or renamed.</p></li>
</ul></div>
<p>PKGREVISION must also be incremented when dependencies have ABI
    changes.</p>
</div>
<div class="sect2" title="19.1.12. Substituting variable text in the package files (the SUBST framework)">
<div class="titlepage"><div><div><h3 class="title">
<a name="fixes.subst"></a>19.1.12. Substituting variable text in the package files (the SUBST framework)</h3></div></div></div>
<p>When you want to replace the same text in multiple files
    or when the replacement text varies, patches alone cannot help.
    This is where the SUBST framework comes in. It provides an
    easy-to-use interface for replacing text in files.
    Example:</p>
<pre class="programlisting">
SUBST_CLASSES+=                 fix-paths
SUBST_STAGE.fix-paths=          pre-configure
SUBST_MESSAGE.fix-paths=        Fixing absolute paths.
SUBST_FILES.fix-paths=          src/*.c
SUBST_FILES.fix-paths+=         scripts/*.sh
SUBST_SED.fix-paths=            -e 's,"/usr/local,"${PREFIX},g'
SUBST_SED.fix-paths+=           -e 's,"/var/log,"${VARBASE}/log,g'
    </pre>
<p><code class="varname">SUBST_CLASSES</code> is a list of identifiers
    that are used to identify the different SUBST blocks that are
    defined. The SUBST framework is heavily used by pkgsrc, so it is
    important to always use the <code class="literal">+=</code> operator with
    this variable. Otherwise some substitutions may be
    skipped.</p>
<p>The remaining variables of each SUBST block are
    parameterized with the identifier from the first line
    (<code class="literal">fix-paths</code> in this case.) They can be seen as
    parameters to a function call.</p>
<p><code class="varname">SUBST_STAGE.*</code> specifies the stage at
    which the replacement will take place. All combinations of
    <code class="literal">pre-</code>, <code class="literal">do-</code> and
    <code class="literal">post-</code> together with a phase name are
    possible, though only few are actually used. Most commonly used
    are <code class="literal">post-patch</code> and
    <code class="literal">pre-configure</code>. Of these two,
    <code class="literal">pre-configure</code> should be preferred because
    then it is possible to run <span class="command"><strong>bmake patch</strong></span> and
    have the state after applying the patches but before making any
    other changes. This is especially useful when you are debugging
    a package in order to create new patches for it. Similarly,
    <code class="literal">post-build</code> is preferred over
    <code class="literal">pre-install</code>, because the install phase should
    generally be kept as simple as possible. When you use
    <code class="literal">post-build</code>, you have the same files in the
    working directory that will be installed later, so you can check
    if the substitution has succeeded.</p>
<p><code class="varname">SUBST_MESSAGE.*</code> is an optional text
    that is printed just before the substitution is done.</p>
<p><code class="varname">SUBST_FILES.*</code> is the list of shell
    globbing patterns that specifies the files in which the
    substitution will take place. The patterns are interpreted
    relatively to the <code class="varname">WRKSRC</code> directory.</p>
<p><code class="varname">SUBST_SED.*</code> is a list of arguments to
    <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?sed+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">sed</span>(1)</span></a> that specify the actual substitution. Every sed
    command should be prefixed with <code class="literal">-e</code>, so that
    all SUBST blocks look uniform.</p>
<p>There are some more variables, but they are so seldomly
    used that they are only documented in the
    <code class="filename">mk/subst.mk</code> file.</p>
</div>
</div>
<div class="sect1" title="19.2. Fixing problems in the fetch phase">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="fixes.fetch"></a>19.2. Fixing problems in the <span class="emphasis"><em>fetch</em></span> phase</h2></div></div></div>
<div class="sect2" title="19.2.1. Packages whose distfiles aren't available for plain downloading">
<div class="titlepage"><div><div><h3 class="title">
<a name="no-plain-download"></a>19.2.1. Packages whose distfiles aren't available for plain downloading</h3></div></div></div>
<p>If you need to download from a dynamic URL you can set
    <code class="varname">DYNAMIC_MASTER_SITES</code> and a <span class="command"><strong>make
    fetch</strong></span> will call <code class="filename">files/getsite.sh</code>
    with the name of each file to download as an argument, expecting
    it to output the URL of the directory from which to download
    it. <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/graphics/ns-cult3d/README.html" target="_top"><code class="filename">graphics/ns-cult3d</code></a> is an
    example of this usage.</p>
<p>If the download can't be automated, because the user must
    submit personal information to apply for a password, or must pay
    for the source, or whatever, you can set
    <code class="varname">FETCH_MESSAGE</code> to a list of lines that are
    displayed to the user before aborting the build. Example:</p>
<pre class="programlisting">
FETCH_MESSAGE=  "Please download the files"
FETCH_MESSAGE+= "    "${DISTFILES:Q}
FETCH_MESSAGE+= "manually from "${MASTER_SITES:Q}"."
    </pre>
</div>
<div class="sect2" title="19.2.2. How to handle modified distfiles with the 'old' name">
<div class="titlepage"><div><div><h3 class="title">
<a name="modified-distfiles-same-name"></a>19.2.2. How to handle modified distfiles with the 'old' name</h3></div></div></div>
<p>Sometimes authors of a software package make some
    modifications after the software was released, and they put up a
    new distfile without changing the package's version number. If a
    package is already in pkgsrc at that time, the checksum will
    no longer match. The contents of the new distfile should be
    compared against the old one before changing anything, to make
    sure the distfile was really updated on purpose, and that
    no trojan horse or so crept in.
    Please mention that the distfiles were compared and what was found
    in your commit message.
    Then, the correct way to work around this is to
    set <code class="varname">DIST_SUBDIR</code> to a unique directory name,
    usually based on <code class="varname">PKGNAME_NOREV</code>. All
    <code class="varname">DISTFILES</code> and
    <code class="varname">PATCHFILES</code> for this package will be put in that
    subdirectory of the local distfiles directory.
    (See <a class="xref" href="fixes.html#bumping-pkgrevision" title="19.1.11. How to handle incrementing versions when fixing an existing package">Section 19.1.11, &#8220;How to handle incrementing versions when fixing an existing package&#8221;</a> for more details.)
    In case this
    happens more often, <code class="varname">PKGNAME</code> can be used (thus
    including the <code class="filename">nbX</code> suffix) or a date stamp
    can be appended, like <code class="varname">${PKGNAME_NOREV}-YYYYMMDD</code>.
    Do not forget regenerating the <code class="filename">distinfo</code> file
    after that, since it contains the <code class="varname">DIST_SUBDIR</code>
    path in the filenames.
    Also increase the PKGREVISION if the installed package is different.
    Furthermore, a mail to the package's authors seems appropriate
    telling them that changing distfiles after releases without
    changing the file names is not good practice.</p>
</div>
</div>
<div class="sect1" title="19.3. Fixing problems in the configure phase">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="fixes.configure"></a>19.3. Fixing problems in the <span class="emphasis"><em>configure</em></span> phase</h2></div></div></div>
<div class="sect2" title="19.3.1. Shared libraries - libtool">
<div class="titlepage"><div><div><h3 class="title">
<a name="fixes.libtool"></a>19.3.1. Shared libraries - libtool</h3></div></div></div>
<p>pkgsrc supports many different machines, with different
    object formats like a.out and ELF, and varying abilities to do
    shared library and dynamic loading at all. To accompany this,
    varying commands and options have to be passed to the
    compiler, linker, etc. to get the Right Thing, which can be
    pretty annoying especially if you don't have all the machines
    at your hand to test things.  The
    <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/devel/libtool/README.html" target="_top"><code class="filename">devel/libtool</code></a> pkg
    can help here, as it just <span class="quote">&#8220;<span class="quote">knows</span>&#8221;</span> how to build
    both static and dynamic libraries from a set of source files,
    thus being platform-independent.</p>
<p>Here's how to use libtool in a package in seven simple
    steps:</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>Add <code class="varname">USE_LIBTOOL=yes</code> to the package
	Makefile.</p></li>
<li class="listitem"><p>For library objects, use <span class="quote">&#8220;<span class="quote">${LIBTOOL} --mode=compile
	${CC}</span>&#8221;</span> in place of <span class="quote">&#8220;<span class="quote">${CC}</span>&#8221;</span>. You could even
	add it to the definition of <code class="varname">CC</code>, if only
	libraries are being built in a given Makefile. This one command
	will build both PIC and non-PIC library objects, so you need not
	have separate shared and non-shared library rules.</p></li>
<li class="listitem">
<p>For the linking of the library, remove any
	<span class="quote">&#8220;<span class="quote">ar</span>&#8221;</span>, <span class="quote">&#8220;<span class="quote">ranlib</span>&#8221;</span>, and <span class="quote">&#8220;<span class="quote">ld
	-Bshareable</span>&#8221;</span> commands, and instead use:</p>
<pre class="programlisting">
${LIBTOOL} --mode=link \
    ${CC} -o ${.TARGET:.a=.la} \
        ${OBJS:.o=.lo} \
        -rpath ${PREFIX}/lib \
        -version-info major:minor
	</pre>
<p>Note that the library is changed to have a
	<code class="filename">.la</code> extension, and the objects are
	changed to have a <code class="filename">.lo</code>
	extension. Change <code class="varname">OBJS</code> as
	necessary. This automatically creates all of the
	<code class="filename">.a</code>,
	<code class="filename">.so.major.minor</code>, and ELF symlinks (if
	necessary) in the build directory. Be sure to include
	<span class="quote">&#8220;<span class="quote">-version-info</span>&#8221;</span>, especially when major and
	minor are zero, as libtool will otherwise strip off the
	shared library version.</p>
<p>From the libtool manual:</p>
<pre class="programlisting">
So, libtool library versions are described by three integers:

CURRENT
The most recent interface number that this library implements.

REVISION
The implementation number of the CURRENT interface.

AGE
The difference between the newest and oldest interfaces that
this library implements.  In other words, the library implements
all the interface numbers in the range from number `CURRENT -
AGE' to `CURRENT'.

If two libraries have identical CURRENT and AGE numbers, then the
dynamic linker chooses the library with the greater REVISION number.
	</pre>
<p>The <span class="quote">&#8220;<span class="quote">-release</span>&#8221;</span> option will produce
	different results for a.out and ELF (excluding symlinks)
	in only one case. An ELF library of the form
	<span class="quote">&#8220;<span class="quote">libfoo-release.so.<span class="emphasis"><em>x</em></span>.<span class="emphasis"><em>y</em></span></span>&#8221;</span>
	will have a symlink of
	<span class="quote">&#8220;<span class="quote">libfoo.so.<span class="emphasis"><em>x</em></span>.<span class="emphasis"><em>y</em></span></span>&#8221;</span>
	on an a.out platform. This is handled
	automatically.</p>
<p>The <span class="quote">&#8220;<span class="quote">-rpath argument</span>&#8221;</span> is the install
	directory of the library being built.</p>
<p>In the <code class="filename">PLIST</code>, include only the
	<code class="filename">.la</code> file, the other files will be
	added automatically.</p>
</li>
<li class="listitem">
<p>When linking shared object (<code class="filename">.so</code>)
	files, i.e. files that are loaded via <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?dlopen+3+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">dlopen</span>(3)</span></a>, NOT
	shared libraries, use <span class="quote">&#8220;<span class="quote">-module
	-avoid-version</span>&#8221;</span> to prevent them getting version
	tacked on.</p>
<p>The <code class="filename">PLIST</code> file gets the
	<code class="filename">foo.so</code> entry.</p>
</li>
<li class="listitem">
<p>When linking programs that depend on these libraries
	<span class="emphasis"><em>before</em></span> they are installed, preface
	the <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?cc+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">cc</span>(1)</span></a> or <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?ld+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">ld</span>(1)</span></a> line with <span class="quote">&#8220;<span class="quote">${LIBTOOL}
	--mode=link</span>&#8221;</span>, and it will find the correct
	libraries (static or shared), but please be aware that
	libtool will not allow you to specify a relative path in
	-L (such as <span class="quote">&#8220;<span class="quote">-L../somelib</span>&#8221;</span>), because it
	expects you to change that argument to be the
	<code class="filename">.la</code> file. e.g.</p>
<pre class="programlisting">
${LIBTOOL} --mode=link ${CC} -o someprog -L../somelib -lsomelib
	</pre>
<p>should be changed to:</p>
<pre class="programlisting">
${LIBTOOL} --mode=link ${CC} -o <em class="replaceable"><code>someprog</code></em> <em class="replaceable"><code>../somelib/somelib.la</code></em>
	</pre>
<p>and it will do the right thing with the libraries.</p>
</li>
<li class="listitem">
<p>When installing libraries, preface the <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?install+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">install</span>(1)</span></a>
	or <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?cp+1+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">cp</span>(1)</span></a> command with <span class="quote">&#8220;<span class="quote">${LIBTOOL}
	--mode=install</span>&#8221;</span>, and change the library name to
	<code class="filename">.la</code>. e.g.</p>
<pre class="programlisting">
${LIBTOOL} --mode=install ${BSD_INSTALL_LIB} ${SOMELIB:.a=.la} ${PREFIX}/lib
	</pre>
<p>This will install the static <code class="filename">.a</code>,
	shared library, any needed symlinks, and run
	<a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?ldconfig+8+NetBSD-current"><span class="citerefentry"><span class="refentrytitle">ldconfig</span>(8)</span></a>.</p>
</li>
<li class="listitem"><p>In your <code class="filename">PLIST</code>, include only
	the <code class="filename">.la</code>
	file (this is a change from previous behaviour).</p></li>
</ol></div>
</div>
<div class="sect2" title="19.3.2. Using libtool on GNU packages that already support libtool">
<div class="titlepage"><div><div><h3 class="title">
<a name="using-libtool"></a>19.3.2. Using libtool on GNU packages that already support libtool</h3></div></div></div>
<p>Add <code class="varname">USE_LIBTOOL=yes</code> to the
    package Makefile. This will override the package's own libtool
    in most cases.  For older libtool using packages,  libtool is
    made by ltconfig script during the do-configure step; you can
    check the libtool script location by doing <span class="command"><strong>make
    configure; find work*/ -name libtool</strong></span>.</p>
<p><code class="varname">LIBTOOL_OVERRIDE</code> specifies which libtool
    scripts, relative to <code class="varname">WRKSRC</code>, to override.  By
    default, it is set to <span class="quote">&#8220;<span class="quote">libtool */libtool
    */*/libtool</span>&#8221;</span>.  If this does not match the location of the
    package's libtool script(s), set it as appropriate.</p>
<p>If you do not need <code class="filename">*.a</code> static
    libraries built and installed, then use
    <code class="varname">SHLIBTOOL_OVERRIDE</code> instead.</p>
<p>If your package makes use of the platform-independent library
    for loading dynamic shared objects, that comes with libtool
    (libltdl), you should include devel/libltdl/buildlink3.mk.</p>
<p>Some packages use libtool incorrectly so that the package
    may not work or build in some circumstances. Some of the more
    common errors are:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem">
<p>The inclusion of a shared object (-module) as a dependent library in an
	executable or library. This in itself isn't a problem if one of two things
	has been done:</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>The shared object is named correctly, i.e.
	    <code class="filename">libfoo.la</code>, not
	    <code class="filename">foo.la</code></p></li>
<li class="listitem"><p>The -dlopen option is used when linking an executable.</p></li>
</ol></div>
</li>
<li class="listitem"><p>The use of libltdl without the correct calls to initialisation routines.
	The function lt_dlinit() should be called and the macro
	<code class="varname">LTDL_SET_PRELOADED_SYMBOLS</code> included in
	executables.</p></li>
</ul></div>
</div>
<div class="sect2" title="19.3.3. GNU Autoconf/Automake">
<div class="titlepage"><div><div><h3 class="title">
<a name="autoconf-automake"></a>19.3.3. GNU Autoconf/Automake</h3></div></div></div>
<p>If a package needs GNU autoconf or automake to be executed
    to regenerate the configure script and Makefile.in makefile
    templates, then they should be executed in a pre-configure
    target.</p>
<p>For packages that need only autoconf:</p>
<pre class="programlisting">
AUTOCONF_REQD=  2.50            # if default version is not good enough
USE_TOOLS+=     autoconf        # use "autoconf213" for autoconf-2.13
...

pre-configure:
        cd ${WRKSRC} &amp;&amp; autoconf

...
    </pre>
<p>and for packages that need automake and autoconf:</p>
<pre class="programlisting">
AUTOMAKE_REQD=  1.7.1           # if default version is not good enough
USE_TOOLS+=     automake        # use "automake14" for automake-1.4
...

pre-configure:
        set -e; cd ${WRKSRC}; \
        aclocal; autoheader; automake -a --foreign -i; autoconf

...
    </pre>
<p>Packages which use GNU Automake will almost certainly
    require GNU Make.</p>
<p>There are times when the configure process makes
    additional changes to the generated files, which then causes
    the build process to try to re-execute the automake sequence.
    This is prevented by touching various files in the configure
    stage. If this causes problems with your package you can set
    <code class="varname">AUTOMAKE_OVERRIDE=NO</code> in the package
    Makefile.</p>
</div>
</div>
<div class="sect1" title="19.4. Programming languages">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="programming-languages"></a>19.4. Programming languages</h2></div></div></div>
<div class="sect2" title="19.4.1. C, C++, and Fortran">
<div class="titlepage"><div><div><h3 class="title">
<a name="basic-programming-languages"></a>19.4.1. C, C++, and Fortran</h3></div></div></div>
<p>Compilers for the C, C++, and Fortran languages comes with
    the NetBSD base system.  By default, pkgsrc assumes that a package
    is written in C and will hide all other compilers (via the wrapper
    framework, see <a class="xref" href="buildlink.html" title="Chapter 14. Buildlink methodology">Chapter 14, <i>Buildlink methodology</i></a>).</p>
<p>To declare which language's compiler a package needs, set
    the <code class="varname">USE_LANGUAGES</code> variable. Allowed values
    currently are <span class="quote">&#8220;<span class="quote">c</span>&#8221;</span>, <span class="quote">&#8220;<span class="quote">c++</span>&#8221;</span>, and
    <span class="quote">&#8220;<span class="quote">fortran</span>&#8221;</span> (and any combination).  The default is
    <span class="quote">&#8220;<span class="quote">c</span>&#8221;</span>.  Packages using GNU configure scripts, even if
    written in C++, usually need a C compiler for the configure
    phase.</p>
</div>
<div class="sect2" title="19.4.2. Java">
<div class="titlepage"><div><div><h3 class="title">
<a name="java-programming-language"></a>19.4.2. Java</h3></div></div></div>
<p>If a program is written in Java, use the Java framework in
    pkgsrc.  The package must include
    <code class="filename">../../mk/java-vm.mk</code>.  This Makefile fragment
    provides the following variables:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p><code class="varname">USE_JAVA</code> defines if a build
      dependency on the JDK is added.  If
      <code class="varname">USE_JAVA</code> is set to <span class="quote">&#8220;<span class="quote">run</span>&#8221;</span>, then
      there is only a runtime dependency on the JDK.  The default is
      <span class="quote">&#8220;<span class="quote">yes</span>&#8221;</span>, which also adds a build dependency on the
      JDK.</p></li>
<li class="listitem"><p>Set <code class="varname">USE_JAVA2</code> to declare that
      a package needs a Java2 implementation.  The supported values
      are <span class="quote">&#8220;<span class="quote">yes</span>&#8221;</span>, <span class="quote">&#8220;<span class="quote">1.4</span>&#8221;</span>, and
      <span class="quote">&#8220;<span class="quote">1.5</span>&#8221;</span>.  <span class="quote">&#8220;<span class="quote">yes</span>&#8221;</span> accepts any Java2
      implementation, <span class="quote">&#8220;<span class="quote">1.4</span>&#8221;</span> insists on versions 1.4 or
      above, and <span class="quote">&#8220;<span class="quote">1.5</span>&#8221;</span> only accepts versions 1.5 or
      above. This variable is not set by default.</p></li>
<li class="listitem"><p><code class="varname">PKG_JAVA_HOME</code> is
      automatically set to the runtime location of the used Java
      implementation dependency. It may be used to set
      <code class="varname">JAVA_HOME</code> to a good value if the program
      needs this variable to be defined.
      </p></li>
</ul></div>
</div>
<div class="sect2" title="19.4.3. Packages containing perl scripts">
<div class="titlepage"><div><div><h3 class="title">
<a name="perl-scripts"></a>19.4.3. Packages containing perl scripts</h3></div></div></div>
<p>If your package contains interpreted perl scripts, add
    <span class="quote">&#8220;<span class="quote">perl</span>&#8221;</span> to the <code class="varname">USE_TOOLS</code> variable
    and set <code class="varname">REPLACE_PERL</code> to ensure that the proper
    interpreter path is set. <code class="varname">REPLACE_PERL</code> should
    contain a list of scripts, relative to <code class="varname">WRKSRC</code>,
    that you want adjusted.  Every occurrence of
    <code class="filename">*/bin/perl</code> will be replaced with the full
    path to the perl executable.</p>
<p>If a particular version of perl is needed, set the
    <code class="varname">PERL5_REQD</code> variable to the version number.  The
    default is <span class="quote">&#8220;<span class="quote">5.0</span>&#8221;</span>.</p>
<p>See <a class="xref" href="fixes.html#perl-modules" title="19.6.6. Packages installing perl modules">Section 19.6.6, &#8220;Packages installing perl modules&#8221;</a> for information
    about handling perl modules.</p>
</div>
<div class="sect2" title="19.4.4. Other programming languages">
<div class="titlepage"><div><div><h3 class="title">
<a name="other-programming-languages"></a>19.4.4. Other programming languages</h3></div></div></div>
<p>Currently, there is no special handling for other languages
    in pkgsrc.  If a compiler package provides a
    <code class="filename">buildlink3.mk</code> file, include that, otherwise
    just add a (build) dependency on the appropriate compiler
    package.</p>
</div>
</div>
<div class="sect1" title="19.5. Fixing problems in the build phase">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="fixes.build"></a>19.5. Fixing problems in the <span class="emphasis"><em>build</em></span> phase</h2></div></div></div>
<p>The most common failures when building a package are that
	some platforms do not provide certain header files, functions or
	libraries, or they provide the functions in a library that the
	original package author didn't know. To work around this, you
	can rewrite the source code in most cases so that it does not
	use the missing functions or provides a replacement function.</p>
<div class="sect2" title="19.5.1. Compiling C and C++ code conditionally">
<div class="titlepage"><div><div><h3 class="title">
<a name="fixes.build.cpp"></a>19.5.1. Compiling C and C++ code conditionally</h3></div></div></div>
<p>If a package already comes with a GNU configure script, the
	preferred way to fix the build failure is to change the
	configure script, not the code. In the other cases, you can
	utilize the C preprocessor, which defines certain macros
	depending on the operating system and hardware architecture it
	compiles for. These macros can be queried using for example
	<code class="varname">#if defined(__i386)</code>. Almost every operating
	system, hardware architecture and compiler has its own macro.
	For example, if the macros <code class="varname">__GNUC__</code>,
	<code class="varname">__i386__</code> and <code class="varname">__NetBSD__</code>
	are all defined, you know that you are using NetBSD on an i386
	compatible CPU, and your compiler is GCC.</p>
<p>The list of the following macros for hardware and
	operating system depends on the compiler that is used. For
	example, if you want to conditionally compile code on Solaris,
	don't use <code class="varname">__sun__</code>, as the SunPro compiler
	does not define it. Use <code class="varname">__sun</code> instead.</p>
<div class="sect3" title="19.5.1.1. C preprocessor macros to identify the operating system">
<div class="titlepage"><div><div><h4 class="title">
<a name="fixes.build.cpp.os"></a>19.5.1.1. C preprocessor macros to identify the operating system</h4></div></div></div>
<p>To distinguish between 4.4 BSD-derived systems and the
        rest of the world, you should use the following code.</p>
<pre class="programlisting">
#include &lt;sys/param.h&gt;
#if (defined(BSD) &amp;&amp; BSD &gt;= 199306)
/* BSD-specific code goes here */
#else
/* non-BSD-specific code goes here */
#endif
</pre>
<p>If this distinction is not fine enough, you can also test
	for the following macros.</p>
<pre class="programlisting">
FreeBSD     __FreeBSD__
DragonFly   __DragonFly__
Interix     __INTERIX
IRIX        __sgi (TODO: get a definite source for this)
Linux       linux, __linux, __linux__
NetBSD      __NetBSD__
OpenBSD     __OpenBSD__
Solaris     sun, __sun
</pre>
</div>
<div class="sect3" title="19.5.1.2. C preprocessor macros to identify the hardware architecture">
<div class="titlepage"><div><div><h4 class="title">
<a name="fixes.build.cpp.arch"></a>19.5.1.2. C preprocessor macros to identify the hardware architecture</h4></div></div></div>
<pre class="programlisting">
i386        i386, __i386, __i386__
MIPS        __mips
SPARC       sparc, __sparc
</pre>
</div>
<div class="sect3" title="19.5.1.3. C preprocessor macros to identify the compiler">
<div class="titlepage"><div><div><h4 class="title">
<a name="fixes.build.cpp.compiler"></a>19.5.1.3. C preprocessor macros to identify the compiler</h4></div></div></div>
<pre class="programlisting">
GCC         __GNUC__ (major version), __GNUC_MINOR__
MIPSpro     _COMPILER_VERSION (0x741 for MIPSpro 7.41)
SunPro      __SUNPRO_C (0x570 for Sun C 5.7)
SunPro C++  __SUNPRO_CC (0x580 for Sun C++ 5.8)
</pre>
</div>
</div>
<div class="sect2" title="19.5.2. How to handle compiler bugs">
<div class="titlepage"><div><div><h3 class="title">
<a name="compiler-bugs"></a>19.5.2. How to handle compiler bugs</h3></div></div></div>
<p>Some source files trigger bugs in the compiler, based on
        combinations of compiler version and architecture and almost
        always relation to optimisation being enabled.  Common symptoms
        are gcc internal errors or never finishing compiling a
	file.</p>
<p>Typically, a workaround involves testing the
        <code class="varname">MACHINE_ARCH</code> and compiler version, disabling
        optimisation for that combination of file,
	<code class="varname">MACHINE_ARCH</code> and compiler, and documenting it
	in <code class="filename">pkgsrc/doc/HACKS</code>. See that file for a
	number of examples.</p>
</div>
<div class="sect2" title="19.5.3. Undefined reference to &#8220;...&#8221;">
<div class="titlepage"><div><div><h3 class="title">
<a name="undefined-reference"></a>19.5.3. Undefined reference to <span class="quote">&#8220;<span class="quote">...</span>&#8221;</span>
</h3></div></div></div>
<p>This error message often means that a package did not
	link to a shared library it needs. The following functions are
	known to cause this error message over and over.</p>
<div class="informaltable">
<a name="undefined-reference-functions"></a><table border="1">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead><tr>
<th>Function</th>
<th>Library</th>
<th>Affected platforms</th>
</tr></thead>
<tbody>
<tr>
<td>accept, bind, connect</td>
<td>-lsocket</td>
<td>Solaris</td>
</tr>
<tr>
<td>crypt</td>
<td>-lcrypt</td>
<td>DragonFly, NetBSD</td>
</tr>
<tr>
<td>dlopen, dlsym</td>
<td>-ldl</td>
<td>Linux</td>
</tr>
<tr>
<td>gethost*</td>
<td>-lnsl</td>
<td>Solaris</td>
</tr>
<tr>
<td>inet_aton</td>
<td>-lresolv</td>
<td>Solaris</td>
</tr>
<tr>
<td>nanosleep, sem_*, timer_*</td>
<td>-lrt</td>
<td>Solaris</td>
</tr>
<tr>
<td>openpty</td>
<td>-lutil</td>
<td>Linux</td>
</tr>
</tbody>
</table>
</div>
<p>To fix these linker errors, it is often sufficient to say
    <code class="literal">LIBS.<em class="replaceable"><code>OperatingSystem</code></em>+=
    -l<em class="replaceable"><code>foo</code></em></code> to the package
    <code class="filename">Makefile</code> and then say <span class="command"><strong>bmake clean;
    bmake</strong></span>.</p>
<div class="sect3" title="19.5.3.1. Special issue: The SunPro compiler">
<div class="titlepage"><div><div><h4 class="title">
<a name="undefined-reference-sunpro"></a>19.5.3.1. Special issue: The SunPro compiler</h4></div></div></div>
<p>When you are using the SunPro compiler, there is another
possibility. That compiler cannot handle the following code:</p>
<pre class="programlisting">
extern int extern_func(int);

static inline int
inline_func(int x)
{
        return extern_func(x);
}

int main(void)
{
        return 0;
}
</pre>
<p>It generates the code for <code class="function">inline_func</code> even if
that function is never used. This code then refers to
<code class="function">extern_func</code>, which can usually not be resolved. To
solve this problem you can try to tell the package to disable inlining
of functions.</p>
</div>
</div>
<div class="sect2" title="19.5.4. Running out of memory">
<div class="titlepage"><div><div><h3 class="title">
<a name="out-of-memory"></a>19.5.4. Running out of memory</h3></div></div></div>
<p>Sometimes packages fail to build because the compiler runs
    into an operating system specific soft limit.  With the
    <code class="varname">UNLIMIT_RESOURCES</code> variable pkgsrc can be told
    to unlimit the resources.  Currently, the allowed values are
    <span class="quote">&#8220;<span class="quote">datasize</span>&#8221;</span> and <span class="quote">&#8220;<span class="quote">stacksize</span>&#8221;</span> (or both).
    Setting this variable is similar to running the shell builtin
    <span class="command"><strong>ulimit</strong></span> command to raise the maximum data
    segment size or maximum stack size of a process, respectively, to
    their hard limits.</p>
</div>
</div>
<div class="sect1" title="19.6. Fixing problems in the install phase">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="fixes.install"></a>19.6. Fixing problems in the <span class="emphasis"><em>install</em></span> phase</h2></div></div></div>
<div class="sect2" title="19.6.1. Creating needed directories">
<div class="titlepage"><div><div><h3 class="title">
<a name="install-scripts"></a>19.6.1. Creating needed directories</h3></div></div></div>
<p>The BSD-compatible <span class="command"><strong>install</strong></span> supplied
    with some operating systems cannot create more than one
    directory at a time. As such, you should call
    <code class="literal">${INSTALL_*_DIR}</code> like this:</p>
<pre class="programlisting">
${INSTALL_DATA_DIR} ${PREFIX}/dir1
${INSTALL_DATA_DIR} ${PREFIX}/dir2
    </pre>
<p>You can also just append <span class="quote">&#8220;<span class="quote"><code class="literal">dir1
    dir2</code></span>&#8221;</span> to the
    <code class="varname">INSTALLATION_DIRS</code> variable, which will
    automatically do the right thing.</p>
</div>
<div class="sect2" title="19.6.2. Where to install documentation">
<div class="titlepage"><div><div><h3 class="title">
<a name="where-to-install-documentation"></a>19.6.2. Where to install documentation</h3></div></div></div>
<p>In general, documentation should be installed into
    <code class="filename">${PREFIX}/share/doc/${PKGBASE}</code> or
    <code class="filename">${PREFIX}/share/doc/${PKGNAME}</code> (the latter
    includes the version number of the package).</p>
<p>Many modern packages using GNU autoconf allow to set the
    directory where HTML documentation is installed with the
    <span class="quote">&#8220;<span class="quote">--with-html-dir</span>&#8221;</span> option. Sometimes using this flag
    is needed because otherwise the documentation ends up in
    <code class="filename">${PREFIX}/share/doc/html</code> or other
    places.</p>
<p>An exception to the above is that library API documentation
    generated with the <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/textproc/gtk-doc/README.html" target="_top"><code class="filename">textproc/gtk-doc</code></a> tools, for use by special
    browsers (devhelp) should be left at their default location, which
    is <code class="filename">${PREFIX}/share/gtk-doc</code>.  Such
    documentation can be recognized from files ending in
    <code class="filename">.devhelp</code> or <code class="filename">.devhelp2</code>.
    (It is also acceptable to install such files in
    <code class="filename">${PREFIX}/share/doc/${PKGBASE}</code> or
    <code class="filename">${PREFIX}/share/doc/${PKGNAME}</code>; the
    <code class="filename">.devhelp*</code> file must be directly in that
    directory then, no additional subdirectory level is allowed in
    this case. This is usually achieved by using
    <span class="quote">&#8220;<span class="quote">--with-html-dir=${PREFIX}/share/doc</span>&#8221;</span>.
    <code class="filename">${PREFIX}/share/gtk-doc</code> is preferred
    though.)</p>
</div>
<div class="sect2" title="19.6.3. Installing highscore files">
<div class="titlepage"><div><div><h3 class="title">
<a name="installing-score-files"></a>19.6.3. Installing highscore files</h3></div></div></div>
<p>Certain packages, most of them in the games category, install
    a score file that allows all users on the system to record their
    highscores.  In order for this to work, the binaries need to be
    installed setgid and the score files owned by the appropriate
    group and/or owner (traditionally the "games" user/group).  The
    following variables, documented in more detail in
    <code class="filename">mk/defaults/mk.conf</code>, control this
    behaviour: <code class="varname">SETGIDGAME</code>,
    <code class="varname">GAMEDATAMODE</code>, <code class="varname">GAMEGRP</code>,
    <code class="varname">GAMEMODE</code>, <code class="varname">GAMEOWN</code>.</p>
<p>Note that per default, setgid installation of games is
    disabled;  setting <code class="varname">SETGIDGAME=YES</code> will set all
    the other variables accordingly.</p>
<p>A package should therefore never hard code file ownership or
    access permissions but rely on <code class="varname">INSTALL_GAME</code> and
    <code class="varname">INSTALL_GAME_DATA</code> to set these
    correctly.</p>
</div>
<div class="sect2" title="19.6.4. Adding DESTDIR support to packages">
<div class="titlepage"><div><div><h3 class="title">
<a name="destdir-support"></a>19.6.4. Adding DESTDIR support to packages</h3></div></div></div>
<p><code class="varname">DESTDIR</code> support means that a package
    installs into a staging directory, not the final location of the
    files. Then a binary package is created which can be used for
    installation as usual. There are two ways: Either the package must
    install as root (<span class="quote">&#8220;<span class="quote">destdir</span>&#8221;</span>) or the package can
    install as non-root user (<span class="quote">&#8220;<span class="quote">user-destdir</span>&#8221;</span>).</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p><code class="varname">PKG_DESTDIR_SUPPORT</code> has to be
      set to <span class="quote">&#8220;<span class="quote">destdir</span>&#8221;</span> or <span class="quote">&#8220;<span class="quote">user-destdir</span>&#8221;</span>. If
      bsd.prefs.mk is included in the Makefile,
      <code class="varname">PKG_DESTDIR_SUPPORT</code> needs to be set before
      the inclusion.</p></li>
<li class="listitem"><p>All installation operations have to be prefixed with
      <code class="filename">${DESTDIR}</code>.</p></li>
<li class="listitem"><p>automake gets this DESTDIR mostly right
      automatically. Many manual rules and pre/post-install often are
      incorrect; fix them.</p></li>
<li class="listitem"><p>If files are installed with special owner/group
      use <code class="varname">SPECIAL_PERMS</code>.</p></li>
<li class="listitem"><p>In general, packages should support
      <code class="varname">UNPRIVILEGED</code> to be able to use
      DESTDIR.</p></li>
</ul></div>
</div>
<div class="sect2" title="19.6.5. Packages with hardcoded paths to other interpreters">
<div class="titlepage"><div><div><h3 class="title">
<a name="hardcoded-paths"></a>19.6.5. Packages with hardcoded paths to other interpreters</h3></div></div></div>
<p>Your package may also contain scripts with hardcoded paths to
      other interpreters besides (or as well as) perl.  To correct the
      full pathname to the script interpreter, you need to set the
      following definitions in your <code class="filename">Makefile</code> (we
    shall use <span class="command"><strong>tclsh</strong></span> in this example):</p>
<pre class="programlisting">
REPLACE_INTERPRETER+=   tcl
REPLACE.tcl.old=        .*/bin/tclsh
REPLACE.tcl.new=        ${PREFIX}/bin/tclsh
REPLACE_FILES.tcl=      # list of tcl scripts which need to be fixed,
# relative to ${WRKSRC}, just as in REPLACE_PERL
    </pre>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;">
<h3 class="title">Note</h3>
<p>Before March 2006, these variables were called
    <code class="varname">_REPLACE.*</code> and
    <code class="varname">_REPLACE_FILES.*</code>.</p>
</div>
</div>
<div class="sect2" title="19.6.6. Packages installing perl modules">
<div class="titlepage"><div><div><h3 class="title">
<a name="perl-modules"></a>19.6.6. Packages installing perl modules</h3></div></div></div>
<p>Makefiles of packages providing perl5 modules should include
    the Makefile fragment
    <code class="filename">../../lang/perl5/module.mk</code>.  It provides a
    <span class="command"><strong>do-configure</strong></span> target for the standard perl
    configuration for such modules as well as various hooks to tune
    this configuration.  See comments in this file for
    details.</p>
<p>Perl5 modules will install into different places depending
    on the version of perl used during the build process.  To
    address this, pkgsrc will append lines to the
    <code class="filename">PLIST</code> corresponding to the files listed in
    the installed <code class="filename">.packlist</code> file generated by
    most perl5 modules.  This is invoked by defining
    <code class="varname">PERL5_PACKLIST</code> to a space-separated list of
    paths to packlist files, e.g.:</p>
<pre class="programlisting">
PERL5_PACKLIST= ${PERL5_SITEARCH}/auto/Pg/.packlist
    </pre>
<p>The variables <code class="varname">PERL5_SITELIB</code>,
    <code class="varname">PERL5_SITEARCH</code>, and
    <code class="varname">PERL5_ARCHLIB</code> represent the three locations
    in which perl5 modules may be installed, and may be used by
    perl5 packages that don't have a packlist.  These three
    variables are also substituted for in the
    <code class="filename">PLIST</code>.</p>
</div>
<div class="sect2" title="19.6.7. Packages installing info files">
<div class="titlepage"><div><div><h3 class="title">
<a name="faq.info-files"></a>19.6.7. Packages installing info files</h3></div></div></div>
<p>Some packages install info files or use the
    <span class="quote">&#8220;<span class="quote">makeinfo</span>&#8221;</span>  or <span class="quote">&#8220;<span class="quote">install-info</span>&#8221;</span>
    commands.  <code class="varname">INFO_FILES</code> should be defined in
    the package Makefile so that <code class="filename">INSTALL</code> and
    <code class="filename">DEINSTALL</code> scripts will be generated to
    handle registration of the info files in the Info directory
    file. The <span class="quote">&#8220;<span class="quote">install-info</span>&#8221;</span> command used for the info
    files registration is either provided by the system, or by a
    special purpose package automatically added as dependency if
    needed.</p>
<p><code class="varname">PKGINFODIR</code> is the directory under
    <code class="filename">${PREFIX}</code> where info files are primarily
    located. <code class="varname">PKGINFODIR</code> defaults to
    <span class="quote">&#8220;<span class="quote">info</span>&#8221;</span> and can be overridden by the user.</p>
<p>The info files for the package should be listed in the
    package <code class="filename">PLIST</code>; however any split info files
    need not be listed.</p>
<p>A package which needs the <span class="quote">&#8220;<span class="quote">makeinfo</span>&#8221;</span> command
    at build time must add <span class="quote">&#8220;<span class="quote">makeinfo</span>&#8221;</span> to
    <code class="varname">USE_TOOLS</code> in its Makefile. If a minimum
    version of the <span class="quote">&#8220;<span class="quote">makeinfo</span>&#8221;</span> command is needed it
    should be noted with the <code class="varname">TEXINFO_REQD</code>
    variable in the package <code class="filename">Makefile</code>. By
    default, a minimum version of 3.12 is required. If the system
    does not provide a <span class="command"><strong>makeinfo</strong></span> command or if it
    does not match the required minimum, a build dependency on the
    <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/devel/gtexinfo/README.html" target="_top"><code class="filename">devel/gtexinfo</code></a> package will
    be added automatically.</p>
<p>The build and installation process of the software provided
    by the package should not use the
    <span class="command"><strong>install-info</strong></span> command as the registration of
    info files is the task of the package
    <code class="filename">INSTALL</code> script, and it must use the
    appropriate <span class="command"><strong>makeinfo</strong></span> command.</p>
<p>To achieve this goal, the pkgsrc infrastructure creates
    overriding scripts for the <span class="command"><strong>install-info</strong></span> and
    <span class="command"><strong>makeinfo</strong></span> commands in a directory listed early
    in <code class="varname">PATH</code>.</p>
<p>The script overriding <span class="command"><strong>install-info</strong></span> has
    no effect except the logging of a message. The script overriding
    <span class="command"><strong>makeinfo</strong></span> logs a message and according to the
    value of <code class="varname">TEXINFO_REQD</code> either runs the appropriate
    <span class="command"><strong>makeinfo</strong></span> command or exit on error.</p>
</div>
<div class="sect2" title="19.6.8. Packages installing man pages">
<div class="titlepage"><div><div><h3 class="title">
<a name="manpages"></a>19.6.8. Packages installing man pages</h3></div></div></div>
<p>All packages that install manual pages should install them
    into the same directory, so that there is one common place to look
    for them. In pkgsrc, this place is
    <code class="literal">${PREFIX}/${PKGMANDIR}</code>, and this expression
    should be used in packages. The default for
    <code class="varname">PKGMANDIR</code> is
    <span class="quote">&#8220;<span class="quote"><code class="filename">man</code></span>&#8221;</span>. Another often-used value
    is <span class="quote">&#8220;<span class="quote"><code class="filename">share/man</code></span>&#8221;</span>.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;">
<h3 class="title">Note</h3>
<p>The support for a custom <code class="varname">PKGMANDIR</code>
    is far from complete.</p>
</div>
<p>The <code class="filename">PLIST</code> files can just use
    <code class="filename">man/</code> as the top level directory for the man
    page file entries, and the pkgsrc framework will convert as
    needed. In all other places, the correct
    <code class="varname">PKGMANDIR</code> must be used.</p>
<p>Packages that are
    configured with <code class="varname">GNU_CONFIGURE</code> set as
    <span class="quote">&#8220;<span class="quote">yes</span>&#8221;</span>, by default will use the
    <code class="filename">./configure</code>
    --mandir switch to set where the man pages should be installed.
    The path is <code class="varname">GNU_CONFIGURE_MANDIR</code> which defaults
    to <code class="varname">${PREFIX}/${PKGMANDIR}</code>.</p>
<p>Packages that use <code class="varname">GNU_CONFIGURE</code> but do not
    use --mandir, can set <code class="varname">CONFIGURE_HAS_MANDIR</code>
    to <span class="quote">&#8220;<span class="quote">no</span>&#8221;</span>.
    Or if the <code class="filename">./configure</code> script uses
    a non-standard use of --mandir, you can set
    <code class="varname">GNU_CONFIGURE_MANDIR</code> as needed.</p>
<p>See <a class="xref" href="plist.html#manpage-compression" title="13.5. Man page compression">Section 13.5, &#8220;Man page compression&#8221;</a> for
    information on installation of compressed manual pages.</p>
</div>
<div class="sect2" title="19.6.9. Packages installing GConf data files">
<div class="titlepage"><div><div><h3 class="title">
<a name="gconf-data-files"></a>19.6.9. Packages installing GConf data files</h3></div></div></div>
<p>If a package installs <code class="filename">.schemas</code> or
    <code class="filename">.entries</code> files, used by GConf,
    you need to take some extra steps to make sure they get registered
    in the database:</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>Include <code class="filename">../../devel/GConf/schemas.mk</code>
	instead of its <code class="filename">buildlink3.mk</code> file.  This
	takes care of rebuilding the GConf database at installation and
	deinstallation time, and tells the package where to install
	GConf data files using some standard configure arguments.  It
	also disallows any access to the database directly from the
	package.</p></li>
<li class="listitem"><p>Ensure that the package installs its
	<code class="filename">.schemas</code> files under
	<code class="filename">${PREFIX}/share/gconf/schemas</code>.  If they get
	installed under <code class="filename">${PREFIX}/etc</code>, you will
	need to manually patch the package.</p></li>
<li class="listitem"><p>Check the PLIST and remove any entries under the etc/gconf
	directory, as they will be handled automatically.  See
	<a class="xref" href="faq.html#faq.conf" title="9.13. How do I change the location of configuration files?">Section 9.13, &#8220;How do I change the location of configuration files?&#8221;</a> for more information.</p></li>
<li class="listitem"><p>Define the <code class="varname">GCONF_SCHEMAS</code> variable in
	your <code class="filename">Makefile</code> with a list of all
	<code class="filename">.schemas</code> files installed by the package, if
	any.  Names must not contain any directories in them.</p></li>
<li class="listitem"><p>Define the <code class="varname">GCONF_ENTRIES</code> variable in
	your <code class="filename">Makefile</code> with a
	list of all <code class="filename">.entries</code> files installed by the
	package, if any. Names must not contain any directories in
	them.</p></li>
</ol></div>
</div>
<div class="sect2" title="19.6.10. Packages installing scrollkeeper/rarian data files">
<div class="titlepage"><div><div><h3 class="title">
<a name="scrollkeeper-data-files"></a>19.6.10. Packages installing scrollkeeper/rarian data files</h3></div></div></div>
<p>If a package installs <code class="filename">.omf</code> files, used by
    scrollkeeper/rarian, you need to take some extra steps to make sure they
    get registered in the database:</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>Include
	<code class="filename">../../mk/omf-scrollkeeper.mk</code>
	instead of rarian's <code class="filename">buildlink3.mk</code> file.  This
	takes care of rebuilding the scrollkeeper database at
	installation and deinstallation time, and disallows any access
	to it directly from the package.</p></li>
<li class="listitem"><p>Check the PLIST and remove any entries under the
	<code class="filename">libdata/scrollkeeper</code> directory, as they
	will be handled automatically.</p></li>
<li class="listitem"><p>Remove the <code class="filename">share/omf</code> directory from
	the PLIST.  It will be handled by rarian. (<span class="command"><strong>make
	print-PLIST</strong></span> does this automatically.)</p></li>
</ol></div>
</div>
<div class="sect2" title="19.6.11. Packages installing X11 fonts">
<div class="titlepage"><div><div><h3 class="title">
<a name="x11-fonts"></a>19.6.11. Packages installing X11 fonts</h3></div></div></div>
<p>If a package installs font files, you will need to rebuild
    the fonts database in the directory where they get installed at
    installation and deinstallation time.  This can be automatically
    done by using the pkginstall framework.</p>
<p>You can list the directories where fonts are installed in the
    <code class="varname">FONTS_DIRS.<em class="replaceable"><code>type</code></em></code>
    variables, where <em class="replaceable"><code>type</code></em> can be one of
    <span class="quote">&#8220;<span class="quote">ttf</span>&#8221;</span>, <span class="quote">&#8220;<span class="quote">type1</span>&#8221;</span> or <span class="quote">&#8220;<span class="quote">x11</span>&#8221;</span>.
    Also make sure that the database file
    <code class="filename">fonts.dir</code> is not listed in the PLIST.</p>
<p>Note that you should not create new directories for fonts;
    instead use the standard ones to avoid that the user needs to
    manually configure his X server to find them.</p>
</div>
<div class="sect2" title="19.6.12. Packages installing GTK2 modules">
<div class="titlepage"><div><div><h3 class="title">
<a name="gtk2-modules"></a>19.6.12. Packages installing GTK2 modules</h3></div></div></div>
<p>If a package installs GTK2 immodules or loaders, you need to
    take some extra steps to get them registered in the GTK2 database
    properly:</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>Include
      <code class="filename">../../x11/gtk2/modules.mk</code> instead of its
      <code class="filename">buildlink3.mk</code> file.  This takes care of
      rebuilding the database at installation and deinstallation time.</p></li>
<li class="listitem"><p>Set <code class="varname">GTK2_IMMODULES=YES</code> if
      your package installs GTK2 immodules.</p></li>
<li class="listitem"><p>Set <code class="varname">GTK2_LOADERS=YES</code> if your package installs
      GTK2 loaders.</p></li>
<li class="listitem">
<p>Patch the package to not touch any of the GTK2
      databases directly.  These are:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p><code class="filename">libdata/gtk-2.0/gdk-pixbuf.loaders</code></p></li>
<li class="listitem"><p><code class="filename">libdata/gtk-2.0/gtk.immodules</code></p></li>
</ul></div>
</li>
<li class="listitem"><p>Check the <code class="filename">PLIST</code> and remove
      any entries under the <code class="filename">libdata/gtk-2.0</code>
      directory, as they will be handled automatically.</p></li>
</ol></div>
</div>
<div class="sect2" title="19.6.13. Packages installing SGML or XML data">
<div class="titlepage"><div><div><h3 class="title">
<a name="sgml-xml-data"></a>19.6.13. Packages installing SGML or XML data</h3></div></div></div>
<p>If a package installs SGML or XML data files that need to be
    registered in system-wide catalogs (like DTDs, sub-catalogs,
    etc.), you need to take some extra steps:</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>Include
	<code class="filename">../../textproc/xmlcatmgr/catalogs.mk</code> in
	your <code class="filename">Makefile</code>, which takes care of
	registering those files in system-wide catalogs at
	installation and deinstallation time.</p></li>
<li class="listitem"><p>Set <code class="varname">SGML_CATALOGS</code> to the full path of
	any SGML catalogs installed by the package.</p></li>
<li class="listitem"><p>Set <code class="varname">XML_CATALOGS</code> to the full path of
	any XML catalogs installed by the package.</p></li>
<li class="listitem"><p>Set <code class="varname">SGML_ENTRIES</code> to individual entries
	to be added to the SGML catalog.  These come in groups of
	three strings; see xmlcatmgr(1) for more information
	(specifically, arguments recognized by the 'add' action).
	Note that you will normally not use this variable.</p></li>
<li class="listitem"><p>Set <code class="varname">XML_ENTRIES</code> to individual entries
	to be added to the XML catalog.  These come in groups of three
	strings; see xmlcatmgr(1) for more information (specifically,
	arguments recognized by the 'add' action).  Note that you will
	normally not use this variable.</p></li>
</ol></div>
</div>
<div class="sect2" title="19.6.14. Packages installing extensions to the MIME database">
<div class="titlepage"><div><div><h3 class="title">
<a name="mime-database"></a>19.6.14. Packages installing extensions to the MIME database</h3></div></div></div>
<p>If a package provides extensions to the MIME database by
    installing <code class="filename">.xml</code> files inside
    <code class="filename">${PREFIX}/share/mime/packages</code>, you
    need to take some extra steps to ensure that the database is kept
    consistent with respect to these new files:</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>Include
	<code class="filename">../../databases/shared-mime-info/mimedb.mk</code>
	(avoid using the <code class="filename">buildlink3.mk</code> file from
	this same directory, which is reserved for inclusion from
	other <code class="filename">buildlink3.mk</code> files).  It takes
	care of rebuilding the MIME database at installation and
	deinstallation time, and disallows any access to it directly
	from the package.</p></li>
<li class="listitem"><p>Check the PLIST and remove any entries under the
	<code class="filename">share/mime</code> directory,
	<span class="emphasis"><em>except</em></span> for files saved under
	<code class="filename">share/mime/packages</code>.  The former are
	handled automatically by
	the update-mime-database program, but the latter are
	package-dependent and must be removed by the package that
	installed them in the first place.</p></li>
<li class="listitem"><p>Remove any <code class="filename">share/mime/*</code> directories
	from the PLIST.  They will be handled by the shared-mime-info
	package.</p></li>
</ol></div>
</div>
<div class="sect2" title="19.6.15. Packages using intltool">
<div class="titlepage"><div><div><h3 class="title">
<a name="intltool"></a>19.6.15. Packages using intltool</h3></div></div></div>
<p>If a package uses intltool during its build, add
    <code class="literal">intltool</code> to the <code class="varname">USE_TOOLS</code>,
    which forces it to use the intltool package provided by pkgsrc,
    instead of the one bundled with the distribution file.</p>
<p>This tracks intltool's build-time dependencies and uses the
    latest available version; this way, the package benefits of any
    bug fixes that may have appeared since it was released.</p>
</div>
<div class="sect2" title="19.6.16. Packages installing startup scripts">
<div class="titlepage"><div><div><h3 class="title">
<a name="startup-scripts"></a>19.6.16. Packages installing startup scripts</h3></div></div></div>
<p>If a package contains a rc.d script, it won't be copied into
    the startup directory by default, but you can enable it, by adding
    the option <code class="varname">PKG_RCD_SCRIPTS=YES</code> in
    <a class="link" href="configuring.html#mk.conf"><code class="filename">mk.conf</code></a>. This option will copy the scripts
    into <code class="filename">/etc/rc.d</code> when a package is installed, and
    it will automatically remove the scripts when the package is
    deinstalled.</p>
</div>
<div class="sect2" title="19.6.17. Packages installing TeX modules">
<div class="titlepage"><div><div><h3 class="title">
<a name="tex-packages"></a>19.6.17. Packages installing TeX modules</h3></div></div></div>
<p>If a package installs TeX packages into the texmf tree,
    the <code class="filename">ls-R</code> database of the tree needs to be
    updated.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;">
<h3 class="title">Note</h3>
<p>Except the main TeX packages such as kpathsea,
    packages should install files
    into <code class="filename">${PREFIX}/share/texmf-dist</code>,
    not <code class="filename">${PREFIX}/share/texmf</code>.</p>
</div>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>Include
      <code class="filename">../../print/kpathsea/texmf.mk</code>.  This
      takes care of rebuilding the <code class="filename">ls-R</code>
      database at installation and deinstallation time.</p></li>
<li class="listitem">
<p>If your package installs files into a texmf
      tree other than the one
      at <code class="filename">${PREFIX}/share/texmf-dist</code>,
      set <code class="varname">TEX_TEXMF_DIRS</code> to the list of all texmf
      trees that need database update.</p>
<p>If your package also installs font map files that need
      to be registered using <span class="command"><strong>updmap</strong></span>,
      include <code class="filename">../../print/texlive-tetex/map.mk</code> and
      set <code class="varname">TEX_MAP_FILES</code> and/or
      <code class="varname">TEX_MIXEDMAP_FILES</code> to the list of all
      such font map files.  Then <span class="command"><strong>updmap</strong></span> will
      be run automatically at installation/deinstallation to
      enable/disable font map files for TeX output
      drivers.</p>
</li>
<li class="listitem"><p>Make sure that none of <code class="filename">ls-R</code>
      databases are included in <code class="filename">PLIST</code>, as
      they will be removed only by the teTeX-bin package.</p></li>
</ol></div>
</div>
<div class="sect2" title="19.6.18. Packages supporting running binaries in emulation">
<div class="titlepage"><div><div><h3 class="title">
<a name="emulation-packages"></a>19.6.18. Packages supporting running binaries in
    emulation</h3></div></div></div>
<p>There are some packages that provide libraries and
    executables for running binaries from a one operating system
    on a different one (if the latter supports it).  One example
    is running Linux binaries on NetBSD.</p>
<p>The <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/pkgtools/rpm2pkg/README.html" target="_top"><code class="filename">pkgtools/rpm2pkg</code></a>
    helps in extracting and packaging Linux rpm packages.</p>
<p>The <code class="varname">CHECK_SHLIBS</code> can be set to no to
    avoid the <span class="command"><strong>check-shlibs</strong></span> target, which tests
    if all libraries for each installed executable can be found by
    the dynamic linker.  Since the standard dynamic linker is run,
    this fails for emulation packages, because the libraries used
    by the emulation are not in the standard directories.</p>
</div>
<div class="sect2" title="19.6.19. Packages installing hicolor theme icons">
<div class="titlepage"><div><div><h3 class="title">
<a name="hicolor-theme"></a>19.6.19. Packages installing hicolor theme icons</h3></div></div></div>
<p>If a package installs images under the
    <code class="filename">share/icons/hicolor</code> and/or updates the
    <code class="filename">share/icons/hicolor/icon-theme.cache</code>
    database, you need to take some extra steps to make sure that the
    shared theme directory is handled appropriately and that the cache
    database is rebuilt:</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>Include
	<code class="filename">../../graphics/hicolor-icon-theme/buildlink3.mk</code>.</p></li>
<li class="listitem"><p>Check the <code class="filename">PLIST</code> and remove the
	entry that refers to the theme cache.</p></li>
<li class="listitem"><p>Ensure that the PLIST does not remove the shared icon
	  directories from the <code class="filename">share/icons/hicolor</code>
	  hierarchy because they will be handled automatically.</p></li>
</ol></div>
<p>The best way to verify that the PLIST is correct with
      respect to the last two points is to regenerate it using
      <span class="command"><strong>make print-PLIST</strong></span>.</p>
</div>
<div class="sect2" title="19.6.20. Packages installing desktop files">
<div class="titlepage"><div><div><h3 class="title">
<a name="desktop-files"></a>19.6.20. Packages installing desktop files</h3></div></div></div>
<p>If a package installs <code class="filename">.desktop</code> files
      under <code class="filename">share/applications</code> and these include
      MIME information, you need to take extra steps to ensure that they
      are registered into the MIME database:</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>Include
	  <code class="filename">../../sysutils/desktop-file-utils/desktopdb.mk</code>.</p></li>
<li class="listitem"><p>Check the PLIST and remove the entry that refers to the
	  <code class="filename">share/applications/mimeinfo.cache</code> file.
	  It will be handled automatically.</p></li>
</ol></div>
<p>The best way to verify that the PLIST is correct with
      respect to the last point is to regenerate it using <span class="command"><strong>make
      print-PLIST</strong></span>.</p>
</div>
</div>
<div class="sect1" title="19.7. Marking packages as having problems">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="punting"></a>19.7. Marking packages as having problems</h2></div></div></div>
<p>In some cases one does not have the time to solve a problem
  immediately. In this case, one can plainly mark a package as broken.  For
  this, one just sets the variable <code class="varname">BROKEN</code> to the
  reason why the package is broken (similar to the
  <code class="varname">RESTRICTED</code> variable).  A user trying to build
  the package will immediately be shown this message, and the build
  will not be even tried.</p>
<p><code class="varname">BROKEN</code> packages are removed from pkgsrc in irregular
  intervals.</p>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="tools.html">Prev</a> </td>
<td width="20%" align="center"><a accesskey="u" href="developers-guide.html">Up</a></td>
<td width="40%" align="right"> <a accesskey="n" href="debug.html">Next</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">Chapter 18. Tools needed for building or running </td>
<td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td>
<td width="40%" align="right" valign="top"> Chapter 20. Debugging</td>
</tr>
</table>
</div>
</body>
</html>
