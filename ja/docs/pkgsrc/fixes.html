<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Chapter 19. パッケージを動くようにする</title>
<link rel="stylesheet" type="text/css" href="/global.css">
<meta name="generator" content="DocBook XSL Stylesheets VX.X.X">
<link rel="home" href="index.html" title="The pkgsrc guide">
<link rel="up" href="developers-guide.html" title="Part II. pkgsrc 開発者向けの手引き">
<link rel="prev" href="tools.html" title="Chapter 18. 構築や実行のために必要なツール">
<link rel="next" href="debug.html" title="Chapter 20. デバッグ">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">Chapter 19. パッケージを動くようにする</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="tools.html">Prev</a> </td>
<th width="60%" align="center">Part II. pkgsrc 開発者向けの手引き</th>
<td width="20%" align="right"> <a accesskey="n" href="debug.html">Next</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="chapter" title="Chapter 19. パッケージを動くようにする">
<div class="titlepage"><div><div><h2 class="title">
<a name="fixes"></a>Chapter 19. パッケージを動くようにする</h2></div></div></div>
<div class="toc">
<p><b>Table of Contents</b></p>
<dl>
<dt><span class="sect1"><a href="fixes.html#general-operation">19.1. 一般的な操作</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="fixes.html#portability-of-packages">19.1.1. パッケージの移植性</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#pulling-vars-from-etc-mk.conf">19.1.2. <code class="filename">mk.conf</code> から利用者が設定可能な変数を捕まえる方法</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#user-interaction">19.1.3. ユーザーとの対話</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#handling-licenses">19.1.4. ライセンスの処理</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#restricted-packages">19.1.5. 制限つきパッケージ</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#dependencies">19.1.6. 依存性の処理</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#conflicts">19.1.7. 他のパッケージとの衝突の処理</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#not-building-packages">19.1.8. 構築することができない、あるいはすべきでないパッケージ</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#undeletable-packages">19.1.9. 一旦インストールしたら削除すべきでないパッケージ</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#security-handling">19.1.10. セキュリティー問題を持つパッケージへの対処</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#bumping-pkgrevision">19.1.11. 既存パッケージ修正時に、バージョンを上げるにはどうするか</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#fixes.subst">19.1.12. パッケージのファイル中の各種テキストを置換する (SUBST の枠組)</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="fixes.html#fixes.fetch">19.2. <span class="emphasis"><em>fetch</em></span> 相での問題を修正する</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="fixes.html#no-plain-download">19.2.1. distfileのダウンロードが単純にできないパッケージ</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#modified-distfiles-same-name">19.2.2. '古い'名前のまま更新されたdistfileの取り扱い</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="fixes.html#fixes.configure">19.3. <span class="emphasis"><em>configure</em></span> 相での問題を修正する</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="fixes.html#fixes.libtool">19.3.1. 共有ライブラリー - libtool</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#using-libtool">19.3.2. すでにlibtoolをサポートしているGNUパッケージでlibtoolを使う</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#autoconf-automake">19.3.3. GNU Autoconf/Automake</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="fixes.html#programming-languages">19.4. プログラミング言語</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="fixes.html#basic-programming-languages">19.4.1. C, C++ および Fortran</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#java-programming-language">19.4.2. Java</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#perl-scripts">19.4.3. perl スクリプトを含むパッケージ</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#other-programming-languages">19.4.4. 他のプログラミング言語</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="fixes.html#fixes.build">19.5. <span class="emphasis"><em>build</em></span> 相での問題を修正する</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="fixes.html#fixes.build.cpp">19.5.1. C および C++ のコードの条件つきコンパイル</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#compiler-bugs">19.5.2. コンパイラーのバグへの対処方法</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#undefined-reference">19.5.3. undefined reference to <span class="quote">“<span class="quote">...</span>”</span></a></span></dt>
<dt><span class="sect2"><a href="fixes.html#out-of-memory">19.5.4. メモリーが不足する</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="fixes.html#fixes.install">19.6. <span class="emphasis"><em>install</em></span> 相での問題を修正する</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="fixes.html#install-scripts">19.6.1. 必要なディレクトリーを作成する</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#where-to-install-documentation">19.6.2. ドキュメンテーションのインストール場所</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#installing-score-files">19.6.3. 最高得点ファイルをインストールする</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#destdir-support">19.6.4. パッケージを DESTDIR に対応させる</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#hardcoded-paths">19.6.5. その他のインタープリターへのパスがハードコードされているパッケージ</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#perl-modules">19.6.6. perl モジュールをインストールするパッケージ</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#faq.info-files">19.6.7. infoファイルをインストールするパッケージ</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#manpages">19.6.8. マニュアルページをインストールするパッケージ</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#gconf-data-files">19.6.9. GConf のデータファイルをインストールするパッケージ</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#scrollkeeper-data-files">19.6.10. scrollkeeper/rarian のデータファイルをインストールするパッケージ</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#x11-fonts">19.6.11. X11 のフォントをインストールするパッケージ</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#gtk2-modules">19.6.12. GTK2 のモジュールをインストールするパッケージ</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#sgml-xml-data">19.6.13. SGML または XML のデータをインストールするパッケージ</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#mime-database">19.6.14. MIME データベースの拡張をインストールするパッケージ</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#intltool">19.6.15. intltool を使うパッケージ</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#startup-scripts">19.6.16. 起動スクリプトをインストールするパッケージ</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#tex-packages">19.6.17. TeX モジュールをインストールするパッケージ</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#emulation-packages">19.6.18. エミュレーションによるバイナリーの実行に対応したパッケージ</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#hicolor-theme">19.6.19. ハイカラーテーマのアイコンをインストールするパッケージ</a></span></dt>
<dt><span class="sect2"><a href="fixes.html#desktop-files">19.6.20. デスクトップファイルをインストールするパッケージ</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="fixes.html#punting">19.7. パッケージに問題があるという印をつける</a></span></dt>
</dl>
</div>
<div class="sect1" title="19.1. 一般的な操作">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="general-operation"></a>19.1. 一般的な操作</h2></div></div></div>
<div class="sect2" title="19.1.1. パッケージの移植性">
<div class="titlepage"><div><div><h3 class="title">
<a name="portability-of-packages"></a>19.1.1. パッケージの移植性</h3></div></div></div>
<p>pkgsrc の目玉の一つは、多くのプラットフォームで動作することです。
    そのため、pkgsrc のパッケージの移植性をできるかぎり高めることが重要になります。
    本章では、pkgsrc の作業に際して、
    注意が必要となる具体的な事項を説明します。</p>
</div>
<div class="sect2" title="19.1.2. mk.conf から利用者が設定可能な変数を捕まえる方法">
<div class="titlepage"><div><div><h3 class="title">
<a name="pulling-vars-from-etc-mk.conf"></a>19.1.2. <a class="link" href="configuring.html#mk.conf"><code class="filename">mk.conf</code></a> から利用者が設定可能な変数を捕まえる方法</h3></div></div></div>
<p>pkgsrc の利用者は、<code class="varname">MAKECONF</code>
    によって参照されるファイル (標準では <a class="link" href="configuring.html#mk.conf"><code class="filename">mk.conf</code></a>)
    でいくつかの変数を上書きして、pkgsrc の設定をすることができます。
    このような変数を <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?make+1+NetBSD-5.0.1+i386"><span class="citerefentry"><span class="refentrytitle">make</span>(1)</span></a> のプリプロセッサーディレクティブ
    (たとえば <code class="literal">.if</code> や
    <code class="literal">.for</code>) の内部で使いたい場合は、
    利用者の設定が読み込まれる場所より前で
    <code class="filename">../../mk/bsd.prefs.mk</code> をインクルードする必要があります。</p>
<p>しかし、変数によっては、
    まだ定義されていない変数への参照を含んでいることがあるために、
    <code class="filename">../../mk/bsd.prefs.mk</code>
    をインクルードした後では完全に定義することができないものがあります。
    シェルコマンドの場合は、変数の実態はマクロであり、
    使われるときにしか展開されないので、このことは問題にはなりません。
    ただし、前述したプリプロセッサーディレクティブの内部や、
    依存性を記した行 (<code class="literal">target: dependencies</code> のような形式の行)
    においては、読み込み時に変数が展開されます。</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;">
<h3 class="title">Note</h3>
<p>各変数が読み込み時に使用可能か、
    実行時にのみ使用可能かを網羅した一覧は、現在のところありませんが、
    準備をしているところです。</p>
</div>
</div>
<div class="sect2" title="19.1.3. ユーザーとの対話">
<div class="titlepage"><div><div><h3 class="title">
<a name="user-interaction"></a>19.1.3. ユーザーとの対話</h3></div></div></div>
<p>時々、パッケージがユーザーとの対話を必要とする場合がありますが、
    そのような状況は何通りもありえます:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>distfile の取得時に、パッケージによっては、
	ユーザー名とパスワードの入力や web ページ上のライセンスへの同意のような、
	利用者の対話を必要とするものがあります。</p></li>
<li class="listitem"><p>distfile の展開時に、
	パッケージによってはパスワードを要求することがあります。</p></li>
<li class="listitem"><p>パッケージの構築前の設定の補助</p></li>
<li class="listitem"><p>構築過程の最中の補助</p></li>
<li class="listitem"><p>パッケージのインストール中の補助</p></li>
</ul></div>
<p>どの段階で対話が必要になるかをpkgsrcの機構に知らせるため、
    <code class="varname">INTERACTIVE_STAGE</code> 定義が用意されており、
    パッケージの<code class="filename">Makefile</code>で定義します。
    たとえば以下のようにします。</p>
<pre class="programlisting">
INTERACTIVE_STAGE=      build
    </pre>
<p>複数の段階を指定することもできます:</p>
<pre class="programlisting">
INTERACTIVE_STAGE=      configure install
    </pre>
<p>利用者は、<code class="varname">BATCH</code> 変数を設定して、
    この定義がおこなわれているパッケージをとばすことができます。</p>
</div>
<div class="sect2" title="19.1.4. ライセンスの処理">
<div class="titlepage"><div><div><h3 class="title">
<a name="handling-licenses"></a>19.1.4. ライセンスの処理</h3></div></div></div>
<p>ソフトウェアの作者は、
    そのソフトウェアをどのようなライセンスのもとでコピーすることができるかを、定めることができます。
    これは著作権法にもとづくことであって、ライセンス選択の理由は
    pkgsrc システムの範疇外です。pkgsrc システムでは、
    ライセンスのなかには、従うことに不服だったり、
    従うことが困難あるいは不可能だったりする利用者がいるようなライセンスがたくさんあることを認識しています。
    Free Software Foundation ではいくつかのライセンスに対して、
    それが「自由」なライセンスであると表明していますし、
    Open Source Initiative では「オープンソース」を定義しています。
    pkgsrc では、ライセンスが「自由」あるいは「オープンソース」であるといった目印をパッケージにつけたりはしないという方針をとっています。
    ただし、これらの定義にあてはまらないライセンスをもつパッケージには、
    ライセンスについて記した目印がついています。
    なお、ライセンスでコピーを認めていないパッケージは、
    明らかに、「自由」にも「オープンソース」にも該当しません。</p>
<p>「自由」でも「オープンソース」でもないパッケージについては、
    構築してよいということを、個々のライセンスについて利用者が pkgsrc に指定しておかない限り、
    pkgsrc はパッケージを構築しません。
    なお、このドキュメンテーションでは、「ライセンスに同意する」
    ("accepted the license") という言いまわしを避けています。
    pkgsrc システムは、単に、
    フリーでないライセンスのソフトウェアを誤って構築してしまうことがないようにする仕組みを提供しているだけです。
    判断や責任は、利用者に委ねています。
    (現在のところ、バイナリーパッケージのインストールは、
    この仕組みの対象外です。これはバグです。)</p>
<p>BSD ライセンスと GPL のパッケージだけをインストールし、
    それ以外はインストールしたくない、ということがあるかもしれません。
    標準状態では、フリーなライセンスが
    <code class="varname">ACCEPTABLE_LICENSES</code> 変数に列挙されています。
    <code class="varname">ACCEPTABLE_LICENSES</code> 変数を
    "+=" ではなく "=" を使って設定すれば、
    どのライセンスを許容するかを利用者が上書きできます。
    標準状態で許容されているライセンスは以下のとおりです。
    </p>
<pre class="programlisting">
    public-domain
    gnu-gpl-v2 gnu-lgpl-v2
    gnu-gpl-v3 gnu-lgpl-v3
    original-bsd modified-bsd
    x11
    apache-2.0
    cddl-1.0
    open-font-license
    </pre>
<p>
    </p>
<p>ライセンスの目印の仕組みは、パッケージの構築、インストール、
    および使用にまつわる著作権関連の問題を処理するためのものであって、
    再配布にまつわる問題 (<code class="varname">RESTRICTED</code> および
    <code class="varname">NO_SRC_ON_FTP</code> などを参照) のためのものではありません。
    再配布に制限のあるパッケージには、
    これらの変数を使って再配布に制限があることを示す必要があります。</p>
<p>パッケージのコピーが特殊なライセンスのもとで認められていることを示すには、
    そのライセンスを
    <code class="filename">pkgsrc/licenses</code> に置いたうえで、
    <code class="varname">LICENSE</code> 変数をライセンスを特定する文字列に設定します。
    たとえば、<a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/graphics/xv/README.html" target="_top"><code class="filename">graphics/xv</code></a> では以下のようになります。</p>
<pre class="programlisting">
LICENSE=        xv-license
    </pre>
<p>構築しようとすると、利用者はそのパッケージに適用されているライセンスが
    <code class="varname">ACCEPTABLE_LICENSES</code>
    変数に設定されていないことを知らされます。</p>
<pre class="programlisting">
<code class="prompt">%</code> <strong class="userinput"><code>make</code></strong>
===&gt; xv-3.10anb9 has an unacceptable license: xv-license.
===&gt;     To view the license, enter "/usr/bin/make show-license".
===&gt;     To indicate acceptance, add this line to your /etc/mk.conf:
===&gt;     ACCEPTABLE_LICENSES+=xv-license
*** Error code 1
    </pre>
<p>ライセンス自体は <span class="command"><strong>make
    show-license</strong></span> すると見ることができます。
    そのライセンスのものを構築してよい場合は、
    pkgsrc が今後はそのライセンスを理由に構築をやめないように、
    上の表示中で指示されている行を <a class="link" href="configuring.html#mk.conf"><code class="filename">mk.conf</code></a>
    に追加することができます。</p>
<pre class="programlisting">
ACCEPTABLE_LICENSES+=xv-license
    </pre>
<p>新しいライセンスが適用されているパッケージを追加する場合、
    表示用のライセンスのテキストを <code class="filename">pkgsrc/licenses</code>
    に追加します。既知のライセンスの一覧は、
    このディレクトリーで見ることができます。</p>
<p>ライセンスが (整形以外で) 変更された場合は、
    必ず、新しいライセンスの名前を以前のものと別の名前にします (たとえば、
    バージョン番号があればそれを、なければ日付を末尾につけるなど)。
    これは、前バージョンのライセンスのもとにあるプログラムを構築することを
    pkgsrc に指示している利用者が、
    新しいライセンスのもとにあるプログラムを構築しないようにするためです。
    もっと高度な点でいうと、
    pkgsrc はライセンスの相当性を評価しません。
    すなわち、個々のライセンスのテキストを、二組織のいずれかが
    (「自由」あるいは「オープンソース」であると) 認めているかどうかという、
    機械的な検査をしているだけなのです。</p>
<p><code class="varname">LICENSE=shareware</code> や、
    <code class="varname">LICENSE=no-commercial-use</code> のような言いまわしは、
    ライセンスの文面を特定できないので、
    使わないことになりました。
    また、このような言いまわしを使った場合の別の問題として、
    利用者が pkgsrc に対して、同じ目印のついた複数のパッケージのうち、
    ひとつのパッケージだけは構築を続行するが、
    それ以外のパッケージは構築を続行しない、
    といった指定ができなくなるというものもあります。</p>
</div>
<div class="sect2" title="19.1.5. 制限つきパッケージ">
<div class="titlepage"><div><div><h3 class="title">
<a name="restricted-packages"></a>19.1.5. 制限つきパッケージ</h3></div></div></div>
<p>ライセンスによっては、ソフトウェアの再配布方法に制限があります。
    パッケージが「自由」あるいは「オープンソース」でない限りは、
    ライセンスの目印が必要なので、制限のあるパッケージにはすべてライセンスの目印がついているはずです。
    その制限について記述しておくと、パッケージのツールは、
    自動的に制限されたこと (たとえばバイナリーパッケージを FTP サイトに置くこと)
    を控えたりすることができます。</p>
<p>ソース (distfile) とバイナリーそれぞれについて、
    置いていけないのが FTP サイトか CD-ROM かの組み合わせで、
    4 種類の制限を表現することができます。どのライセンスでも、
    これが厳密な文言となっていることはほとんどないことや、
    フリーでない各ライセンスはお互いに異なる傾向があることから、
    pkgsrc では FTP と CD-ROM を定義しています。
    pkgsrc では、"FTP" を、ソースやバイナリーのファイルを、
    インターネット上で料金を払わずに利用できるようにしてはいけない、
    という意味で使います。
    pkgsrc では、"CD-ROM" を、ソースやバイナリーを、
    配布料金をとるような何らかの種類の媒体に、
    他のソースやバイナリーパッケージと同梱して利用できるようにすることはできない、
    という意味で使います。
    </p>
<p>このような
    制限を表現するため、パッケージシステムでは以下のような制限を設定で
    きる5個のmake変数を定義しています:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem">
<p><code class="varname">RESTRICTED</code></p>
<p>なにか制限がある場合は常に、(制限の種類にかかわらず)この変数を設定します。
	この変数を、その制限の理由を含む文字列に設定してください。
	制限を理解しなければならない人は、ライセンスを読む必要がありますし、
	おそらく法的な助言も必要だと考えなければなりません。</p>
</li>
<li class="listitem">
<p><code class="varname">NO_BIN_ON_CDROM</code></p>
<p>バイナリーを、配布料金を取れるようにして、
	他のバイナリーパッケージとともにCD-ROMに収録することができません。
	そのような場合は常に、この変数を<code class="varname">${RESTRICTED}</code>に設定
	してください。</p>
</li>
<li class="listitem">
<p><code class="varname">NO_BIN_ON_FTP</code></p>
<p>バイナリーを、インターネット上で料金を払わずに利用できるようにすることができません。
	そのような場合は常に、この変数を
	<code class="varname">${RESTRICTED}</code>に設定してください。
	この変数を設定すると、バイナリーパッケージは
	ftp.NetBSD.org に置かれません。</p>
</li>
<li class="listitem">
<p><code class="varname">NO_SRC_ON_CDROM</code></p>
<p>distfileを、料金を取れるようにして、
	他のdistfileとともにCD-ROMに収録することができません。
	そのような場合は、この変数を
	<code class="varname">${RESTRICTED}</code>に設定してください。</p>
</li>
<li class="listitem">
<p><code class="varname">NO_SRC_ON_FTP</code></p>
<p>distfileを、インターネット上で料金を払わずに利用できるようにすることができません。
	そのような場合は、この変数を
	<code class="varname">${RESTRICTED}</code>に設定してください。
	この変数を設定すると、distfile は
	ftp.NetBSD.org にミラーされません。</p>
</li>
</ul></div>
</div>
<div class="sect2" title="19.1.6. 依存性の処理">
<div class="titlepage"><div><div><h3 class="title">
<a name="dependencies"></a>19.1.6. 依存性の処理</h3></div></div></div>
<p>パッケージは他のパッケージに依存するかもしれません。そして、この依存性を定
    義するためのいろいろな方法があります。pkgsrc は、<code class="filename">buildlink3.mk</code>を使った依存関
    係 (依存性の処理用としては、こちらが望ましい方法です。
    この方法では以下の各変数を使っています。
    さらなる情報は<a class="xref" href="buildlink.html" title="Chapter 14. buildlink 方法論">Chapter 14, <i>buildlink 方法論</i></a>を参照してください)
    のほか、
    <code class="varname">BUILD_DEPENDS</code> および <code class="varname">DEPENDS</code> 定義、
    <code class="varname">USE_TOOLS</code> 定義をサポートしています。</p>
<p>両変数の基本的な差異は、以下の通りです: <code class="varname">DEPENDS</code>定義では、
    その依存性がバイナリーパッケージ内に記録されるので、
    後でバイナリーパッケージをインストールする時に依存性が呼び出されます。
    一方、<code class="varname">BUILD_DEPENDS</code>定義ではバイナリーパッケージにそのような記録はされず、
    パッケージの構築に際して依存性があることが示されているだけです。</p>
<p>つまり、あるパッケージが必要となるのが構築時だけである場合、そのパッケージ
    は<code class="varname">BUILD_DEPENDS</code>として書きます。</p>
<p><code class="varname">BUILD_DEPENDS</code>および
    <code class="varname">DEPENDS</code>定義の書式は以下の通りです:</p>
<pre class="programlisting">
&lt;pre-req-package-name&gt;:../../&lt;category&gt;/&lt;pre-req-package&gt;
    </pre>
<p>なお、この<span class="quote">“<span class="quote">pre-req-package-name</span>”</span> のバージョン番号には、<a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?pkg_info+1+NetBSD-5.0.1+i386"><span class="citerefentry"><span class="refentrytitle">pkg_info</span>(1)</span></a> で説明され
    ている各ワイルドカードを含めることができます。</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem">
<p>パッケージを構築または実行するために他のパッケージのバイナリーやライブラリーが必要で、
	そのパッケージに <code class="filename">buildlink3.mk</code> ファイルがある場合は、
	それを使ってください。</p>
<pre class="programlisting">
.include "../../graphics/jpeg/buildlink3.mk"
	</pre>
</li>
<li class="listitem">
<p>パッケージを構築するために、他のパッケージのバイナリーが必要な場合は、
	<code class="varname">BUILD_DEPENDS</code> 定義を使ってください。</p>
<pre class="programlisting">
BUILD_DEPENDS+= scons-[0-9]*:../../devel/scons
	</pre>
</li>
<li class="listitem"><p>パッケージがリンクのためのライブラリーを必要とし、
	そのパッケージに <code class="filename">buildlink3.mk</code> ファイルがない場合は、
	<code class="filename">buildlink3.mk</code> ファイルを作ってください。
	<code class="varname">DEPENDS</code> を使うと、
	インクルードファイルやライブラリーをコンパイラーから隠してしまうので、このような場合には不適切です。</p></li>
<li class="listitem">
<p>パッケージを実行するために、いくつかの実行可能ファイルが必要であり、かつ
	<code class="filename">buildlink3.mk</code> ファイルが存在しない場合は、
	<code class="varname">DEPENDS</code>変数を使ってください。<a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/print/lyx/README.html" target="_top"><code class="filename">print/lyx</code></a>パッケージを実行する時には、
	teTeXパッケージ由来のlatex のバイナリーが実行可能でなければなりません。これ
	は、以下のように指定します。</p>
<pre class="programlisting">
DEPENDS+=        teTeX-[0-9]*:../../print/teTeX
	</pre>
</li>
<li class="listitem">
<p>パッケージ依存関係にはワイルドカードを使うことができます。
	ワイルドカード依存関係は、バイナリーパッケージを作る時には保持されること
	に注意してください。依存関係はバイナリーパッケージのインストール時にチェッ
	クされ、パターンにマッチするパッケージが使われます。ワイルドカード依存関係
	は、注意を払って使うよう気を付けてください。</p>
<p><span class="quote">“<span class="quote">tk-postgresql</span>”</span>が<span class="quote">“<span class="quote">tk-*</span>”</span>という
	<code class="varname">DEPENDS</code>にマッチするなどの曖昧なマッチの可能性を排除
	するため、<span class="quote">“<span class="quote">-*</span>”</span>ではなく
	<span class="quote">“<span class="quote">-[0-9]*</span>”</span>を使うことをおすすめします。</p>
<p>ワイルドカードは、
	依存パッケージがあるバージョン以上でないと構築できないことを指定するのにも使えます。</p>
<pre class="programlisting">
DEPENDS+=       ImageMagick&gt;=6.0:../../graphics/ImageMagick
	</pre>
<p>以上のように書いた場合、このパッケージは ImageMagick のバージョン 6.0
	以上を使って構築されることを意味します。このような形式の依存関係は、たとえば、
	依存先のコマンドラインオプションが変更された場合にでも、構築できることを保証することができます。</p>
<p>あるバージョン以上のライブラリーに依存させる必要がある場合は、
	the pkgsrc guide の buildlink の節をご覧ください。</p>
<p>セキュリティー上の修正があった場合は、
	パッケージ脆弱性ファイルを更新してください。
	さらなる情報は、<a class="xref" href="fixes.html#security-handling" title="19.1.10. セキュリティー問題を持つパッケージへの対処">Section 19.1.10, “セキュリティー問題を持つパッケージへの対処”</a>を参照してください。</p>
</li>
</ol></div>
<p>パッケージの構築用に別のパッケージに含まれるファイルが必要な場合は、
    関連する配布ファイルを
    <code class="varname">DISTFILES</code> に追加して、
    必要なファイルが自動的に展開されるようにします。例としては <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/print/ghostscript/README.html" target="_top"><code class="filename">print/ghostscript</code></a> パッケージをご覧ください。
    (このパッケージは、
    構築の際に jpeg のソースがソースの状態で存在することに依存しています。)</p>
</div>
<div class="sect2" title="19.1.7. 他のパッケージとの衝突の処理">
<div class="titlepage"><div><div><h3 class="title">
<a name="conflicts"></a>19.1.7. 他のパッケージとの衝突の処理</h3></div></div></div>
<p>パッケージは、すでにインストール済みの別のパッケージと衝突する可能性があり
    ます。例えば、パッケージが、pkgsrcの中の別のパッケージと同じファイルをイン
    ストールするような場合です。</p>
<p>この場合、衝突するパッケージ(バージョン文字列を含む)のリストをスペースで区
    切って<code class="varname">CONFLICTS</code>にセットすることができます。</p>
<p>例えば、<a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/x11/Xaw3d/README.html" target="_top"><code class="filename">x11/Xaw3d</code></a>
    および<a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/x11/Xaw-Xpm/README.html" target="_top"><code class="filename">x11/Xaw-Xpm</code></a>は同じ共有ライブラリーをイ
    ンストールします。したがって、<code class="filename">pkgsrc/x11/Xaw3d/Makefile</code>に以下のような設定を
    おこなってください。</p>
<pre class="programlisting">
CONFLICTS=      Xaw-Xpm-[0-9]*
    </pre>
<p>そして、<code class="filename">pkgsrc/x11/Xaw-Xpm/Makefile</code>には以下の設定が必要です。</p>
<pre class="programlisting">
CONFLICTS=      Xaw3d-[0-9]*
    </pre>
<p>パッケージは、名前のプレフィックスが同じで、異なるバージョン文字列をもつ別
    のパッケージと自動的に衝突します。例えば<span class="quote">“<span class="quote">Xaw3d-1.5</span>”</span>は、古いバージョンの
    <span class="quote">“<span class="quote">Xaw3d-1.3</span>”</span>と衝突するでしょう。</p>
</div>
<div class="sect2" title="19.1.8. 構築することができない、あるいはすべきでないパッケージ">
<div class="titlepage"><div><div><h3 class="title">
<a name="not-building-packages"></a>19.1.8. 構築することができない、あるいはすべきでないパッケージ</h3></div></div></div>
<p>環境によってはパッケージを構築しないよう指示するような理由がいくつかありま
    す。パッケージが、ほとんどのプラットフォームで構築および実行できる場合は、
    <code class="varname">NOT_FOR_PLATFORM</code>として例外を記述します。逆に、パッケージが一部のプラットフォー
    ムでしか構築および実行できない場合は、<code class="varname">ONLY_FOR_PLATFORM</code>を設定します。
    <code class="varname">ONLY_FOR_PLATFORM</code> と
    <code class="varname">NOT_FOR_PLATFORM</code> の値はいずれも、OS triples
    (OS-version-platform) であり、
    グロブ形式のワイルドカードを使うことができます。</p>
<p>パッケージのなかには、あるオペレーティングシステムの特定のバージョンに強く依存するものがあります。
    たとえば、LKM や <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/sysutils/lsof/README.html" target="_top"><code class="filename">sysutils/lsof</code></a> などです。
    このようなバイナリーパッケージは、同じ OS の別バージョンと後方互換ではないので、
    FTP サーバーでは対象バージョン専用のディレクトリーにアップロードするようにします。
    <code class="varname">OSVERSION_SPECIFIC</code> を <span class="quote">“<span class="quote">yes</span>”</span> に設定して、
    パッケージに印をつけてください。この変数は、現在のところ、
    パッケージシステム内部のどこでも使われませんが、
    将来は使われることになるかもしれません。</p>
<p>パッケー
    ジをとばすべき場合(たとえば、そのパッケージが提供する機能が、すでにシステム
    で提供されている場合)は、
    <code class="varname">PKG_SKIP_REASON</code>にそのことを説明するメッセージを設
    定します。必要な条件が満たされていないせいでパッケージの構築が失敗するであ
    ろう場合は、<code class="varname">PKG_FAIL_REASON</code>にそのことを説明するメッセージを設定します。</p>
</div>
<div class="sect2" title="19.1.9. 一旦インストールしたら削除すべきでないパッケージ">
<div class="titlepage"><div><div><h3 class="title">
<a name="undeletable-packages"></a>19.1.9. 一旦インストールしたら削除すべきでないパッケージ</h3></div></div></div>
<p>あるパッケージを、一旦インストールしたら削除できないようにするためには、
    そのパッケージの Makefile で <code class="varname">PKG_PRESERVE</code>
    定義を設定します。この定義を設定した
    pkgsrc エントリーから作られたバイナリーパッケージには、その旨が記録されます。
    <span class="quote">“<span class="quote">preserved</span>”</span> 付きのパッケージは、
    <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?pkg_delete+1+NetBSD-5.0.1+i386"><span class="citerefentry"><span class="refentrytitle">pkg_delete</span>(1)</span></a> を使っても、
    <span class="quote">“<span class="quote">-f</span>”</span> オプションを付けない限りは削除されません。</p>
</div>
<div class="sect2" title="19.1.10. セキュリティー問題を持つパッケージへの対処">
<div class="titlepage"><div><div><h3 class="title">
<a name="security-handling"></a>19.1.10. セキュリティー問題を持つパッケージへの対処</h3></div></div></div>
<p>脆弱性が発見された場合、そのことを
    <code class="filename">localsrc/security/advisories/pkg-vulnerabilities</code>に記載してcommitしてくださ
    い。このファイルを commit した後、同じディレクトリーで <span class="command"><strong>make upload</strong></span>
    して、ftp.NetBSD.org 上のファイルを更新してください。</p>
<p>脆弱性の修正を、パッチの適用によっておこなった場合は、修正後に
    <code class="varname">PKGREVISION</code> を上げます (もちろん、問題の修正を、
    新しくリリースされたソフトウェアを使っておこなった場合は、
    これは必要ありません)。</p>
<p>また、修正を安定版 pkgsrc 枝に適用したほうがよい場合は、
    pullup 要求を提出してください。</p>
<p>ftp.NetBSD.org 上にすでに置かれているバイナリーパッケージは、
    週次の cron ジョブによって半自動的に対処されます。</p>
</div>
<div class="sect2" title="19.1.11. 既存パッケージ修正時に、バージョンを上げるにはどうするか">
<div class="titlepage"><div><div><h3 class="title">
<a name="bumping-pkgrevision"></a>19.1.11. 既存パッケージ修正時に、バージョンを上げるにはどうするか</h3></div></div></div>
<p>既存のパッケージに修正を加えたときに、<code class="varname">PKGNAME</code>のバージョン番号を変えると便利
    な場合があります。元の作者による将来のバージョンと衝突しないようにするため、
    <code class="varname">PKGREVISION=1</code> (2, ...)を設定して、パッケージのバージョンに
    <span class="quote">“<span class="quote">nb1</span>”</span>, <span class="quote">“<span class="quote">nb2</span>”</span>, ...
    という接尾辞をつけることができます。この<span class="quote">“<span class="quote">nb</span>”</span>は、パッケージのツール群からは<span class="quote">“<span class="quote">.</span>”</span>と
    同様の扱いを受けます。たとえば、</p>
<pre class="programlisting">
DISTNAME=       foo-17.42
PKGREVISION=    9
    </pre>
<p>とすると、<code class="varname">PKGNAME</code>は<span class="quote">“<span class="quote">foo-17.42nb9</span>”</span>になります。
    たとえば <code class="varname">DIST_SUBDIR</code> の設定用などに、
    <code class="varname">PKGNAME</code> に接尾辞 <span class="quote">“<span class="quote">nbX</span>”</span> がつかない、
    元の値を使いたい場合は、<code class="varname">PKGNAME_NOREV</code> を使います。</p>
<p>このパッケージの新しいリリース版が出た際には、
    <code class="varname">PKGREVISION</code>は消してください。
    たとえば、上で例示したパッケージの新しいマイナーリリースに際しては、以下の
    ようにします。</p>
<pre class="programlisting">
DISTNAME=       foo-17.43
    </pre>
<p>バイナリーパッケージに対して自明でない変化をおよぼす場合は、すべて、
    <code class="varname">PKGREVISION</code> を上げるようにします。
    <code class="varname">PKGREVISION</code> を上げないと、
    変更前のバージョンをインストールしている人が、
    そのパッケージが古くなったことを知るすべがなくなってしまいます。
    したがって、<code class="varname">PKGREVISION</code> を上げない変更とは、本質的に
    「誰もアップグレードする必要のない自明な変更」ということであり、
    これが <code class="varname">PKGREVISION</code> を上げるべきか否かを大雑把に判断する方法です。
    <code class="varname">PKGREVISION</code> を上げる意味のない変更には、たとえば以下のようなものがあります。</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p><code class="varname">HOMEPAGE</code>,
      <code class="varname">MAINTAINER</code>, <code class="varname">OWNER</code>
      や、Makefile 中のコメントの変更。</p></li>
<li class="listitem"><p>
      構築変数の変更で、作成されるバイナリーパッケージに変化がない場合。</p></li>
<li class="listitem"><p>
      <code class="filename">DESCR</code> の変更。</p></li>
<li class="listitem"><p>
      <code class="varname">PKG_OPTIONS</code> の追加で、標準のオプションに変化がない場合。</p></li>
</ul></div>
<p><code class="varname">PKGREVISION</code> を上げる価値のある変更には、
    たとえば以下のようなものがあります。</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>
      セキュリティーの修正</p></li>
<li class="listitem"><p>
      パッチファイルの変更または追加</p></li>
<li class="listitem"><p>
      <code class="filename">PLIST</code> の変更</p></li>
<li class="listitem"><p>依存性の変更や、依存先パッケージの改称。</p></li>
</ul></div>
<p>依存するパッケージの ABI が変更された場合にも、
    PKGREVISION を上げる必要があります。</p>
</div>
<div class="sect2" title="19.1.12. パッケージのファイル中の各種テキストを置換する (SUBST の枠組)">
<div class="titlepage"><div><div><h3 class="title">
<a name="fixes.subst"></a>19.1.12. パッケージのファイル中の各種テキストを置換する (SUBST の枠組)</h3></div></div></div>
<p>複数のファイルに含まれる同じテキストを置換したい場合や、
    テキストの置換方法を変化させたい場合には、パッチだけでは実現できません。
    そこで SUBST の枠組の出番です。この枠組では、
    ファイル内のテキストを置換するために簡単に使えるインターフェースを用意しています。
    たとえば以下のように使います。</p>
<pre class="programlisting">
SUBST_CLASSES+=                 fix-paths
SUBST_STAGE.fix-paths=          pre-configure
SUBST_MESSAGE.fix-paths=        Fixing absolute paths.
SUBST_FILES.fix-paths=          src/*.c
SUBST_FILES.fix-paths+=         scripts/*.sh
SUBST_SED.fix-paths=            -e 's,"/usr/local,"${PREFIX},g'
SUBST_SED.fix-paths+=           -e 's,"/var/log,"${VARBASE}/log,g'
    </pre>
<p><code class="varname">SUBST_CLASSES</code> は、ここで定義する
    SUBST の塊を区別するための識別子を並べたリストです。
    SUBST の枠組は pkgsrc で多用されているので、この変数には常に
    <code class="literal">+=</code> 演算子を使うことが重要です。
    そうしないと、一部の置換がおこなわれなくなることがあります。</p>
<p>各 SUBST の塊の残りの変数は、
    最初の行の識別子 (この例では <code class="literal">fix-paths</code>)
    を使ってパラメーター化されています。
    これらは、関数呼び出しの引数とみなすことができます。</p>
<p><code class="varname">SUBST_STAGE.*</code> は、
    この置換をどの期におこなうかを指定します。
    実際に使われるものは限られていますが、相の名前と
    <code class="literal">pre-</code>, <code class="literal">do-</code>,
    <code class="literal">post-</code> のあらゆる組合せを使うことができます。
    もっともよく使われるのは <code class="literal">post-patch</code> と
    <code class="literal">pre-configure</code> です。このふたつのうち、
    <code class="literal">pre-configure</code> を使うと、
    <span class="command"><strong>bmake patch</strong></span> を実行することで、
    パッチを適用したほかは一切変更されていない状態にすることができるため、
    こちらのほうが好まれます。このことは、
    新しいパッチを作成するためにパッケージのデバッグをする際に、
    特に便利です。これと同様に、<code class="literal">pre-install</code>
    よりも <code class="literal">post-build</code> のほうが好まれます。
    これは、一般的に install 相は極力簡素なものにするほうがよいからです。
    <code class="literal">post-build</code> を使った場合、
    後にインストールされるものと同じファイルが作業ディレクトリーにできあがるので、
    正しく置換がおこなわれたかを確認することができます。</p>
<p><code class="varname">SUBST_MESSAGE.*</code> は、
    置換がおこなわれる直前に表示するテキストで、省略可能です。</p>
<p><code class="varname">SUBST_FILES.*</code> は、置換の対象となるファイルを、
    シェルのグロブパターンで指定したものを並べたリストです。
    このパターンは、<code class="varname">WRKSRC</code>
    ディレクトリーからの相対位置として解釈されます。</p>
<p><code class="varname">SUBST_SED.*</code> は置換の内容を
    <a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?sed+1+NetBSD-5.0.1+i386"><span class="citerefentry"><span class="refentrytitle">sed</span>(1)</span></a> への引数の形で指定したものを並べたリストです。
    各 sed コマンドの前には <code class="literal">-e</code> をつけて、
    SUBST の塊全体が一様に見えるようにします。</p>
<p>以上のほかにも変数がいくつかありますが、
    それらはほとんど使われないものなので、
    <code class="filename">mk/subst.mk</code> ファイル内でのみ文書化されています。</p>
</div>
</div>
<div class="sect1" title="19.2. fetch 相での問題を修正する">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="fixes.fetch"></a>19.2. <span class="emphasis"><em>fetch</em></span> 相での問題を修正する</h2></div></div></div>
<div class="sect2" title="19.2.1. distfileのダウンロードが単純にできないパッケージ">
<div class="titlepage"><div><div><h3 class="title">
<a name="no-plain-download"></a>19.2.1. distfileのダウンロードが単純にできないパッケージ</h3></div></div></div>
<p>動的なURLからダウンロードする必要がある場合は、
    <code class="varname">DYNAMIC_MASTER_SITES</code>
    を設定す
    ることができます。すると、<span class="command"><strong>make fetch</strong></span>は、ダウンロードすべき各ファイルを引
    数として<code class="filename">files/getsite.sh</code>を呼び出します。このスクリプトは、ファイルをダウン
    ロードするディレクトリーのURLを出力することが前提となっています。
    <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/graphics/ns-cult3d/README.html" target="_top"><code class="filename">graphics/ns-cult3d</code></a>が、
    この使い方の例となっています。</p>
<p>パスワード用に個人情報の登録が必要だったり、ソースに代金を払う必要があった
    り、その他もろもろの理由により、ダウンロードが自動化できない場合は、
    <code class="varname">FETCH_MESSAGE</code> を、
    構築中止前にユーザーに表示する説明文を行ごとに並べたリストに設定することができます。
    たとえば以下のようにします。</p>
<pre class="programlisting">
FETCH_MESSAGE=  "Please download the files"
FETCH_MESSAGE+= "    "${DISTFILES:Q}
FETCH_MESSAGE+= "manually from "${MASTER_SITES:Q}"."
    </pre>
</div>
<div class="sect2" title="19.2.2. '古い'名前のまま更新されたdistfileの取り扱い">
<div class="titlepage"><div><div><h3 class="title">
<a name="modified-distfiles-same-name"></a>19.2.2. '古い'名前のまま更新されたdistfileの取り扱い</h3></div></div></div>
<p>時々、ソフトウェアパッケージの作者がソフトウェアのリリース後に変更を加え、
    変更後のdistfileを、バージョン番号を変えずに公開することがあります。このと
    き、pkgsrcにそのパッケージがすでに入っていると、チェックサムが一致しない
    ことになります。distfileの更新が意図されたものであって、
    トロイの木馬などが仕込まれたのではないことを確認するため、
    新しい distfile の内容と変更前の古い distfile の内容と比較してください。
    新旧の distfile を比較したことと、何が変わったのかを、
    commit メッセージに含めてください。
    確認後、この問題の正しい回避策は、<code class="varname">DIST_SUBDIR</code>
    を一意な (普通は <code class="varname">PKGNAME_NOREV</code>
    にもとづく) ディレクトリー名に設定することです。
    これを設定すると、このパッケージの <code class="varname">DISTFILES</code> と
    <code class="varname">PATCHFILES</code> はすべて、
    distfiles ディレクトリー以下の、設定した名前のサブディレクトリーに置かれます。
    (詳細は、<a class="xref" href="fixes.html#bumping-pkgrevision" title="19.1.11. 既存パッケージ修正時に、バージョンを上げるにはどうするか">Section 19.1.11, “既存パッケージ修正時に、バージョンを上げるにはどうするか”</a>をご覧ください。)
    この問題がよく起きる場合は、ディレクトリー名に
    <code class="varname">PKGNAME</code> を使ったり
    (これにより <code class="filename">nbX</code> サフィックスが含まれる)、
    <code class="varname">${PKGNAME_NOREV}-YYYYMMDD</code> のように日付を付けたりすることができます。
    設定後は、<code class="filename">distinfo</code> ファイルを作り直すのを忘れないでください。
    このファイルでは、ファイル名のなかに <code class="varname">DIST_SUBDIR</code>
    パスが含まれているからです。
    この変更によって、インストールされるパッケージが以前のものと異なるものになる場合は、
    PKGREVISION も上げます。
    さらに、パッケージの正当な作者にメールを出して、
    リリース後に、ファイル名を変えずに
    distfile の内容を変えるのはよろしくないやり方だと伝えてください。</p>
</div>
</div>
<div class="sect1" title="19.3. configure 相での問題を修正する">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="fixes.configure"></a>19.3. <span class="emphasis"><em>configure</em></span> 相での問題を修正する</h2></div></div></div>
<div class="sect2" title="19.3.1. 共有ライブラリー - libtool">
<div class="titlepage"><div><div><h3 class="title">
<a name="fixes.libtool"></a>19.3.1. 共有ライブラリー - libtool</h3></div></div></div>
<p>pkgsrcはさまざまな種類のマシンをサポートします。それらはa.outとELFのような
    異なるオブジェクトフォーマットを使い、共有ライブラリー、ダイナミックローディ
    ングの有無すらも異なります。これに対応するためにコマンドそのもの、およびオ
    プションがコンパイラー、リンカーなどに渡される必要があります。すべてのマシ
    ンで正しく動作させることは非常にむずかしく、テストのためにすべてのマシンを
    持っていない場合は特にそうでしょう。
    <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/devel/libtool/README.html" target="_top"><code class="filename">devel/libtool</code></a>パッケージはこれを助けます。
    <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/devel/libtool/README.html" target="_top"><code class="filename">devel/libtool</code></a>はプラットフォームによらずに、
    ソースファイルから、静的、動的なライブラリー両方を構築する方法
    を<span class="quote">“<span class="quote">知って</span>”</span>いるからです。</p>
<p>以下に、libtoolをパッケージで使用するための7つの手順を記述します。</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p><code class="varname">USE_LIBTOOL=yes</code>をパッケージのMakefileへ追加します。</p></li>
<li class="listitem"><p>ライブラリーオブジェクトのために、<span class="quote">“<span class="quote">${LIBTOOL} --mode=compile ${CC}</span>”</span>を<span class="quote">“<span class="quote">${CC}</span>”</span>
	に設定します。ライブラリーが、提供されたMakefileだけを使用して構築される
	のであれば、<code class="varname">CC</code>の定義にこれを追加するだけです。このコマンドひとつだけで、
	PICと非PICのライブラリーオブジェクトを作成します。したがって、共有ライブ
	ラリーとそうでないライブラリーの構築規則を別々に記述する必要はありません。</p></li>
<li class="listitem">
<p>ライブラリーのリンクのための<span class="quote">“<span class="quote">ar</span>”</span>、<span class="quote">“<span class="quote">ranlib</span>”</span>、<span class="quote">“<span class="quote">ld -Bshareable</span>”</span>コマン
	ドを削除してください。そしてその代わりに以下のコマンドを使用してください。</p>
<pre class="programlisting">
${LIBTOOL} --mode=link \
    ${CC} -o ${.TARGET:.a=.la} \
        ${OBJS:.o=.lo} \
        -rpath ${PREFIX}/lib \
        -version-info major:minor
	</pre>
<p>ライブラリーの拡張子は<code class="filename">.la</code>に、オブジェクトの拡張子は
	<code class="filename">.lo</code>に変更されることに
	注意してください。<code class="varname">OBJS</code>
	を必要に応じて変更してください。このコマンドは、必
	要なものすべて、
	<code class="filename">.a</code>、<code class="filename">.so.major.minor</code>、
	そしてELFのシンボリックリンク(必要
	なら)を自動的にカレントディレクトリーに作成します。特に、メジャー番号と
	マイナー番号がゼロの場合は、<span class="quote">“<span class="quote">-version-info</span>”</span>をかならず含めるようにしてくだ
	さい。そうしないとlibtoolは共有ライブラリーのバージョンを取り除きます。</p>
<p>libtool のマニュアルより:</p>
<pre class="programlisting">
libtool のライブラリーのバージョンは、以下の三つの整数で表されます。

CURRENT
このライブラリーが実装しているインターフェース番号のうち最新のもの。

REVISION
CURRENT インターフェースの実装番号。

AGE
このライブラリーが実装しているインターフェースの最新のものと最古のものの間の差。
すなわち、このライブラリーが実装しているのは、
`CURRENT - AGE' から `CURRENT' までの番号の範囲にある、
すべてのインターフェース番号です。

二つのライブラリーの CURRENT と AGE 番号がいずれも同じ場合、
ダイナミックリンカーは REVISION 番号が大きいほうのライブラリーを選びます。
	</pre>
<p>また、<span class="quote">“<span class="quote">-release</span>”</span>オプションは、ある一つの場合に限って、a.outとELF(シンボ
	リックリンクを除く)との間で異なる結果をもたらします。
	<span class="quote">“<span class="quote">libfoo-release.so.<span class="emphasis"><em>x</em></span>.<span class="emphasis"><em>y</em></span></span>”</span>
	の形式のELFライブラリーは、a.outプラットフォーム上
	では
	<span class="quote">“<span class="quote">libfoo.so.<span class="emphasis"><em>x</em></span>.<span class="emphasis"><em>y</em></span></span>”</span>
	のシンボリックリンクを持ちます。これは自動的に処理され
	ます。</p>
<p><span class="quote">“<span class="quote">-rpath引数</span>”</span>は構築されたライブラリーのインストール先ディレクトリーです。</p>
<p><code class="filename">PLIST</code>には、
	<code class="filename">.la</code> ファイルだけを含めます。
	これ以外のファイルは自動的に追加されます。</p>
</li>
<li class="listitem">
<p>共有オブジェクト(<code class="filename">.so</code>)ファイル(すなわち、<a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?dlopen+3+NetBSD-5.0.1+i386"><span class="citerefentry"><span class="refentrytitle">dlopen</span>(3)</span></a>でロードされるファイル
	であって、共有ライブラリーでは*ありません*)のリンク時には、ファイルにバー
	ジョンが加えられないようにするため、<span class="quote">“<span class="quote">-module -avoid-version</span>”</span>を使ってくだ
	さい。</p>
<p><code class="filename">PLIST</code>ファイルには<code class="filename">foo.so</code>
	の一覧が加わります。</p>
</li>
<li class="listitem">
<p>インストールする<span class="emphasis"><em>前</em></span>のライブラリーに依存するプログラムをリンクする時に、
	<a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?cc+1+NetBSD-5.0.1+i386"><span class="citerefentry"><span class="refentrytitle">cc</span>(1)</span></a>か<a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?ld+1+NetBSD-5.0.1+i386"><span class="citerefentry"><span class="refentrytitle">ld</span>(1)</span></a>の前に
	<span class="quote">“<span class="quote">${LIBTOOL} --mode=link</span>”</span>を書いてください。このコマンドは、正
	しいライブラリー(静的、または共有)を見つけます。ただし、libtoolを使う時
	には-Lオプションで相対パスを指定すること(<span class="quote">“<span class="quote">-L../somelib</span>”</span>のように)ができない
	ことに注意してください。引数として<code class="filename">.la</code>ファイルを使うように修正しなければ
	なりません。例えば、</p>
<pre class="programlisting">
${LIBTOOL} --mode=link ${CC} -o someprog -L../somelib -lsomelib
	</pre>
<p>は、以下のように変更する必要があります。</p>
<pre class="programlisting">
${LIBTOOL} --mode=link ${CC} -o <em class="replaceable"><code>someprog</code></em> <em class="replaceable"><code>../somelib/somelib.la</code></em>
	</pre>
<p>これで、ライブラリーを正しく扱う事ができます。</p>
</li>
<li class="listitem">
<p>ライブラリーをインストールするときに、<a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?install+1+NetBSD-5.0.1+i386"><span class="citerefentry"><span class="refentrytitle">install</span>(1)</span></a>
	あるいは<a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?cp+1+NetBSD-5.0.1+i386"><span class="citerefentry"><span class="refentrytitle">cp</span>(1)</span></a>コマンドの前に
	<span class="quote">“<span class="quote">${LIBTOOL} --mode=install</span>”</span>を書いて下さい。そしてライブラリーの名前を
	<code class="filename">.la</code>に変えてください。例えば、以下のように書く必要があります。</p>
<pre class="programlisting">
${LIBTOOL} --mode=install ${BSD_INSTALL_LIB} ${SOMELIB:.a=.la} ${PREFIX}/lib
	</pre>
<p>これは、静的リンクのための<code class="filename">.a</code>、共有ライブラリー、必要なシンボリックリンク
	をインストールし、<a class="citerefentry" href="http://netbsd.gw.com/cgi-bin/man-cgi?ldconfig+8+NetBSD-5.0.1+i386"><span class="citerefentry"><span class="refentrytitle">ldconfig</span>(8)</span></a>を実行します。</p>
</li>
<li class="listitem"><p><code class="filename">PLIST</code>には、
	<code class="filename">.la</code> ファイルだけを含めます
	(これは、以前のものから変わった点です)。</p></li>
</ol></div>
</div>
<div class="sect2" title="19.3.2. すでにlibtoolをサポートしているGNUパッケージでlibtoolを使う">
<div class="titlepage"><div><div><h3 class="title">
<a name="using-libtool"></a>19.3.2. すでにlibtoolをサポートしているGNUパッケージでlibtoolを使う</h3></div></div></div>
<p><code class="varname">USE_LIBTOOL=yes</code> をパッケージの
    Makefile に追加します。こうするとほとんどの場合、パッケージ固有の
    libtool を無視します。古い libtool を使っているパッケージでは、
    libtool はdo-configureターゲットでltconfigスクリプトにより作られます。<span class="command"><strong>make
    configure; find work*/ -name libtool</strong></span>
    のようにして、libtool スクリプトの場所を確認することができます。</p>
<p><code class="varname">LIBTOOL_OVERRIDE</code> で、どの libtool
    スクリプトを無視するかを、<code class="varname">WRKSRC</code> からの相対位置で指定します。
    指定しなかった場合、<span class="quote">“<span class="quote">libtool */libtool
    */*/libtool</span>”</span> に設定されますので、パッケージ固有の libtool
    スクリプトの場所がこのいずれとも異なる場合は、適宜設定してください。</p>
<p>静的ライブラリー <code class="filename">*.a</code>
    の構築やインストールが必要ない場合は、かわりに
    <code class="varname">SHLIBTOOL_OVERRIDE</code> を使います。</p>
<p>パッケージが動的共有オブジェクトのロードに、libtool (libltdl)のプラットフォー
    ム独立なライブラリーを使う場合は、
    devel/libltdl/buildlink3.mkをインクルードしてください。</p>
<p>パッケージによっては、環境により動作や構築ができなくなるような、正しくない
    libtoolの使い方をしているものがあります。ありがちな間違いは以下のようなもの
    です。</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem">
<p>実行形式やライブラリーで、共有オブジェクト(-module)を依存ライブラリーと
	してインクルードする。このこと自体は、以下の二つのうちいずれかが行なわれ
	ている場合は、問題になりません。</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>その共有オブジェクトが正しく命名されている。すなわち、
	    <code class="filename">libfoo.la</code>ではなく
	    <code class="filename">libfoo.la</code>となっている。</p></li>
<li class="listitem"><p>-dlopenオプションが実行形式のリンク時に使われている。</p></li>
</ol></div>
</li>
<li class="listitem"><p>ルーチンの初期化を適切に呼ばずにlibltdlを使う。関数lt_dlinit()を呼んで、
	マクロ
	<code class="varname">LTDL_SET_PRELOADED_SYMBOLS</code>を実行形式にインクルードするようにしましょ
	う。</p></li>
</ul></div>
</div>
<div class="sect2" title="19.3.3. GNU Autoconf/Automake">
<div class="titlepage"><div><div><h3 class="title">
<a name="autoconf-automake"></a>19.3.3. GNU Autoconf/Automake</h3></div></div></div>
<p>パッケージが、configureスクリプトやmakefileの雛型Makefile.inを再生成するた
    めにGNU autoconfまたはautomakeを実行する必要がある場合、これらの実行は
    pre-configureターゲットでおこないます。</p>
<p>autoconfのみを必要とするパッケージでは以下のようになります:</p>
<pre class="programlisting">
AUTOCONF_REQD=  2.50            # if default version is not good enough
USE_TOOLS+=     autoconf        # use "autoconf213" for autoconf-2.13
...

pre-configure:
        cd ${WRKSRC} &amp;&amp; autoconf

...
    </pre>
<p>また、automakeとautoconfを必要とするパッケージでは以下のようになります:</p>
<pre class="programlisting">
AUTOMAKE_REQD=  1.7.1           # if default version is not good enough
USE_TOOLS+=     automake        # use "automake14" for automake-1.4
...

pre-configure:
        set -e; cd ${WRKSRC}; \
        aclocal; autoheader; automake -a --foreign -i; autoconf

...
    </pre>
<p>GNU Automake を使うパッケージは、ほぼ確実に
    GNU Make を必要とします。</p>
<p>生成されたファイルに対して、configureプロセスがさらに変更を加える時がありま
    すが、この時には構築プロセスが一連のautomakeの手順を再実行しようとします。
    configureの段階でさまざまなファイルに手を加えると、この挙動は止められます。
    この挙動が問題が起こす場合は、そのパッケージのMakefileで
    <code class="varname">AUTOMAKE_OVERRIDE=NO</code>を設定することができます。</p>
</div>
</div>
<div class="sect1" title="19.4. プログラミング言語">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="programming-languages"></a>19.4. プログラミング言語</h2></div></div></div>
<div class="sect2" title="19.4.1. C, C++ および Fortran">
<div class="titlepage"><div><div><h3 class="title">
<a name="basic-programming-languages"></a>19.4.1. C, C++ および Fortran</h3></div></div></div>
<p>C, C++ および Fortran 言語用のコンパイラーは、
    NetBSD の基本システムに附属しています。標準では、
    pkgsrc はパッケージが C で書かれていると仮定し、それ以外のコンパイラーをすべて隠します
    (ラッパーの枠組による。<a class="xref" href="buildlink.html" title="Chapter 14. buildlink 方法論">Chapter 14, <i>buildlink 方法論</i></a>参照)。</p>
<p>パッケージがどの言語のコンパイラーを必要としているかを表すには、
    <code class="varname">USE_LANGUAGES</code> 変数を設定します。使うことのできる値は、
    現在のところ、<span class="quote">“<span class="quote">c</span>”</span>, <span class="quote">“<span class="quote">c++</span>”</span>,
    <span class="quote">“<span class="quote">fortran</span>”</span> (および、これらの任意の組合せ) です。標準では
    <span class="quote">“<span class="quote">c</span>”</span> になります。GNU の configure スクリプトを使うパッケージでは、
    C++ で書かれているものであっても、通常は configure 相で
    C コンパイラーを必要とします。</p>
</div>
<div class="sect2" title="19.4.2. Java">
<div class="titlepage"><div><div><h3 class="title">
<a name="java-programming-language"></a>19.4.2. Java</h3></div></div></div>
<p>プログラムが Java で書かれている場合は、pkgsrc における Java
    の枠組を使います。パッケージは
    <code class="filename">../../mk/java-vm.mk</code> をインクルードする必要があります。
    この Makefile の断片は、以下の変数を用意してくれます。</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p><code class="varname">USE_JAVA</code> は、
      JDK への依存性が追加されるかどうかを定義します。
      <code class="varname">USE_JAVA</code> が <span class="quote">“<span class="quote">run</span>”</span> に設定された場合は、
      JDK への実行時依存性があるだけです。標準では <span class="quote">“<span class="quote">yes</span>”</span> となり、
      この場合は JDK への構築時依存性も追加されます。</p></li>
<li class="listitem"><p>パッケージが Java2 の実装を必要とすることを表すため、
      <code class="varname">USE_JAVA2</code> を設定します。この変数が対応している値は、
      <span class="quote">“<span class="quote">yes</span>”</span>, <span class="quote">“<span class="quote">1.4</span>”</span>,
      <span class="quote">“<span class="quote">1.5</span>”</span> です。 <span class="quote">“<span class="quote">yes</span>”</span> は任意の Java2
      の実装を受け入れます。<span class="quote">“<span class="quote">1.4</span>”</span> はバージョン 1.4 以上を要求し、
      <span class="quote">“<span class="quote">1.5</span>”</span> はバージョン 1.5 以上のみを受け入れます。
      この変数は標準では設定されません。</p></li>
<li class="listitem"><p><code class="varname">PKG_JAVA_HOME</code> は、
      依存している Java 実装のランタイムの場所を自動的に設定するものです。
      <code class="varname">JAVA_HOME</code> 変数の定義が必要なプログラムでは、
      この変数に適切な値を設定するために使うことができます。
      </p></li>
</ul></div>
</div>
<div class="sect2" title="19.4.3. perl スクリプトを含むパッケージ">
<div class="titlepage"><div><div><h3 class="title">
<a name="perl-scripts"></a>19.4.3. perl スクリプトを含むパッケージ</h3></div></div></div>
<p>perl スクリプトがパッケージに含まれる場合は、
    <code class="varname">USE_TOOLS</code> 変数に <span class="quote">“<span class="quote">perl</span>”</span> を追加し、
    適切なインタープリターへのパスが設定されるようにするために
    <code class="varname">REPLACE_PERL</code> を設定します。
    <code class="varname">REPLACE_PERL</code> の値には、パスを調節する対象のスクリプトを
    <code class="varname">WRKSRC</code> からの相対位置として並べたリストを含めるようにします。
    対象のスクリプト内に現れる <code class="filename">*/bin/perl</code> はすべて、
    perl の実行ファイルへのフルパスに置き換えられます。</p>
<p>特定のバージョンの perl が必要な場合は、
    <code class="varname">PERL5_REQD</code> 変数をバージョン番号に設定します。
    標準では <span class="quote">“<span class="quote">5.0</span>”</span> になります。</p>
<p>perl モジュールの扱いについては、
    <a class="xref" href="fixes.html#perl-modules" title="19.6.6. perl モジュールをインストールするパッケージ">Section 19.6.6, “perl モジュールをインストールするパッケージ”</a>をご覧ください。</p>
</div>
<div class="sect2" title="19.4.4. 他のプログラミング言語">
<div class="titlepage"><div><div><h3 class="title">
<a name="other-programming-languages"></a>19.4.4. 他のプログラミング言語</h3></div></div></div>
<p>現在のところ、pkgsrc では、他のプログラミング言語に対する特別な扱いはありません。
    その言語のコンパイラーのパッケージに
    <code class="filename">buildlink3.mk</code> ファイルがある場合は、
    このファイルをインクルードします。このファイルがない場合は、
    適切なコンパイラーのパッケージへの (構築時) 依存性を追加するだけです。</p>
</div>
</div>
<div class="sect1" title="19.5. build 相での問題を修正する">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="fixes.build"></a>19.5. <span class="emphasis"><em>build</em></span> 相での問題を修正する</h2></div></div></div>
<p>パッケージ構築時に最もよくある障害は、
	プラットフォームによっては必要なヘッダーファイル、関数やライブラリーがなかったり、
	あるいは、ライブラリーで提供される関数がパッケージ作者の考えているものと違っていたりするものです。
	そのようなことを回避するために、ほとんどの場合は、
	ない関数を使わないようにしたり、代替の関数を提供したりするように
	ソースコードを書き換えることができます。</p>
<div class="sect2" title="19.5.1. C および C++ のコードの条件つきコンパイル">
<div class="titlepage"><div><div><h3 class="title">
<a name="fixes.build.cpp"></a>19.5.1. C および C++ のコードの条件つきコンパイル</h3></div></div></div>
<p>パッケージに最初から GNU configure スクリプトが附属している場合は、
	構築の障害の修正方法としては、コードを変更せずに configure
	スクリプトを変更するのが望ましい方法です。configure スクリプトが附属しない場合は、
	コンパイル対象のオペレーティングシステムやハードウェアアーキテクチャーに応じて必要なマクロを定義している
	C プリプロセッサーを役立てることができます。このマクロは、たとえば
	<code class="varname">#if defined(__i386)</code> のようにして調べることができます。
	ほとんどすべてのオペレーティングシステム、ハードウェアアーキテクチャー、
	およびコンパイラーには、独自のマクロがあります。
	たとえば、<code class="varname">__GNUC__</code>,
	<code class="varname">__i386__</code>, <code class="varname">__NetBSD__</code>
	の各マクロがすべて定義されている場合は、i386 互換 CPU 上の NetBSD を使っていることと、
	コンパイラーが GCC であることがわかります。</p>
<p>以下に列挙するハードウェアおよびオペレーティングシステム用のマクロは、
	使っているコンパイラーに依存します。
	たとえば、Solaris 上でコードを条件付きコンパイルしたい場合、
	<code class="varname">__sun__</code> は
	SunPro コンパイラーでは定義されていないので使ってはいけません。
	かわりに <code class="varname">__sun</code> を使います。</p>
<div class="sect3" title="19.5.1.1. オペレーティングシステムを特定するための C プリプロセッサーマクロ">
<div class="titlepage"><div><div><h4 class="title">
<a name="fixes.build.cpp.os"></a>19.5.1.1. オペレーティングシステムを特定するための C プリプロセッサーマクロ</h4></div></div></div>
<p>4.4 BSD から派生したシステムとそれ以外のシステムを
        見分けるには、以下のコードを使うようにしてください。</p>
<pre class="programlisting">
#include &lt;sys/param.h&gt;
#if (defined(BSD) &amp;&amp; BSD &gt;= 199306)
/* BSD-specific code goes here */
#else
/* non-BSD-specific code goes here */
#endif
</pre>
<p>これでは十分正確でない場合は、
	以下のマクロを検査することもできます。</p>
<pre class="programlisting">
FreeBSD     __FreeBSD__
DragonFly   __DragonFly__
Interix     __INTERIX
IRIX        __sgi (TODO: 出典の確認)
Linux       linux, __linux, __linux__
NetBSD      __NetBSD__
OpenBSD     __OpenBSD__
Solaris     sun, __sun
</pre>
</div>
<div class="sect3" title="19.5.1.2. ハードウェアアーキテクチャーを特定するための C プリプロセッサーマクロ">
<div class="titlepage"><div><div><h4 class="title">
<a name="fixes.build.cpp.arch"></a>19.5.1.2. ハードウェアアーキテクチャーを特定するための C プリプロセッサーマクロ</h4></div></div></div>
<pre class="programlisting">
i386        i386, __i386, __i386__
MIPS        __mips
SPARC       sparc, __sparc
</pre>
</div>
<div class="sect3" title="19.5.1.3. コンパイラーを特定するための C プリプロセッサーマクロ">
<div class="titlepage"><div><div><h4 class="title">
<a name="fixes.build.cpp.compiler"></a>19.5.1.3. コンパイラーを特定するための C プリプロセッサーマクロ</h4></div></div></div>
<pre class="programlisting">
GCC         __GNUC__ (メジャーバージョン), __GNUC_MINOR__
MIPSpro     _COMPILER_VERSION (MIPSpro 7.41 なら 0x741)
SunPro      __SUNPRO_C (Sun C 5.7 なら 0x570)
SunPro C++  __SUNPRO_CC (Sun C++ 5.8 なら 0x580)
</pre>
</div>
</div>
<div class="sect2" title="19.5.2. コンパイラーのバグへの対処方法">
<div class="titlepage"><div><div><h3 class="title">
<a name="compiler-bugs"></a>19.5.2. コンパイラーのバグへの対処方法</h3></div></div></div>
<p>ソースファイルのなかには、コンパイラーのバージョンとアーキテクチャーの組合
        せによって、また、ほとんどの場合は、最適化を有効にしたことも関係して、コン
        パイラーのバグを発現させるものがあります。よくある症状は、gccの内部エラーや、
        ファイルのコンパイルが完了しないというものです。</p>
<p>たいていは、回避策として、<code class="varname">MACHINE_ARCH</code>
        とコンパイラーのバージョンを確認し、
        問題のあるファイル・<code class="varname">MACHINE_ARCH</code>・コンパイラーの組合せに対して最適化を無効に
	し、そのことを<code class="filename">pkgsrc/doc/HACKS</code>に文書化しておくことが必要となります。
	このファイルに多くの例が載っているので、参照してください。</p>
</div>
<div class="sect2" title="19.5.3. undefined reference to “...”">
<div class="titlepage"><div><div><h3 class="title">
<a name="undefined-reference"></a>19.5.3. undefined reference to <span class="quote">“<span class="quote">...</span>”</span>
</h3></div></div></div>
<p>このエラーメッセージは、しばしば、
	パッケージが必要な共有ライブラリーにリンクしていないことを表します。
	以下の関数は、このエラーメッセージを何度も出すことがわかっているものです。</p>
<div class="informaltable">
<a name="undefined-reference-functions"></a><table border="1">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead><tr>
<th>関数</th>
<th>ライブラリー</th>
<th>影響のあるプラットフォーム</th>
</tr></thead>
<tbody>
<tr>
<td>accept, bind, connect</td>
<td>-lsocket</td>
<td>Solaris</td>
</tr>
<tr>
<td>crypt</td>
<td>-lcrypt</td>
<td>DragonFly, NetBSD</td>
</tr>
<tr>
<td>dlopen, dlsym</td>
<td>-ldl</td>
<td>Linux</td>
</tr>
<tr>
<td>gethost*</td>
<td>-lnsl</td>
<td>Solaris</td>
</tr>
<tr>
<td>inet_aton</td>
<td>-lresolv</td>
<td>Solaris</td>
</tr>
<tr>
<td>nanosleep, sem_*, timer_*</td>
<td>-lrt</td>
<td>Solaris</td>
</tr>
<tr>
<td>openpty</td>
<td>-lutil</td>
<td>Linux</td>
</tr>
</tbody>
</table>
</div>
<p>このようなリンカーのエラーの修正は、多くの場合、
    パッケージの <code class="filename">Makefile</code> に
    <code class="literal">LIBS.<em class="replaceable"><code>OperatingSystem</code></em>+=
    -l<em class="replaceable"><code>foo</code></em></code> を追加してから <span class="command"><strong>bmake clean;
    bmake</strong></span> を実行すれば十分です。</p>
<div class="sect3" title="19.5.3.1. 特殊な問題: SunPro コンパイラー">
<div class="titlepage"><div><div><h4 class="title">
<a name="undefined-reference-sunpro"></a>19.5.3.1. 特殊な問題: SunPro コンパイラー</h4></div></div></div>
<p>SunPro コンパイラーを使っている場合は、別の問題の可能性があります。
このコンパイラーは、以下のようなコードを処理することができません。</p>
<pre class="programlisting">
extern int extern_func(int);

static inline int
inline_func(int x)
{
        return extern_func(x);
}

int main(void)
{
        return 0;
}
</pre>
<p>ここからは、<code class="function">inline_func</code> 関数がたとえ使われていなくても、
この関数用のコードが生成され、そのコードから
<code class="function">extern_func</code> が参照されますが、この参照は通常は解決することができません。
この問題を解決するため、
パッケージに関数のインライン化を無効化するよう指示してみることができます。</p>
</div>
</div>
<div class="sect2" title="19.5.4. メモリーが不足する">
<div class="titlepage"><div><div><h3 class="title">
<a name="out-of-memory"></a>19.5.4. メモリーが不足する</h3></div></div></div>
<p>時には、コンパイラーの実行でオペレーティングシステム固有のソフトリミットに達するために、
    パッケージの構築に失敗することがあります。
    <code class="varname">UNLIMIT_RESOURCES</code> 変数を設定して、
    pkgsrc に資源の制限を解除するよう伝えることができます。
    現在のところ、使うことのできる値は、
    <span class="quote">“<span class="quote">datasize</span>”</span> と <span class="quote">“<span class="quote">stacksize</span>”</span> (あるいは両方) です。
    この変数を設定すると、シェル組み込みの <span class="command"><strong>ulimit</strong></span>
    コマンドを実行した場合と同様に、それぞれ、
    データセグメントのサイズとスタックのサイズの上限を、
    ハードリミットまで引き上げます。</p>
</div>
</div>
<div class="sect1" title="19.6. install 相での問題を修正する">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="fixes.install"></a>19.6. <span class="emphasis"><em>install</em></span> 相での問題を修正する</h2></div></div></div>
<div class="sect2" title="19.6.1. 必要なディレクトリーを作成する">
<div class="titlepage"><div><div><h3 class="title">
<a name="install-scripts"></a>19.6.1. 必要なディレクトリーを作成する</h3></div></div></div>
<p>一部のプラットフォームに附属する BSD 互換の <span class="command"><strong>install</strong></span> は、
    一度に複数のディレクトリーを作成することができません。
    このため、 <code class="literal">${INSTALL_*_DIR}</code> を使うときは、以下のようにします。</p>
<pre class="programlisting">
${INSTALL_DATA_DIR} ${PREFIX}/dir1
${INSTALL_DATA_DIR} ${PREFIX}/dir2
    </pre>
<p>こうするかわりに、単に <span class="quote">“<span class="quote"><code class="literal">dir1
    dir2</code></span>”</span> を
    <code class="varname">INSTALLATION_DIRS</code> 変数に追加するという方法もあります。
    こうすると、適切な処理が自動的におこなわれます。</p>
</div>
<div class="sect2" title="19.6.2. ドキュメンテーションのインストール場所">
<div class="titlepage"><div><div><h3 class="title">
<a name="where-to-install-documentation"></a>19.6.2. ドキュメンテーションのインストール場所</h3></div></div></div>
<p>一般的には、ドキュメンテーションは
    <code class="filename">${PREFIX}/share/doc/${PKGBASE}</code> または
    <code class="filename">${PREFIX}/share/doc/${PKGNAME}</code> (後者は、
    パッケージのバージョン番号を含んでいます) 以下にインストールします。</p>
<p>GNU autoconf を使っている最近のパッケージの多くは、
    HTML のドキュメンテーションのインストール先を、
    <span class="quote">“<span class="quote">--with-html-dir</span>”</span> オプションを使って設定することができます。
    時には、このフラグを使わないとドキュメンテーションが
    <code class="filename">${PREFIX}/share/doc/html</code> や他の場所にインストールされるために、
    このフラグを使う必要があることがあります。</p>
<p>例外は、<a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/textproc/gtk-doc/README.html" target="_top"><code class="filename">textproc/gtk-doc</code></a> ツールによって生成される、
    ライブラリーの API のドキュメンテーションです。このドキュメンテーションは、
    専用のブラウザー (devhelp) から使うものであり、ブラウザーが標準で使う場所である
    <code class="filename">${PREFIX}/share/gtk-doc</code> に置くようにします。
    このようなドキュメンテーションは、ファイル名の末尾が
    <code class="filename">.devhelp</code> または
    <code class="filename">.devhelp2</code> であることから区別できます。
    (これらのファイルを
    <code class="filename">${PREFIX}/share/doc/${PKGBASE}</code> または
    <code class="filename">${PREFIX}/share/doc/${PKGNAME}</code>
    にインストールしても使うことができます。この場合、
    これらのディレクトリーの直下に
    <code class="filename">.devhelp*</code> ファイルを置く必要があり、
    サブディレクトリー階層を追加することはできません。通常は、
    <span class="quote">“<span class="quote">--with-html-dir=${PREFIX}/share/doc</span>”</span>
    を使えばそのようにすることができます。
    <code class="filename">${PREFIX}/share/gtk-doc</code>
    のほうが好ましいのですが。)</p>
</div>
<div class="sect2" title="19.6.3. 最高得点ファイルをインストールする">
<div class="titlepage"><div><div><h3 class="title">
<a name="installing-score-files"></a>19.6.3. 最高得点ファイルをインストールする</h3></div></div></div>
<p>パッケージによっては (ほとんどは games カテゴリーのもの)、
    システム上の各ユーザーが最高得点を記録できるように、
    得点ファイルをインストールします。これを実現するために、
    バイナリーは setgid してインストールし、得点ファイルは
    グループとオーナーのいずれかまたは両方を当該グループやオーナー
    (伝統的には "games" ユーザーおよびグループ) の所有とする必要があります。
    <code class="varname">SETGIDGAME</code>,
    <code class="varname">GAMEDATAMODE</code>, <code class="varname">GAMEGRP</code>,
    <code class="varname">GAMEMODE</code>, <code class="varname">GAMEOWN</code>
    の各変数でこの挙動を制御します。詳細は
    <code class="filename">mk/defaults/mk.conf</code> に書かれています。</p>
<p>なお、games に setgid されたインストールは、標準では有効になっていません。
    <code class="varname">SETGIDGAME=YES</code> を設定すると、
    これに応じて他の各変数が設定されます。</p>
<p>このため、パッケージではファイルの所有やアクセス許可属性を決してハードコードせずに、
    <code class="varname">INSTALL_GAME</code> および
    <code class="varname">INSTALL_GAME_DATA</code>
    の設定に応じて適切に設定されるようにします。</p>
</div>
<div class="sect2" title="19.6.4. パッケージを DESTDIR に対応させる">
<div class="titlepage"><div><div><h3 class="title">
<a name="destdir-support"></a>19.6.4. パッケージを DESTDIR に対応させる</h3></div></div></div>
<p>パッケージが <code class="varname">DESTDIR</code> に対応しているというのは、
    ファイルを最終的な置き場所にインストールせずに、
    足場となるディレクトリーにインストールするということです。
    その後、通常の方法でインストール可能なバイナリーパッケージが作成されます。
    この対応には、二つの方法があります。
    パッケージを root としてインストールする必要がある場合
    (<span class="quote">“<span class="quote">destdir</span>”</span>)と、root 以外のユーザーでインストール可能な場合
    (<span class="quote">“<span class="quote">user-destdir</span>”</span>) です。</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p><code class="varname">PKG_DESTDIR_SUPPORT</code> を、
      <span class="quote">“<span class="quote">destdir</span>”</span> または <span class="quote">“<span class="quote">user-destdir</span>”</span> のいずれかに設定する必要があります。
      Makefile で bsd.prefs.mk をインクルードする場合、
      <code class="varname">PKG_DESTDIR_SUPPORT</code> は、
      インクルードの前に設定する必要があります。</p></li>
<li class="listitem"><p>すべてのインストール操作では、インストール先を
      <code class="filename">${DESTDIR}</code> から始まる場所にする必要があります。</p></li>
<li class="listitem"><p>automake は、たいていは、この DESTDIR に対して、
      自動的に対処します。自動化されていない処理や pre/post-install
      では、不適切に処理されることが多いので、修正してください。</p></li>
<li class="listitem"><p>ファイルが、特別な所有者や所有グループでインストールされる場合は、
      <code class="varname">SPECIAL_PERMS</code> を使ってください。</p></li>
<li class="listitem"><p>一般的に、各パッケージは、
      DESTDIR を使えるようにするために、
      <code class="varname">UNPRIVILEGED</code> に対応させるようにしてください。
</p></li>
</ul></div>
</div>
<div class="sect2" title="19.6.5. その他のインタープリターへのパスがハードコードされているパッケージ">
<div class="titlepage"><div><div><h3 class="title">
<a name="hardcoded-paths"></a>19.6.5. その他のインタープリターへのパスがハードコードされているパッケージ</h3></div></div></div>
<p>パッケージには perl 以外のインタープリターへのパスがハードコードされていることもあります。
      スクリプトのインタープリターへのフルパスを適切なものにするため、
      当該パッケージの <code class="filename">Makefile</code> で、
      以下のような定義をする必要があります
    (ここでは例として <span class="command"><strong>tclsh</strong></span> を使います)。</p>
<pre class="programlisting">
REPLACE_INTERPRETER+=   tcl
REPLACE.tcl.old=        .*/bin/tclsh
REPLACE.tcl.new=        ${PREFIX}/bin/tclsh
REPLACE_FILES.tcl=      # パスを修正する必要がある tcl スクリプトを列挙します
# REPLACE_PERL と同様に、${WRKSRC} からの相対位置とします
    </pre>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;">
<h3 class="title">Note</h3>
<p>2006 年 3 月より前は、この各変数は
    <code class="varname">_REPLACE.*</code> および
    <code class="varname">_REPLACE_FILES.*</code> という名前でした。</p>
</div>
</div>
<div class="sect2" title="19.6.6. perl モジュールをインストールするパッケージ">
<div class="titlepage"><div><div><h3 class="title">
<a name="perl-modules"></a>19.6.6. perl モジュールをインストールするパッケージ</h3></div></div></div>
<p>perl5モジュールを提供するパッケージでは、MakefileにMakefileの断片
    <code class="filename">../../lang/perl5/module.mk</code>をインクルードしてください。このファイルには、perl5モ
    ジュール用の標準的なperlの構成をする<span class="command"><strong>do-configure</strong></span>ターゲットのほか、その構成
    を調整するためのさまざまなフックが含まれています。詳細は、このファイル中の
    コメントをご覧ください。</p>
<p>perl5 のモジュールがインストールされる場所は、構築プロセスで使われるperl の
    バージョンに応じて変わります。これを扱うために、pkgsrc は、
    インストールされた<code class="filename">.packlist</code>ファイル(ほとんどの perl5 モジュールが生成します)
    に列挙された各ファイルに対応する行を、<code class="filename">PLIST</code> に追加します。これは、packlist
    ファイルへのパスをスペースで区切ったリストを<code class="varname">PERL5_PACKLIST</code>として定義するこ
    とで行なわれるようになります。たとえば以下のように定義します。</p>
<pre class="programlisting">
PERL5_PACKLIST= ${PERL5_SITEARCH}/auto/Pg/.packlist
    </pre>
<p><code class="varname">PERL5_SITELIB</code>, <code class="varname">PERL5_SITEARCH</code>,
    <code class="varname">PERL5_ARCHLIB</code>の各変数は、perl5モジュールがイ
    ンストールされうる三つの場所を表すもので、packlistを持たないperl5パッケージ
    で使うことができます。この3変数の置換は、<code class="filename">PLIST</code>でもおこなわれます。</p>
</div>
<div class="sect2" title="19.6.7. infoファイルをインストールするパッケージ">
<div class="titlepage"><div><div><h3 class="title">
<a name="faq.info-files"></a>19.6.7. infoファイルをインストールするパッケージ</h3></div></div></div>
<p>パッケージによっては、infoファイルをインストールしたり、<span class="quote">“<span class="quote">makeinfo</span>”</span>または
    <span class="quote">“<span class="quote">install-info</span>”</span>コマンドを使ったりします。
    このようなパッケージでは、パッケージの Makefile で
    <code class="varname">INFO_FILES</code> を定義するようにします。
    これを定義しておくと、info ファイルを
    Info ディレクトリーファイルに登録するために、<code class="filename">INSTALL</code> および
    <code class="filename">DEINSTALL</code> スクリプトが作られるようになります。
    info ファイルの登録用の <span class="quote">“<span class="quote">install-info</span>”</span> コマンドは、
    システム附属のものが使われるか、
    または、必要があればそれ用のパッケージが自動的に追加されて使われます。</p>
<p><code class="varname">PKGINFODIR</code> は
    <code class="filename">${PREFIX}</code> 以下のディレクトリーで、
    info ファイルが置かれる主な場所です。
    <code class="varname">PKGINFODIR</code> は標準では
    <span class="quote">“<span class="quote">info</span>”</span> となっており、利用者が上書きすることができます。</p>
<p>info ファイルは、そのパッケージの <code class="filename">PLIST</code>
    に列挙します。ただし、分割された
    info ファイルは列挙する必要はありません。</p>
<p>構築時に <span class="quote">“<span class="quote">makeinfo</span>”</span> コマンドが必要なパッケージは、
    Makefile で <code class="varname">USE_TOOLS</code> 変数に <span class="quote">“<span class="quote">makeinfo</span>”</span> を追加する必要があります。
    あるバージョン以上の<span class="quote">“<span class="quote">makeinfo</span>”</span>コマンドが必要な場合は、
    パッケージの <code class="filename">Makefile</code> で
    <code class="varname">TEXINFO_REQD</code> 変数を必要な最低バージョンに設定します。
    デフォルトでは、 3.12 が最低限必要なバージョンとなります。
    <span class="command"><strong>makeinfo</strong></span> コマンドがシステムにないか、
    最低限必要なバージョンを満たさない場合は、
    <a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/devel/gtexinfo/README.html" target="_top"><code class="filename">devel/gtexinfo</code></a>
    パッケージへの構築時の依存関係が自動的に追加されます。</p>
<p>パッケージで提供されるソフトウェアの構築やインストールの過程では、
    <span class="command"><strong>install-info</strong></span> コマンドを使ってはいけません。
    info ファイルの登録は <code class="filename">INSTALL</code> スクリプトの仕事であって、
    適切な <span class="command"><strong>makeinfo</strong></span> コマンドを使う必要があるからです。</p>
<p>pkgsrc の基盤は、以上のことを実現するため、
    <code class="varname">PATH</code> のはじめのほうにあるディレクトリーに、
    <span class="command"><strong>install-info</strong></span> や <span class="command"><strong>makeinfo</strong></span>
    を上書きするスクリプトを作成します。</p>
<p><span class="command"><strong>install-info</strong></span> を上書きするスクリプトは、メッセージを記録すること以外、
    何の効果もありません。<span class="command"><strong>makeinfo</strong></span> を上書きするスクリプトは、
    メッセージを記録し、<code class="varname">TEXINFO_REQD</code>
    の値に従って、適切な <span class="command"><strong>makeinfo</strong></span> コマンドを実行するか、
    または異常終了します。</p>
</div>
<div class="sect2" title="19.6.8. マニュアルページをインストールするパッケージ">
<div class="titlepage"><div><div><h3 class="title">
<a name="manpages"></a>19.6.8. マニュアルページをインストールするパッケージ</h3></div></div></div>
<p>マニュアルページをインストールするパッケージはすべて、
    マニュアルページを同じディレクトリー内にインストールして、
    マニュアルページを共通のひとつの場所から探せるようにします。
    pkgsrc では、この場所は
    <code class="literal">${PREFIX}/${PKGMANDIR}</code> であり、パッケージ内ではこの表記を使うようにします。
    <code class="varname">PKGMANDIR</code> の値は標準では
    <span class="quote">“<span class="quote"><code class="filename">man</code></span>”</span> です。これ以外によく使われる値は、
    <span class="quote">“<span class="quote"><code class="filename">share/man</code></span>”</span> です。</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;">
<h3 class="title">Note</h3>
<p><code class="varname">PKGMANDIR</code> の独自設定には、
    完全には対応していません。</p>
</div>
<p><code class="filename">PLIST</code> ファイル内では、
    マニュアルページのファイルの最上層ディレクトリーを、
    単に <code class="filename">man/</code> と書くことができます。
    これは pkgsrc の枠組みが必要に応じて変換してくれます。
    これ以外の場所の場合は、正確な
    <code class="varname">PKGMANDIR</code> を使って書く必要があります。</p>
<p><code class="varname">GNU_CONFIGURE</code> が
    <span class="quote">“<span class="quote">yes</span>”</span> に設定されているパッケージでは、
    標準では
    <code class="filename">./configure</code>
    --mandir スイッチを使って、マニュアルページをどこにインストールするかを設定します。
    このパスは <code class="varname">GNU_CONFIGURE_MANDIR</code> で、
    標準では <code class="varname">${PREFIX}/${PKGMANDIR}</code> になります。</p>
<p>パッケージが <code class="varname">GNU_CONFIGURE</code> を使うが、
    --mandir は使わない場合は、<code class="varname">CONFIGURE_HAS_MANDIR</code> を
    <span class="quote">“<span class="quote">no</span>”</span> に設定することができます、
    また、<code class="filename">./configure</code>
    スクリプトが標準的ではない --mandir の使い方をする場合は、
    必要に応じて <code class="varname">GNU_CONFIGURE_MANDIR</code> を設定することができます。</p>
<p>圧縮したマニュアルページのインストールに関する情報は、
    <a class="xref" href="plist.html#manpage-compression" title="13.5. マニュアルページの圧縮">Section 13.5, “マニュアルページの圧縮”</a> をご覧ください。</p>
</div>
<div class="sect2" title="19.6.9. GConf のデータファイルをインストールするパッケージ">
<div class="titlepage"><div><div><h3 class="title">
<a name="gconf-data-files"></a>19.6.9. GConf のデータファイルをインストールするパッケージ</h3></div></div></div>
<p>パッケージが、 GConf が使用する <code class="filename">.schemas</code> または
    <code class="filename">.entries</code> ファイルをインストールする場合は、
    これらが確実にデータベースに登録されるようにするために、
    いくつか特別な手順を踏む必要があります。</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>GConf の <code class="filename">buildlink3.mk</code> ファイルではなく
	<code class="filename">../../devel/GConf/schemas.mk</code> をインクルードします。
	こうすると、インストールおよびアンインストール時に、 GConf
	のデータベースを再構築し、また、GConf のデータファイルのインストール場所を
	標準的な configure 引数を使ってパッケージに伝えてくれます。
	また、パッケージがデータベースに直接アクセスすることが一切できなくなります。</p></li>
<li class="listitem"><p>パッケージが
	<code class="filename">.schemas</code> ファイルを必ず
	<code class="filename">${PREFIX}/share/gconf/schemas</code> 以下にインストールするようにします。
	<code class="filename">${PREFIX}/etc</code> 以下にインストールするようになっている場合は、
	手作業でパッケージを修正する必要があります。</p></li>
<li class="listitem"><p>PLIST を確認し、etc/gconf ディレクトリー以下の項目をすべて削除します。
	これらは自動的に処理されるものだからです。詳細は
	<a class="xref" href="faq.html#faq.conf" title="9.13. 設定ファイルの置き場所を変更する方法は?">Section 9.13, “設定ファイルの置き場所を変更する方法は?”</a>を参照してください。</p></li>
<li class="listitem"><p><code class="filename">Makefile</code> で、
	<code class="varname">GCONF_SCHEMAS</code> 変数を定義します。変数値には
	パッケージがインストールする <code class="filename">.schemas</code>
	ファイルをすべて列挙します。このファイル名にディレクトリーを含めてはいけません。</p></li>
<li class="listitem"><p><code class="filename">Makefile</code> で、
	<code class="varname">GCONF_ENTRIES</code> 変数を定義します。変数値には
	パッケージがインストールする <code class="filename">.entries</code>
	ファイルをすべて列挙します。
	このファイル名にディレクトリーを含めてはいけません。</p></li>
</ol></div>
</div>
<div class="sect2" title="19.6.10. scrollkeeper/rarian のデータファイルをインストールするパッケージ">
<div class="titlepage"><div><div><h3 class="title">
<a name="scrollkeeper-data-files"></a>19.6.10. scrollkeeper/rarian のデータファイルをインストールするパッケージ</h3></div></div></div>
<p>パッケージが、 scrollkeeper/rarian が使用する <code class="filename">.omf</code>
    ファイルをインストールする場合は、これらが確実にデータベースに登録されるようにするために、
    いくつか特別な手順を踏む必要があります。</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>rarian の <code class="filename">buildlink3.mk</code> ファイルではなく
	<code class="filename">../../mk/omf-scrollkeeper.mk</code>
	をインクルードします。
	こうすると、インストールおよびアンインストール時に、 scrollkeeper
	のデータベースを再構築してくれます。
	また、パッケージがデータベースに直接アクセスすることが一切できなくなります。</p></li>
<li class="listitem"><p>PLIST を確認し、<code class="filename">libdata/scrollkeeper</code>
	ディレクトリー以下の項目をすべて削除します。
	これらは自動的に処理されるものだからです。</p></li>
<li class="listitem"><p>PLIST から <code class="filename">share/omf</code> ディレクトリーを削除します。
	これは rarian が処理します。(<span class="command"><strong>make
	print-PLIST</strong></span> で自動でおこなえます。)</p></li>
</ol></div>
</div>
<div class="sect2" title="19.6.11. X11 のフォントをインストールするパッケージ">
<div class="titlepage"><div><div><h3 class="title">
<a name="x11-fonts"></a>19.6.11. X11 のフォントをインストールするパッケージ</h3></div></div></div>
<p>パッケージがフォントファイルをインストールする場合は、
    インストール時とアンインストール時に、
    フォントのインストール先ディレクトリーにあるフォントデータベースを再構築する必要があります。
    この処理は pkginstall の枠組を使って自動的におこなうことができます。</p>
<p>フォントのインストール先ディレクトリーを
    <code class="varname">FONTS_DIRS.<em class="replaceable"><code>type</code></em></code>
    変数に列挙することができます。変数名中の <em class="replaceable"><code>type</code></em> は、
    <span class="quote">“<span class="quote">ttf</span>”</span>, <span class="quote">“<span class="quote">type1</span>”</span>, <span class="quote">“<span class="quote">x11</span>”</span> のいずれかです。
    また、データベースファイル <code class="filename">fonts.dir</code>
    は PLIST に含めてはいけません。</p>
<p>なお、フォント用のディレクトリーを新たに作らないようにしてください。
    X サーバーがフォントを見つけるための設定をユーザーが手動でおこなう必要がないようにするため、
    新しいディレクトリーではなく標準的なディレクトリーを使うようにします。</p>
</div>
<div class="sect2" title="19.6.12. GTK2 のモジュールをインストールするパッケージ">
<div class="titlepage"><div><div><h3 class="title">
<a name="gtk2-modules"></a>19.6.12. GTK2 のモジュールをインストールするパッケージ</h3></div></div></div>
<p>パッケージが GTK2 の IM モジュールやローダーをインストールする場合は、
    これらが確実に GTK2 のデータベースに登録されるようにするために、
    いくつか特別な手順を踏む必要があります。</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>gtk2 の <code class="filename">buildlink3.mk</code> ファイルではなく
      <code class="filename">../../x11/gtk2/modules.mk</code> をインクルードします。
      こうすると、インストールおよびアンインストール時に、GTK2
      のデータベースを再構築してくれます。</p></li>
<li class="listitem"><p>GTK2 の IM モジュールをインストールするパッケージでは、
      <code class="varname">GTK2_IMMODULES=YES</code> を設定します。</p></li>
<li class="listitem"><p>GTK2 のローダーをインストールするパッケージでは、
      <code class="varname">GTK2_LOADERS=YES</code> を設定します。</p></li>
<li class="listitem">
<p>パッケージが GTK2 のデータベースディレクトリーを直接いじらないよう修正します。
      データベースは以下のとおりです。</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p><code class="filename">libdata/gtk-2.0/gdk-pixbuf.loaders</code></p></li>
<li class="listitem"><p><code class="filename">libdata/gtk-2.0/gtk.immodules</code></p></li>
</ul></div>
</li>
<li class="listitem"><p><code class="filename">PLIST</code> を確認し、<code class="filename">libdata/gtk-2.0</code>
      ディレクトリー以下の項目をすべて削除します。
      これらは自動的に処理されるものだからです。</p></li>
</ol></div>
</div>
<div class="sect2" title="19.6.13. SGML または XML のデータをインストールするパッケージ">
<div class="titlepage"><div><div><h3 class="title">
<a name="sgml-xml-data"></a>19.6.13. SGML または XML のデータをインストールするパッケージ</h3></div></div></div>
<p>パッケージが、システム全体で使われるカタログへ登録する必要のある
    SGML または XML のデータファイル (DTD, sub-catalog など) をインストールする場合は、
    いくつか特別な手順を踏む必要があります。</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>パッケージの <code class="filename">Makefile</code> で
	<code class="filename">../../textproc/xmlcatmgr/catalogs.mk</code> をインクルードします。
	こうすると、インストールおよびアンインストール時に、
	データファイルをシステム全体で使われるカタログに登録してくれます。</p></li>
<li class="listitem"><p><code class="varname">SGML_CATALOGS</code> を、このパッケージがインストールする
	SGML カタログをすべてをフルパス表記にしたものに設定します。</p></li>
<li class="listitem"><p><code class="varname">XML_CATALOGS</code> を、このパッケージがインストールする
	XML カタログをすべてをフルパス表記にしたものに設定します。</p></li>
<li class="listitem"><p><code class="varname">SGML_ENTRIES</code> を、SGML カタログに追加する
	個々のエントリーに設定します。各エントリーは
	3 個の文字列からなります。書き方の詳細は xmlcatmgr(1)
	(特に、'add' アクション用の引数) を参照してください。
	なお、通常はこの変数を使うことはありません。</p></li>
<li class="listitem"><p><code class="varname">XML_ENTRIES</code> を、XML カタログに追加する
	個々のエントリーに設定します。各エントリーは
	3 個の文字列からなります。書き方の詳細は xmlcatmgr(1)
	(特に、'add' アクション用の引数) を参照してください。
	なお、通常はこの変数を使うことはありません。</p></li>
</ol></div>
</div>
<div class="sect2" title="19.6.14. MIME データベースの拡張をインストールするパッケージ">
<div class="titlepage"><div><div><h3 class="title">
<a name="mime-database"></a>19.6.14. MIME データベースの拡張をインストールするパッケージ</h3></div></div></div>
<p>パッケージが、<code class="filename">.xml</code> ファイルを
    <code class="filename">${PREFIX}/share/mime/packages</code>
    以下にインストールすることで MIME データベースを拡張する場合は、
    データベースがこの新規ファイルについて確実に整合性を持つようにするために、
    いくつか特別な手順を踏む必要があります。</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p><code class="filename">../../databases/shared-mime-info/mimedb.mk</code>
	をインクルードします (同じディレクトリーにある <code class="filename">buildlink3.mk</code>
	ファイルは、他の <code class="filename">buildlink3.mk</code>
	ファイルでインクルードするために予約されているので使いません)
	こうすると、インストールおよびアンインストール時に、MIME
	データベースを再構築してくれます。
	また、パッケージがデータベースに直接アクセスすることが一切できなくなります。</p></li>
<li class="listitem"><p>PLIST を確認し、<code class="filename">share/mime</code>
	ディレクトリー以下の項目のうち、
	<code class="filename">share/mime/packages</code> 以下に置かれるファイル
	<span class="emphasis"><em>以外の</em></span>ものをすべて削除します。
	このディレクトリーについては update-mime-database プログラムが自動的に処理しますが、
	除外したファイルはパッケージ依存のファイルなので、
	ファイルをインストールしたパッケージが自分で削除する必要があります。</p></li>
<li class="listitem"><p>PLIST から <code class="filename">share/mime/*</code> ディレクトリーをすべて削除します。
	これらは shared-mime-info プログラムが処理します。</p></li>
</ol></div>
</div>
<div class="sect2" title="19.6.15. intltool を使うパッケージ">
<div class="titlepage"><div><div><h3 class="title">
<a name="intltool"></a>19.6.15. intltool を使うパッケージ</h3></div></div></div>
<p>パッケージが構築時に intltool を使う場合は、
    <code class="literal">intltool</code> を <code class="varname">USE_TOOLS</code>
    に追加します。
    こうすると、パッケージの配布ファイルに附属する intltool ではなく、
    pkgsrc の intltool を強制的に使うようになります。</p>
<p>この仕組みは、intltool 構築時の依存関係を追跡して、
    利用可能な最新版を使います。この方法を使うことで、
    リリース後にできたバグ修正も適用することができます。</p>
</div>
<div class="sect2" title="19.6.16. 起動スクリプトをインストールするパッケージ">
<div class="titlepage"><div><div><h3 class="title">
<a name="startup-scripts"></a>19.6.16. 起動スクリプトをインストールするパッケージ</h3></div></div></div>
<p>パッケージに rc.d スクリプトが附属する場合、このスクリプトは、
    標準では起動ディレクトリーにコピーされませんが、
    <a class="link" href="configuring.html#mk.conf"><code class="filename">mk.conf</code></a> にオプション
    <code class="varname">PKG_RCD_SCRIPTS=YES</code> を追加指定すると、
    パッケージのインストール時に、スクリプトが
    <code class="filename">/etc/rc.d</code> 以下にコピーされます。
    また、パッケージのアンインストール時には、
    自動的にスクリプトが削除されます。</p>
</div>
<div class="sect2" title="19.6.17. TeX モジュールをインストールするパッケージ">
<div class="titlepage"><div><div><h3 class="title">
<a name="tex-packages"></a>19.6.17. TeX モジュールをインストールするパッケージ</h3></div></div></div>
<p>パッケージが、TeX パッケージを texmf ツリーにインストールする場合は、
    texmf ツリーの <code class="filename">ls-R</code>
    データベースを更新する必要があります。</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;">
<h3 class="title">Note</h3>
<p>kpathsea のような主たる TeX パッケージ以外のパッケージは、
    <code class="varname">${PREFIX}/share/texmf</code>
    ではなく <code class="varname">${PREFIX}/share/texmf-dist</code>
    内にファイルをインストールするようにします。</p>
</div>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>
      <code class="filename">../../print/kpathsea/texmf.mk</code>
      をインクルードします。こうすると、インストール時とアンインストール時に
      <code class="filename">ls-R</code> を再構築してくれます。</p></li>
<li class="listitem">
<p>パッケージが
      <code class="filename">${PREFIX}/share/texmf-dist</code> の texmf ツリー以外の
      texmf ツリーにファイルをインストールする場合は、
      <code class="varname">TEX_TEXMF_DIRS</code> を、データベースの更新が必要となる
      texmf ツリーをすべて並べたリストに設定します。</p>
<p>パッケージが、<span class="command"><strong>updmap</strong></span>
      を使って登録する必要があるフォントマップファイルもインストールする場合は、
      <code class="filename">../../print/texlive-tetex/map.mk</code> をインクルードしたうえで、
      <code class="varname">TEX_MAP_FILES</code> と
      <code class="varname">TEX_MIXEDMAP_FILES</code> のいずれかまたは両方を、
      そのようなフォントマップファイルをすべて並べたリストに設定します。
      こうすると、インストール時とアンインストール時に
      <span class="command"><strong>updmap</strong></span> が自動的に実行され、
      TeX 出力ドライバー用のフォントマップファイルの有効化や無効化をしてくれます。</p>
</li>
<li class="listitem"><p><code class="filename">PLIST</code> には
      <code class="filename">ls-R</code> データベースは一切含めないようにします。
      このデータベースは teTeX-bin パッケージによってのみ削除されるものだからです。</p></li>
</ol></div>
</div>
<div class="sect2" title="19.6.18. エミュレーションによるバイナリーの実行に対応したパッケージ">
<div class="titlepage"><div><div><h3 class="title">
<a name="emulation-packages"></a>19.6.18. エミュレーションによるバイナリーの実行に対応したパッケージ</h3></div></div></div>
<p>パッケージのなかには、あるオペレーティングシステム用のバイナリーを
    (エミュレーションに対応した) 別のオペレーティングシステム上で実行するための、
    ライブラリーや実行ファイルを提供するものがあります。
    例としては、NetBSD 上で Linux のバイナリーを実行するものがあげられます。</p>
<p><a href="ftp://ftp.NetBSD.org/pub/pkgsrc/current/pkgsrc/pkgtools/rpm2pkg/README.html" target="_top"><code class="filename">pkgtools/rpm2pkg</code></a>
    は、Linux の rpm パッケージの展開やパッケージ化を補助するものです。</p>
<p><code class="varname">CHECK_SHLIBS</code> を no に設定して、
    インストールされた実行ファイル用のライブラリーを動的リンカーがすべて見つけられることを検査する
    <span class="command"><strong>check-shlibs</strong></span> ターゲットを抑止することができます。
    この検査では標準の動的リンカーを実行するので、
    エミュレーションパッケージに対しては検査が失敗します。
    エミュレーションで使われるライブラリーは、
    標準のディレクトリーには置かれていないからです。</p>
</div>
<div class="sect2" title="19.6.19. ハイカラーテーマのアイコンをインストールするパッケージ">
<div class="titlepage"><div><div><h3 class="title">
<a name="hicolor-theme"></a>19.6.19. ハイカラーテーマのアイコンをインストールするパッケージ</h3></div></div></div>
<p>パッケージが、
    <code class="filename">share/icons/hicolor</code> 以下に画像をインストールするか
    <code class="filename">share/icons/hicolor/icon-theme.cache</code> データベースを更新するかあるいはその両方をおこなう場合は、
    テーマ用の共有ディレクトリーを適切に扱い、キャッシュデータベースを確実に再構築するために、
    以下の手順を踏む必要があります。</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p><code class="filename">../../graphics/hicolor-icon-theme/buildlink3.mk</code>
	をインクルードします。</p></li>
<li class="listitem"><p><code class="filename">PLIST</code> を確認し、
	テーマのキャッシュを参照するエントリーを削除します。</p></li>
<li class="listitem"><p>PLIST が <code class="filename">share/icons/hicolor</code>
	  階層からアイコン用の共有ディレクトリーを削除しないようにします。
	  これは自動的に処理されるものだからです。</p></li>
</ol></div>
<p>後の 2 点について、
      PLIST がこれらを守っていることを確認する最良の方法は、
      <span class="command"><strong>make print-PLIST</strong></span> を使って作り直すことです。</p>
</div>
<div class="sect2" title="19.6.20. デスクトップファイルをインストールするパッケージ">
<div class="titlepage"><div><div><h3 class="title">
<a name="desktop-files"></a>19.6.20. デスクトップファイルをインストールするパッケージ</h3></div></div></div>
<p>パッケージが、<code class="filename">.desktop</code> ファイルを
      <code class="filename">share/applications</code> 以下にインストールし、そのファイルに
      MIME 情報が含まれている場合は、それらが MIME データベースに確実に登録されるようにするために、
      以下の手順を踏む必要があります。</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p><code class="filename">../../sysutils/desktop-file-utils/desktopdb.mk</code>
	  をインクルードします。</p></li>
<li class="listitem"><p>PLIST を確認し、
	  <code class="filename">share/applications/mimeinfo.cache</code> ファイルを参照するエントリーを削除します。
	  これは自動的に処理されるものだからです。</p></li>
</ol></div>
<p>最後の点について、
      PLIST がこれらを守っていることを確認する最良の方法は、<span class="command"><strong>make
      print-PLIST</strong></span> を使って作り直すことです。</p>
</div>
</div>
<div class="sect1" title="19.7. パッケージに問題があるという印をつける">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="punting"></a>19.7. パッケージに問題があるという印をつける</h2></div></div></div>
<p>場合によっては、パッケージの問題をすぐに解決できないことがあります。
  この場合、パッケージが壊れていることを表すだけの目印をつけることができます。
  これをおこなうには、<code class="varname">BROKEN</code> 変数を、
  (<code class="varname">RESTRICTED</code> 変数と同様に)
  パッケージが壊れている理由に設定するだけです。
  利用者がパッケージを構築しようとすると、
  パッケージはその場でこのメッセージを表示して、
  構築をしないようになります。</p>
<p><code class="varname">BROKEN</code> となったパッケージは、
  不定期的に pkgsrc から削除されます。</p>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="tools.html">Prev</a> </td>
<td width="20%" align="center"><a accesskey="u" href="developers-guide.html">Up</a></td>
<td width="40%" align="right"> <a accesskey="n" href="debug.html">Next</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">Chapter 18. 構築や実行のために必要なツール </td>
<td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td>
<td width="40%" align="right" valign="top"> Chapter 20. デバッグ</td>
</tr>
</table>
</div>
</body>
</html>
