<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
<head>
<!-- Copyright (c) 1994-2004
	The NetBSD Foundation, Inc.  ALL RIGHTS RESERVED. -->
<meta http-equiv="Content-Type" content="text/html; charset=ISO-2022-JP">
<link rev="made" href="mailto:www@jp.NetBSD.org">
<link rel="shortcut icon" href="../../../favicon.ico" origlink="/favicon.ico" type="image/x-icon">
    <title>Cross-building NetBSD</title>
  </head>

<body bgcolor="#FFFFFF" text="#000000">

<HEADING> NetBSD のクロス構築

<LIST>

<h2>他の情報源</h2>
<ul>
<li><a href="../current/">NetBSD-currentの追跡</a></li>
<li><a href="../../Documentation/">総合的な NetBSD ドキュメンテーション</a>
    - クロス構築だけに限らない疑問について。</li>
<li>``<a
href="http://www.mewburn.net/luke/talks/bsdcon-2003/index.html">Cross-building
NetBSD</a>'' - Luke Mewburn と Matthew Green の<a
href="http://www.mewburn.net/luke/papers/build.sh.pdf">論文</a>に関する BSDCon
2003 でのプレゼンテーション</li>
</ul>

<SECTION>繰り返される質問

<ENTRY>terminology  用語
<ul>
<li>ホストシステム: クロス構築で、作業そのものを行おうとするシステム。

<li>ターゲットシステム: クロス構築の作業結果を動かそうとするシステム。

<li>クロス構築: ターゲットシステムとホストシステムが異なる場合に行うのがクロス構築。

<li>セルフ構築: ターゲットシステムとホストシステムが同じ場合、セルフ構築。
</ul>

 NetBSD/i386 上で、 NetBSD/sh3 のバイナリーを構築するなら、
 クロス構築 をします。
NetBSD/i386 が "ホストシステム" で、 NetBSD/sh3 が "ターゲットシステム" です。

<ENTRY>why  どうしてクロス構築?  クロス構築が必要なのはいつ?
クロス構築をする理由はいくつもあります:
<ul>
<li>NetBSD は<A HREF="../../Ports/">非常に多くのアーキテクチャー</A> を
サポートします。
それらのいくつかは、他の現代的アーキテクチャーに比べ低速です。
古いアーキテクチャー向けに何度も構築作業を行うなら、
クロス構築は良い解決法です。

<li>もし、 ターゲットシステムが(携帯電話のような)組み込みシステム製品で、
それに、 NetBSD を移植しようとするなら、
 ターゲットシステム上で セルフ構築 をできないかもしれません。

<li>もし何らかの理由で、 NetBSD ではないホストシステム でNetBSD バイナリーを
構築する必要があるなら、 クロス構築する必要があります。

<li> NetBSD を新しいアーキテクチャーに移植しようとするなら、
クロスコンパイルだけが、唯一の選択肢です。
</ul>

<SECTION>道のり

<ENTRY>host-system  ホストシステムの選択
特別な理由がなければ、ホストシステムには、
 NetBSD(多分 最新のリリース または NetBSD-current)  を使うことを勧めます。
NetBSD 以外のプラットフォームもサポートされていますが、十分テストされてはいません。
最近の状況については、
<CURRENTSRC>src/tools/compat/README をご覧ください。

<ENTRY>build-tree  build tree を用意する
まず第一に、NetBSD ソースコードツリー全体を入手する必要があります。
詳しくは <a href="../current/">"NetBSD-currentの追跡"</a> を見てください。
以下の記述において、ツリーは $TOP/src の下にあると仮定します。
<p>
<ENTRY>create-toolchain クロスコンパイラー toolchain を作る
たとえば <em>macppc</em> 用の toolchain を、 /usr/cross/{bin,include,lib,libexec,...}
ディレクトリー以下に作るには、次のようにします:
<pre>
	% cd $TOP/src
	% ./build.sh -m macppc -T /usr/cross tools
</pre>
NetBSD 1.6 では上記のほか、後に説明するツールによって生成されるファイル群を
build.sh がインストールするディレクトリーを定義する必要があります。これは、環境変数
DESTDIR を設定するか、または、次のように -D オプションを使います:
<pre>
	% cd $TOP/src
	% ./build.sh -m macppc -T /usr/cross -D $DESTDIR tools
</pre>
<p>
このほかのオプション (チェックアウトされたソースツリーをもとにした完全な NetBSD
ツリーの構築を含む) については、
<pre>
./build.sh -h
</pre>
で参照できます。

<ENTRY>compile-kernel クロスコンパイルの実際 - カーネル
カーネルの構築には、構築スクリプトで作成した toolchain を使います。
NetBSD の config(8) は、アーキテクチャーに依存しないので、
ホストシステムの物を使うことができます。 (ただし、バージョンには依存します。
-current の config を使って 1.6 のカーネルを作ることはできませんので、
以下ではクロスバイナリーディレクトリーにある nbconfig バイナリーを使います。)
<pre>
% cd $TOP/src/sys/arch/macppc/conf
% cp GENERIC MYCONF
% vi MYCONF
</pre>

作業はすべて ./build.sh でおこないます:
<pre>
% cd $TOP/src
% ./build.sh -m macppc -T /usr/cross -u kernel=MYCONF
</pre>  

<p>

<ENTRY>compile-userland クロスコンパイルの実際 - ユーザーランド
ツリー全体の構築には構築スクリプトを用い、
<a href="../current/">"NetBSD-currentの追跡"</a> に書かれているように
します。
<pre>
# cd $TOP/src
# ./build.sh -D $DESTDIR distribution 
</pre>

<SECTION>一般的な問題

<ENTRY>compiler-issue  コンパイラーが内部エラーか同じような何らかの原因でお亡くなりになります。
クロス構築におけるコンパイラーの設定は、より巧妙なものになります。
クロス構築設定においては、コンパイラーのバグが現れやすくなります。
また、セルフ構築と異なるバージョンのコンパイラーを使う必要があることもあり、
それで、コンパイラーの互換性問題( GCC のバージョンが違うとか、他のベンダーのコンパイラー
であるとか)が頭痛の種となることがあります。
<p>

正しい cpp を使ってください。さもないと
 <tt>__NO_LEADING_UNDERSCORES__</tt> や <tt>__LITTLE_ENDIAN__</tt> のような、
あらかじめ定義されたシンボルで困ることになります。
<p>

もちろん、クロス構築をもっと安定させる必要はあります。

<p>

これに対しては魔法の杖はありません:
<ul>
<li>コンパイルスクリプトの中身を検討します。
	もし、(クロス構築中に /usr/bin/as を使うなどのように)
	異なるターゲット向けのコンパイラーが混ざると、問題を起こします。
<li>次善策として、実行時にコンパイラーの設定を変え、
	最適化レベルを下げて試してみます( -O2 から -O のように)
<li>クロスコンパイラー生成時のコンパイラーの設定を検討します。
<li>もし、それを再現する方法がわかっていて、 gcc を使っているなら、
	<a href="http://www.gnu.org/software/gcc/bugs.html">
	gcc の人たちにバグレポートを申し出ましょう</a>。
</ul>

<ENTRY>compiler-usage  NetBSD クロスコンパイラーを NetBSD ソースツリー以外で使う方法は?
$TOOLDIR にクロスコンパイラーツールチェインを構築した後、そのコンパイラーが $TARGETROOT
にあるターゲットシステムのインクルードファイルやライブラリーを使うようにするにはどうすればいいのでしょうか?
1.6.x のツールチェインを使い、ターゲットが 'vax' である場合、
以下のような手順を踏んでください: 

<pre>
	% cd $TOOLDIR/vax--netbsdelf
        % mv include include.BAK
        % ln -s $VAXROOT/usr/include .
        % mv lib lib.BAK
        % ln -s $VAXROOT/usr/lib .
        % set path=($path `pwd`/bin)
        % rehash
</pre>

-current および 2.0 システムでは、 /lib 以下のライブラリーについて特段の注意が必要です。
tech-toolchain メーリングリストのアーカイブの、
<a href="http://mail-index.NetBSD.org/tech-toolchain/2004/02/03/0006.html">この
記事</a>をご覧ください。
<p>

しかるのちに、クロスコンパイルした gcc が使えます:

<pre>
	% which gcc
	/home/cvs/src-1.6/tools/obj.vax/tools.NetBSD-1.6-vax/vax--netbsdelf/bin/gcc
	% gcc h.c -o h
	% file h
	h: ELF 32-bit LSB executable, Digital VAX, version 1 (SYSV), for NetBSD, dynamically linked (uses shared libs), not stripped
</pre>

</LIST>

<DOCLINK>

<hr>
<address>
  <small>
  (連絡先 - <a href="http://www.NetBSD.org/cgi-bin/feedback.cgi">英語</a>,
       <a href="mailto:www@jp.NetBSD.org">日本語:
       www@jp.NetBSD.org</a>)<br>
  $NetBSD: index.list,v 1.41 2004/11/14 00:30:53 mbw Exp $<br>
  <!-- based on english translation: -->
  <!-- NetBSD: index.list,v 1.41 2004/11/14 00:30:53 mbw Exp   -->
  <a href="../../Misc/disclaimer.html">Copyright &copy; 1994-2004
    The NetBSD Foundation, Inc.  ALL RIGHTS RESERVED.</a>
  </small>
</address>

</body>
</html>
