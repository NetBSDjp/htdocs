<html>
<head>
<!-- Copyright (c) 1996, 1998
	The NetBSD Foundation, Inc.  ALL RIGHTS RESERVED.
     Copyright (c) 1998
	The Japan NetBSD Users' Group.  ALL RIGHTS RESERVED. -->
<link rev="made" href="mailto:www@jp.NetBSD.ORG">
<title>NetBSD Documentation: Kernel</title>
</head>
<body bgcolor="#FFFFFF" text="#000000">

<table><tr><td>
<a href="/Misc/daemon-copy.html">
<img align="center" src="/images/BSD-demon.gif" alt="BSD demon"></a>
</td><td align=center>
<h2>NetBSD ドキュメンテーション: カーネル</h2>
</td></tr></table>
<p>

<h3>FAQ - よくある質問</h3>
<ul>
<li><a href="#where_to_download_kernel_source">
	どこでカーネルソースをダウンロードできますか</a>
<li><a href="#how_to_build_a_kernel">
	カーネルの作り方</a>
<li><a href="#why_msoft_float">
	なぜカーネルを <b>-msoft-float</b> 付きでコンパイルするのですか</a>
<li><a href="#problems_compiling_a_current_kernel">
	-current カーネルのコンパイルに関する問題</a>
<li><a href="#how_to_debug_a_kernel_crash_dump">
	カーネルクラッシュダンプのデバッグの方法</a>
<li><a href="#plip_support">
	PLIP (Parallel Line IP) をサポートしていますか</a>
<li><a href="#how_to_add_a_kernel_to_a_boot_floppy">
	ブートフロッピーにカーネルを追加する方法</a>
</ul>

<h3>NetBSD に特有のドキュメント</h3>
<ul>
<li><a href="converting-ethernet-drivers.html">
	過去の BSD イーサネットドライバーを NetBSD-1.2D 以降に更改する</a>
<li><a href="elf-notes.html">
	ベンダー特有の ELF Note Element</a>
<li><a href="uvm.html">UVM、あたらしい仮想メモリーシステム</a>
<li><a href="vfork.html">なぜ伝統的な vfork() を実装したか</a>
</ul>

<h3>その他のオンライン ドキュメント</h3>
<ul>
<li><a href="http://www.netapp.com/technology/level3/nfsbook.html">
    4.4BSD のデザインと実装、第9章 (NFS)</a>
</ul>

<p><hr><h3><a name="where_to_download_kernel_source">
	どこでカーネルソースをダウンロードできますか
</a></h3>
<h4><a name="official_release_kernel_source">公式リリース</a></h4>
リリースされたカーネルのソースは、そのリリースのメインディレクトリーの中の
gzip された tar ファイル 'source/sets/syssrc.tgz' にあります。
たとえば、NetBSD 1.3.2 のカーネルソースは次のファイルにあります:
<pre>   <a
href="ftp://ftp.netbsd.org/pub/NetBSD/NetBSD-1.3.2/source/sets/syssrc.tgz">/pub/NetBSD/NetBSD-1.3.2/source/sets/syssrc.tgz</a></pre>
もし <a href="http://www.netbsd.com">NetBSD CD-Rom</a>を持っていたら、
'source/sets/syssrc.tgz' も含まれています。ソースはどこでも展開できますが、
習慣的に /usr/src に置かれます。
展開するには "<b><tt>cd / ; tar xvzpf &lt;ファイル名&gt;</tt></b>" と
してください。
<p> <h4>'流血の刃先' -current ソース、冒険好きな人限定!</h4>
最新のカーネルソースは ftp.netbsd.org かミラーサイトの
<a href="ftp://ftp.netbsd.org/pub/NetBSD/NetBSD-current/src/sys/">
/pub/NetBSD/NetBSD-current/src/sys/</a> ディレクトリーにあります。
カーネルをコンパイルするには、以下のものを
<a href="ftp://ftp.netbsd.org/pub/NetBSD/NetBSD-current/tar_files/src/">
/pub/NetBSD/NetBSD-current/tar_files/src</a> からダウンロードした方が
いいでしょう:  <ul>
   <li><a
   href="ftp://ftp.netbsd.org/pub/NetBSD/NetBSD-current/tar_files/src/config.tar.gz">config.tar.gz</a>
   ('config' プログラムのソース) <li><a
   href="ftp://ftp.netbsd.org/pub/NetBSD/NetBSD-current/tar_files/src/sys.tar.gz">sys.tar.gz</a>
   (全てのアーキテクチャーの完全なカーネルソース) </ul>
あなたが使っているバージョンから変更があった場合、最初に 'config'
プログラムをビルドとインストールすべきです。
-current は NetBSD 開発の最先端なので、
<a href="#problems_compiling_a_current_kernel">-current カーネルの
コンパイルに関する問題</a> があるかもしれません。
あなたがコンフィグの手順に慣れるまでは
<a href="#official_release_kernel_source">公式リリース</a> のソースを
使うことをお勧めします。

<p><hr><h3><a name="how_to_build_a_kernel">
	カーネルの作り方
</a></h3>
<ol>
    <li>カーネルソースをダウンロードし展開します (
	<a href="#where_to_download_kernel_source">
	どこでカーネルソースをダウンロードできますか</a>参照)。
 <p><li>-current を使っている場合、 新しいバージョンの config のコンパイルが
	必要かもしれません。完全な -current のソースをダウンロードしたら:
	<br>
	"<b><tt>cd /usr/src/usr.sbin/config ; make && make install</tt></b>"
 <p><li>"<b><tt>cd /sys/arch/&lt;ARCH&gt;/conf</tt></b>"<br>
	&lt;ARCH&gt; には 'i386', 'sparc', 'mac68k' のような
	あなたのマシンアーキテクチャーが入ります。
 <p><li>"<b><tt>cp GENERIC &lt;MYCONF&gt;</tt></b>"<br>
	&lt;MYCONF&gt; はこの設定にあなたが名づけた名前です。ホスト名や
	マシンタイプ、あなたの名前を使ってもよいのです。英文字、数字、
	そして _ 文字が使えます。
 <p><li><b>&lt;MYCONF&gt;</b> の編集<br>
	最初はこのステップは飛ばしても構いません。
	i386 上で仮想コンソールを得るために
	 'pc0' をコメントアウトして 'vt0' を有効にしたりするように、
	あなたが持っていなかったり使っていない CPU タイプやハードウェア、
	デバイスのドライバーを削除することができます。
	あなたがどのハードウェアドライバーを使い続けるかを決めるよい第一歩
	となるのは、"<b><tt>dmesg</tt></b>" か
	"<b><tt>dmesg | grep ' at '</tt></b>" の出力を読むことです。
	'&lt;XXX&gt; at &lt;YYY&gt;' を含む全ての行について
	&lt;XXX&gt; と &lt;YYY&gt; の両方のエントリーを残す必要があります。
	他のカーネル設定のオプションの情報のために、
	"<b><tt>man 4 options</tt></b>" も読んでください。
 <p><li>"<b><tt>config &lt;MYCONF&gt;</tt></b>"<br>
	&lt;MYCONF&gt; のカーネルをビルドするためのディレクトリーを
	生成します。
 <p><li>"<b><tt>cd ../compile/&lt;MYCONF&gt;</tt></b>"<br>
	カーネルをビルドするためのディレクトリーに移動します。
 <p><li>"<b><tt>make depend</tt></b>"<br>
	make プログラムがどのファイルをリビルドすればいいのか
	わかるように(この時点では全て!)、'.depend' ファイルを生成します 。
 <p><li>"<b><tt>make</tt></b>"<br>
	カーネルをコンパイルします。もし全てがうまくいけば、'netbsd'
	カーネルができているでしょう。もしあなたが VAX を使っていれば
	これは相当時間がかかり、大規模な Alpha マシンならとても短い時間であり、
	残りの人たちはこの中間の時間になります。
 <p><li>"<b><tt>mv /netbsd /netbsd.old ; mv netbsd /</tt></b>"<br>
	現在のカーネルを保存し、(_とても_ 重要)、
	新しいカーネルをブートできるよう移動します。
	<br><b>NetBSD/pmax</b> ではこの代わりに:
	"<b><tt>mv /netbsd /netbsd.old ; mv netbsd.aout /netbsd</tt></b>"
 <p><li>"<b><tt>reboot</tt></b>"<br>
	これであなたの新しいカーネルを使ってリブートします -
	ブートメッセージには次の行を含んでいるべきでしょう:
	'NetBSD &lt;VERSION&gt; (&lt;MYCONF&gt;) #0: &lt;コンパイルした時刻&gt;'

 <p><li><b>何か問題があったら:</b><br>
	シングルユーザーモードで 'netbsd.old' カーネルをブートしましょう。
	変更する手順はブート手順に依存していますが、i386 ではこうでしょう:
	<ol>
	    <li><b>最初の NetBSD のメッセージが表示されたら <tt>SPACE</tt> を押す</b></li>
	    <li>"<b><tt>boot -s netbsd.old</tt></b>"</li>
	</ol>
	<p>
	次にカーネルを元に戻す:
	<ol>
	    <li>"<b><tt>fsck /</tt></b>"</li>
	    <li>"<b><tt>mount /</tt></b>"</li>
	    <li>"<b><tt>mv netbsd.old netbsd</tt></b>"</li>
	    <li>"<b><tt>exit</tt></b>"</li>
	</ol>
	</p>
</ol>

<p><hr><h3><a name="why_msoft_float">
	なぜカーネルを <b>-msoft-float</b> 付きでコンパイルするのですか
</a></h3>
<p>
プロセスがシステムコールを呼び出したとき、
後でそのプロセスに戻ってこられるように、
カーネルはプロセッサーの状態を保存する必要があります。
浮動小数点レジスターは比較的大きくなりがちなので、それらを保存したり
回復したりすることは高価な操作です。もし FPU がまだ処理を実行途中であっ
たなら、CPU はその処理が完了するまで待ってからでないと、レジスターのコピー
を行うことができません。
<p>
カーネル内で浮動小数点レジスターを利用するのを避けることで、システムコール実行
の効率を、かなり向上させることができます。
また sparc など、いくつかのプロセッサーでは、浮動小数点コンテキストの切
り替えを lazy に行うことによって、プロセス切り替えの際の浮動小数点レジ
スターの保存/回復処理を、場合によっては省略することもできます。
<p>
いくつかのアーキテクチャーではコンパイラーは主要な操作 (メモリーブロック転送など)
のスピードアップのために浮動小数点レジスターを使うことができ、
上記の動作を止めるためには '-msoft-float' が必要です。

<p><hr><h3><a name="problems_compiling_a_current_kernel">
	-current カーネルのコンパイルに関する問題
</a></h3>
最初に注意すべき点は、
<a href="../../MailingLists/index.html#current-users">current-users</a>
メーリングリストに参加した方がよいということです。
current-users を読まずに -current を追うことはライトを灯けずに夜道を
ドライブしているようなものです。警告しましたよ :)<p>
最新の
<a href="ftp://ftp.netbsd.org/pub/NetBSD/NetBSD-current/tar_files/src/config.tar.gz">config.tar.gz</a>
をダウンロードし、コンパイル、インストールし、あなたの
コンフィグファイルに対して再度 config を実行してください。
 (config コマンドはリリースごとにかなり頻繁に変更されますから)

<p><hr><h3><a name="how_to_debug_a_kernel_crash_dump">
	カーネルクラッシュダンプのデバッグの方法
</a></h3>
<ul>
<li>設定ファイルの中で DEBUG を有効にして
    <a href="#how_to_build_a_kernel">カーネルの作成</a> をしたことを
    確認してください。
<li>"<b><tt>gdb netbsd.gdb</tt></b>"
    (カーネルをコンパイルしているディレクトリーで)
<li>gdb プロンプトで "<b><tt>target kcore /var/crash/netbsd.0.core</tt></b>"
</ul>
一般のgdb コマンド 't' なども使えます。

<p><hr><h3><a name="plip_support">
	PLIP (Parallel Line IP) をサポートしていますか
</a></h3>
NetBSD/i386 に PLIP をサポートした Martin Husemann のパッチが
<a href="http://www.NetBSD.org/cgi-bin/query-pr-single.pl?number=1278">
PR 1278</a> として出ています。
この PR の末尾にあるパッチは、NetBSD 1.3.2 ソースツリーに対して適用す
ることができます。

<p><hr><h3><a name="how_to_add_a_kernel_to_a_boot_floppy">
	ブートフロッピーにカーネルを追加する方法
</a></h3>
いくつかのポートでは既に
"<b><tt>cd /usr/src/distrib/<em>&lt;ARCH&gt;</em>/floppies ; make </tt></b>"
としてブートフロッピーを構築することができます。
これを実行する前に INSTALL カーネルを手動で構築する必要があるかもしれません。
既に <b>boot.fs</b> ファイルがあるのなら、次の手順でカーネルを置き換え
ることもできます:
<ol>
<li><b><tt>vnconfig -c vnd0 boot.fs</tt></b>
<li><b><tt>mount /dev/vnd0a /mnt</tt></b>
<li><b><tt>gzip -c -9 &lt; netbsd &gt; /mnt/netbsd.gz</tt></b>
<li><b><tt>umount /mnt</tt></b>
<li><b><tt>vnconfig -u vnd0</tt></b>
</ol>
この手順は、コンフィグファイルに "<tt>pseudo-device vnd</tt>" を指定して
作成したカーネルを、現在利用していることを前提としています。

<hr>
<table width="100%"><tr>
  <td>
    <table><tr>
      <td>
	<a href="../../index.html">
	<img src="/images/NetBSD-banner.gif" alt="NetBSD&nbsp;Home"></a>
      </td><td>
	<a href="../../index.html">ホームページ</a>
      </td>
    </tr></table>
  </td><td>
    <table><tr>
      <td>
	<a href="../index.html">
	<img src="/images/NetBSD-banner.gif"
	alt="NetBSD&nbsp;Documentation"></a>
      </td><td>
	<a href="../index.html">ドキュメントと FAQ</a>
      </td>
    </tr></table>
  </td>
</tr></table>

<hr>
<address>
  www@jp.NetBSD.ORG<br>
  $Id$<br>
  $NetBSD: index.html,v 1.6 1998/11/02 05:53:43 abs Exp $<br>
  <a href="../../Misc/disclaimer.html">Copyright &copy; 1998
    The NetBSD Foundation, Inc.  ALL RIGHTS RESERVED.</a>
  <br>
    Copyright &copy; 1998
    The Japan NetBSD Users' Group.  ALL RIGHTS RESERVED.
</address>

</body>
</html>
