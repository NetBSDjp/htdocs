<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<html>
<head>

<!-- DO NOT EDIT THIS FILE. EDIT 'kgdb.list' AND RUN 'make' -->

<!-- Copyright (c) 2000
        The NetBSD Foundation, Inc.  ALL RIGHTS RESERVED. -->
<link rev="made" href="mailto:www@JP.NetBSD.ORG">
<title>How to Debug the NetBSD kernel with GDB</title>
</head>
<body bgcolor="#FFFFFF" text="#000000">


<table><tr><td>
<a href="/Misc/daemon-copy.html">
<img align="center" src="/images/BSD-demon.jpg" border=0
width=146 height=129 alt="BSD demon"></a>
</td><td align=center>
<h1>NetBSD ドキュメンテーション:</h1>
<h1>GDB を使い NetBSD カーネルをデバッグする方法</h1>
</td></tr></table>
<p>


<h2><a name="top">KGDB の使用方法</a></h2>
<font><ul>
<li><a href="#introduction">概要</a></li>
<li><a href="#prerequisites">事前に準備しておくこと</a></li>
<li><a href="#instructions">手順</a></li>
<li><a href="#troubleshooting">トラブルシューティング</a></li>
<li><a href="#general_caveats">一般的な注意</a></li>
</ul></font>


<hr>
<h2>KGDB の使用方法</h2><hr>
<p><dl><dt>
<font><h3><a name="introduction">概要</a>
<font size="-1">(<a href="#top">top</a>)</font></h3></font>
</dt><dd>

NetBSD カーネルに含まれている DDB デバッガーは、クラッシュ・トレースバック
を入手したり、変数の値の検査、その他のこまかいデバッグのために、役に立ちま
す。しかしながら、もし、真剣にカーネルをハックしているのであれば、DDB のか
わりに、リモートデバッガー KGDB が動作するように設定したいと思うでしょう。
<p>

DDB に対する KGDB の利点は、ディスアセンブルされたマシンコードでなく
カーネルの *ソースコード* を見ることができることです。実際のところ、
ほとんどすべての GDB の機能が使用可能で、gdb のいくつかのグラフィカル
インターフェースを使うこともできます(例えば <a href="ftp://ftp.netbsd.org/pub/NetBSD/packages/pkgsrc/devel/ddd/README.html">ddd</a> など)。

</dd></dl></p>
<p><dl><dt>
<font><h3><a name="prerequisites">事前に準備しておくこと</a>
<font size="-1">(<a href="#top">top</a>)</font></h3></font>
</dt><dd>

* 同一アーキテクチャーで NetBSD の動作しているマシン二台(オブジェクトコード
のフォーマットも同一であること)<p><p>

<PRE>
    TARGET - デバッグするカーネルを実行するマシン
    REMOTE - gdb を実行、表示するマシン
</PRE>

あるアーキテクチャーのホストで、他のアーキテクチャーのターゲット用の gdb 
を構築することも可能です。しかし、これについてはここではふれません。きっと
誰かが書いてくれることでしょう。<p><p>

* 空きのシリアルポートが両方のマシンに存在すること<p>
* null モデムケーブル<p>
* カーネルの構築とインストール、そして gdb の使用法についての知識<p>

</dd></dl></p>
<p><dl><dt>
<font><h3><a name="instructions">手順</a>
<font size="-1">(<a href="#top">top</a>)</font></h3></font>
</dt><dd>

(以下の文中では、REMOTE マシン上(gdb が動作している)で tty01 を、TARGET 
マシン(デバッグされる)では tty00 を使用していると仮定して説明します。
これで、以下の手順の中で、どのシリアルポートについてのべているのか混乱する
ことはないでしょう。<p><p>

<ol>
<li>KGDB を有効にしたカーネルの構築
<p>
(注意: たぶん、これがリモートマシン上でカーネルを構築する最良の方法
でしょう。これで、デバッグする時には、すべての必要なソースファイルと
シンボルファイルはすでに準備されています。)<p><p>
<p>

<ul>
<li>TARGET マシンのためにカーネルのコンフィグファイル内の以下の行を
コメントアウトしてください。
<p>

<PRE>
  #options 	DDB		# in-kernel debugger
  #options 	DDB_HISTORY_SIZE=100	# enable history editing 
</PRE>

以下の三行をアンコメントアウト(あるいは追加)してください。<p><p>

<PRE>
  options 	KGDB		# remote debugger
  options 	"KGDB_DEVNAME=\"com\"",KGDBADDR=0x3f8,KGDBRATE=9600
  makeoptions	DEBUG="-g"	# compile full symbol table
</PRE>

TARGET マシン上で使用するシリアルポートの IO アドレス(0x3f8 は tty00、
0x2f8 は tty01 用です)に一致するように、KGDBADDR を変更してください。
それから、KGDBRATEを、使用するビットレートに一致させてください。<p><p>

<li> TARGET マシンのカーネルの設定と<a href="./#how_to_build_a_kernel">
構築</>をおこなってください。
<p>
</ul></li>

<li> TARGET マシンの準備
<p>
ファイル「netbsd」を、カーネルを構築したディレクトリから TARGET マシンの
ルートディレクトリにコピーしてください。このカーネルをリモートマシンに
インストールしてはいけません。(特に、両方のマシンで同じ tty を使っている
時には注意してください!)
<p>

<li>REMOTE マシンの準備
<p>

<ul>
<li> TARGET マシンでカーネルを構築したのであれば、/usr/src/sys すべてを、
REMOTE マシンにコピーしてください。(*注意: TARGET マシンのディレクトリ
を 単に NFS マウントしてはいけません。gdb がブレークポイントで停止した
時に、TARGET マシン上の nfsd を含むすべてのプロセスは停止します。)
<p>

<li>REMOTE マシン上で使う予定の(そして REMORE マシンでだけ使う) tty の
ために /etc/ttys を変更してください。例えば以下のように。
<p>

<PRE>
   tty01 "/usr/libexec/getty std.9600" unknown off local
</PRE>

ここで重要なのは、「off」(これで、init がこのポートで getty を起動する
ことはありません)と「local」です。ttyflags は、/etc/ttys に従ってブート
時にポートのデフォルトを設定します。そして、gdb を使うには、DTR を待た
ないようにするために「local」が設定されていなければなりません
(*注意: 「local」の設定は、1999 年 12 月 21 日以降の NetBSD-current、
そして NetBSD 1.5 リリースでは必要ありません。)
<p>

「std.9600」を別のビットレートに変更したい場合もあるかもしれません。この
場合、ビットレートは、gdb で設定する remotebaudrate (後で説明します)と
同様に、TARGET 用のカーネルオプションで設定したレートと一致していなけ
ればなりません。/etc/gettytab の中に、あなたが使う名前と一致するエントリー
があることを確認してください。<p><p>
<p>

<li>REMOTE マシンをリブートするか、ttyflags を起動し /etc/ttys を再
読み込みさせてください。(「kill -1 1」で十分かもしれません。しかし、
/etc/ttys の項目の順番を変更したことにより、init が混乱したのを見た
経験があります。)
<p>
</ul></li>

<li>null モデムケーブルを使い、シリアルポートに接続してください。
<p>

<li>TARGET マシンをリブートし、ブートローダーのメッセージが表示されたら
すぐに、スペースキーを押してください。そして、次のコマンドを入力して
ください。
<p>

<PRE>
	boot -d
</PRE>

これによりカーネルがロードされます。「waiting for kgdb」というメッセージ
が表示された後、TARGET は停止します。
<p>

<li>REMOTE マシン側で、カーネルを構築したディレクトリ
(一般的には /usr/src/sys/arch/&lt;something&gt;/compile/&lt;config-name&gt;) 
に移動し、gdb を起動します。
<p>

<PRE>
	gdb netbsd.gdb
</PRE>

数秒後、(gdb) プロンプトが表示されるはずです。

<li>gdb のいくつかのフラグを設定する
<p>

<PRE>
	# いつでも Ctrl-C により TARGET を停止させることができるようにする。
	(gdb) set remotebreak 1
	# gdb の使用するボーレートを設定する。(デフォルトは 9600、
	# TARGET にインストールされたカーネルの設定と一致していること)
	(gdb) set remotebaud 9600
	# シリアル上でラインエラーが発生した場合の再送速度を速くする。
	(gdb) set remotetimeout 3
</PRE>
<p>

<li> REMOTE マシンに接続します(REMOTEマシン側で tty00 を使用していると
仮定しています)
<p>

<PRE>
	target remote /dev/tty00
</PRE>

以下のようなメッセージが表示されます。
<p>

<PRE>
	Remote debugging using /dev/tty01
	kgdb_connect (verbose=1) at 	../../../../arch/i386/i386/kgdb_machdep.c:244
	244             if (verbose)
	(gdb)
</PRE>
<p>

もし、これらのメッセージが表示されるかわりに、GDB が 「hang」しているよう
なら、シリアルハードウェア、ケーブル、あるいは設定に何か間違いがあります。
トラブルシューティングのセクションを参照してください。
<p>

<li>さて、プロンプトが表示されれば、ハックする準備はできています。
ブレークポイントを設定したり、データを確認したり、一ステップ毎に実行する
ことができます。ちょうど、ローカルマシン上で動作しているユーザーレベル
アプリケーションを gdb でデバッグするのと同じです。カーネルのブートプロ
セスを続行させるには、「cont」を使ってください。後でデバッガーにもどるため
には、Ctrl-C を押してください。
<p>

<li>5 から 7 の手順を自動化するためには、カーネルを構築するディレクトリに
以下の内容のファイル .gdbinit を作成してください。
<p>

<PRE>
      file netbsd.gdb
      set remotebreak 1
      set remotebuad 9600
      target remote /dev/tty00
</PRE>
<p>

さて、これで「gdb」とタイプするだけで、デバッグを始めることができます。
</ol>

</dd></dl></p>
<p><dl><dt>
<font><h3><a name="troubleshooting">トラブルシューティング</a>
<font size="-1">(<a href="#top">top</a>)</font></h3></font>
</dt><dd>

もし、うまく動作しない場合は、以下の事を試してみてください。
<p>

<ul>
<li>-d を指定せずに TARGET マシンをリブートしてください。デバイスの
プローブ時に以下のようなメッセージが表示されるはずです。二行目が表示
されていなければ、構築したカーネルでは KGDB が有効になっていないか、
間違ったカーネルを使用しています。
<p>

<PRE>
	com0 at isa0 port 0x3f8-0x3ff irq4: ns16550a, working fifo
	com0: kgdb
</PRE>
<p>

<li>シリアルポートとケーブルが「通常」のアプリケーションで動作すること
を確認してください。KGDB を無効にしたカーネルで TARGET マシンをリブート
し、二つのマシン間で「tip 」を実行してみてください。もし、tip について
知らないのであれば、以下の簡単な手順を参考にしてください。
<p>

* 以下の行を、TARGET と REMOTE 両マシンの /etc/remote に追加してください。
<p>

<dl><dd><code>
	tty00-9600:dv=/dev/tty00:br#9600:pa=none:dc:<br>
	tty01-9600:dv=/dev/tty01:br#9600:pa=none:dc:<br>
</code></dd></dl>
<p>

* TARGET マシン上で「tip tty00-9600」を、REMOTE マシン上で「tip tty01-9600」
を実行してください。
<p>

* 両方のマシンのキーボードで適当な文字を入力してください。文字は
他のマシンのディスプレイに表示されるはずです。
<p>

<li>/etc/ttys の中の、自分が使っている tty の行を再度確認し、それが有効
かどうかを確認するためにリブートしてください。
<p>

<li>今まで書いてた文章の中では、root で作業している事を仮定していました。
一般ユーザーの場合、tip と gdb は動作しません。(/dev/tty0* のパーミッション
に依存します)。もちろん、root での作業は、一般的にはおすすめできません。
かわりに、以下のようにしてください。
<p>

   * /dev/tty0* のグループを「wheel」にしてください(そうなっていなければ)<p>
   * あなたのユーザー名を、/etc/group の「wheel」行に追加してください<p>
   * あなたのユーザー名を、/etc/group の「dialer」行に追加してください<p>
<p>
(2) により、gdb のプロセスが(そして、あなたが起動している他のプロセスも)、
tty をオープンできるようになる。(3) により、tip を起動することができる
ようになる。
</ul>

</dd></dl></p>
<p><dl><dt>
<font><h3><a name="general_caveats">一般的な注意</a>
<font size="-1">(<a href="#top">top</a>)</font></h3></font>
</dt><dd>

<ol>
<li>コマンドを入力してから反応が返ってくるまでに、時々長い時間がかかる
ことがあります。これは、おそらくシリアルコネクション上の不正なデータの
せいです。みじかい休止と再送の後、すべて正常にもどります。
「remotetimeout」の値をデフォルトの 20 秒より短かく設定するとよいでしょう。
(これはある人から報告がありました。(彼の場合は)カーネルのsprintf() が
コマンドの間に実行されたことが原因でした。これにより gdb のデータがこわれ
たようです)。
<p>
<li>カーネルが高優先度の割り込み(機種依存)ロック中は、Ctrl-C は動作しません。
例えば、i386 では、splimp() の中の永久ループを停止させることはできません。
しかし、ブレークポイントを、そのループの前にセットすれば、そこを一ステップ
ずつ実行することができます。
</ol>

</dd></dl></p>
<hr>

<a href=""><em>NetBSD Documentation: Kernel</em>にもどる</a>
<hr>


<table width="100%"><tr>
<td>
  <table><tr>
  <td>
    <a href="../../">
    <img src="/images/NetBSD-banner.gif" border=0 alt=""></a>
  </td><td>
    <font>
    <a href="../../">
    <img src="/images/empty.gif" border=0
     alt="NetBSD ">ホームページ</a>
    </font>
  </td>
  </tr></table>
</td><td>
  <table><tr>
  <td>
    <a href="../../Documentation/">
    <img src="/images/NetBSD-banner.gif" border=0 alt=""></a>
  </td><td>
    <font>
    <a href="../../Documentation/">
    <img src="/images/empty.gif" border=0
     alt="NetBSD ">Documentation top level</a>
    </font>
  </td>
  </tr></table>
</td>
</table>


<hr>
<address>
  <small>
  <a href="../../Misc/feedback.html">(Contact us)</a>
  $NetBSD: kgdb.html,v 1.3 2000/10/17 15:06:03 yyamano Exp $<br>
  <a href="../../Misc/disclaimer.html">Copyright &copy; 2000
    The NetBSD Foundation, Inc.  ALL RIGHTS RESERVED.</a>
  </small>
</address>

</body>
</html>
