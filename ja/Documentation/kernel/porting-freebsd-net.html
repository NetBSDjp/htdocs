<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">

<html>
<head>
<!-- Copyright (c) 1994-2003
	The NetBSD Foundation, Inc.  ALL RIGHTS RESERVED. -->
<link rev="made" href="mailto:www@JP.NetBSD.ORG">
<title>NetBSD Documentation: Notes on porting FreeBSD network drivers to NetBSD</title>
</head><body bgcolor="#FFFFFF" text="#000000">

<table><tr><td>
<a href="/Misc/daemon-copy.html" origlink="../../Misc/daemon-copy.html">
<img align="middle" src="/images/BSD-daemon.jpg" origlink="../../images/BSD-daemon.jpg" border=0
width=146 height=129 alt="BSD daemon"></a>
</td><td align=center>
<h1>NetBSD ドキュメンテーション:</h1>
<h1>FreeBSD のネットワークドライバーを NetBSD に移植するためのメモ</h1>
</td></tr></table>
<p>

<h2>概要</h2>
Matthias Drochner は、FreeBSD のネットワークドライバーを NetBSD に
移植する時に見つけた相異点をまとめています。
これが役に立つことを願っています。
<p>

<h2>基本的なインクルードファイルや定義要素</h2>
<ul><li>
#include ファイル名 / 場所は、思ったより異なっています。
</li><li>
パケットフィルター<br>
FreeBSD: "BPF"<br>
NetBSD: "BPFILTER"<br>
[理由は無い様に見受けられますが、多くの OS 間で異なっている様です。(DEC: "packetfilter")]
</li><li>
NetBSD では、"opt_inet.h" と "opt_ns.h" をインクルードする必要が有ります。
</li><li>
NetBSD には、グローバル変数 "bootverbose" が存在しません。</li><li>
NetBSD は、集中管理された PCI ID データベースと PCI レジスターの定義を持っています。</li><li>
if_media: FreeBSD: IFM_1000_SX, NetBSD: IFM_1000_FX<br>
[1000_FX と言う物は存在しません。- NetBSD が間違っています。]
</li><li>
&lt;sys/queue.h&gt; の中の要素の違い<br>
(NetBSD には SLIST の様な物は存在しません。)<br>
[名前の違いに理由は有りません。しかし、SLIST の様な物は(SIMPLEQ よりオーバーヘッドが少ないので)
 NetBSD にとっても有用です。]
</li></ul>

<h2>ネットワーク固有でないフレームワーク</h2>
<ul><li>
オートコンフィギュレーションのフレームワークが異なります。
</li><li>
デバイス名の表示<br>
FreeBSD: name:unit<br>
NetBSD: xname<br>
("struct ifnet" も同様です。)
</li><li>
割り込み用のハンドラーが、FreeBSD では void、NetBSD では int です。<br>
[stray interrupts の検出???]
</li><li>
bus.h: マップされた範囲の仮想アドレスへのアクセス<br>
(全てのハードウェアがサポートしているわけではないので、
一般的にはリニアーマッピングは避けた方が良いです。しかし、どうしても必要なら
BUS_SPACE_MAP_LINEAR がこれを提供すべきです。)<br>
[NetBSD の bus_space フレームワークには存在しません。移植性を低下させる原因なので、
可能なら bus_space_xxx を使いましょう。]
</li><li>
bus_dma 関係(FreeBSD は、まだ古い機能を使っています。)
</li></ul>

<h2>ネットワーク関連</h2>
<ul><li>
外部 mbuf ストレージ処理<br>
FreeBSD: xxxfree() への引数は有りません。<br>
NetBSD: xxxfree() への引数がはっきりしません。<br>
FreeBSD: ドライバーが与えるリファレンスカウント<br>
NetBSD: 自動的リファレンスカウント<br>
</li><li>
FreeBSD は汎用の ether_ioctl() を持っています。<br>
[良い - 汎用のコードを削除する。]
</li><li>
アドレスバイトのための "struct ether_addr" のメンバー<br>
FreeBSD: "octet"<br>
NetBSD: "ether_addr_octet"<br>
[理由は無い]
</li><li>
softc の "ethercom" 対 "arpcom" <br>
[技術的には、 NetBSD が正しい。]
</li><li>
イーサネットアドレスへのアクセス<br>
FreeBSD: "arpcom" の中でアクセスされる。<br>
NetBSD: ether_ifattach() へ渡され、ifp を経由してアクセスされる。
(LLADDR() - アライメント問題の監視!)<br>
[NetBSD では実行中のアドレス変更を扱うことが出来ません。]
</li><li>
マルチキャストアドレスのリスト<br>
FreeBSD: ifp-&gt;if_multiaddrs の、そのままのリスト<br>
NetBSD: "struct ethercom" の一部と言う、特別なフレームワーク
</li><li>
"struct ifnet" のメンバーが異って (if_attach、ether_ifattach) おり、
異なる初期化を行う。<br>
-xname 対 name:unit<br>
-FreeBSD: xxxinit() - ether_ioctl() によって使われるため<br>
-イーサネットアドレス
</li><li>
bpf 関数の引数<br>
FreeBSD: ifp<br>
NetBSD: ifp-&gt;if_bpf<br>
</li><li>
受信パケットの上位レイヤーへの引渡し<br>
FreeBSD: ether_input()に、イーサネットヘッダーを分離して渡す。<br>
NetBSD: 全てのパケットを、 ifp-&gt;ifp_input と間接的に経由して渡す。<br>
[最近、NetBSD で変更されました。]
</li><li>
NetBSD は MII フレームワークを持っており、ドライバーはレジスターへのアクセスを提供するだけです。
</li></ul>
<p>

<hr>
<a href=""><em>NetBSD Documentation: Kernel</em> にもどる</a>
<hr>

<table width="100%"><tr><td>
  <table><tr><td>
    <a href="../../"><img
        src="/images/NetBSD-flag.gif" origlink="../../images/NetBSD-flag.gif" border="0"
        width="91" height="42" alt=""></a>
  </td><td>
    <a href="../../"><img
        src="/images/empty.gif" origlink="../../images/empty.gif" border="0"
        width="1" height="1" alt="NetBSD ">ホームページ</a>
  </td></tr></table>
</td><td>
  <table><tr><td>
    <a href="../../Documentation"><img
        src="/images/NetBSD-flag.gif" origlink="../../images/NetBSD-flag.gif" border="0"
        width="91" height="42" alt=""></a>
  </td><td>
    <a href="../../Documentation"><img
        src="/images/empty.gif" origlink="../../images/empty.gif" border="0"
        width="1" height="1" alt="NetBSD ">ドキュメントのトップ</a>
  </td></tr></table>
</td></tr></table>

<hr>
<address>
  <small>
  <a href="http://www.netbsd.org/cgi-bin/feedback.cgi">(Contact us)</a>
  $NetBSD: porting-freebsd-net.html,v 1.4 2003/03/08 19:44:18 grant Exp $<br>
  <a href="../../Misc/disclaimer.html">Copyright &copy; 1994-2003
  The NetBSD Foundation, Inc.  ALL RIGHTS RESERVED.</a>
  </small>
</address>

</body>
</html>

