<!-- $NetBSD: chapter.xml,v 1.4 2003/05/24 04:24:40 grant Exp $ -->
<!-- Based on english version: -->
<!-- NetBSD: chapter.xml,v 1.4 2003/05/24 04:24:40 grant Exp   -->

<chapter id="features"> <?dbhtml filename="features.html"?>
<title>FAQとパッケージシステムの特徴</title>

<sect1>
<title>GNU autoconfを利用するパッケージ</title>

<para>
もしパッケージがGNU autoconfで作成されたconfigureスクリプトを使うのであれば、
パッケージのMakefileに以下の設定を追加してください。
</para>

<programlisting>GNU_CONFIGURE= yes</programlisting>

<para>
この設定がCONFIGURE_ARGSに--prefix=${PREFIX}を追加することに注意してくださ
い。したがって、あなた自身でこれを追加する必要はありません。そして、これは
あなたの望む設定とは異なるかもしれません。
</para>
</sect1>


<sect1>
<title>.tar.gz 以外の配布方法</title>

<para>
パッケージが.tar.gz以外の方法で配布されている場合、<pkg>editors/sam</pkg>パッケー
ジを参考にしてください。これはgzipされたシェルアーカイブ(shar)を使っていま
す。いちおう簡単に説明すると、DISTNAMEフィールドの後でEXTRACT_SUFXに名前を
設定し、パッケージのMakefileに以下の設定を追加してください。
</para>

<programlisting>EXTRACT_SUFX=   .msg.gz
EXTRACT_CMD=            zcat
EXTRACT_BEFORE_ARGS=
EXTRACT_AFTER_ARGS=     |sh</programlisting>
</sect1>


<sect1>
<title>それ自身のサブディレクトリーを作り出さないパッケージ</title>

<para>
パッケージが例えばGNUソフトウェアのようにサブディレクトリーを作るのではなく、
カレントディレクトリーに展開される場合、もう一度<pkg>editors/sam</pkg>を見てく
ださい。簡単にいうと以下の設定が必要です。
</para>

<programlisting>WRKSRC=		${WRKDIR}</programlisting>

<para>
なお、以前使われていた
</para>

<programlisting>NO_WRKSUBDIR=   yes</programlisting>

<para>
は廃止されましたので、もう使わないでください。
</para>
</sect1>

<sect1>
<title>カスタムコンフィギュレーションプロセス</title>

<para>
パッケージが、かわったConfigureスクリプトを使用している場合、topのパッケー
ジを参照してください。簡単にいえば、以下の設定をおこなってください。
</para>

<programlisting>HAS_CONFIGURE=          yes
CONFIGURE_SCRIPT=       Configure
CONFIGURE_ARGS+=        netbsd13</programlisting>
</sect1>


<sect1>
<title>DISTNAMEディレクトリーで作成されないパッケージ</title>

<para>
パッケージが、DISTNAMEをベースにしないディレクトリーで構築される場合、tcl、
およびtkパッケージを参考にしてください。
</para>

<programlisting>WRKSRC=         ${WRKDIR}/${DISTNAME}/unix</programlisting>
</sect1>


<sect1>
<title>一度にすべてのdistfileを取得する方法</title>

<para>
<command>make fetch</command>を実行できない職場や大学において、一回のバッチ処理で、すべて
のdistfileをダウンロードしたいと思うことがあるかもしれません。しかしながら、
ftp.NetBSD.orgにはdistfileのアーカイブはありません。そしてftp.freebsd.org
上にあるアーカイブは、移植されていない多くのdistfileを含んでいます。
</para>

<para>
現時点では、<command>make fetch-list</command>を<filename>/usr/pkgsrc</filename>で実行し、その結果のリストを職
場や学校のマシンに持ってきて、使用してくださいとしかいえません。NetBSDと互
換なftp(1)(lukemftpなど)が使えない場合は、URLを指定して取得ができるコマンド
をFETCH_CMDに指定することを忘れないでください:
</para>

<para>
自宅で:
</para>

<programlisting>% cd /usr/pkgsrc
% make fetch-list FETCH_CMD=wget DISTDIR=/tmp/distfiles >/tmp/fetch.sh
% scp /tmp/fetch.sh work:/tmp</programlisting>

<para>
職場で:
</para>

<programlisting>% sh /tmp/fetch.sh</programlisting>

<para>
実行後、 /tmp/distfiles を tar で固めて自宅に持って帰ります。
</para>

<para>
NetBSDで動いているマシンがあって、*すべての*distfile (そのマシンのアーキテ
クチャー向けではないものも含む)を取得したい場合は、上述の<command>make fetch-list</command>
の方法を使うか、以下のようにしてdistfileを直接取得することができます。
</para>

<programlisting>% make mirror-distfiles</programlisting>

<para>
NO_{SRC,BIN}_ON_{FTP,CDROM}も無視したい場合は、以下のようにしてすべてのもの
を取得することができます。
</para>

<programlisting>% make fetch NO_SKIP=yes</programlisting>
</sect1>


<sect1>
<title>防火壁の内側からファイルを取得する方法</title>

<para>
もし、あなたが防火壁の内側にいて、インターネットのホストに直接接続できない
(つまりNATを使っていない)場合、適切なプロキシーホストを指定することができま
す。これはURL形式の環境変数で指定します。例えば、Amdahlドメインにおいては、
orpheus.amdahl.comというマシンは防火壁のひとつで、プロキシーポート番号とし
て、80番のポートを使用します。この場合、proxy環境変数は以下のようになります。
</para>

<programlisting>ftp_proxy=ftp://orpheus.amdahl.com:80/
http_proxy=http://orpheus.amdahl.com:80/</programlisting>
</sect1>


<sect1>
<title>パッチがRCS IDを含む場合</title>

<para>
パッチからRCS IDを削除する方法については、<xref linkend="components.patches"/>を参照してください。
</para>
</sect1>


<sect1>
<title>/etc/mk.confから変数を捕まえる方法</title>

<para>
MAKECONFや<filename>/etc/mk.conf</filename>で上書き可能な、パッケージで定義された変数には問題が
あります。それは、変数はmake(1)がそれを使う時に展開されるが、プリプロセッサー
風の文(.if、.ifdefそして.ifndef)は読み込み時に評価される事です。したがって、
.if*文内で変数(<filename>/etc/mk.conf</filename>でセットされる可能性のある)を使う時は、その.if*
ステートメントの前に<filename>/etc/mk.conf</filename>をインクルードしておかなくていけません。
</para>

<para>
<filename>/etc/mk.conf</filename>やMAKECONFが存在したら、それらをインクルードするというad-hocな
方法をとらずに、すべてのプリプロセッサー風の.if、.ifdef、または.ifndef文の
前で、<filename>pkgsrc/mk/bsd.prefs.mk</filename>をインクルードしてください。
</para>

<programlisting>.include "../../mk/bsd.prefs.mk"

.if defined(USE_MENUS)
  ...
.endif</programlisting>
</sect1>


<sect1>
<title>pkgについて話しあうためのメーリングリストはありますか?</title>

<para>
はい。パッケージに関する問題を議論するために<email>tech-pkg@NetBSD.org</email>が存在します。
参加するためには以下のようにして下さい。
</para>

<programlisting>% echo subscribe tech-pkg | mail majordomo@NetBSD.org</programlisting>
</sect1>


<sect1>
<title>どうすれば<command>make fetch</command>でpassive FTPを使用することができますか?</title>

<para>
distfileの取得にどのユーティリティーを使っているかによります。<filename>bsd.pkg.mk</filename>は、
以下のリストのなかで利用可能なコマンドのうち、最初のものをFETCH_CMDに割り当
てます:
</para>

<programlisting>/usr/bin/fetch
${LOCALBASE}/bsd/bin/ftp
/usr/bin/ftp</programlisting>

<para>
NetBSDのデフォルトのインストールでは、<filename>/usr/bin/ftp</filename>となり、これは自動的に、
最初はパッシブ接続を試みます。そして、サーバーがパッシブ接続を拒否した場合
は、アクティブ接続に切り替わります。これ以外のツールの場合は、
<filename>/etc/mk.conf</filename>に以下の設定を追加してください。PASSIVE_FETCH=1
</para>

<para>
これを設定すると、<filename>/usr/bin/ftp</filename>はアクティブ転送への切り替えをおこなわなくな
ります。
</para>
</sect1>


<sect1>
<title>他のパッケージへの依存</title>

<para>
パッケージは他のパッケージに依存するかもしれません。そして、この依存性を定
義するためのいろいろな方法があります。NetBSDは、<filename>buildlink2.mk</filename>を使った依存関
係(<xref linkend="buildlink2"/>参照)のほか、BUILD_DEPENDS、DEPENDS定義をサポートしています。
</para>

<para>
両定義の基本的な差異は、以下の通りです: DEPENDS定義では、その依存性がバイナ
リーパッケージ内に記録されますが、BUILD_DEPENDS定義では記録されません。
</para>

<para>
つまり、あるパッケージが必要となるのが構築時だけである場合、そのパッケージ
はBUILD_DEPENDSとして書きます。
</para>

<para>
BUILD_DEPENDSおよびDEPENDS定義の書式は以下の通りです:
</para>

<programlisting>&lt;pre-req-package-name&gt;:../../&lt;category&gt;/&lt;pre-req-package&gt;</programlisting>

<para>
なお、この<quote>pre-req-package-name</quote>のバージョン番号には、pkg_info(1)で説明され
ている各ワイルドカードを含めることができます。
</para>

<orderedlist>

<listitem>
<para>
パッケージを構築するために他のパッケージが必要なら、BUILD_DEPENDS定義を
使ってください。
</para>

<programlisting>BUILD_DEPENDS+=  autoconf-2.13:../../devel/autoconf</programlisting>
</listitem>

<listitem>
<para>
もし、パッケージがリンクのためのライブラリーを必要とするなら、DEPENDS定
義を使ってください。たとえば、pkgsrc/print/lyxパッケージは、作成のためにxpm
ライブラリーのバージョン3.4jを使用します。
</para>

<programlisting>DEPENDS+=       xpm-3.4j:../../graphics/xpm</programlisting>

<para>
また、パッケージ依存関係にはワイルドカードを使うことができます。
</para>

<programlisting>DEPENDS+=	xpm-[0-9]*:../../graphics/xpm</programlisting>

<para>
ワイルドカード依存関係は、バイナリーパッケージを作る時には保持されること
に注意してください。依存関係はバイナリーパッケージのインストール時にチェッ
クされ、パターンにマッチするパッケージが使われます。ワイルドカード依存関係
は、注意を払って使うよう気を付けてください。
</para>

<para>
tk-postgresqlがtk-*というDEPENDにマッチするなどの曖昧なマッチの可能性を排除
するため、-*ではなく-[0-9]*を使うことをおすすめします。
</para>
</listitem>

<listitem>
<para>
もし、パッケージを実行するために、いくつかの実行可能ファイルが必要なら、
DEPENDS定義を使ってください。<pkg>print/lyx</pkg>パッケージを実行する時には、
teTeXパッケージ由来のlatex のバイナリーが実行可能でなければなりません。これ
は、以下のように指定します。
</para>

<programlisting>DEPENDS+=        teTeX-[0-9]*:../../print/teTeX</programlisting>

<para>
上述した、ワイルドカード依存関係に関する注意は、ここにも当てはまります。
</para>
</listitem>

</orderedlist>

<para>
パッケージの構築用に別のパッケージに含まれるファイルが必要な場合は、
<pkg>print/ghostscript5</pkg>パッケージの<quote>do-configure</quote>ターゲットの最初の部分を
ご覧ください(このパッケージは、構築の際にjpegのソースがソースの状態で存在す
ることに依存しています)。
</para>

<programlisting>if [ ! -e ${_PKGSRCDIR}/graphics/jpeg/${WRKDIR:T}/jpeg-6b ]; then \
	cd ${_PKGSRCDIR}/../../graphics/jpeg &amp;&amp; ${MAKE} extract;              \
fi</programlisting>

<para>
このように、別のパッケージの構築用にソースを展開する場合は、構築するパッケー
ジの作業ファイルの削除時に、展開した依存先パッケージの作業ファイルも削除す
るようにしてください。そうするための一番簡単な方法は、pre-cleanターゲットを
追加することです。
</para>

<programlisting>pre-clean:
	cd ${_PKGSRCDIR}/../../graphics/jpeg &amp;&amp; ${MAKE} clean</programlisting>

<para>
また、便利に使うことができるBUILD_USES_MSGFMTおよびBUILD_USES_GETTEXT_M4定
義にも注意してください。前者は、基本システムにmsgfmt(1)があるかどうか調べて、
ない場合は<pkg>devel/gettext</pkg>パッケージをインストールします。後者は、構築
の際に、旧バージョンのgettextパッケージがインストールされていることに依存す
るようにし、これがインストールされていない場合は<pkg>devel/gettext-m4</pkg>パッ
ケージをインストールします。
</para>
</sect1>


<sect1>
<title>他のパッケージとの衝突</title>

<para>
パッケージは、すでにインストール済みの別のパッケージと衝突する可能性があり
ます。例えば、パッケージが、pkgsrcの中の別のパッケージと同じファイルをイン
ストールするような場合です。
</para>

<para>
この場合、衝突するパッケージ(バージョン文字列を含む)のリストをスペースで区
切ってCONFLICTSにセットすることができます。
</para>

<para>
例えば、<pkg>x11/Xaw3d</pkg>および<pkg>x11/Xaw-Xpm</pkg>は同じ共有ライブラリーをイ
ンストールします。したがって、<filename>pkgsrc/x11/Xaw3d/Makefile</filename>に以下のような設定を
おこなってください。
</para>

<programlisting>CONFLICTS=      Xaw-Xpm-[0-9]*</programlisting>

<para>
そして、<filename>pkgsrc/x11/Xaw-Xpm/Makefile</filename>には以下の設定が必要です。
</para>

<programlisting>CONFLICTS=      Xaw3d-[0-9]*</programlisting>

<para>
パッケージは、名前のプレフィックスが同じで、異なるバージョン文字列をもつ別
のパッケージと自動的に衝突します。例えば<quote>Xaw3d-1.5</quote>は、古いバージョンの
<quote>Xaw3d-1.3</quote>と衝突するでしょう。
</para>
</sect1>


<sect1>
<title>WWWホームページがあるソフトウェア</title>

<para>
NetBSDパッケージシステムは、HOMEPAGE変数をサポートしています。もし、パッケー
ジ化されたソフトウェアのホームページが存在するのであれば、そのページのURLを
MakefileのHOMEPAGE変数に設定します。この変数はMAINTAINER変数のすぐ後に定義
してください。
</para>
</sect1>


<sect1>
<title>'古い'名前のまま更新されたdistfileの取り扱い</title>

<para>
時々、ソフトウェアパッケージの作者がソフトウェアのリリース後に変更を加え、
変更後のdistfileを、バージョン番号を変えずに公開することがあります。このと
き、pkgsrcにそのパッケージがすでに入っていると、md5チェックサムが一致しない
ことになります。この問題の正しい回避策は、パッケージのmd5チェックサムをマス
ターサイト(ミラーサイトでは更新されていないことがあります!)のパッケージに合
わせて変更し、古いdistfileをftp.NetBSD.orgの<filename>/pub/NetBSD/packages/distfiles</filename>
ディレクトリーから削除することです。さらに、パッケージの正当な作者にメール
を出して、distfileの更新が意図されたものであって、トロイの木馬などが仕込ま
れたのではないことを確認します。
</para>
</sect1>

<sect1>
<title>"Don't know how to make /usr/share/tmac/tmac.andoc" ってどういうこと?</title>
<para>
<pkg>pkgtools/pkg_install</pkg>パッケージのコンパイル時に、makeが
<filename>/usr/share/tmac/tmac.andoc</filename> の作り方がわからないというエラーを出します。これ
は、そのマシンに<quote>text</quote>セット(nroffなど)がインストールされていないことを意味
しています。<quote>text</quote>セットをインストールしてください。
</para>

<para>
このpkg_installパッケージの事例は、環境変数か<filename>/etc/mk.conf</filename>のどちらかで
NOMAN=YESを設定して回避することもできます。
</para>
</sect1>


<sect1>
<title>既存パッケージ修正時に、バージョンを上げるにはどうするか
</title>

<para>
既存のパッケージに修正を加えたときに、PKGNAMEのバージョン番号を変えると便利
な場合があります。元の作者による将来のバージョンと衝突しないようにするため、
PKGREVISION=1 (2,. ..)を設定して、パッケージのバージョンに'nb1' ('nb2',
...)という接尾辞をつけることができます。この<quote>nb</quote>は、pkgツール群からは"."と
同様の扱いを受けます。たとえば、
</para>

<programlisting>DISTNAME=	foo-17.42
PKGREVISION=	9</programlisting>

<para>
とすると、PKGNAMEは<quote>foo-17.42nb9</quote>になります。
</para>

<para>
このパッケージの新しいリリース版が出た際には、PKGREVISIONは消してください。
たとえば、上で例示したパッケージの新しいマイナーリリースに際しては、以下の
ようにします
</para>

<programlisting>DISTNAME=	foo-17.43</programlisting>
</sect1>


<sect1>
<title>Could not find bsd.own.mk - 何がいけないの?</title>

<para>
NetBSDのインストール時にコンパイラー一式comp.tgzをインストールしなかったか
らです。comp.tgzを入手し、/で展開してインストールしてください:
</para>

<programlisting># tar --unlink -pvxf .../comp.tgz</programlisting>

<para>
comp.tgzはNetBSDのどのリリースにも含まれていますので、あなたがインストール
したリリース(<command>uname
-r</command>で調べられます) に合ったものを入手してください。
</para>
</sect1>


<sect1>
<title>制限つきパッケージ</title>

<para>
ライセンスによっては、ソフトウェアの再配布方法に制限があります。このような
制限を満たすようにするため、パッケージシステムでは以下のような制限を設定で
きる5個のmake変数を定義しています:
</para>

<itemizedlist>

<listitem>
<para>RESTRICTED</para>
<para>
   なにか制限がある場合は常に、(制限の種類にかかわらず)この変数を設定します。
   この変数を、その制限の理由を含む文字列に設定してください。
</para>
</listitem>

<listitem> 
<para>NO_BIN_ON_CDROM</para>
<para>
   バイナリーをCD-ROMに収録してはいけません。バイナリーパッケージを
   CD-ROMに含めることができない場合は常に、この変数を${RESTRICTED}に設定
   してください。
</para>
</listitem>

<listitem> 
<para>NO_BIN_ON_FTP</para>
<para>
   バイナリーをftpサーバーに置いてはいけません。バイナリーパッケージをイ
   ンターネット上で公開することができない場合は常に、この変数を
   ${RESTRICTED}に設定してください。
</para>
</listitem>

<listitem>
<para>NO_SRC_ON_CDROM</para>
<para>
   distfileをCD-ROMに収録してはいけません。ソースコードやその他の
   distfileのCD-ROMによる再配布が許可されていない場合は、この変数を
   ${RESTRICTED}に設定してください。
</para>
</listitem>

<listitem> 
<para>NO_SRC_ON_FTP</para>
<para>
   distfileをFTPに置いてはいけません。ソースコードやその他のdistfileのイ
   ンターネット経由での再配布が許可されていない場合は、この変数を
   ${RESTRICTED}に設定してください。
</para>
</listitem>

</itemizedlist>

<para>
NO_PACKAGE, IGNORE, NO_CDROMなど、制限を意味する上記以外の汎用make変数は使
わないようにしてください。これらは、ユーザーのバイナリーパッケージ作成を、
無条件にできないようにするからです。
</para>
</sect1>


<sect1>
<title>(n)cursesを使うパッケージ</title>

<para>
パッケージによっては1.4Y以前のNetBSD自身のcursesにはなかった機能を必要とし
ます。
</para>

<para>
パッケージのMakefileで<filename>../../devel/ncurses/buildlink2.mk</filename>をインクルードすると、
pre-configure時に、cursesライブラリーとncurses機能用のヘッダーが
${BUILDLINK_DIR}内にリンクされます。ncursesが本当に必要な場合は、パッケージ
のMakefileでUSE_NCURSESを定義してください。
</para>
</sect1>


<sect1>
<title>自動セキュリティーチェック</title>

<para>
サードパーティーのソフトウェアにはしばしばバグがあること、そして、バグのな
かにはマシンをアタッカーの攻撃に対して脆弱な状態にするものもあることに、ど
うか注意してください。そのような攻撃にさらされることを減らすために、NetBSD
パッケージチームでは、pkgsrc化されたことのあるパッケージに関する既知の攻撃
のデータベースを保守しています。このデータベースを自動的にダウンロードして、
システムにインストールされている全パッケージのセキュリティー監査をおこなう
ことができます。これをおこなうには<pkg>security/audit-packages</pkg>パッケージ
をインストールします。このパッケージは、以下の二つの構成要素からなっていま
す。
</para>

<orderedlist>

<listitem>
<para>
     <quote>download-vulnerability-list</quote>: セキュリティー脆弱性情報のリストのダウン
     ロードを簡単にできるようにするものです。この脆弱性情報のリストは、
     NetBSDセキュリティーオフィサーとNetBSDパッケージチームが最新の状態に保っ
     ており、NetBSD ftpサーバーで配布されています。
</para>
<filename>ftp://ftp.NetBSD.org/pub/NetBSD/packages/distfiles/vulnerabilities</filename>
</listitem>

<listitem>
<para>
     <quote>audit-packages</quote>: マシンの監査を簡単にできるようにするもので、既知の各脆
     弱性の確認をします。脆弱性のあるパッケージがインストールされていた場合、
     そのことを標準出力に出力します。この出力には、脆弱性の種類の説明と詳細
     情報のURLが含まれます。
</para>
</listitem>

</orderedlist>

<para>
audit-packagesパッケージを使うよう強くおすすめします。
</para>

<para>
audit-packagesのインストール中に以下のようなメッセージが表示されます。
</para>

<screen>
======================================================================
You may wish to have the vulnerabilities file downloaded daily so that
it remains current.  This may be done by adding an appropriate entry
to the root users crontab(5) entry.  For example the entry
	
# download vulnerabilities file
0 3 * * * ${PREFIX}/sbin/download-vulnerability-list &gt;/dev/null 2&gt;&amp;1
	
will update the vulnerability list every day at 3AM.
	
In addition, you may wish to run the package audit from the daily
security script.  This may be accomplished by adding the following
lines to /etc/security.local
	
if [ -x ${PREFIX}/sbin/audit-packages ]; then
	${PREFIX}/sbin/audit-packages
fi
======================================================================
</screen>

<para>
パッケージ開発者への註: 脆弱性が発見された場合、そのことを
<filename>localsrc/security/advisories/pkg-vulnerabilities</filename>に記載してcommitしてくださ
い。このファイルはftp.NetBSD.orgの
<filename>/pub/NetBSD/packages/distfiles/vulnerabilities</filename> にコピーされます。
</para>
</sect1>


<sect1>
<title>パッケージでアカウントを作成する場合の適切な方法は?</title>

<para>
パッケージ特有のグループやユーザーをpre-install時に作成するよう制御するため、
二つのmake変数があります。一つ目はPKG_GROUPSで、group[:groupid]という要素
(グループIDはあってもなくてもかまいません)を列挙したものです。二つ目は
PKG_USERSで、以下のような形式の要素を列挙したものです:
</para>

<programlisting>user:group[:[userid][:[description][:[home][:shell]]]]</programlisting>

<para>
userとgroupのみが必須であり、それ以外はあってもなくてもかまいません。簡単な
例は、以下のとおりです:
</para>

<programlisting>PKG_GROUPS=	foogroup
PKG_USERS=	foouser:foogroup</programlisting>

<para>
もっと複雑な、二つのグループと二つのユーザーを作成する例は、以下のとおりで
す:
</para>

<programlisting>PKG_GROUPS=	group1 group2:1005
PKG_USERS=	first:group1::First\\ User			\
		second:group2::Second\\ User:/home/second:${SH}</programlisting>

<para>
ユーザーのホームディレクトリーやログインシェルを指定しなかった場合の、デフォ
ルトのホームディレクトリーは/nonexistent、ログインシェルは/sbin/nologinです。
</para>

<para>
これらの変数を指定するほか、パッケージのMakefileで、<filename>bsd.pkg.mk</filename>をインクルー
ドする前に<filename>../../mk/bsd.pkg.install.mk</filename>をインクルードする必要があります。こ
れにより、pre-install時にユーザーとグループが作成されるようになり、
post-deinstall時にはこのユーザーとグループの削除を管理者に促すようになりま
す。パッケージのインストールの前に環境変数 PKG_CREATE_USERGROUPをonかoffに
設定しておくと、ユーザーとグループを自動で作成するかどうかを切替えることが
できます。
</para>
</sect1>


<sect1>
<title>コンパイラーのバグへの対処方法</title>

<para>
ソースファイルのなかには、コンパイラーのバージョンとアーキテクチャーの組合
せによって、また、ほとんどの場合は、最適化を有効にしたことも関係して、コン
パイラーのバグを発現させるものがあります。よくある症状は、gccの内部エラーや、
ファイルのコンパイルが完了しないというものです。
</para>

<para>
たいていは、回避策として、MACHINE_ARCHとコンパイラーのバージョンを確認し、
問題のあるファイル/MACHINE_ARCH/コンパイラーの組合せに対して最適化を無効に
し、そのことを<filename>doc/HACKS</filename>に文書化しておくことが必要となります。例については
<filename>doc/HACKS</filename>を参照してください。
</para>
</sect1>


<sect1>
<title>infoファイルが附属するパッケージ</title>

<para>
パッケージによっては、infoファイルをインストールしたり、makeinfoまたは
install-infoコマンドを使ったりします。この場合、パッケージのMakefileで、
<filename>mk/bsd.pkg.mk</filename>をインクルードする前に、makefileの断片<filename>mk/texinfo.mk</filename>をインクルー
ドする必要があります。texinfoの新しいバージョン(バージョン4以上)は、困った
ことに、それより前のバージョンとコマンド行のレベルで互換性がありません。ま
た、TeXinfoマクロセットに拡張がいくつか導入されています。このため、パッケー
ジ作者は、シェルのPATH変数の内容に依存したりせずに、適切なバイナリーが選ば
れるようにしてください。
</para>

<para>
主たるinfoディレクトリーファイルは、infoファイルがインストールされたことを
反映するために更新する必要があります。パッケージによっては、インストール過
程でこの更新をおこなってくれます。そうしてくれないパッケージでは、NetBSDパッ
ケージコレクションのINFO_FILES定義を、この更新用に使うことができます。パッ
ケージのMakefileで、
</para>

<programlisting>INFO_FILES=	ident.info</programlisting>

<para>
と定義するだけです。この<quote>ident.info</quote>は、infoディレクトリーファイルにインス
トールされるinfoファイルの名前にします。
</para>

<para>
パッケージ作者は、パッケージの構築とインストールのプロセスが、適切なバージョ
ンのmakeinfoおよびinstall-infoコマンドを使うようにするよう、注意を払ってく
ださい。最近のソフトウェアパッケージに附属するMakefilesやconfigureスクリプ
トのなかには、<quote>makeinfo</quote>および<quote>install-info</quote>コマンドへのパス名を含めているもの
があります。残念ながら、古いソフトウェアパッケージは、そのようにはしない傾
向があります。問題となるのはこのケースで、パッケージ作者が手間をかける必要
があります。
</para>

<para>
makefileの断片<filename>mk/texinfo.mk</filename>は、適切な<quote>makeinfo</quote>および<quote>install-info</quote>コマンドをシ
ステム上で利用可能な状態にして、パッケージのconfigureおよびbuildプロセスが
これらのコマンドのバイナリーを使うようにします。
</para>

<para>
あるバージョン以上の<quote>makeinfo</quote>および<quote>install-info</quote>コマンドが必要な場合は、パッ
ケージのMakefileで、 TEXINFO_REQDを必要な最低バージョンに設定します。
</para>

<para>
パッケージが適切な挙動をしない(つまり、configureやbuildの際に環境変数
MAKEINFOやINSTALL_INFOを参照しない) 場合は、以下のいずれか適切な方をおこな
うようにします:
</para>

<orderedlist>

<listitem>
<para>
    パッケージのファイルにパッチを当てて、configureやbuildの際に、makeinfo
    やinstall-infoがPATH中にあることを前提にするのではなく、環境変数
    MAKEINFOやINSTALL_INFOを使うようにする;
</para>
</listitem>

<listitem>
<para>
    パッケージのMakefileにTEXINFO_OVERRIDE=YESを書いておき、パッケージのソー
    スファイルの内容を置換するようにする(mk/texinfo.mkの内容を参考にしてく
    ださい)。
</para>
</listitem>

</orderedlist>
</sect1>


<sect1>
<title>distfileのダウンロードが単純にできないパッケージ</title>

<para>
動的なURLからダウンロードする必要がある場合は、DYNAMIC_MASTER_SITESを設定す
ることができます。すると、<command>make fetch</command>は、ダウンロードすべき各ファイルを引
数として<filename>files/getsite.sh</filename>を呼び出します。このスクリプトは、ファイルをダウン
ロードするディレクトリーのURLを出力することが前提となっています。
<pkg>graphics/ns-cult3d</pkg>が、この使い方の例となっています。
</para>

<para>
パスワード用に個人情報の登録が必要だったり、ソースに代金を払う必要があった
り、その他もろもろの理由により、ダウンロードが自動化できない場合は、
_FETCH_MESSAGEに、説明文を表示するマクロを設定することができます。
_FETCH_MESSAGEは、説明文そのものではなく、実行可能なシェルコマンドである必
要があります。(一般的には、${ECHO}を実行します)。本稿執筆時点で、この方法を
使っているパッケージは、<pkg>audio/realplayer</pkg>,
<pkg>cad/simian</pkg>, <pkg>devel/ipv6socket</pkg>,
<pkg>emulators/vmare-module</pkg>,
<pkg>fonts/acroread-jpnfont</pkg>,
<pkg>sysutils/storage-manager</pkg>,
<pkg>www/ap-aolserver</pkg>, <pkg>www/openacs</pkg>です。これらと一貫性のある使い方をしてください。
</para>
</sect1>

<sect1>
<title>設定ファイルの処理および配置</title>

<para>
大域変数PKG_SYSCONFBASE(とその他の変数)を、システム管理者が<filename>/etc/mk.conf</filename>で設
定すると、設定ファイルのインストール場所を定義することができます。このため、
各パッケージはこの機能に対応する必要があります。この変数で定義される設定ファ
イル用ディレクトリーには、本当に必要なファイルだけをインストールするようにし、
$PREFIX/shareに置いてもよいファイルはそちらにインストールするよう
注意してください。
</para>

<para>
まず、利用可能な変数をお見せします(<filename>bsd.pkg.mk</filename>に、さらに詳しい情報があります)。
PKG_SYSCONFDIRが、パッケージの設定ファイルが置かれる場所になります(これはフ
ルパスです。たとえば、<filename>/etc</filename>や<filename>/usr/pkg/etc</filename>になります)。この変数値は、さまざま
な方法によってカスタマイズすることができます:
</para>

<orderedlist>

<listitem>
<para>
    PKG_SYSCONFBASEは主たる設定ディレクトリーで、パッケージ用の設定ファイル
    すべてがこれ以下に置かれます。ユーザーは普通はPKG_SYSCONFBASEを/etcに設
    定するか、デフォルトの場所の${PREFIX}/etcのままにするでしょう。
</para>
</listitem>

<listitem>
<para>
    PKG_SYSCONFSUBDIRのサブディレクトリーで、個々のパッケージ用の設定ファイ
    ルはこの下に置かれます。デフォルトでは$SYSCONFBASEになります。
</para>
</listitem>

<listitem>
<para>
    PKG_SYSCONFVARは、個々のパッケージの設定を上書きする値を識別するための、
    特別な接尾辞です(次の項目参照)。デフォルトでは${PKGBASE}になりますが、
    PKG_SYSCONFDIRを同じに揃えておくとよい一連の関連パッケージに対しては、
    各パッケージのMakefileで、PKG_SYSCONFVARを同じ値に設定することができま
    す。
</para>
</listitem>

<listitem>
<para>
    PKG_SYSCONFDIR.${PKG_SYSCONFVAR}は、同じPKG_SYSCONFVARを持つパッケージ
    の${PKG_SYSCONFDIR}を上書きします。
</para>

<para>
    たとえば、KDE関連の各パッケージでは、PKG_SYSCONFVARを"kde"に設定すると
    よいでしょう。こうしておくと、管理者が<filename>/etc/mk.conf</filename>で
    ${PKG_SYSCONFDIR.kde}を設定して、KDEの設定ファイルのインストール場所を
    定義できるようになります。
</para>
</listitem>

</orderedlist>

<para>
プログラムの設定ディレクトリーは、configureの段階で定義します。GNU autoconf
を使うパッケージでは、通常は--sysconfdirのパラメーターを使って定義すること
ができますが、この方法は問題を起こすことがわかっています。このパス名をパッ
ケージ側で変更する場合は、ファイルをディレクトリーに直接インストールしない
ようにします。そうするかわりに、ファイルをshare/examples/${PKGNAME}以下にイ
ンストールして、PLISTにそちらを登録できるようにする必要があります。
</para>

<para>
必要な設定ファイルを適切な場所(<filename>share/examples</filename>ディレクトリー以下)に一旦置い
てから、この設定ファイルをPKG_SYSCONFDIRにコピーするために、CONF_FILES変数
を設定します。この変数の値は、ファイル名を二個組み合わせたものを並べたもの
です; 組合せの一つ目で、examplesディレクトリー内のファイル(PLISTに登録され
ているもの)を指定し、二つ目で、それをコピーする先のファイルを指定します。こ
れにより、バイナリーパッケージが、自動生成されるINSTALL/DEINSTALLスクリプト
を使って、ファイルを正しいディレクトリーに配置することが可能になります。ま
た、この自動生成されるスクリプトを使うために、パッケージのMakefileで
<filename>bsd.pkg.mk</filename>をインクルードする前に<filename>../../mk/bsd.pkg.install.mk</filename>をインクルード
しなければなりません。設定ファイルの自動コピーは、パッケージをインストール
する前に環境変数PKG_CONFIGを設定しておくことで、おこなうかどうかを切替える
ことができます。
</para>

<para>
mail/mutt/Makefileでの例を示します:
</para>

<programlisting>EGDIR=		${PREFIX}/share/doc/mutt/samples
CONF_FILES=	${EGDIR}/Muttrc ${PKG_SYSCONFDIR}/Muttrc</programlisting>

<para>
ご覧のとおり、このパッケージは設定ファイルをEGDIRにインストールし、この場所
がPLISTに登録されます。その後、CONF_FILES変数に、はじめにインストールされた
ファイルと、そのコピー先ファイルを列挙します。ファイルがこの方法でインストー
ルされる時には、パッケージの利用者にメッセージを自動的に表示します。
</para>
</sect1>


<sect1>
<title>ログインシェルを提供するパッケージ</title>

<para>
パッケージの目的がログインシェルの提供である場合は、PKG_SHELL変数を、このパッ
ケージでインストールされるシェルの実行ファイルのフルパス名とします。また、
自動生成されるINSTALL/DEINSTALLスクリプトを使うために、パッケージのMakefile
で、<filename>bsd.pkg.mk</filename>をインクルードする前に、
<filename>../../mk/bsd.pkg.install.mk</filename>をインクルードする必要も
あります。
</para>

<para>
以下はshells/zshでの例です。
</para>

<programlisting>PKG_SHELL=	${PREFIX}/bin/zsh
.include "../../mk/bsd.pkg.install.mk"</programlisting>

<para>
インストールされたシェルは、post-installの段階で、INSTALLスク
リプトによって自動的に<filename>/etc/shells</filename>ファイルに登録されます。また、deinstallの
段階で、DEINSTALLスクリプトによって<filename>/etc/shells</filename>から削除されます。
</para>
</sect1>


<sect1>
<title>ロケールのカタログを提供するパッケージ</title>

<para>
パッケージに、そのパッケージ用のロケールのカタログが附属する場合は、変数
USE_PKGLOCALEDIRを定義します。これにより、パッケージのMakefile雛型ファイル
が必要に応じて修正され、適切なロケールディレクトリー(OSにより異なることがあ
ります)を使うようになります。${PKGLOCALEDIR}に関して詳しくは、5.1節も参照し
てください。この機能はbuildlink2限定です。
</para>
</sect1>


<sect1>
<title>pkgsrcで'sudo'を使う</title>

<para>
パッケージのインストールをroot以外のユーザーで実行し、root権限が必要なとこ
ろではpkgsrcのsu(1)機能を使う場合、必要なパッケージをインストールするたびに
rootのパスワードを打つのは面倒かもしれません。これを避けるために、パスワー
ドを一定時間保持してくれるsudoパッケージを使うことができます。sudoを使うに
は、sudoを(バイナリーパッケージ、または<pkg>security/sudo</pkg>のいずれかから)
インストールしてから、<filename>/etc/mk.conf</filename>に以下の内容を書いておきます。
</para>

<programlisting>SU_CMD=/usr/pkg/bin/sudo /bin/sh -c</programlisting>
</sect1>


<sect1>
<title>perlスクリプトを含むパッケージ</title>

<para>
perlスクリプトがパッケージに含まれる場合は、
インタープリターのパスが適切に設定されるようにするために、
REPLACE_PERLを設定します。
REPLACE_PERLの設定値は、調整の対象となるスクリプトをWRKSRCからの相対位置で列挙したものにします。
</para>
</sect1>


<sect1>
<title>構築することができない、あるいはすべきでないパッケージ</title>

<para>
環境によってはパッケージを構築しないよう指示するような理由がいくつかありま
す。パッケージが、ほとんどのプラットフォームで構築および実行できる場合は、
NOT_FOR_PLATFORMとして例外を記述します。逆に、パッケージが一部のプラットフォー
ムでしか構築および実行できない場合は、ONLY_FOR_PLATFORMを設定します。パッケー
ジをとばすべき場合(たとえば、そのパッケージが提供する機能が、すでにシステム
で提供されている場合)は、PKG_SKIP_REASONにそのことを説明するメッセージを設
定します。必要な条件が満たされていないせいでパッケージの構築が失敗するであ
ろう場合は、PKG_FAIL_REASONにそのことを説明するメッセージを設定します。
</para>

<para>
IGNOREは、構築失敗の理由を特定するために十分な情報を提供しないので、使わな
いでください。
</para>
</sect1>

</chapter>

