<!-- $NetBSD: chapter.xml,v 1.5 2003/12/31 10:08:05 hrs Exp $ -->

<chapter id="plist">
  <title>PLIST issues</title>

  <para>This section addresses some special issues that one needs to pay attention
    to when dealing with the <filename>PLIST</filename> file (or files, see below!).</para>

  <sect1 id="plist.misc">
    <title>Miscellaneous</title>

    <variablelist>
      <varlistentry>
	<term>&os; RCS Id</term>

	<listitem>
	  <para>
	    Be sure to add a RCS ID line as the first thing in any
	    <filename>PLIST</filename> file you write:
	  </para>

	  <para>
	    <programlisting>@comment &#36;NetBSD&#36;</programlisting>
	  </para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term>${MACHINE_ARCH}, ${MACHINE_GNU_ARCH}</term>

	<listitem>
	  <para>Some packages like emacs and perl embed information about which
	    architecture they were built on into the pathnames where they install
	    their file. To handle this case, PLIST will be preprocessed before
	    actually used, and the symbol "${MACHINE_ARCH}" will be replaced by
	    what <command>uname -p</command> gives. The same is done if the string
	    ${MACHINE_GNU_ARCH} is embedded in PLIST somewhere - use this on
	    packages that have GNU autoconf created configure scripts.</para>

	  <note>
	    <title>Legacy note</title>

	    <para>There used to be a symbol "&lt;$ARCH&gt;" that was replaced by
	      the output of <command>uname -m</command>, but that's no longer supported
	      and has been removed.</para>
	  </note>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term>${OPSYS}, ${LOWER_OPSYS}, ${OS_VERSION}</term>

	<listitem>
	  <para>Some packages want to embed the OS name and version into some paths.
	    To do this, use these variables in the <filename>PLIST</filename>:
	  </para>

	  <itemizedlist>
	    <listitem>
	      <para>${OPSYS} - output of "uname -s"</para>
	    </listitem>

	    <listitem>
	      <para>${LOWER_OPSYS} - lowercase common name (eg. "solaris")</para>
	    </listitem>

	    <listitem>
	      <para>${OS_VERSION} - "uname -r"</para>
	    </listitem>
	  </itemizedlist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term>${PKGLOCALEDIR}</term>

	<listitem>
	  <para>Packages that install locale files should list them in the PLIST as
	    <quote>${PKGLOCALEDIR}/locale/de/LC_MESSAGES/...</quote> instead of
	    <quote>share/locale/de/LC_MESSAGES/...</quote>.  This properly handles
	    the fact that different OS's expect locale files to be either in
	    <filename>share</filename> or <filename>lib</filename> by default.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term>Manpage-compression</term>

	<listitem>
	  <para>Manpages should be installed in compressed form if
	    <varname>MANZ</varname> is set (in <filename>bsd.own.mk</filename>),
	    and uncompressed otherwise. To handle this in the
	    <filename>PLIST</filename> file, the suffix <quote>.gz</quote> is
	    appended/removed automatically for manpages according to
	    <varname>MANZ</varname> and <varname>MANCOMPRESSED</varname> being set
	    or not, see above for details. This modification of the
	    <filename>PLIST</filename> file is done on a copy of it, not
	    <filename>PLIST</filename> itself.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term>Platform specific and differing PLISTs</term>

	<listitem>
	  <para>Some packages decide to install a different set of files based on
	    the operating system being used. These differences can be
	    automatically handled by using the following files:</para>

	  <itemizedlist>
	    <listitem>
	      <para><filename>PLIST.common</filename></para>
	    </listitem>

	    <listitem>
	      <para><filename>PLIST.${OPSYS}</filename></para>
	    </listitem>

	    <listitem>
	      <para><filename>PLIST.common_end</filename></para>
	    </listitem>
	  </itemizedlist>

	  <para>If <filename>PLIST.${OPSYS}</filename> exists, these files are used
	    instead of <filename>PLIST</filename>. This allows packages which
	    behave in this way to be handled gracefully.  Manually overriding
	    <varname>PLIST_SRC</varname> for other more exotic uses is also
	    possible.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term>Semi-automatic <filename>PLIST</filename> generation</term>

	<listitem>
	  <para>You can use the <command>make print-PLIST</command> command to output
	    a PLIST that matches any new files since the package was extracted.
	    See below for more information on this target.</para>
	</listitem>
      </varlistentry>
    </variablelist>
  </sect1>

  <sect1>
    <title>PLIST_SRC</title>

    <para>To use one or more files as source for the <filename>PLIST</filename> used
      in generating the binary package, set the variable
      <varname>PLIST_SRC</varname> to the names of that file(s).
      The files are later concatenated using cat(1), and order of things is
      important.</para>
  </sect1>

  <sect1>
    <title>PLIST_SUBST</title>

    <para>Similar to <varname>MESSAGE_SUBST</varname> (see above), you can add
      variables and their expansions to this variable in the following way:</para>

    <programlisting>PLIST_SUBST+=    SOMEVAR="somevalue"</programlisting>

    <para>which replaces all occurrences of <quote>${SOMEVAR}</quote> in the
      <filename>PLIST</filename> with <quote>somevalue</quote>.
      For the values which are replaced by default, please look in
      <filename>bsd.pkg.mk</filename> (and search for
      <emphasis>PLIST_SUBST</emphasis>).</para>
  </sect1>

  <sect1>
    <title>Perl5 modules</title>

    <para>Makefile of packages providing perl5 modules should include the
      makefile fragment <filename>lang/perl5/module.mk</filename>.  It provides
      a do-configure
      target for the standard perl configuration for such modules as well
      as various hooks to tune this configuration.  See comments in this
      file for details.</para>

    <para>Perl5 modules will install into different places depending on the version
      of perl used during the build process.  To address this, the &os;
      packages system will append lines to the <filename>PLIST</filename>
      corresponding to the files
      listed in the installed .packlist file generated by most perl5 modules.
      This is invoked by defining <varname>PERL5_PACKLIST</varname> to a
      space-separated list of paths to packlist files:</para>

    <programlisting>PERL5_PACKLIST=	${PERL5_SITEARCH}/auto/Pg/.packlist</programlisting>

    <para>The variables <varname>PERL5_SITELIB</varname>,
      <varname>PERL5_SITEARCH</varname>, and <varname>PERL5_ARCHLIB</varname>
      represent the three locations in which perl5 modules may be installed, and
      may be used by perl5 packages that don't have a packlist.  These three
      variables are also substituted for in the <filename>PLIST</filename>.</para>
  </sect1>

  <sect1>
    <title>User Interaction</title>

    <para>Occasionally, packages require interaction from the user, and this can be
      in a number of ways:</para>

    <itemizedlist>
      <listitem>
	<para>help in fetching the distfiles</para>
      </listitem>

      <listitem>
	<para>help to configure the package before it is built</para>
      </listitem>

      <listitem>
	<para>help during the build process</para>
      </listitem>

      <listitem>
	<para>help during the installation of a package</para>
      </listitem>
    </itemizedlist>

    <para>The <varname>INTERACTIVE_STAGE</varname> definition is provided to notify
      the pkgsrc mechanism of an interactive stage which will be needed, and
      this should be set in the package's <filename>Makefile</filename>. e.g.</para>

    <programlisting>INTERACTIVE_STAGE= build</programlisting>

    <para>Multiple interactive stages can be specified:</para>

    <programlisting>INTERACTIVE_STAGE= configure install</programlisting>
  </sect1>
</chapter>
