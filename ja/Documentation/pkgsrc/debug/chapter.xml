<!-- $NetBSD: chapter.xml,v 1.4 2003/12/06 22:18:26 hrs Exp $ -->
<!-- Based on english version: -->
<!-- NetBSD: chapter.xml,v 1.4 2003/12/06 22:18:26 hrs Exp   -->

<chapter id="debug">
<title>デバッグ</title>
<para>
パッケージを作成する時に落ちいりやすい間違いをチェックし、パッケージを動作
させるための手順があります。これは基本的には前のセクションで説明したことと
同じですが、デバッグを助けるための方法を追加しています。
</para>

<itemizedlist>
<listitem>
<para>
<varname>PKG_DEVELOPER=1</varname> を <filename>/etc/mk.conf</filename> で設定しておいてください
</para>
</listitem>

<listitem>
<para>
<pkg>pkgtools/url2pkg</pkg> をインストールして、以下を実行します
</para>

<screen><prompt>#</prompt> <userinput>url2pkg http://www.example.com/path/to/distfile.tar.gz</userinput></screen>
</listitem>

<listitem>
<para>
<filename>Makefile</filename>に、必要な編集を加えます。
</para>
</listitem>

<listitem>
<para><filename>DESCR</filename>の内容を書きます
</para>
</listitem>

<listitem>
<para>
<command>make configure</command> を実行します。
</para>
</listitem>

<listitem>
<para>
configureの段階でわかった依存関係をすべて、
パッケージの<filename>Makefile</filename>に書き加えます。
</para>
</listitem>

<listitem>
<para>
以下を繰り返しおこなって、パッケージを作り上げます
</para>

<screen><prompt>#</prompt> <userinput>make</userinput>
<prompt>#</prompt> <userinput>pkgvi ${WRKSRC}/some/file/that/does/not/compile</userinput>
<prompt>#</prompt> <userinput>mkpatches</userinput>
<prompt>#</prompt> <userinput>patchdiff</userinput>
<prompt>#</prompt> <userinput>mv ${WRKDIR}/.newpatches/* patches</userinput>
<prompt>#</prompt> <userinput>make mps</userinput>
<prompt>#</prompt> <userinput>make clean</userinput></screen>

<para>
root以外のユーザーで作業をおこなうと、改変すべきでないファイルは改変され
ません。特に、構築の段階以外では。
</para>
</listitem>
<listitem>
<para>
必要なら<filename>Makefile</filename>を修正してください。<xref
linkend="components.Makefile"/>を参考にしてください。
</para>
</listitem>

<listitem>
<para>
<filename>PLIST</filename>を作成します:
</para>

<screen><prompt>#</prompt> <userinput>make install</userinput>
<prompt>#</prompt> <userinput>make print-PLIST &gt; PLIST</userinput>
<prompt>#</prompt> <userinput>make deinstall</userinput>
<prompt>#</prompt> <userinput>make install</userinput>
<prompt>#</prompt> <userinput>make deinstall</userinput></screen>

<para>
これは通常、rootで実行する必要があります。
残ったままのファイルがないか調べます:
</para>

<screen><prompt>#</prompt> <userinput>make print-PLIST</userinput></screen>

<para>
もし、なにかファイルが見つかれば、それらは<filename>PLIST</filename>に不足しているので、追加
してください。
</para>
</listitem>

<listitem>
<para>
これで<filename>PLIST</filename>の修正ができました。パッケージを再度インストールして、バイナ
リーパッケージを作ります:
</para>

<screen><prompt>#</prompt> <userinput>make reinstall &amp;&amp; make package</userinput></screen>
</listitem>

<listitem>
<para>
インストールしたパッケージを削除します:
</para>
 
<screen><prompt>#</prompt> <userinput>pkg_delete blub</userinput></screen>
</listitem>

<listitem>
<para>
上記のfindコマンドを繰り返します。今度は何も見つからないはずです:
</para>

<screen><prompt>#</prompt> <userinput>make print-PLIST</userinput></screen>

</listitem>
<listitem>
<para>
バイナリーパッケージを再インストールします:
</para>
 
<screen><prompt>#</prompt> <userinput>pkgadd .../blub.tgz</userinput></screen>
</listitem>

<listitem>
<para>
遊んでみてください。すべてが機能することを確認してください。
</para>
</listitem>

<listitem>
<para>
<pkg>pkgtools/pkglint</pkg>に含まれる<command>pkglint</command>を実行し、報告される問題を修正し
てください。
</para>

<screen><prompt>#</prompt> <userinput>pkglint</userinput></screen>
</listitem>

<listitem>
<para>
提出してください(もし cvs アクセス可能であればコミットしてください)。<xref
linkend="submit"/>が参考になります。
</para>
</listitem>
</itemizedlist>

</chapter>
