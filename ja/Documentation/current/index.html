<html>
<head>

<!-- DO NOT EDIT THIS FILE. EDIT 'index.list' AND RUN 'make' -->

<!-- Copyright (c) 1998, 1999
	The NetBSD Foundation, Inc.  ALL RIGHTS RESERVED. -->
    <title>Tracking NetBSD-current</title>
  </head>

<body bgcolor="#FFFFFF" text="#000000">


<table><tr><td>
<a href="/Misc/daemon-copy.html">
<img align="center" src="/images/BSD-daemon.jpg" border=0
width=146 height=129 alt="BSD daemon"></a>
</td><td align=center>
<h1>NetBSD ドキュメンテーション:</h1>
<h1>NetBSD-currentの追跡</h1>
</td></tr></table>
<p>


<h2><a name="top">よくある質問</a></h2>
<font><ul>
<li><a href="#why-track">なぜ NetBSD-current を追跡するのか?</a></li>
<li><a href="#why-difficult">なぜそんなに難しいのか</a></li>
<li><a href="#starting">-currentの追跡を始める</a></li>
<li><a href="#what-to-do">覚えておくべきこと</a></li>
<li><a href="#build-targets">Makefileのいろいろなターゲットは何ですか</a></li>
<li><a href="#using-anoncvs">anoncvs を用いた NetBSD-current の追跡</a></li>
<li><a href="#using-sup-into-cvs">SUP と CVS の組合せによる NetBSD-current の追跡</a></li>
</ul></font>
<h2>特定の問題</h2>
<font><ul>
<li><a href="#wscons">wsconsにアップデートした後コンソールが使えない</a></li>
</ul></font>


<hr>
<h2>よくある質問</h2><hr>
<p><dl><dt>
<font><h3><a name="why-track">なぜ NetBSD-current を追跡するのか?</a>
<font size="-1">(<a href="#top">top</a>)</font></h3></font>
</dt><dd>
NetBSDの開発者はそのときどきの開発中のソースをいくつかの理由から一般に
公開してきました。まず、NetBSD-currentを用意することで、より安定した、
利用しやすいシステムを作ることができます。
<p>
これにより、NetBSDの開発に熱中するのが容易になります。最新の開発中ソー
スを配布することで、システムが今どうなっているのかが多くの人に明らかに
なりますし、新機能が実装されればすぐにそれを試してみることができます。
また、利用者からの変更を統合するのも楽になります。もし利用者が最新の開
発中ソースに対して変更を加えたならば、その変更をマスターソースツリーに
取り込むための作業は事実上要らなくなります。
<p>
また、そうすることでソフトウェアが開発されてすぐに広い範囲のテストをす
ることができます。NetBSD-currentの利用者は最新のソースについての<a
href="../../Misc/send-pr.html">バグレポート</a>を出すことが奨励されます。
これはバグを見つけたり修正したりする助けになります。ソフトウェアが書か
れてからすぐに多くの人がそれをテストするために、より多くのバグを見つけ
出して退治することができます。

</dd></dl></p>
<p><dl><dt>
<font><h3><a name="why-difficult">なぜそんなに難しいのか</a>
<font size="-1">(<a href="#top">top</a>)</font></h3></font>
</dt><dd>
-currentはその流れを一瞬も止めることがありません。ソースツリーをコンパ
イルするために使われるツールは毎日のように改良されていますし、新機能も
追加されていきます。これは-currentのソースツリーをコンパイルするために
はそのためのツールをまずにコンパイルしてインストールしなくてはならない
ことを意味します。
<p>
これはそう頻繁ではありませんが、その結果、以前のリリースからアップグレー
ドしようとする利用者は、ソースツリー全体をコンパイルする前に、一見任意
のいくつかのツールをコンパイルし、インストールしておかなければならない
こともあり得ます。
<p>
この苦労を少なくするための詳細は<a href="#starting">-currentの追跡を始
める</a>を御覧ください。

</dd></dl></p>
<p><dl><dt>
<font><h3><a name="starting">-currentの追跡を始める</a>
<font size="-1">(<a href="#top">top</a>)</font></h3></font>
</dt><dd>
スタート地点としてはあなたが利用しているポートに最近のスナップショット
が出ているかどうか調べるのが一番いいでしょう。スナップショットは
-currentからコンパイルされて標準の<a href="http://www.flame.org/cgi-bin/uncgi/hman?page=release&amp;sect=7">release(7)</a>形式で配布されています。
<p>

これは<a href="ftp://ftp.netbsd.org/pub/NetBSD/arch/">
ftp://ftp.netbsd.org/pub/NetBSD/arch/</a><em>ARCH</em>/snapshotから
手に入り、通常のリリースと同様にインストールできます。これ以上の情報や
そのスナップショットについては個々の<a
href="../../Ports/">NetBSDポート</a>のウェブページを御覧ください。<p>

次のステージはftpで<a
href="ftp://ftp.netbsd.org/pub/NetBSD/NetBSD-current/tar_files/src/">
ftp://ftp.netbsd.org/pub/NetBSD/NetBSD-current/tar_files/src/</a>から、
もしくは<a
href="ftp://ftp.netbsd.org/pub/NetBSD/README.sup">SUP</a>を使って
-currentのソースをダウンロードすることです。最寄りの<a
href="../../Sites/net.html">NetBSDミラーサイト</a>も
調べた方がいいでしょう。
<p>
もし、NetBSD のソースに対するローカルな変更を追跡したいならば、
ローカルな CVS ツリーをセットアップし、<a href="#using-sup-into-cvs">sup 
で行なわれた変更を import</a> した方が良いでしょう。
<p>
また、-current を追跡する際に覚えておく必要のあるリストが次の節に
書かれていますので、必ずお読みください。

</dd></dl></p>
<p><dl><dt>
<font><h3><a name="what-to-do">覚えておくべきこと</a>
<font size="-1">(<a href="#top">top</a>)</font></h3></font>
</dt><dd>
<ul>
 <li>
  より新しいバージョンの-currentにアップグレードするときは、どれかの新しい
  ライブラリー(<a href="#star">*</a>)をインストールする前に<em>必ず</em>
  新しいカーネルをコンパイルし、それで起動していなければなりません。
  一般的にもっともよいのは他のどれよりも先に新しいカーネルを試し、何か問
  題にぶつかったら(<a
  href="../kernel/#problems_compiling_a_current_kernel">
  カーネル FAQ</a>にある項目を御覧ください)新しいカーネルをインストールするのに
  必要な最小限のツールをコンパイルしてインストールするやりかたです。
  <p>
  カーネルが動き出したらソースツリーの一番上で<tt>make build</tt>を実行する
  といいでしょう。

 <li>
  -current のカーネルをコンパイルする際には、常に
  COMPAT_&lt;最新のリリース&gt; オプション (例えば COMPAT_14)
  を含めるのを忘れないでください。current が最新の安定版リリース
  からかけはなれていくと互換性のコードが加えられますが、
  このオプションが設定されている時だけ有効になります。
  少なくとも、この互換性のためのコードは、新しいカーネルをブートして、
  <tt>make build</tt>が終了するまでは必要です。

 <li>
  NetBSD-currentを使っている人は<b><a
  href="../../MailingLists/#current-users">current-users</a></b>
  メーリングリストを購読することを強く薦めます。<b><a
  href="../../MailingLists/#source-changes">source-changes</a></b>
  を読むのも興味深いでしょう。
</ul>

<a name="star">*</a> :もし新たなシステムコールが追加されていないことが
確かでなければ、とりあえずこうしてください。それがより安全です。

</dd></dl></p>
<p><dl><dt>
<font><h3><a name="build-targets">Makefileのいろいろなターゲットは何ですか</a>
<font size="-1">(<a href="#top">top</a>)</font></h3></font>
</dt><dd>
もっとも明らかなターゲットは<a
href="ftp://ftp.netbsd.org/pub/NetBSD/NetBSD-current/src/Makefile">/usr/src/Makefile</a>
の'make build'です。これは更新された'mk'ファイル、インクルードファイル、
ライブラリーをインストールして、それからシステムを再構築します。もしソー
スツリーを更新していれば、新しいシステムコールが追加されていたときのた
めに備えて、他のどれよりも<em>先に</em>カーネルをコンパイルしてインス
トールするべきです。他の便利なターゲットは<a
href="ftp://ftp.netbsd.org/pub/NetBSD/NetBSD-current/src/share/mk/bsd.README">/usr/src/share/mk/bsd.README</a>
に記述されています。これは<tt>/usr/share/mk/</tt>にインストールされます。

</dd></dl></p>
<p><dl><dt>
<font><h3><a name="using-anoncvs">anoncvs を用いた NetBSD-current の追跡</a>
<font size="-1">(<a href="#top">top</a>)</font></h3></font>
</dt><dd>

<h4>セットアップ</h4>

<ol>
<p><li><a href="ftp://ftp.netbsd.org/pub/NetBSD/packages/pkgsrc/devel/cvs/README.html">cvs</a> をインストールします。
<p><li>環境変数 CVSROOT を お好きな anoncvs サーバを指すように設定します。
      anoncvs サーバーとしては anoncvs.netbsd.org か、それの <a href="../../Sites/net.html#anoncvs">ミラー</a>を
      使用することができます:
<ul>
    <li><a href="http://www.flame.org/cgi-bin/uncgi/hman?page=csh&amp;sect=1">csh(1)</a> または <a href="ftp://ftp.netbsd.org/pub/NetBSD/packages/pkgsrc/shells/tcsh/README.html">tcsh</a> ユーザーの方:<br>
    <tt><b>setenv CVSROOT :pserver:anoncvs@anoncvs.netbsd.org:/cvsroot</b>
    </tt><br>
    <li><a href="http://www.flame.org/cgi-bin/uncgi/hman?page=sh&amp;sect=1">sh(1)</a>, <a href="http://www.flame.org/cgi-bin/uncgi/hman?page=ksh&amp;sect=1">ksh(1)</a>, または <a href="ftp://ftp.netbsd.org/pub/NetBSD/packages/pkgsrc/shells/bash2/README.html">bash2</a> ユーザーの方:<br>
    <tt><b>CVSROOT=:pserver:anoncvs@anoncvs.netbsd.org:/cvsroot; export CVSROOT
    </b></tt>
    </ul>

<p><li>(root で) "<tt><b>mkdir /usr/src</b></tt>".<br>
    もし、ソースツリーを root 以外のユーザーの所有にしたいならば、
    次のコマンドを実行してください。
    "<tt><b>chown <em>user</em> /usr/src</b></tt>".

<p><li>
    <tt><b>cd /usr/src</b></tt><br>
    <tt><b>cvs login</b></tt>                      (パスワードとして "anoncvs" を使用してください)<br>
<p><li>カーネル(カーネルをコンパイルするには 
usr.sbin/config と usr.sbin/dbsym をコンパイルして使用する必要があります)のみをチェックアウトする<br>
    <tt><b>cvs checkout _syssrc-cmp</b></tt><br>
<p><li>ソースツリー全体をチェックアウトする
    <ul>
    <li>米国内の方:<br>
    <tt><b>cvs checkout -P src-crypto-all</b></tt><br>
    <li>米国以外の方 (anoncvs.netbsd.org から暗号に関するソースを
    取得しないでください):<br>
    <tt><b>cvs checkout -P src-nocrypto</b></tt><br>
    </ul>
</ol>
<p>
これで /usr/src に全ての NetBSD のソースが準備できました。

<h4>ソースの更新</h4>

<pre><b>
    cd /usr/src
    cvs update -d -P
</b></pre>

<h4>特定の日付のソースをチェックアウトするには次のようにして下さい</h4>
<pre><b>   cvs checkout -D 19991223-UTC src</b></pre>

<h4>特定の枝のソースをチェックアウトするには</h4>
<pre><b>   cvs checkout -rnetbsd-1-5 src</b></pre>

<h4>有用なヒント</h4>
<p>
cvs による更新が正しく実行できるようにするためには objdirs を
使用する必要があります。もし、cvs から
<pre>
   cvs [update aborted]: could not chdir to gnu/usr.bin/gdb/gdb: Not a directory
</pre>
のようなエラーメッセージを受けたならば、<b>"make cleandir"</b> を
実行して、もう一度試して下さい。cvs による更新の後、
<b>"make obj"</b>を実行するのを忘れないように。
</p>

<p>
使用している回線が非常に細い場合、コマンドラインでコマンドの<em>前に</em>
-z5 (あるいは 1 から 9の間の他の数字)をつけると良いかも知れません
(例 "<tt><b>cvs -z5 update -d -P</b></tt>"); こうすると、
全てのデータは圧縮されて転送されます。これは、cvs サーバーにとっては、余分な
負荷を与えることを心に止めておいてください。

<p>
特定のコマンドに対するスイッチはホームディレクトリの .cvsrc に
記述しておけば、自動的に使われます。.cvsrc ファイルの例を
掲げておきます。

<pre>
   cvs -q -z5
   update -d -P
   checkout -P
   diff -u
</pre>
</p>

<h4>ソースからの NetBSD の構築</h4>

<I>(すでに、最新の NetBSD バイナリースナップショットと /usr/src に
ソースがインストールされていると仮定します。):</I><p>

はじめてユーザーランドを構築する場合:<p>

<PRE>
   mkdir /usr/obj
   cd /usr/src
   make obj
   make build
</PRE>

CVS update の後、ユーザーランドのバイナリーを更新する場合:<p>

<PRE>
   cd /usr/src
   make obj
   make UPDATE=1 build
</PRE>

これらによって、新しいバイナリーが実行されたシステムにインストールされます。
新しいバイナリーが全て有効になるようにリブートしてください。
バイナリーをどこか他の場所にインストールする(例えば、動作する環境をだいなしに
するのが嫌な場合)には
DESTDIR を設定すれば OK です。次のように実行してください:<p>

<PRE>
   make DESTDIR=/usr/NetBSD-new-build UPDATE=1 build
</PRE>

</dd></dl></p>
<p><dl><dt>
<font><h3><a name="using-sup-into-cvs">SUP と CVS の組合せによる NetBSD-current の追跡</a>
<font size="-1">(<a href="#top">top</a>)</font></h3></font>
</dt><dd>
    <h4>概要</h4>

    <p>currentは次の方法により追跡できます。基準となるソースのコピーを、
       標準的にはほぼ週に一回SUPを使い最新の状態に維持します。そして、
       この基準となるソースツリーを、ローカルのCVSリポジトリーにインポー
       トします。そして、リポジトリーのコピーをチェックアウトし、それ
       からcurrentを作成します。

    <p>このアプローチには3つの主要な理由があります。
    <ol>
      <li>いつどのようにcurrentが更新されたか追跡するため。</li>
      <li>ローカルの変更をほとんど自動的に更新されたcurrentソースにマー
        ジできるようにするため。</li>
      <li>構築するときの問題に備えて、いつもまったく変更していない
	NetBSD-currentのソースツリーがあることを保証するため。</li>
    </ol>
    
    <p>このアプローチの短所は、3つの独立のソースツリーのために、実際の
      currentの構築に必要な空きを含めないで、およそ150MBのディスクスペー 
      スが必要なところです。

    <h4>必要なもの</h4>
    <ul>
      <li>CVS 1.9かそれ以降(pkgsrcか、ソースから構築のどちらでも)。マー
      ジが上手なのでCVS 1.10かそれ以降が望ましい。</li>
      <li>SUP</li>
      <li>Perl 5(任意)附属スクリプトのため</li>
    </ul>
    <h4>詳説</h4>
    <p>currentの追跡と構築は、6つの段階からなります:
    <ol>
      <li>マスターソースツリーにSUPでソースを更新します。</li>
      <li>SUPしたファイルをCVSにインポートし、ソースの作業用コピーを更
        新します。</li>
      <li>作業用ソースとSUPしたソースとをマージします。</li>
      <li>currentを構築してインストールします。</li>
      <li>構築に成功したソースにタグをつけます。</li> 
    </ol>
    <h3>ソースのSUP</h3>
    <p>ソースは、どのNetBSD SUPサーバーからもSUP可能です。またSUPの出
      力は後の参照のためにファイルに保存するべきです。

    <h3>ソースのインポートとマージ</h3>
    <p>ソースのインポートは次のように行ないます:
    <pre>
cvs -d /misc/cvsrep import -I ! -I CVS netbsd netbsd current-<i>date</i>
    </pre>
    <p><i>date</i>は追跡のためにSUP時の日付と置き換えます。
      <code>-I ! -I CVS</code> オプションは、
      ソースツリー中の 'CVS' ディレクトリを除く全てのファイルが
      無視されないことを保証します。これはNetBSDのソースファイルに、通
      常CVSにより無視される拡張子のものがいくつかあるからです。もしロー
      カルのパッチと衝突がある場合、importコマンドはそれらを出力し、衝
      突をマージするためのコマンドを次のように出力します:
    <pre>
cvs checkout -jnetbsd:yesterday -jnetbsd netbsd
    </pre>
    <p>このマージコマンドは、インポートされたNetBSDソースを正確にマー
      ジするためのものですが、SUPにより削除されたファイルは、ローカル
      に反映されません。これを行なうためのマージコマンドはこうなるでしょ
      う:
    <pre>
cvs update -j<i>previous import tag</i> -j current-<i>date</i>
    </pre>
    <p><i>previous import tag</i>は前回のCVSインポートで使用したタグ名
      と置き換えます。<i>date</i>は、今マージしたばかりのcurrentのイン
      ポートに使用したタグ名を利用できるようにするために、現在の日付と
      置き換えます。
    <p>importコマンドにより表示される衝突は、衝突の可能性のあるもので
      す。これらは、通常updateコマンドによりマージされますが、いくつか
      の場合、実際に衝突を引き起こします。この場合、衝突行を手動でマー
      ジすることが必要です。実際に衝突がある場合、cvs update時に、
      <code>C</code>に続きファイルネームが表示されます。
    <p>手作業による衝突のマージは単純作業ではありませんが、多くの場合、
      ファイルへ行なったローカルの変更を削除し、元のNetBSDソースコード
      に似せてやることで解決します。
    <p>CVSは衝突を次のように表します:
<pre>
&lt;&lt;&lt;&lt;&lt;&lt;
  <i>ローカルファイルのコード</i>
======
  <i>インポートしたファイルのコード</i>
&gt;&gt;&gt;&gt;&gt;&gt; <i>新たにインポートされるリビジョンのローカルリビジョン番号</i>
</pre>

    <p>もしimportコマンドが何の衝突を表示しない場合でも、チェックアウ
      トしたツリーのコピーは衝突した場合と同じ方法で更新できます。
    <p>updateとcheckoutコマンドはすべて、チェックアウトしたソースのディ
      レクトリーで行なってください。私のシステムでは、これは
      <code>/usr/src/netbsd</code>です。
    <p>もし、これが最初のインポートならば、チェックアウトしたソースは
      ないでしょう。'<code>/usr/src/netbsd</code>'にソースツリーを作り
      たいと仮定すると、次のコマンドでソースをチェックアウトします。マー
      ジ作業は必要ありません。
    <pre>
cd /usr/src
cvs -d/misc/cvsrep checkout netbsd
    </pre>
    <h3>currentの構築</h3>
    <ol>
    <li>configure の後、<a href="../kernel/#how_to_build_a_kernel">
	カーネルの構築</a>を行ない、できた新しいカーネルでリブートします。
    <li>-current のソースツリーのベースディレクトリに移動し、
	<tt>"<b>make build</b>"</tt>
       とタイプします。
    <li>必要ならば、/etc の中のファイルに対する変更を merge します。
    </ol>

    <h3>構築に成功したものへのタグ付け</h3>
    <p> もし、構築がうまくいって動作するバイナリーセットを作成できたの
      ならば、動作するソースにタグ付けすることで使いやすくできます。こ
      れは、万一なにかの原因で構築できないcurrentツリーになっても、ひ
      とつのCVSコマンドで、構築できるツリーに巻き戻すことを可能にしま
      す。タグ付けは次のコマンドで行えます:
    <pre>
cvs tag successful-build-<i>build date</i>
    </pre>
    <h4>註</h4>
    <ul>
      <li>もし、ファイル中の<b>$Net</b><b>BSD$</b>マーカーを認識する
        NetBSDカスタムバージョンのCVSを使用しない場
        合、ファイルのNetBSDリビジョン番号を、構築時に問題が起きた場合
        に参照の目的に使用することができます。</li>
      <li>上記のSUP/インポート/マージの作業は、まったく簡単に自動化で
        きます。以下のPerlスクリプトがこの作業を自動的に行ないます。
<pre>
#!/usr/local/bin/perl
#
# NetBSD-currentをSUPしてそれをCVSに取り込み、手元の変更とマージする
# スクリプト
#
# 原註:
# このスクリプトはエラー処理をしていないので、対話的でない用途には向い
# ていない。
#
# このスクリプトはcvs-1.10.1とcvs-1.9.18でのみテストされている。
#
$SRCROOT="/usr/src/netbsd";
$IMPORTROOT="/misc/import";
$CVSROOT="/misc/cvsrep";
# supを実行してその標準出力をperlに取り込む
system "/usr/sbin/sup -zsv" ; # ここは最新のシステム以外では変更する
                              # 必要がある

# 新しいファイルをCVSに取り込む

chdir $IMPORTROOT or die "Could not cd to $IMPORTROOT\n";

($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) = localtime;
$date = localtime;
$shortdate = sprintf "%02d%02d%04d",$mday,$mon+1,1900+$year;
system "/usr/local/bin/cvs -d$CVSROOT import -I ! -m\"SUP Import $date\" netbsd netbsd current-$shortdate ";

# 作業ディレクトリーを手元のNetBSDソースツリーにする
chdir $SRCROOT or die "Could not change to $SRCROOT diectory\n";

# 取り込みを始める
$lastimport = `cat /usr/src/netbsd/.tag`; # `はバッククォート
$lastimport =~ s/\n//; # 文字列の終りの改行をすべて取り去る
system "/usr/local/bin/cvs update -j $lastimport  -j
current-$shortdate ";
# tag保存ファイルに最新のファイルを書き込む
open TAG,"&gt;$SRCROOT/.tag" or die "Could not open new tag file";
 print TAG "current-$shortdate";
close TAG;
    </pre> 
    <p>このスクリプトは作者がもっともよく使っているスクリプティングツー
          ルであるという理由からPerlでかかれていますが、同じことをする
          shellスクリプトを書くのはとても簡単でしょう。</li>
      <li>CVSを用いてcurrentを追跡するテクニックについてはNetBSDの
        current-usersメーリングリストで何度か議論されています。他のテ 
        クニックについてはNetBSDメーリングリストを検索してみてください。</li>
    </ul>
    <p>
    何かコメントや提案があれば、この部分を担当しているMike Pumford <a
    href="mailto:mpumford@black-star.demon.co.uk">
    mpumford@black-star.demon.co.uk</a>(訳註:英語で)、または<a
    href="mailto:www@jp.netbsd.org">www@jp.netbsd.org</a>までメイルし
    てください。

</dd></dl></p>
<hr>
<h2>特定の問題</h2><hr>
<p><dl><dt>
<font><h3><a name="wscons">wsconsにアップデートした後コンソールが使えない</a>
<font size="-1">(<a href="#top">top</a>)</font></h3></font>
</dt><dd>
以下の手順が必要です。<a
href="ftp://ftp.jp.netbsd.org/pub/NetBSD/NetBSD-current/src/etc/">src/etc</a>
にある適切なetc.<i>port</i>ディレクトリーから最新のMAKEDEVファイルを
<tt>/dev</tt>にコピーしてシングルユーザーで起動してください。そのあと
以下をタイプします:

<ul>
<li>fsck -p
<li>mount -vt nonfs
<li>cd /dev
<li>./MAKEDEV wscons
</ul>

</dd></dl></p>
<hr>


<table width="100%"><tr>
<td>
  <table><tr>
  <td>
    <a href="../../">
    <img src="/images/NetBSD-banner.gif" border=0 alt=""></a>
  </td><td>
    <font>
    <a href="../../">
    <img src="/images/empty.gif" border=0
     alt="NetBSD ">ホームページ</a>
    </font>
  </td>
  </tr></table>
</td><td>
  <table><tr>
  <td>
    <a href="../../Documentation/">
    <img src="/images/NetBSD-banner.gif" border=0 alt=""></a>
  </td><td>
    <font>
    <a href="../../Documentation/">
    <img src="/images/empty.gif" border=0
     alt="NetBSD ">Documentation top level</a>
    </font>
  </td>
  </tr></table>
</td>
</table>


<hr>
<address>
  <small>
  <a href="../../Misc/feedback.html">(Contact us)</a>
  $NetBSD: index.list,v 1.16 2000/07/14 17:17:55 dent Exp $<br>
  <a href="/Misc/disclaimer.html">Copyright &copy;
    1998, 1999, 2000
    The NetBSD Foundation, Inc.  ALL RIGHTS RESERVED.</a>
  </small>
</address>

</body>
</html>
