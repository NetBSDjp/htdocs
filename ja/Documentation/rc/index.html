<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<html lang="ja">
<head>

<!-- DO NOT EDIT THIS FILE. EDIT 'index.list' AND RUN 'make' -->

<!-- Copyright (c) 1994-2003
        The NetBSD Foundation, Inc.  ALL RIGHTS RESERVED. -->
<meta http-equiv="Content-Type" content="text/html; charset=ISO-2022-JP">
<link rev="made" href="mailto:www@jp.NetBSD.org">
<link rel="shortcut icon" href="../../../favicon.ico" origlink="/favicon.ico" type="image/x-icon">
<title>NetBSD Initialization and Services Control</title>
</head>
<body bgcolor="#ffffff" text="#000000">

<h1>NetBSD の初期化とサービス制御</h1>

NetBSD バージョン 1.5 では、システムのスタートアップの仕組みが若干変更され、
サービスの制御に rc スクリプト群を使うようになりました。この文書は、
NetBSD 1.5 以降における rc コンフィギュレーションの概要です。


<ul>
<li>
<a href="#a2">rc.d コンフィギュレーション</a></li>
<li>
<a href="#a3">rc.d スクリプト群</a></li>
<li>
<a href="#a4"><code>rcorder</code> と rc スクリプトの役割</a></li>
<li>
<a href="#a5">さらなる読みもの</a></li>
<li>
<a href="#a6">まとめ</a></li>
</ul>


<h2>リンク</h2>
<ul>
<li> NetBSD において rc.d の実装をおこなった主要開発者のひとりが Luke Mewburn
     です。 Luke は USENIX 2001 で、 rc.d システムの実装に関して
     すばらしい発表をおこないました。この資料は、 Luke のウェブサイトに
     <a href="http://www.mewburn.net/luke/papers/rc.d.pdf">PDF</a>
     フォーマットで置かれています。
<li> Will Andrews による、 NetBSD rc.d システムに関する
     <a href="http://www.daemonnews.org/200108/rcdsystem.html">DaemonNews の記事</a>。

<!-- XXX: BSDToday is no more.  Martti, do you have the article somewhere?
<li> Martti Kuparinen による、設定ファイルと起動ファイルの更新に関する
  <a href="http://www.bsdtoday.com/2001/December/Features605.html">BSD Today
  の記事</a>。
-->

</ul>

<hr>

<SECTION>

<p><h3>
<a name="a2">rc.d コンフィギュレーション</a>
<font size="-1">(<a href="#top">top</a>)</font>
</h3><dl><dt><dd>

<p>
システムの rc ファイル群は、下記のとおり <code>/etc</code> 以下に配置されています:

<pre>
/etc/rc
/etc/rc.conf
/etc/rc.d/*
/etc/rc.lkm
/etc/rc.local
/etc/rc.shutdown
/etc/rc.subr
/etc/defaults/*
/etc/rc.conf.d/*
</pre>

<p>
最初に、制御およびサポート用のスクリプトを見てみましょう:

<ul>
<li><code>/etc/rc</code> - このスクリプトが <code>/etc/rc.d</code> にあるスクリプト群を実行します
<li><code>/etc/rc.subr</code> - このスクリプトには rc スクリプト群が共通して使う関数が含まれます
<li><code>/etc/shutdown</code> - このスクリプトは <code>/etc/rc.d</code> にあるスクリプト群を逆順に呼び出します
</ul>

<p>
rc.d ディレクトリー以外にあるスクリプト:

<ul>
<li><code>/etc/rc.lkm</code> - このスクリプトはローダブルカーネルモジュールのロードやアンロードを行います
<li><code>/etc/rc.local</code> - このスクリプトはブートの過程の (ほぼ) 最後に呼び出されます。ローカルデーモンはここに加えてもよいでしょう。
</ul>

<p>以下は、 apache web サーバーの記述を <code>/etc/rc.local</code> に追加したシステムの例です:

<pre>
if [ -f /usr/pkg/etc/rc.d/apache ]; then
       /usr/pkg/etc/rc.d/apache start
fi
</pre>

<p>
<code>/etc/defaults</code> ディレクトリーには NetBSD のデフォルト設定が置かれており、これは書き換えてはいけません。 rc の話題の中では、意味を持つファイルは <code>/etc/rc.conf</code> だけで、これは NetBSD に附属するデフォルトの rc コンフィギュレーションです。デフォルト設定の変更は、 <code>rc.conf</code> を上書きすることでできます。たとえば、セキュアシェルデーモンを有効にしたければ次のようにします:

<pre>
# cd /etc; grep ssh defaults/rc.conf
sshd=NO                 sshd_flags=""
# echo "sshd=YES" >> rc.conf
</pre>

<p>またはお好きなエディターでこのファイルを編集してください。すべてのデフォルトの設定は、同様にして変更できます。

<p>このほか、次のようにしても、 <code>rc.conf</code> の編集が簡単にできます:

<pre>
# cd /etc/defaults
# cat rc.conf >> ../rc.conf
</pre>

<p>こうしてから、不要な部分を削ります。

<p>
<code>/etc/rc.conf.d</code> ディレクトリーは <code>/etc/rc.conf<code> とほとんど同じ方法で使うことができます:

<pre>
# cd /etc; grep ^wscons defaults/rc.conf
wscons=NO		wscons_flags=""		# setup wscons from wscons.conf
# echo "wscons=YES" >> rc.conf.d/wscons
</pre>

<p>
ただし、 <code>/etc/rc.conf.d</code> にあるスクリプトは <code>/etc/rc.d</code> にあるスクリプトより<b>後に</b> <code>rc.subr</code> によって読み込まれるため、興味深い可能性が考えられます。以下のような方法でベースシステムのコマンドを pkgsrc でインストールしたコマンドで置き換えることを考えてみましょう:

<pre>
echo 'command="/usr/pkg/bin/${name}"' > /etc/rc.conf.d/ntpd
ln /etc/rc.conf.d/ntpd /etc/rc.conf.d/ntpdate
</pre>

<p>
<code>/etc/rc.conf.d</code> スクリプトに対して <code>${name}</code> が使えることに注目してください。さらに、 <code>/etc/rc.d</code> スクリプトをすべて <code>/etc/rc.conf.d</code> にあるスクリプト群で上書きすることも可能ですが、そうするのであれば、ふつうに <code>/etc/rc.d</code> 自体を書き換えたほうがきれいでよりわかりやすいでしょう。

</dd></dl>
<p><h3>
<a name="a3">rc.d スクリプト群</a>
<font size="-1">(<a href="#top">top</a>)</font>
</h3><dl><dt><dd>

<p>
サービスを制御するスクリプト群は <code>/etc/rc.d</code> 以下にあります。以下は NetBSD 1.5 に含まれるすべての rc スクリプトです:

<table width="100%" border="0" cellpadding="5" cellspacing="5">
<tr>
<td align="left" valign="top" width="25%">
DAEMON<br>
LOGIN<br>
NETWORK<br>
SERVERS<br>
accounting<br>
amd<br>
apmd<br>
bootconf.sh<br>
bootparams<br>
ccd<br>
cleartmp<br>
cron<br>
dhclient<br>
dhcpd<br>
dhcrelay<br>
dmesg<br>
fsck<br>
gated<br>
inetd<br>
</td>
<td align="left" valign="top" width="25%">
ipfilter<br>
ipmon<br>
ipnat<br>
ipsec<br>
kdc<br>
ldconfig<br>
lkm1<br>
lkm2<br>
lkm3<br>
local<br>
lpd<br>
mopd<br>
motd<br>
mountall<br>
mountcritlocal<br>
mountcritremote<br>
mountd<br>
mrouted<br>
named<br>    
</td>
<td align="left" valign="top" width="25%">
network<br>
nfsd<br>
nfslocking<br>
ntpd<br>
ntpdate<br>
postfix<br>
ppp<br>
pwcheck<br>
quota<br>
raidframe<br>
rarpd<br>
rbootd<br>
root<br>
route6d<br>
routed<br>
rpcbind<br>
rtadvd<br>
rtsold<br>
rwho<br> 
</td>
<td align="left" valign="top" width="25%">
savecore<br>
screenblank<br>
securelevel<br>
sendmail<br>
sshd<br>
swap1<br>
swap2<br>
sysctl<br>
sysdb<br>
syslogd<br>
timed<br>
ttys<br>
virecover<br>
wscons<br>
xdm<br>
xfs<br>
ypbind<br>
yppasswdd<br>
ypserv<br>     
</td>
</tr>
</table>


<p>
いったんサービスを有効にしたり、あるいは有効にしないように <code>/etc/rc.conf</code> で指定してあっても、コマンドラインから rc スクリプトを呼び出せば変更できます。たとえば管理者がセキュアシェルを動かす必要がある場合には、次のようにします:

<pre>
ash# /etc/rc.d/sshd start
Starting sshd.
</pre>

<p>
rc スクリプト群は、下記の各引数を受け付けます:

<ul>
<li>start
<li>stop
<li>kill 
<li>restart
</ul>

<p>named サーバーの named データベースに新しいレコードを追加したときの一例:

<pre>
ash# /etc/rc.d/named restart
Stopping named.
Starting named.
</pre>

<p>
若干複雑な例としては、複数の設定、たとえば、防火壁の ipfilter のルール・ ipnat の設定・セキュアシェルサーバーの暗号化方式の変更をおこなうような場合があります:

<pre>
ash# cd /etc/rc.d
ash# ./ipfilter restart; ./ipnat restart; ./sshd restart
</pre>

</dd></dl>
<p><h3>
<a name="a4"><code>rcorder</code> と rc スクリプトの役割</a>
<font size="-1">(<a href="#top">top</a>)</font>
</h3><dl><dt><dd>

<p>
システム管理者マニュアルによれば、 <code>rcorder</code> は「依存しあうファイル群の依存順を出力するよう設計されています」。基本的には、実行順序をなんとかして決定します。一部の Unix システムでは、スクリプトのファイル名で、また、ファイルをランレベルディレクトリー毎に置くことによって、実行順序を決定していますが、そういった方法は美しくありません。 NetBSD では、この文書の冒頭で説明した制御スクリプトと、各 rc スクリプトの内容をもとに決定します。

<p>
rc スクリプト群には、以下に示すような行が含まれています:

<ul>
<li>REQUIRE
<li>PROVIDE
<li>BEFORE
<li>KEYWORD
</ul>

<p>
これらは、その rc スクリプトの依存関係を示しており、これによって <code>rcorder</code> は状況に応じて容易にスクリプトの順序を「前にしたり」「後にしたり」できます。以下に、 <code>nfsd</code> の rc スクリプトの例を示します:

<pre>
. . .
# PROVIDE: nfsd
# REQUIRE: mountd

. /etc/rc.subr         
. . .
</pre>

<p>
これから、このスクリプトは <code>nfsd</code> サービスを提供するものだが <code>mountd</code> がすでに動いて<EM>いなければならない</EM>、ということがわかります。

</dd></dl>
<p><h3>
<a name="a5">さらなる読みもの</a>
<font size="-1">(<a href="#top">top</a>)</font>
</h3><dl><dt><dd>

<p>
以下は、 NetBSD の rc.d システムに関するさらなる資料です:

<ul>
<li>Luke Mewburn による USENIX 発表資料の
  <a href="http://www.mewburn.net/luke/papers/rc.d.pdf">PDF</a> フォーマット。
<li> Will Andrews による <a href="http://www.daemonnews.org/">Daemonnews</a> の記事
<a href="http://www.daemonnews.org/200108/rcdsystem.html">The NetBSD rc.d System</a>

<!-- XXX: BSDToday is no more.  Martti, do you have the article somewhere?
<li> Martti Kuparinen による
  <a href="http://www.bsdtoday.com/">BSD Today</a> の記事
  <a href="http://www.bsdtoday.com/2001/December/Features605.html">Updating
  the NetBSD configuration and startup files after an operating system
  upgrade</a>。
-->
</ul>


</dd></dl>
<p><h3>
<a name="a6">まとめ</a>
<font size="-1">(<a href="#top">top</a>)</font>
</h3><dl><dt><dd>

<p>
新しい rc の構造は、 <code>-HUP</code> と <code>/var/run</code> 以下のファイルを使って kill するといった古い方法を、単純な kill や再起動で置き換えるものです。これは、美しくかつ強力な方法による単純化です。

</dd></dl>
<hr>

<table width="100%"><tr><td>
<table border="0" summary="Footer navigation"><tr>
<td class="foothome"><span class="foothome"><a href="../../"><img src="../../../images/NetBSD-flag.png" origlink="../../images/NetBSD-flag.png" alt="" border="0" width="90" height="90"></a></span></td>
<td class="foothome">
<span class="foothome"><a href="../../">ホームページ</a></span><br>
</td>
</tr></table>
</td><td>
<table border="0" summary="Footer navigation"><tr>
<td class="foothome"><span class="foothome"><a href="../../Documentation/"><img src="../../../images/NetBSD-flag.png" origlink="../../images/NetBSD-flag.png" alt="" border="0" width="90" height="90"></a></span></td>
<td class="foothome">
<span class="foothome"><a href="../../Documentation/">Documentation top level</a></span><br>
</td>
</tr></table>

</td></tr></table>

<hr>
<address>
  <small>
  (連絡先 - <a href="http://www.NetBSD.org/cgi-bin/feedback.cgi">英語</a>,
       <a href="mailto:www@jp.NetBSD.org">日本語:
       www@jp.NetBSD.org</a>)<br>
  $NetBSD: index.list,v 1.20 2003/12/07 19:15:50 fredb Exp $<br>
  <!-- based on english translation: -->
  <!-- NetBSD: index.list,v 1.20 2003/12/07 19:15:50 fredb Exp   -->
  <a href="../../Misc/disclaimer.html">Copyright &copy; 1994-2003
  The NetBSD Foundation, Inc.  ALL RIGHTS RESERVED.</a>
  </small>
</address>

</body>
</html>

