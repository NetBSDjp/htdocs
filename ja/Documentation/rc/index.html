<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<html>
<head>

<!-- DO NOT EDIT THIS FILE. EDIT 'index.list' AND RUN 'make' -->

<!-- Copyright (c) 1994-2001
        The NetBSD Foundation, Inc.  ALL RIGHTS RESERVED. -->
<link rev="made" href="mailto:www@JP.NetBSD.ORG">
<title>NetBSD Initialization and Services Control</title>
</head>
<body bgcolor="#ffffff" text="#000000">

<h1>NetBSD の初期化とサービス制御</h1>

NetBSD バージョン 1.5 では、システムのスタートアップが若干変更され、
サービスの制御に rc スクリプト群を使うようになりました。この文書は、
NetBSD 1.5 の rc コンフィギュレーションの概要です。


<ul>
<li>
<a href="#a2">rc.d コンフィギュレーション</a></li>
<li>
<a href="#a3">rc.d スクリプト群</a></li>
<li>
<a href="#a4"><code>rcorder</code> と rc スクリプトの役割</a></li>
<li>
<a href="#a5">さらなる読みもの</a></li>
<li>
<a href="#a6">まとめ</a></li>
</ul>


<h2>リンク</h2>
<ul>
<li> NetBSD 1.5 への rc.d の実装をおこなった主要開発者のひとりが Luke Mewburn
     です。 Luke は USENIX 2001 で、 rc.d システムの実装に関して
     よい発表をおこないました。この資料は、 Luke のウェブサイトに
     <a href="http://www.mewburn.net/luke/papers/rc.d.pdf">PDF</a>
     フォーマットで置かれています。
<li> Will Andrews による、 NetBSD rc.d システムに関する
     <a href="http://www.daemonnews.org/200108/rcdsystem.html">DaemonNews の記事</a>。
</ul>

<hr>

<SECTION>

<p><h3>
<a name="a2">rc.d コンフィギュレーション</a>
<font size="-1">(<a href="#top">top</a>)</font>
</h3><dl><dt><dd>

<p>
システムの rc ファイル群は、下記のとおり /etc 以下に配置されています:

<pre>
/etc/rc
/etc/rc.conf
/etc/rc.d/*
/etc/rc.lkm
/etc/rc.local
/etc/rc.shutdown
/etc/rc.subr
/etc/defaults/*
/etc/rc.conf.d/*
</pre>

<p>
最初に、制御およびサポート用のスクリプトが読まれます:

<ul>
<li><code>/etc/rc</code> - このスクリプトが /etc/rc.d にあるスクリプト群を実行します
<li><code>/etc/rc.subr</code> - このスクリプトは rc スクリプト群が共通して使う関数が含まれます
<li><code>/etc/shutdown</code> - このスクリプトは /etc/rc.d にあるスクリプト群を逆順に呼び出します
</ul>

<p>
rc.d ディレクトリーに含まれるもの以外で加わったスクリプト:

<ul>
<li><code>/etc/rc.lkm</code> - このスクリプトはローダブルカーネルモジュールのロードやアンロードを行います
<li><code>/etc/rc.local</code> - このスクリプトはブートの過程の (ほぼ) 最後に呼び出されます。ローカルデーモンはここに加えてもよいでしょう。
</ul>

<p>以下は、 apache web サーバーの記述を <code>/etc/rc.local</code> に追加したシステムの例です:

<pre>
if [ -f /usr/pkg/etc/rc.d/apache ]; then
       /usr/pkg/etc/rc.d/apache start
fi
</pre>

<p>
/etc/defaults ディレクトリーには NetBSD 1.5 のデフォルト設定が置かれており、これは書き換えてはいけません。 rc のコンテキストで意味を持つファイルは rc.conf だけで、これは NetBSD 1.5 に附属するデフォルトの rc コンフィギュレーションです。デフォルト設定の変更は、 /etc/rc.conf を上書きすることでできます。たとえば、セキュアシェルデーモンを有効にしたければ次のようにします:

<pre>
# cd /etc; grep ssh defaults/rc.conf
sshd=NO                 sshd_flags=""
# echo "sshd=YES" >> rc.conf
</pre>

<p>またはお好きなエディターでこのファイルを編集してください。すべてのデフォルトの設定は、同様にして変更できます。

<p>このほか、次のようにしても、 <code>rc.conf</code> の編集が簡単にできます:

<pre>
# cd /etc/defaults
# cat rc.conf >> ../rc.conf
</pre>

<p>こうしてから、不要な部分を削ります。

<p>
最後になりましたが、 <code>/etc/rc.conf.d/</code> ディレクトリーは、
サードパーティー製スクリプト用に使えます。

</dd></dl>
<p><h3>
<a name="a3">rc.d スクリプト群</a>
<font size="-1">(<a href="#top">top</a>)</font>
</h3><dl><dt><dd>

<p>
サービスを制御するスクリプト群は /etc/rc.d 以下にあります。以下は NetBSD 1.5 に含まれるすべての rc スクリプトです:

<table width="100%" border="0" cellpadding="5" cellspacing="5">
<tr>
<td align="left" valign="top" width="25%">
DAEMON<br>
LOGIN<br>
NETWORK<br>
SERVERS<br>
accounting<br>
amd<br>
apmd<br>
bootconf.sh<br>
bootparams<br>
ccd<br>
cleartmp<br>
cron<br>
dhclient<br>
dhcpd<br>
dhcrelay<br>
dmesg<br>
fsck<br>
gated<br>
inetd<br>
</td>
<td align="left" valign="top" width="25%">
ipfilter<br>
ipmon<br>
ipnat<br>
ipsec<br>
kdc<br>
ldconfig<br>
lkm1<br>
lkm2<br>
lkm3<br>
local<br>
lpd<br>
mopd<br>
motd<br>
mountall<br>
mountcritlocal<br>
mountcritremote<br>
mountd<br>
mrouted<br>
named<br>    
</td>
<td align="left" valign="top" width="25%">
network<br>
nfsd<br>
nfslocking<br>
ntpd<br>
ntpdate<br>
postfix<br>
ppp<br>
pwcheck<br>
quota<br>
raidframe<br>
rarpd<br>
rbootd<br>
root<br>
route6d<br>
routed<br>
rpcbind<br>
rtadvd<br>
rtsold<br>
rwho<br> 
</td>
<td align="left" valign="top" width="25%">
savecore<br>
screenblank<br>
securelevel<br>
sendmail<br>
sshd<br>
swap1<br>
swap2<br>
sysctl<br>
sysdb<br>
syslogd<br>
timed<br>
ttys<br>
virecover<br>
wscons<br>
xdm<br>
xfs<br>
ypbind<br>
yppasswdd<br>
ypserv<br>     
</td>
</tr>
</table>


<p>
いったんサービスを有効にしたり、あるいは有効にしないように /etc/rc.conf で指定してあっても、コマンドラインから rc スクリプトを呼び出せば変更できます。たとえば管理者がセキュアシェルを動かす必要がある場合には、次のようにします:

<pre>
ash# /etc/rc.d/sshd start
Starting sshd.
</pre>

<p>
rc スクリプト群は、下記の各引数を受け付けます:

<ul>
<li>start
<li>stop
<li>kill 
<li>restart
</ul>

<p>named サーバーの named データベースに新しいレコードを追加したときの一例:

<pre>
ash# /etc/rc.d/named restart
Stopping named.
Starting named.
</pre>

<p>
若干複雑な例としては、複数の設定、たとえば、防火壁の ipfilter のルール・ ipnat の設定・セキュアシェルサーバーの暗号化方式の変更をおこなうような場合があります:

<pre>
ash# cd /etc/rc.d
ash# ./ipfilter restart; ./ipnat restart; ./sshd restart
</pre>

</dd></dl>
<p><h3>
<a name="a4"><code>rcorder</code> と rc スクリプトの役割</a>
<font size="-1">(<a href="#top">top</a>)</font>
</h3><dl><dt><dd>

<p>
システム管理マニュアルによれば、 <code>rcorder</code> は「依存しあうファイル群の依存関係を出力するよう設計されています」。基本的には、実行順序をなんとかして決定します。一部の Unix システムでは、スクリプトのファイル名で、また、ファイルをランレベルディレクトリー毎に置くことによって、実行順序を決定していますが、そういった方法は美しくありません。 NetBSD では、この文書の冒頭で説明した制御スクリプトと、各 rc スクリプトの内容をもとに決定します。

<p>
rc スクリプト群には、以下に示すような行が含まれています:

<ul>
<li>REQUIRE
<li>PROVIDE
<li>BEFORE
<li>KEYWORD
</ul>

<p>
これらは、その rc スクリプトの依存関係を示しており、これによって <code>rcorder</code> は状況に応じて容易にスクリプトの順序を「上げたり」「下げたり」できます。以下に、 <code>nfsd</code> の rc スクリプトの例を示します:

<pre>
. . .
# PROVIDE: nfsd
# REQUIRE: mountd

. /etc/rc.subr         
. . .
</pre>

<p>
これから、このスクリプトは <code>nfsd</code> サービスを提供するものだが <code>mountd</code> がすでに動いて<EM>いなければならない</EM>、ということがわかります。

</dd></dl>
<p><h3>
<a name="a5">さらなる読みもの</a>
<font size="-1">(<a href="#top">top</a>)</font>
</h3><dl><dt><dd>

<p>
以下は、 NetBSD 1.5 の rc.d システムに関するさらなる資料です:

<ul>
<li>Luke Mewburn による USENIX 発表資料の
  <a href="http://www.mewburn.net/luke/papers/rc.d.pdf">PDF</a> フォーマット。
<li> Will Andrews による <a href="http://www.daemonnews.org/">Daemonnews</a> の記事
<a href="http://www.daemonnews.org/200108/rcdsystem.html">The NetBSD rc.d System</a>
</ul>


</dd></dl>
<p><h3>
<a name="a6">まとめ</a>
<font size="-1">(<a href="#top">top</a>)</font>
</h3><dl><dt><dd>

<p>
新しい rc の構造は、 <code>-HUP</code> と <code>/var/run</code> 以下のファイルを使って kill するといった古い方法を、単純な kill や再起動で置き換えるものです。これは、美しくかつ強力な方法による単純化です。

</dd></dl>
<hr>

<table width="100%"><tr><td>
  <table><tr><td>
    <a href="../../"><img
	src="/images/NetBSD-flag.gif" border="0"
	width="91" height="42" alt=""></a>
  </td><td>
    <a href="../../"><img
	src="/images/empty.gif" border="0"
	width="1" height="1" alt="NetBSD ">ホームページ</a>
  </td></tr></table>
</td><td>
  <table><tr><td>
    <a href="../../Documentation/"><img
	src="/images/NetBSD-flag.gif" border="0"
	width="91" height="42" alt=""></a>
  </td><td>
    <a href="../../Documentation/"><img
	src="/images/empty.gif" border="0"
	width="1" height="1" alt="NetBSD ">Documentation top level</a>
  </td></tr></table>
</td></tr></table>

<hr>
<address>
  <small>
  (連絡先 - <a href="../../Misc/feedback.html">英語</a>,
       <a href="mailto:www@JP.NetBSD.ORG">日本語:
       www@JP.NetBSD.ORG</a>)<br>
  $NetBSD: index.list,v 1.7 2001/12/04 23:56:26 lukem Exp $<br>
  <a href="../../Misc/disclaimer.html">Copyright &copy; 1994-2001
  The NetBSD Foundation, Inc.  ALL RIGHTS RESERVED.</a>
  </small>
</address>

</body>
</html>

