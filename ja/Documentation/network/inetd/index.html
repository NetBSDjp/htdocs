<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<html>
<head>

<!-- DO NOT EDIT THIS FILE. EDIT 'index.list' AND RUN 'make' -->

<!-- Copyright (c) 1994-2003
        The NetBSD Foundation, Inc.  ALL RIGHTS RESERVED. -->
<link rev="made" href="mailto:www@JP.NetBSD.ORG">
<link rel="shortcut icon" href="../../../../favicon.ico" origlink="/favicon.ico" type="image/x-icon">
<title>The Internet Super Server and NetBSD</title>
</head>
<body bgcolor="#ffffff" text="#000000">

<table><tr><td>
    <a href="../../../Misc/disclaimer.html#bsd-daemon"><img
     align="middle" src="../../../../images/BSD-daemon.jpg" origlink="../../../images/BSD-daemon.jpg" border="0"
     width=146 height=129 alt="BSD daemon"></a>
  </td><td align=center>
    <h1>NetBSD ドキュメンテーション:</h1>
    <h1>インターネットスーパーサーバーと NetBSD</h1>
</td></tr></table>
<p>

多くのシステム管理者、ユーザー、技術者、その他の人達は、
インターネットスーパーサーバーすなわち <b>inetd</b> のお世話になっています。
さらにほとんどの人達は、 <code>/etc</code> ディレクトリー以下にある重要な
ファイル群と inetd との関連についても、非常によく関わっています。

しかし意外にも、 inetd の基礎や、 inetd とファイルやシステムの関連について
総括的に説明した文書で、インターネットで容易に入手可能なものは、
ほとんどありません。

<ul>
<li>
<a href="#a2">あらまし</a></li>
<li>
<a href="#a3">inetd とは何か?</a></li>
<li>
<a href="#a4">protocols</a></li>
<li>
<a href="#a5">services</a></li>
<li>
<a href="#a6">RPC</a></li>
<li>
<a href="#a7">inetd</a></li>
<li>
<a href="#a8">サービスを追加する</a></li>
<li>
<a href="#a9">inetd 使用の是非</a></li>
<li>
<a href="#a10">他の情報源</a></li>
</ul>


<hr>

<SECTION>

<p><h3>
<a name="a2">あらまし</a>
<font size="-1">(<a href="#top">top</a>)</font>
</h3><dl><dt><dd>

<p>この文書では、 inetd の簡単な定義づけと、
個々のファイルがどのように inetd の動作と関連しているのか
(これらのファイルが他のソフトウェアと関係ないわけではありません) 、
inetd へのサービスの追加方法、さらに、
特殊なサービスに inetd を使う場合や
inetd を使わずにサービスを実行したほうがよい場合についての考察を扱います。</p>

</dd></dl>
<p><h3>
<a name="a3">inetd とは何か?</a>
<font size="-1">(<a href="#top">top</a>)</font>
</h3><dl><dt><dd>

<p>インターネットスーパーサーバーは、自前のソケットを listen し、
リクエストを受けたときにはどのサーバーへ接続すべきか判断して、
そのサーバープログラム本体を起動させます。</p>

<p>下図は、 inetd のごく簡単な図解です:</p>

<pre>

 pop3  ------  |
               | 
 ftpd -------  | INETD | ---- Internet / DMZ / Switch / Whatever . . . 
               |
 cvspserver -  |

</pre>

<p>上の図で inetd の概略はおわかりでしょう。 inetd サーバーはリクエストを
受け取った上で、適切なサーバープログラムを起動します。 inetd が行なうことは、
ソフトウェア的な多重化です。</p>

<p>ここで重要な注意ですが、他の UNIX-like システムの多くでは、 inetd の
セキュリティーのための拡張として <em>tcpwrappers</em> と呼ばれるパッケージが
ありますが、 NetBSD では tcpwrappers 相当のセキュリティー機能は
&quot;libwrap&quot; を使って内蔵されています。</p>

</dd></dl>
<p><h3>
<a name="a4">protocols</a>
<font size="-1">(<a href="#top">top</a>)</font>
</h3><dl><dt><dd>

<p>最初のファイルは<em>プロトコル名データベース</em>で、これは
<code>/etc/protocols</code> にあります。このファイルには、 DARPA
インターネットプロトコル関係の情報が書かれています。プロトコル名データベース
の書式は以下のとおりです:</p>


<blockquote>
プロトコル名<br>
番号<br>
別名
</blockquote>

<p>例として <code>/etc/protocols</code> db の 2 番目の項目を
見てみましょう:

<pre>
icmp    1       ICMP            # internet control message protocol
</pre>

<p>左から順に見てみますと、 <em>プロトコル名</em> は <b>icmp</b>、
<em>番号</em>は <b>1</b> で、列挙されている<em>別名</em>は <b>ICMP</b>
だけです。</p>

</dd></dl>
<p><h3>
<a name="a5">services</a>
<font size="-1">(<a href="#top">top</a>)</font>
</h3><dl><dt><dd>

<p>次に挙げるファイルは<em>サービス名データベース</em>で、これは
<code>/etc/services</code> にあります。基本的にこの db には、
サービスに関する情報と、プロトコルからポート番号への対応が書かれています。
<code>/etc/services</code>
ファイルの書式は以下のとおりです:</p>

<blockquote>
サービス名<br>
ポート番号<br>
プロトコル名<br>
別名
</blockquote>

<p>例として <code>ssh</code> の項目を見てみましょう:</p>

<pre>
ssh             22/tcp          # Secure Shell
ssh             22/udp
</pre>

<p>ご覧のとおり、左から順に、<em>サービス名</em>は <b>ssh</b>、
<em>ポート番号</em>は <b>22</b>、<em>プロトコル</em>は <b>tcp</b> と
<b>udp</b> の両方です。サービスが利用可能なプロトコル毎に別の項目に
分けることに注意してください (たとえ同じポートを使う場合でもです) 。</p>

</dd></dl>
<p><h3>
<a name="a6">RPC</a>
<font size="-1">(<a href="#top">top</a>)</font>
</h3><dl><dt><dd>

<p>rpc <em>プログラム番号データベース</em> は <code>/etc/rpc</code> にあって、
名前から rpc プログラム番号への対応が書かれています。ファイルの書式は
以下のとおりです:</p>

<blockquote>
サーバー名<br>
プログラム番号<br>
別名
</blockquote>

<p>たとえば、以下は <code>nfs</code> の項目です:</p>

<pre>
nfs             100003  nfsprog
</pre>

<p>左から順に、<em>サーバー名</em>は <b>nfs</b>、
<em>プログラム番号</em>は <b>100003</b> で、<em>別名</em>は
<b>nfsprog</b> です。</p>


</dd></dl>
<p><h3>
<a name="a7">inetd</a>
<font size="-1">(<a href="#top">top</a>)</font>
</h3><dl><dt><dd>

<p>最後に、関連するファイルの中でも重要なものは、
インターネットスーパーサーバーファイル <code>/etc/inetd.conf</code> です。
基本的に、 <code>inetd.conf</code> ファイルは、システム管理者が
inetd 経由で多重化したいサービスについて、その有効化と対応づけを
行ないます。</p>

<p>上記各項目で挙げたファイルは、システムにとって非常に重要な情報を提供しており、
ファイルの構成は比較的単純です。しかし <code>inetd.conf</code>
ファイルは、若干複雑なものなので (といっても、それほどでもありませんが) 、
少し突っ込んだ説明をすべきでしょう。</p>

<p><code>inetd.conf</code> ファイルの基本的なフィールド配置は以下のとおりです:</p>

<blockquote>
サービス名 (service name)<br>
ソケットタイプ (socket type)<br>
プロトコル (protocol)<br>
wait/nowait<br>
user:group<br>
サーバープログラム (server program)<br>
サーバープログラムの引数 (arguments for the server program)
</blockquote>

<dl>

<dt>サービス名</dt>
<dd>
標準的なサービスでは、サービス名はすべて <code>/etc/services</code> ファイル
と一致させるべきです (少なくとも、強く推奨されます) が、
独自に走らせる非標準のサービスについてはそのようなことはなく、
非標準なサービス名を決める上で標準的なサービスとはかち合わないように
することが重要です。
</dd>
<dt>ソケットタイプ</dt>
<dd>
通信のソケットタイプで、以下の種類があります:
&quot;stream&quot;
&quot;dgram&quot;
&quot;raw&quot;
&quot;rdm&quot;
および
&quot;seqpacket&quot; 。
もっとも一般的なソケットタイプは <em>stream</em> と <em>dgram</em> です。
</dd>
<dt>プロトコル</dt>
<dd>
プロトコルは、ほとんどの場合 tcp、 tcp6、 udp、 udp6 になります。
特筆すべきは、 tcp と udp は過去の各バージョンについて後方互換を持つ一方、
tcp4 は特に ipv4 でのみ通信することを意味することです。
将来は移行のため ipv46 を使うという方法もあるかもしれません。
このほか、 rpc は rpc と tcp を、すなわち <code>rpc/tcp</code> を使います。
</dd>
<dt>wait/nowait</dt>
<dd>
このフィールドは、 inetd がサーバープログラムの終了を待つべきか、
あるいは接続をずっと保持させるかを指定するものです。
サーバープロセスへの接続の多くは、サーバーへのデータ転送後に
応答を必要としますが、それ以外の場合では、コネクション上で連続的に送信を
続けるものもあります。後者の場合は &quot;nowait&quot; 、前者の場合は
&quot;wait&quot; と書きます。ほとんどの場合、この項目はソケットタイプと対応しており、
たとえば streaming コネクションのこの項目は (<em>ほとんど</em>の場合)
&quot;nowait&quot; になります。
</dd>
<dt>user[:group]</dt>
<dd>
このフィールドは非常に明白で、 inetd は、このユーザーとグループ (オプション)
の権限でサーバープロセスを実行します。
</dd>
<dt>サーバープログラム</dt>
<dd>このフィールドは、起動されるプログラムへのパスです。
<dt>プログラム引数</dt>
<dd>
このフィールドは、起動されるプログラムと、このサーバープログラムの起動に際して
システム管理者が引数が必要な場合はそれも含めることができます。
</dd>
</dl>

<p>概要は以上であり、これ以外にも一部のフィールドでは、
システム管理者が調整できることがあります。以下は <code>inetd.conf</code>
ファイルから抜粋した例です:</p>

<pre>
ftp            stream  tcp     nowait  root    /usr/libexec/ftpd       ftpd -ll
</pre>


<p>左から順に、<em>サービス名</em>は <b>ftp</b>、
<em>ソケットタイプ</em> は <b>stream</b>、
<em>プロトコル</em>は <b>tcp</b>、
<em>wait/nowait</em> は <b>nowait</b> に設定されており、
<em>ユーザー</em>は <b>root</b>、
<em>パス</em> は <b>/usr/libexec/ftpd</b> で、
<em>プログラム名と引数</em> は <b>ftpd -ll</b> です。
最後のフィールドに注目してください。この <em>プログラム名</em>は、
<em>サービス名</em>とは別のものです。</p>


</dd></dl>
<p><h3>
<a name="a8">サービスを追加する</a>
<font size="-1">(<a href="#top">top</a>)</font>
</h3><dl><dt><dd>

<p>システム管理者にとって、 inetd にないサービスを追加する必要が生じたり、
あるサービスのトラフィックがそう多くないので inetd 経由にしたくなったり
するのは、よくあることでしょう。
これはふつうはかなり単純なことですので、例として、 pop3 のバージョンの
NetBSD システムへの追加を見てみます。</p>

<p>この例では、 cucipop パッケージを持ってきてすでにインストールしてあります。
このサーバーは、非常に簡単に使うことができ、妙な点はパス位置の違いだけです。
ご存知のとおり pop3 ですから、 stream 志向のコネクションで nowait を伴います。
root 権限を使って良好に動作し、
異なるところはプログラムの場所と、プログラム自身の名前です。</p>

<p>そこで、追加する項目の前半は、以下のようになります:</p>

<pre>
pop3   stream  tcp     nowait  root
</pre>

<p>インストールすると、 pkgsrc は cucipop を /usr/pkg/sbin/cucipop に置きます。
よって、次のフィールドを追加すると以下のようになります:</p>

<pre>
pop3   stream  tcp     nowait  root /usr/pkg/sbin/cucipop
</pre>

<p>最後に、 Berkeley mailbox 形式を使いたいので、サーバープログラムには
-Y オプションを付ける必要があります。これで、項目が以下のように
埋まりました:</p>

<pre>
pop3   stream  tcp     nowait  root /usr/pkg/sbin/cucipop cucipop -Y
</pre>

<p>ここで、 inetd に新しい項目を使わせるために、 rc スクリプトを使って
単に再起動させます:</p>

<pre>
/etc/rc.d/inetd restart
</pre>

<p>以上です。ほとんどの場合、お使いになっているソフトウェアには
これらの項目を明示したドキュメンテーションがあり (ないものもありますが) 、
サーバープログラムを追加しようとしたり、似たサーバープログラムを
見付けるために役立つことがあります。この典型例としては、telnet を内蔵した
MUD サーバーがあります。telnet のエントリーをほとんどそのまま使い、
必要な部分を書き換えればよいのです。</p>

</dd></dl>
<p><h3>
<a name="a9">inetd 使用の是非</a>
<font size="-1">(<a href="#top">top</a>)</font>
</h3><dl><dt><dd>

<p>サービスを inetd に加えたり inetd から外したりするのは、普通は
サーバー負荷をもとに決めることになります。例としては、<b>ほとんどの</b>
システムでは、 telnet デーモンはメールサーバー並の新規コネクションは
要求しません。ほとんどの場合、管理者は、サービスが万一移動されたときのことを
考慮する必要があります。</p>

<p>私が経験した好例は、 smtp や pop などのメールサーバーです。
私はメールサーバーをセットアップし、 pop3 は inetd に含め、 exim
はスタンドアローンで走らせました。少数のユーザー (筆者自身と診断用のアカウント)
しかいないので、これで問題なく動くだろうという思い違いをしていたのです。
このサーバーは、酷使されている別のサーバーがダウンした場合に、
バックアップ MX として働き中継するようにもセットアップされていました。
いくつかテストをしたときに、遠隔からの pop 接続に大きなタイムラグが
生じることに気付きました。これは、私の定期的なメール取得と、診断用ユーザー
があちこちに診断メールを頻繁に送ることが原因でした。結局、私は
pop3 サービスを inetd からは外さねばなりませんでした。</p>

<p>サービスを inetd から外した理由はとても興味深いことです。
個々のサービスが激しく使われると、当然ながらシステムの負荷は上がります。
そのサービスが inetd メタデーモン経由で動く場合には、
inetd 経由の別のサービスにまで影響が及びます。この多重化機構 (inetd) が
特定の一つのサービスへの要求を受け過ぎていると、 inetd 経由の他のサービス
のパフォーマンスへの悪影響を起こすことになります。こういった状況での解決策は、
こういう<em>うざいサービス</em>を inetd から外して、
<b>service</b> と <b>inetd</b> 両方の負荷を下げることです。</p>

</dd></dl>
<p><h3>
<a name="a10">他の情報源</a>
<font size="-1">(<a href="#top">top</a>)</font>
</h3><dl><dt><dd>

<p>以下に掲げるのは、このドキュメントで扱ったトピックに関する
さらなる読み物と情報です:</p>

<h3>NetBSD/i386 マニュアルページ</h3>

<ul>
<li><a href="http://man.netbsd.org/man/inetd+8+NetBSD-current">inetd(8)</a>
<li><a href="http://man.netbsd.org/man/protocols+5+NetBSD-current">protocols(5)</a>
<li><a href="http://man.netbsd.org/man/rpc+5+NetBSD-current">rpc(5)</a>
<li><a href="http://man.netbsd.org/man/services+5+NetBSD-current">services(5)</a>
</ul>

<h3>いろいろなリンク</h3>

<ul>
<li><a href="http://www.iana.org/numbers.htm">IANA: Protocol Numbers and Assignment Services</a>
<li><a href="http://www.isi.edu/in-notes/rfc1700.txt">RFC1700: Assigned Numbers</a>
</ul>

</dd></dl>
<hr>

<table width="100%"><tr><td>
  <table><tr><td>
    <a href="../../../"><img
	src="../../../../images/NetBSD-flag.gif" origlink="../../../images/NetBSD-flag.gif" border="0"
	width="91" height="42" alt=""></a>
  </td><td>
    <a href="../../../"><img
	src="../../../../images/empty.gif" origlink="../../../images/empty.gif" border="0"
	width="1" height="1" alt="NetBSD ">ホームページ</a>
  </td></tr></table>
</td><td>
  <table><tr><td>
    <a href="../../../Documentation/"><img
	src="../../../../images/NetBSD-flag.gif" origlink="../../../images/NetBSD-flag.gif" border="0"
	width="91" height="42" alt=""></a>
  </td><td>
    <a href="../../../Documentation/"><img
	src="../../../../images/empty.gif" origlink="../../../images/empty.gif" border="0"
	width="1" height="1" alt="NetBSD ">Documentation top level</a>
  </td></tr></table>
</td></tr></table>

<hr>
<address>
  <small>
  (連絡先 - <a href="http://www.netbsd.org/cgi-bin/feedback.cgi">英語</a>,
       <a href="mailto:www@JP.NetBSD.ORG">日本語:
       www@JP.NetBSD.ORG</a>)<br>
  $NetBSD: index.html,v 1.5 2003/03/08 19:44:25 grant Exp $<br>
  <a href="../../../Misc/disclaimer.html">Copyright &copy; 1994-2003
  The NetBSD Foundation, Inc.  ALL RIGHTS RESERVED.</a>
  </small>
</address>

</body>
</html>

