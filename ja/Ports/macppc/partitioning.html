<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">

<html>
<head>
<!-- Copyright (c) 1998-2003
	The NetBSD Foundation, Inc.  ALL RIGHTS RESERVED. -->
<link rev="made" href="mailto:www@NetBSD.org">
<title>NetBSD/macppc Partitioning HOW-TO</title>
</head>
<body bgcolor="#FFFFFF" text="#000000">

<h1>NetBSD/macppc Partitioning HOW-TO</h1>

<hr>
<p>

This document is broken into four main parts:
<ol>
<li><a href="#intro">Introduction (Understanding Partitions)</a>
<li>Partitioning a disk
<ul>
<li><a href="#drive-setup">Partitioning using Drive Setup</a> (MacOS 9)
<li><a href="#disk-utility">Partitioning using Disk Utility</a> (MacOS X)
<li><a href="#pdisk">Partitioning using <tt>pdisk</tt> and 
 <tt>newfs</tt></a> (MacOS 9, MacOS X, Darwin, NetBSD,  Linux)
</ul>
<li><a href="#msdos">Creating a shared MS-DOS filesystem</a>
<li><a href="#nomenclature">Partition nomenclature</a>
</ol>

<p><i>Note: the Linux <tt>pdisk</tt> command does not properly set the
flags for NetBSD/macppc.  If you have already partitioned your disk using
the Linux <tt>pdisk</tt>, you'll need to use the NetBSD <tt><a
href="#pdisk">pdisk</a></tt> to delete and re-create the NetBSD root and
swap partitions.</i>

<h2><a name="intro">Introduction (Understanding Partitions)</a></h2>
This document describes in depth how to partition a disk for use with 
NetBSD/macppc and MacOS.  Whether you can boot your machine from a 
particular disk into a particular operating system depends on your 
machine's version of <a href="faq.html#ofw-version">Open Firmware</a>.  
The overall goal is to create an Apple Partition Map that Open Firmware 
can understand (and thus boot from) and that the NetBSD kernel can 
understand and use to find its root partition.

<p>There are four tools to partition a disk: Apple's Drive Setup (MacOS
9), Apple's Disk Utility (MacOS X), NetBSD's 
<a href="http://man.NetBSD.org/man/pdisk+8.macppc+NetBSD-current">
<tt>pdisk(8)</tt></a> (all OSes), and NetBSD's 
<a href="http://man.NetBSD.org/man/disklabel+8.macppc+NetBSD-current">
<tt>disklabel(8)</tt></a> (NetBSD/macppc only).  The first two tools 
(Drive Setup and Disk Utility) are distributed by Apple with MacOS and 
are located on bootable MacOS installation CDs.  You can use them to 
partition a disk, create the filesystems, and to install MacOS 
bootloaders (called disk drivers in MacOS terminology).

<p>The <tt>pdisk</tt> program is a command-line program which can be 
compiled and run on most unix-like systems (particularly the ones that 
run on PowerPC-based Macintosh and clone machines).  This program can 
only partition a disk -- it can't install bootloaders or create 
filesystems.

<p>NetBSD's <tt>disklabel</tt> creates a NetBSD-style 
<a href="http://man.NetBSD.org/man/disklabel+5.macppc+NetBSD-current">
<tt>disklabel(5)</tt></a>.  Unlike the other three tools, it can only
create a fake Apple Partition Map (thus you can't use it to create a disk
that's bootable by MacOS).  That's OK, since some versions of Open
Firmware require you to use <tt>disklabel</tt> to install the bootloader. 
Additionally, <tt>disklabel</tt> is the partition tool that is used in the
NetBSD installer. 

<p>In the tables below, "yes" means the disk is bootable, "mount only" 
means that the OS can mount partitions on the disk, but cannot boot from 
it, and "no" means the OS can't mount partitions or boot from the disk.

<p><table border=1 cellpadding=5>
<tr><td align=center colspan="5"><b>Open Firmware 1.0.5 or 2.0.x</b></td></tr>

<tr><td><b>OS</b></td>
<td><b>Drive Setup</b></td>
<td><b>Disk Utility</b></td>
<td><tt><b>pdisk</b></tt></td>
<td><tt><b>disklabel</b></tt></td></tr>

<tr><td><b>NetBSD</b></td>
<td>mount only</td>
<td>mount only</td>
<td>mount only</td>
<td>yes</td></tr>

<tr><td><b>MacOS 9</b></td>
<td>yes</td>
<td>yes</td>
<td>no</td>
<td>no</td></tr>

<tr><td><b>MacOS X and Darwin</b></td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>no</td></tr>

<tr><td><b>Linux</b></td>
<td>yes</td>
<td>yes?</td>
<td>yes</td>
<td>no</td></tr>
</table>

<p><table border=1 cellpadding=5>
<tr><td align=center colspan="5"><b>Open Firmware 2.4 or 3</b></td></tr>

<tr><td><b>OS</b></td>
<td><b>Drive Setup</b></td>
<td><b>Disk Utility</b></td>
<td><tt><b>pdisk</b></tt></td>
<td><tt><b>disklabel</b></tt></td></tr>

<tr><td><b>NetBSD</b></td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>no</td></tr>

<tr><td><b>MacOS 9</b></td>
<td>yes</td>
<td>yes</td>
<td>no</td>
<td>no</td></tr>

<tr><td><b>MacOS X and Darwin</b></td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>no</td></tr>

<tr><td><b>Linux</b></td>
<td>yes</td>
<td>yes?</td>
<td>yes</td>
<td>no</td></tr>
</table>

<p>The Apple Partition Map stores partition information as a numbered list
(usually in order of location on disk).  Partition "zero" is where the
primary bootloader is stored for Open Firmware 1.0.5 or 2.0.x models.  The
partition map is partition number 1.  A disk with MacOS 9 will usually have
partitions 2 thru 8 reserved for its drivers.  The user defined 
partitions (HFS, HFS+, UFS, NetBSD, etc.) will start at partition 9 
(MacOS 9 disk), or 2 (no MacOS 9).  

<p>Keep in mind that Open Firmware uses Apple Partition Map numbers when 
determining the command to boot your machine into NetBSD/macppc.  You can 
use <a href="#pdisk"><tt>pdisk</tt></a> to print out the Apple Partition 
Map, regardless of how it was created.

<p>To make matters a little more confusing, NetBSD/macppc uses its own 
partition naming scheme, the letters 'a' thru 'h'.  The root partition 
(regardless of its Apple Partition Map location) is partition 'a'.  The 
swap partition is partition 'b'.  Partition 'c' represents the whole 
disk.  The '/usr' partition (if it exists) is partition 'g'.  The rest of 
the partitions fill in the remainder of the letters.

<p>See the section on <a href="#nomenclature">Partition nomenclature</a> 
below for a more thorough discussion. 

<p>There are a whole slew of filesystem types you may encounter.  Briefly,
HFS is Apple's old filesystem which has been in use since the '80s.  HFS+
(also known as "extended") is an enhanced version of HFS which allows
larger file (and filesystem) size, storage of unix-style owner and
permissions.  HFS+ is the recommended filesystem type for MacOS &gt;  8.1,
including MacOS X.  UFS is Apple's NeXT-derived version of good old BSD
FFS.  MS-DOS (also known as FAT) is the filesystem standardized on the
MS-DOS/Windows platform.  BSD FFS is the standard filesystem used by most
BSD unix-like OSes since the '80s (including NetBSD).  ext2fs is the most
common linux filesystem. 

<p>You may want to consider whether to include a partition that will be
shared among your OSes.  The most compatible format is MS-DOS FAT, but it
lacks features (such as permissions and good repair tools). 
Unfortunately, NetBSD doesn't yet support the Macintosh HFS and HFS+ file
systems natively.  NetBSD-current has full support for Apple's UFS.  Here's 
the quick breakdown: 

<p><table border=1 cellpadding=5>
<tr><td>format</td>
 <td>MacOS 8.1-9.x</td>
 <td>MacOS X and Darwin</td>
 <td>NetBSD</td>
 <td>Linux</td></tr>
<tr><td>Apple HFS</td>
 <td>yes</td>
 <td>yes</td>
 <td>
<a href="ftp://ftp.NetBSD.org/pub/NetBSD/packages/pkgsrc/sysutils/hfsutils/README.html">hfstools</a>
 </td>
 <td>yes&nbsp;(1)</td></tr>
<tr><td>Apple HFS+</td>
 <td>yes</td>
 <td>yes</td>
 <td>no</td>
 <td>read-only&nbsp;(2)</td></tr>
<tr><td>Apple UFS</td>
 <td>no</td>
 <td>yes</td>
 <td>-current</td>
 <td>read-only</td></tr>
<tr><td>MS-DOS FAT</td>
 <td>File Exchange</td>
 <td>yes</td>
 <td>yes</td>
 <td>yes</td></tr>
<tr><td>BSD FFS</td>
 <td>no</td>
 <td>no</td>
 <td>yes</td>
 <td>read-only</td></tr>
<tr><td>Linux ext2fs</td>
 <td>no</td>
 <td>yes&nbsp;(3)</td>
 <td>yes</td>
 <td>yes</td></tr>
</table>

<p>1 - Either use the stable
<a href="http://www.mars.org/home/rob/proj/hfs/">hfsutils</a> or the 
experimental in-kernel support.
<br>2 - Either use the experimental 
<a href="http://ftp.penguinppc.org/projects/hfsplus/">hfsplus</a> utils
or the experimental
<a href="http://sourceforge.net/projects/linux-hfsplus">linux-hfsplus</a>
kernel module.
<br>3 - Use the highly experimental 
<a href="http://sourceforge.net/projects/ext2fsx/">Ext2 Filesystem</a> kernel
extension.

<p>If you want to create a partition you can share with MacOS 9, you
should create an HFS partition which you will later convert to MS-DOS
format.  See <a href="#msdos">Creating a shared MS-DOS filesystem</a>
after you've partitioned your disk. 

<p>If you don't care about Classic MacOS, then UFS is probably the best 
bet.  Just make the UFS partition from within MacOS X or Darwin, and make 
sure you are using a -current NetBSD kernel.  UFS will be supported in 
the next major release of NetBSD (i.e. not the 1.6.x branch).

<p>Partitioning will erase the contents of your drive, so back up
everything from the disk you will be partitioning.  Follow the
instructions for the partitioning tool you wish to use. 

<ul>
<li><a href="#drive-setup">Partitioning using Drive Setup</a> (MacOS 9)
<li><a href="#disk-utility">Partitioning using Disk Utility</a> (MacOS X)
<li><a href="#pdisk">Partitioning using <tt>pdisk</tt> and 
 <tt>newfs</tt></a> (MacOS 9, MacOS X, Darwin, NetBSD,  Linux)
<li>A <tt>disklabel(8)</tt> is created by the <tt>sysinst</tt> installer 
 when you follow the directions in the <a 
 href="ftp://ftp.NetBSD.org/pub/NetBSD/NetBSD-1.6.1/macppc/INSTALL.html">
 NetBSD 1.6.1 install notes</a>.
</ul>

<h2><a name="drive-setup">Partitioning using Drive Setup</a> (MacOS 9)</h2>
<ol>
<li>You will need to use Drive Setup version 1.8.1 or later.  This is the 
version that comes with MacOS 9.0.  If you are unsure, you need to select 
Drive Setup and pick <tt>Get Info</tt> from the <tt>File</tt> menu.
<p>
<img src="../../images/ports/macppc/drive-setup.gif"
 width="354" height="401" alt="drive setup">
<p>
If you have an older version of MacOS,  you can download either the 
<a href="http://docs.info.apple.com/article.html?artnum=60791">MacOS 
9.0.4</a> (12.2 MB), 
<a href="http://docs.info.apple.com/article.html?artnum=75103">MacOS 9.1</a>
 (71 MB), 
<a href="http://docs.info.apple.com/article.html?artnum=120030">MacOS
9.2.1</a> (82 MB), or
<a href="http://docs.info.apple.com/article.html?artnum=75186">MacOS 
9.2.2</a> (21.3 MB) updates, all of which include a 
version of Drive Setup that works for us.  Note, these are big MacOS 
updates, so you will have to download a multi-megabyte disk image just to 
get the 500 KB Drive Setup application.  Apple has not provided a recent 
version of Drive Setup as a standalone update.
<p>
Also, the 
<a href="http://www.opensource.apple.com/projects/darwin/1.4/release.html">Darwin 
installer</a> has a version of Drive Setup that works.  
Darwin is also enormous (120.7 MB), since it contains a complete operating 
system.
<p>
You'll need to open the disk image and copy Drive Setup to a hard drive, 
RAM disk, Zip disk, or floppy disk (it can't run from the disk image).

<p><li>When you first run Drive Setup, it'll give you a screen like this, 
where you can select the drive that you want to re-partition.
<p>
<img src="../../images/ports/macppc/drive-selection.gif"
 width="328" height="257" alt="select a drive">
<p>
Select the drive to re-partition and click the <tt>Initialize...</tt> 
button.  This will open another dialog box.  Click the <tt>Custom 
Setup...</tt> button.
<p>
<img src="../../images/ports/macppc/initialize.gif"
 width="330" height="244" alt="initialize">

<p><li>Select the number of partitions you'll be using.  You will probably 
need at least 5 partitions, see the INSTALL notes for suggestions.
<p>
<img src="../../images/ports/macppc/custom-setup.gif"
 width="480" height="355" alt="custom setup">
<p>
Pick the <tt>Partitioning Scheme</tt> first since you lose all of your 
<tt>Volumes</tt> info each time you chose a different number of 
partitions.

<p><li>For each of the <tt>Volumes</tt> set the <tt>Type:</tt> under the 
<tt>Volume Info</tt> and <tt>Size:</tt> as suggested in the INSTALL notes.
<p>
<img src="../../images/ports/macppc/custom-type.gif"
 width="480" height="428" alt="custom type">
<p>
You can use the <tt>TAB</tt> key to rotate through the <tt>Volumes</tt>.

<p><li>When you're done, you should have something like the following (you 
get to name the MacOS partitions later from the Finder):
<p>
<img src="../../images/ports/macppc/suggested-layout.gif"
 width="480" height="355" alt="suggested layout">

<p><li>Click the <tt>OK</tt> button.  It will request confirmation of the 
changes.
<p>
<i>This is the point of no return!  If you accept the changes, it will 
erase all contents of your drive</i>

<p><li>After it's done partitioning and creating the HFS(+) partitions, it 
will return to the original screen.
<p>
<img src="../../images/ports/macppc/drivesetup-done.gif"
 width="328" height="257" alt="after partitioning">
<p>
Note: the <tt>A/UX</tt> partitions are not accessible to MacOS.

<p><li>You can quit Drive Setup, you're done with it.  Now, from the 
Finder, you can rename your HFS(+) partitions.  If you are using an Open 
Firmware 1.0.5 or 2.0.x model, you're done -- contine with the INSTALL 
notes.

<p>If your model has Open Firmware 2.4 or 3, and you're going to 
make this disk bootable for NetBSD, you still need to do one more step.  

<p>You will need to copy <tt>ofwboot.xcf</tt> (the bootloader) and 
<tt>netbsd.GENERIC_MD.gz</tt> or <tt>netbsd.ram.gz</tt> (the installer) to 
one of the HFS(+) partitions on your drive.  Make sure that you have 
downloaded these files in <tt>binary</tt> mode.
</ol>

<h2><a name="disk-utility">Partitioning using Disk Utility</a> (MacOS X)</h2>
<p>The MacOS X Disk Utility program cannot directly create NetBSD 
partitions, but where there's a will, there's a way.  The advantage of 
Disk Utility is that it is available from the MacOS X install CDs.  
Disk Utility can only create "Mac OS Extended" (HFS+), "Mac OS Standard" 
(HFS), "UNIX File System" (UFS), and "Free Space" partitions.

<p>NetBSD/macppc -current kernels can use UFS partitions, even as the root 
partition.  At present, if there are no normal NetBSD A/UX-style partitions 
available, NetBSD/macppc does not fall back to assuming that an UFS 
partition is the root.  You may need to figure out what partition NetBSD 
thinks the UFS is at (e.g. "e") and create a kernel with the UFS 
partition specified as the <a href="faq.html#dash-a">root device</a>.

<p>If this doesn't suit your needs, then you can use Disk Utility to 
create your MacOS HFS+ partitions and leave free space for NetBSD.  
You'll need to use <a href="#pdisk"><tt>pdisk</tt></a> to create the 
NetBSD partitions.

<p><ol>
<p><li>Launch Disk Utility.  From the install CDs, it's under the 
"Install" menu.  From MacOS X, open /Applications/Utilities/Disk Utility.

<p><li>You may need to authenticate.  If it says "Click the lock to make 
changes." in the lower left corner of the window, click the lock and type 
in your password (you <i>are</i> using an administrative account, aren't 
you).

<p><li>Select the disk to partition in the left panel.  Click on the 
"Partition" tab.  Pick your "Volume Scheme" (i.e. the number of 
partitions you want).

<p><li>Set the names, formats, and sizes of your partitions.  Hint:  to 
make partitions smaller than it recommends, type a number into the size box 
and hit enter to get it to accept your partition size.  "Mac OS Extended" 
HFS+ partitions have a minimum size of 4 MB.  For example, on 
my two-partition disk (a small HFS partition for <tt>ofwboot.xcf</tt> and 
a large UFS partition for NetBSD), Disk Utility looks like this:
<p>
<img src="../../images/ports/macppc/diskutil-hfs.gif"
 alt="small HFS partition">
<p>
<img src="../../images/ports/macppc/diskutil-ufs.gif"
 alt="large NetBSD UFS partition">

<p><li>Choose whether to install MacOS 9 disk drivers.  This is your only 
opportunity if you think you'll ever want to access any partitions on 
this disk from MacOS 9 or earlier.  Even HFS partitions are inaccessible 
from MacOS 9 if you don't click this button.

<p><li>Click OK and follow through.

<p><li>You can quit Disk Utility, you're done with it.  Now, from the 
Finder, you can rename your HFS(+) and UFS partitions.  If you are using an 
Open Firmware 1.0.5 or 2.0.x model, you're done -- contine with the INSTALL 
notes.
<p>
If your model has Open Firmware 2.4 or 3, and you're going to 
make this disk bootable for NetBSD, you still need to do one more step.  
<p>
You will need to copy <tt>ofwboot.xcf</tt> (the bootloader) to one of the
HFS(+) partitions on your drive.  Copy <tt>netbsd.GENERIC_MD.gz</tt> (the
installer) to your UFS partition (though it can also sit on an HFS(+)
partition).  Make sure that you have downloaded these files in
<tt>binary</tt> mode. 

<p>Remember, you'll need a -current kernel to use UFS as a root 
partition, and it may not be recognized by NetBSD as partition "a".
</ol>

<h2><a name="pdisk">Partitioning using <tt>pdisk</tt></a> and <tt>newfs</tt> 
(MacOS 9, MacOS X, Darwin, NetBSD, Linux)</h2>
The command-line <tt>pdisk</tt> utility is used to view and modify the 
Apple Partition Map on a disk.  NetBSD, MacOS X, and Darwin can all mount 
disks partitioned with <tt>pdisk</tt>.  MacOS 9 and earlier need special 
drivers to be installed to mount a disk (see <a href="#drive-setup">Drive 
Setup</a> and <a href="#disk-utility">Disk Utility</a>).  <tt>pdisk</tt> 
can create partition maps which will be bootable on  Open Firmware 2.4 or 
3 machines running NetBSD, MacOS X, and Darwin.  

<p>You may still find <tt>pdisk</tt> useful to modify a partition map 
created by another utility or simply to list the partition map of a disk.
If you are merely interested in listing the partition map of a disk, 
follow steps 1 through 4.

<p>Before starting, some caveats about partitioning:
<ul>
<p><li>If you create the partition map from <tt>pdisk</tt> (not just modify
 a partition map created using a MacOS utility), you won't be able to
 access the partitions on this disk from MacOS 9 and earlier.
<p><li>You can't create NetBSD A/UX-style partitions using the native 
 MacOS X, Darwin, or Linux <tt>pdisk</tt> program.
<p><li>The MacOS 9 <tt>pdisk</tt> is a little out of date, and may act 
 slightly different than the stuff below, but it still does the job.
<p><li>MacOS X and Darwin won't let you write the <tt>pdisk</tt> partition 
 map onto a drive that is currently in use.  This means you can't 
 repartition your boot drive.  Boot from another disk (or create a 
 bootable CD using a tool like <a href="http://charlessoft.com/">BootCD</a>).
</ul>

<p>The partition numbers listed by <tt>pdisk</tt> 
are the same that Open Firmware uses.  If you're trying to boot an Open 
Firmware 2.4 or 3 machine with this disk, remember which 
<tt>Apple_HFS</tt> partition number has <tt>ofwboot.xcf</tt> and which 
<tt>Apple_UNIX_SVR2</tt> or <tt>Apple_UFS</tt> partition is your NetBSD 
root partition.

<p><ol>
<p><li>Get <tt>pdisk</tt>.<br>
<ul>
<p><li>NetBSD -current, <tt>/sbin/pdisk</tt><br>

<p><li>NetBSD 1.6.x, <a 
href="ftp://ftp.NetBSD.org/pub/NetBSD/arch/macppc/netbsd-pdisk/netbsd-pdisk.macppc-1-6">
ftp://ftp.NetBSD.org/pub/NetBSD/arch/macppc/netbsd-pdisk/netbsd-pdisk.macppc-1-6
 </a><br>
 <tt># <b>chmod 755 netbsd-pdisk.macppc-1-6</b></tt>

<p><li>MacOS X 10.2.5 (known to also work on MacOS X 10.1.5), <a
href="ftp://ftp.NetBSD.org/pub/NetBSD/arch/macppc/netbsd-pdisk/netbsd-pdisk.macos-10-2">
ftp://ftp.NetBSD.org/pub/NetBSD/arch/macppc/netbsd-pdisk/netbsd-pdisk.macos-10-2</a>
 <br>
 <tt># <b>chmod 755 netbsd-pdisk.macos-10-2</b></tt>

<p><li>MacOS 9, <a
 href="ftp://ftp.NetBSD.org/pub/NetBSD/arch/macppc/macos-utils/pdisk.sea.hqx">
 ftp://ftp.NetBSD.org/pub/NetBSD/arch/macppc/macos-utils/pdisk.sea.hqx</a><br>
 Uncompress the archive, and run <tt>pdisk ppc</tt>

<p><li>Everything else (MacOS X, Darwin, Linux), <a
href="ftp://ftp.NetBSD.org/pub/NetBSD/arch/macppc/netbsd-pdisk/netbsd-pdisk.src.20030424.tgz">
ftp://ftp.NetBSD.org/pub/NetBSD/arch/macppc/netbsd-pdisk/netbsd-pdisk.src.20030424.tgz</a>
 <br>
<tt># <b>tar xzf netbsd-pdisk.src.20030424.tgz</b><br>
# <b>make</b></tt>
</ul>

<p><li>Determine the device name for the disk you're going to repartition 
or view.  If you are repartitioning, unmount any of those disk's 
partitions that might be mounted.

<ul>
<p><li>NetBSD:<br>
 <tt># <b>dmesg | grep \[sw\]d\[0-9\]</b></tt><br>
 <tt># <b>umount /mountpoint</b></tt>
<p><li>MacOS 9:<br>
 Drag the disk to the trash.<br>
 Open <tt>pdisk ppc</tt> and type <tt><b>L</b></tt> to list the disks, their
 fake names, and their partitions
<p><li>MacOS X and Darwin:<br>
 <tt># <b>/usr/sbin/diskutil list</b></tt><br>
 <tt># <b>/usr/sbin/disktool -u disk2</b></tt>
<p><li>Linux:<br>
 <tt># <b>dmesg | grep \[hs\]d\[a-g\]</b></tt><br>
 <tt># <b>umount /mountpoint</b></tt>
</ul>

<p><li>Run <tt>pdisk /dev/<i>disk-device</i></tt>, where 
<i>disk-device</i> is something like:
<ul>
<p><li>NetBSD <tt>/dev/sd2c</tt> (use the "<tt>c</tt>" partition)
<p><li>MacOS X and Darwin <tt>/dev/disk2</tt> (use no partition designation)
<p><li>Linux <tt>/dev/hdc</tt> (use no partition designation)
</ul>

<pre>  # <b>./pdisk /dev/disk2</b>
  Edit /dev/disk2 -
  Command (? for help): <b>?</b>
  Notes:
    Base and length fields are blocks, which vary in size between media.
    The base field can be &lt;nth&gt;p; i.e. use the base of the nth partition.
    The length field can be a length followed by k, m, g or t to indicate
    kilo, mega, giga, or tera bytes; also the length can be &lt;nth&gt;p; i.e. use
    the length of the nth partition.
    The name of a partition is descriptive text.
  
  Commands are:
    C    (create with type also specified)
    c    create new partition (standard unix root)
    d    delete a partition
    h    help
    i    initialize partition map
    n    (re)name a partition
    P    (print ordered by base address)
    p    print the partition table
    q    quit editing
    r    reorder partition entry in map
    s    change size of partition map
    t    change a partition's type
    w    write the partition table</pre>
	
<p><li>Double-check you're on the right disk.  If it's already got an
Apple Partition Map, everything should be OK.  

<pre>  Command (? for help): <b>P</b>

  Partition map (with 512 byte blocks) on '/dev/disk0'
   #:                type name             length   base    ( size )
   1: Apple_partition_map Apple                63 @ 1      
   2:      Apple_Driver43*Macintosh            56 @ 64     
   3:      Apple_Driver43*Macintosh            56 @ 120    
   4:    Apple_Driver_ATA*Macintosh            56 @ 176    
   5:    Apple_Driver_ATA*Macintosh            56 @ 232    
   6:      Apple_FWDriver Macintosh           512 @ 288    
   7:  Apple_Driver_IOKit Macintosh           512 @ 800    
   8:       Apple_Patches Patch Partition     512 @ 1312   
   9:          Apple_Free                     192 @ 1824   
  10:           Apple_UFS shared          1700000 @ 2016    (830.1M)
  11:           Apple_HFS macos            408788 @ 1702016 (199.6M)
  12:          Apple_Free                       8 @ 2110804

  Device block size=512, Number of Blocks=2110812 (1.0G)
  DeviceType=0x0, DeviceId=0x0
  Drivers-
  1:  23 @ 64, type=0x1
  2:  36 @ 120, type=0xffff
  3:  21 @ 176, type=0x701
  4:  34 @ 232, type=0xf8ff</pre>

If the disk does not have an APM, it'll give you some errors and you'll
need to initialize the APM before creating new partitions. 

<pre>  Command (? for help): <b>P</b>
  No partition map exists
  Command (? for help): <b>i</b>
  read failed
  Command (? for help): <b>P</b>

  Partition map (with 512 byte blocks) on '/dev/rdisk2'
   #:                type name    length   base    ( size )
   1: Apple_partition_map Apple       63 @ 1      
   2:          Apple_Free Extra  2110749 @ 64      (1.0G)

  Device block size=512, Number of Blocks=2110812 (1.0G)
  DeviceType=0x0, DeviceId=0x0</pre>

<p><li>Delete unused partitions and create your partitions.  There's no 
need to delete the <tt>Apple_Free</tt> partitions, those automatically 
take up any unassigned space.

<p>Use the <tt>P</tt> command to list the partitions to make sure you 
delete the right one(s).
<pre>  Command (? for help): <b>d</b>
  Partition number: <b>9</b></pre>

Useful partition types you might want to create are:
<p><table border=1 cellpadding=5>
<tr><td><tt>Apple_HFS</tt></td>
<td>HFS and HFS+ partitions (also <a href="#msdos">shared 
 MS-DOS</a>)</td></tr>
<tr><td><tt>Apple_UFS</tt></td>
<td>UFS partitions</td></tr>
<tr><td><tt>Apple_UNIX_SVR2</tt></td>
<td>A/UX-style partition for NetBSD and Linux</td></tr>
</table>

<pre>  Command (? for help): <b>C</b>
  First block: <b>2p</b>
  Length in blocks: <b>100m</b>
  Name of partition: <b>Zathras</b>
  Type of partition: <b>Apple_HFS</b>
  Command (? for help): <b>C</b>
  First block: <b>3p</b>
  Length in blocks: <b>800m</b>
  Name of partition: <b>netbsd</b>
  Type of partition: <b>Apple_UNIX_SVR2</b>
  Available partition slices for Apple_UNIX_SVR2:
    a   root partition
    b   swap partition
    c   do not set any bzb bits
    g   user partition
  Other lettered values will create user partitions
  Select a slice for default bzb values: <b>a</b>
  Command (? for help): <b>C</b>
  First block: <b>4p</b>
  Length in blocks: <b>4p</b>
  Name of partition: <b>swap</b>
  Type of partition: <b>Apple_UNIX_SVR2</b>
  Available partition slices for Apple_UNIX_SVR2:
    a   root partition
    b   swap partition
    c   do not set any bzb bits
    g   user partition
  Other lettered values will create user partitions
  Select a slice for default bzb values: <b>b</b>
  Command (? for help): <b>P</b>

  Partition map (with 512 byte blocks) on '/dev/rdisk0'
   #:                type name     length   base    ( size )
   1: Apple_partition_map Apple        63 @ 1      
   2:           Apple_HFS Zathras  204800 @ 64      (100.0M)
   3:     Apple_UNIX_SVR2 netbsd  1638400 @ 204864  (900.0M) S0 RUFS k0  /
   4:     Apple_UNIX_SVR2 swap     267548 @ 1843264 (130.6M) S1  SFS k0  (swap)

  Device block size=512, Number of Blocks=2110812 (1.0G)
  DeviceType=0x0, DeviceId=0x0</pre>

<p><li>Write out the new partition map and quit.

<pre>  Command (? for help): <b>w</b>
  Writing the map destroys what was there before. Is that okay? [n/y]: <b>y</b>
  Command (? for help): <b>q</b></pre>

<p><li>Create new filesystems.
<p><ul>
<p><li>NetBSD can only create its own filesystem (FFS) for the root and user 
partitions.  It can't directly create UFS, HFS, HFS+, or non-floppy sized 
MS-DOS filesystems.  You can use <a
href="ftp://ftp.NetBSD.org/pub/NetBSD/packages/pkgsrc/sysutils/hfsutils/README.html">
hfstools</a> to create an HFS filesystem.<br>
<tt># <b>newfs /dev/sd2a</b></tt><br>
<tt># <b>hformat /dev/sd2e</b></tt>

<p><li>MacOS 9 will ask to create HFS and HFS+ filesystems when you 
reboot.  After the reboot, it will recognize the new partition map, 
notice those partitions don't have filesystems and ask to create them.  
See <a href="#msdos">Creating a shared MS-DOS filesystem</a> on how to 
format a shared MS-DOS partition.

<p><li>MacOS X and Darwin can create UFS, HFS+, and HFS filesystems.  It
can't create NetBSD FFS, or non-floppy sized MS-DOS filesystems using
command-line utilities. You won't need an HFS (non-extended) partition
unless you intend to use it with MacOS 8.0 or earlier.<br>
<tt># <b>newfs_hfs /dev/disk2s2</b></tt> (for HFS+)<br>
<tt># <b>newfs /dev/disk2s5</b></tt> (for UFS)

<p><li>Linux can only create its own filesystem (ext2fs) for the root, swap 
and user partitions and MS-DOS filesystems.  It can't directly create UFS, 
HFS, or HFS+.  You can use <a
href="ftp://ftp.NetBSD.org/pub/NetBSD/packages/pkgsrc/sysutils/hfsutils/README.html">
hfstools</a> to create an HFS filesystem.<br>
<tt># <b>mkfs -t ext2 /dev/hdc2</b></tt><br>
<tt># <b>mkdosfs /dev/hdc3</b></tt><br>
<tt># <b>hformat /dev/hdc5</b></tt>
</ul>

<p><li>Mount your new filesystems.
<p><ul>
<p><li>NetBSD (use the same commands for FFS and UFS):<br>
<tt># <b>mount /dev/sd2a /mnt</b></tt><br>
<tt># <b>hmount /dev/sd2e</b></tt> (virtual mount)

<p><li>MacOS X and Darwin:<br>
<pre>  # <b>/sbin/autodiskmount -v</b>
  ** /dev/rdisk2s2
  FILESYSTEM CLEAN; SKIPPING CHECKS
  ** /dev/rdisk2s5
  QUICKCHECK ONLY; FILESYSTEM CLEAN
  Mounted ufs /dev/disk0s5 on /Volumes/untitled
  DiskDev    Type   FileSys  Fixed Write Volume Name      Mounted On      
  disk2s2    ???    hfs      yes   yes   untitled         /Volumes/untitled
  disk2s5    ???    ufs      yes   yes   untitled         /Volumes/untitled 1
  disk0s10   ???    hfs      yes   yes   OSX              /</pre>

<p><li>Linux:<br>
<tt># <b>mount -t ufs -o ufstype=44bsd,ro /dev/hdc1 /mnt/netbsd</b></tt> 
 (BSD FFS)<br>
<tt># <b>mount -t ufs -o ufstype=openstep,ro /dev/hdc2 /mnt/macosx</b></tt>
 (OSX UFS)<br>
<tt># <b>hmount /dev/hdc3</b></tt> (virtual hfsutils mount)<br>
<tt># <b>mount -t hfs /dev/hdc3 /mnt/macos</b></tt> 
 (experimental in-kernel HFS)<br>
<tt># <b>hpmount /dev/hdc4</b></tt> (virtual hfsplus utils mount)<br>
<tt># <b>mount -t hfsplus -o ro /dev/hdc4 /mnt/macosx</b></tt> 
 (experimental in-kernel HFS+)<br>
<tt># <b>mount -t ext2 /dev/hdc5 /mnt/linux</b></tt> (linux ext2fs)
</ul>

<p><li>If you are using an Open Firmware 1.0.5 or 2.0.x model, you may
want to copy <tt>netbsd.GENERIC_MD.gz</tt> (the installer) to your FFS or
UFS partition.  Make sure that you have downloaded this file in
<tt>binary</tt> mode.  You'll still need to load <tt>ofwboot.xcf</tt> 
from another source to boot your machine, though.

<p>If your model has Open Firmware 2.4 or 3, and you're going to make this
disk bootable for NetBSD, you will need to copy <tt>ofwboot.xcf</tt> (the
bootloader) to one of the HFS(+) partitions on your drive.  From NetBSD,
use the <tt>hcopy</tt> command.  Copy <tt>netbsd.GENERIC_MD.gz</tt> (the
installer) to your FFS or UFS partition (though it can also sit on an
HFS(+) partition).  Make sure that you have downloaded these files in
<tt>binary</tt> mode. 

<p>Remember, you'll need a -current kernel to use UFS as a root 
partition, and it may not be recognized by NetBSD as partition "a".

</ol>

<h2><a name="msdos">Creating a shared MS-DOS filesystem</a></h2>
<p>You can create an MS-DOS format partition that works in all OSes such
that classic MacOS will automatically mount it, and the unix-like OSes
(NetBSD, Linux, Darwin, and MacOS X) can mount it using the
<tt>mount_msdos</tt> command.  The steps below outline the most
straightforward technique. 

<p><ol>
<li>Partition your hard drive with an HFS partition (type 
<tt>Apple_HFS</tt>) reserved for MS-DOS.

<p><li>Next, boot MacOS 8.1-9.x, grab a copy of 
<a href="http://hyperarchive.lcs.mit.edu/cgi-bin/NewSearch?key=disk+charmer&amp;search=&amp;sp=sp">
Disk Charmer</a> or
<a href="http://www.versiontracker.com/moreinfo.fcgi?id=1253">DiskCharmer</a>,
 and set it up to create an
MS-DOS file system.  Your settings should look something like this:
<p>
<img src="../../images/ports/macppc/diskcharmer.gif" width="405" height="251"
alt="screenshot of DiskCharmer">

<p><li>Drag the partition onto DiskCharmer's window and it will prompt you
before erasing it and creating an MS-DOS file system in place of the HFS 
file system you created in the first step.

<p><li>Now, when you boot Classic MacOS, this partition will automatically 
mount using PC Exchange or File Exchange (depending on what it's called in your 
version of MacOS).  

<p>When you boot into MacOS X, Linux, or NetBSD, run the following command:
<pre>mkdir -p /msdos.filesystem;/sbin/mount_msdos -m 777 /dev/disk0s11 /msdos.filesystem</pre>

where <tt>/msdos.filesystem</tt> is the mount point you'd like, and 
<tt>/dev/disk0s11</tt> is the device name for your partition.  Alternatively,
for NetBSD and Linux, you can add an entry to your <tt>/etc/fstab</tt>
to always mount this filesystem.  

<p><li>To get MacOS X and Darwin to automatically mount your MS-DOS file system,
you need to create a System Startup bundle.  The 
<a href="http://www.darwinfo.org/howto/SystemStarter_HOWTO.shtml">SystemStarter
HOWTO</a> is a good reference if you want to learn more about creating your
own startup bundles.  There's probably a way to do this using 
<tt>autodiskmount</tt>, but this technique works fine.  The only downside is
that the MS-DOS filesystem is unavailable to the Classic environment.
Here's an example of what to do:
<p>
<ol>
<li><tt># <b>mkdir -p /Library/StartupItems/MountMSDOS</b></tt>
<p><li>Create 
   <tt>/Library/StartupItems/MountMSDOS/StartupParameters.plist</tt> with
   the following contents:
<pre>{
  Description     = "Mount MSDOS partitions";
  Provides        = ("Manual MSDOS partitions");
  Requires        = ("Disks");
  OrderPreference = "None";
  Messages =
  {
    start = "Mounting MSDOS partitions";
    stop  = "Unmounting MSDOS partitions";
  };
}</pre>
<p><li>Create
   <tt>/Library/StartupItems/MountMSDOS/MountMSDOS</tt> with
   the following contents:
<pre>#!/bin/sh

. /etc/rc.common

##
# Manually mount HFS partition with MS-DOS filesystem
##

ConsoleMessage "Mount MS-DOS partitions"

##
# Mount your filesystems manually.
##
mount_msdos /dev/disk0s11 /Volumes/Thingies</pre>
<p><li>
  <tt># <b>chown -R root /Library/StartupItems/MountMSDOS</b></tt><br>
  <tt># <b>chmod a+rx /Library/StartupItems/MountMSDOS/MountMSDOS</b></tt>
</ol>
</ol>


<h2><a name="nomenclature">Partition nomenclature</a></h2>
<p>There are three partition identification schemes you'll run across
when using NetBSD/macppc.  Each identification scheme sorts the 
partitions differently, even though the partition's location on the disk 
doesn't change.  Some schemes hide certain partitions.

<p><ol>
<p><li><b>Actual order on the disk (0 thru max partition number):</b><br>

This is the scheme used by Open Firmware and the <tt>/dev/diskXsY</tt>
device files in MacOS X and Darwin. The order of partitions is directly
related to the order you selected in Drive Setup, pdisk, or the NetBSD
partitioning tools. You can print out this list from any OS using <a
href="partitioning.html#pdisk">pdisk</a>. 

<p><table border=1 cellpadding=5>
 <tr><td>0</td>
 <td>A special "partition" reserved for a primary bootloader.</td></tr>
 <tr><td>1</td>
 <td>The Apple Partition Map.</td></tr>
 <tr><td>2 thru ~8</td>
 <td>Reserved for MacOS 9 drivers if the drive is formatted with a 
  MacOS tool.  Otherwise, user created partitions.</td></tr>
 <tr><td>~9 thru ~15</td>
 <td>User created partitions, placed in order of their physical location on
  disk.</td></tr>
 </table>

<p><li><b>MacOS-visible partitions (by partition name in Finder):</b><br>
While you may have created a bunch of partitions in Drive Setup, only
those partitions visible to MacOS will show up in the Finder.

<p>The only partitions visible to MacOS 9 and earlier are those formatted in
HFS, HFS+, or MS-DOS formats.  The only partitions visible to MacOS X and later
are those formatted in HFS, HFS+, UFS, and MS-DOS (<i>not</i> NetBSD's 
4.2BSD FFS).

<p><li><b>NetBSD-visible partitions (letters a thru h, as seen by 
 <tt>disklabel</tt>):</b><br>
NetBSD reorders the partitions such that things work out better for 
itself.  The <tt>fstype</tt> reported by <tt>disklabel(8)</tt> is set
by the Apple Partition Map flags, and does not depend on the actual
type of filesystem on that partition (be it NetBSD FFS, Apple HFS, or MS-DOS).
In particular, MS-DOS formatted partitions show up as <tt>HFS</tt> 
partitions, if created using the method in <a href="#msdos">
Creating a shared MS-DOS filesystem</a>.

<p><table border=1 cellpadding=5>
 <tr><td>a</td>
 <td>Your "A/UX Root" partition, regardless of its order on the disk</td></tr>
 <tr><td>b</td>
 <td>Your "A/UX Swap" partition, regardless of its order on the disk</td></tr>
 <tr><td>c</td>
 <td>This is the entire disk (first sector to last sector)</td></tr>
 <tr><td>d-f</td>
 <td>First few non-A/UX partitions (usually the user HFS(+) partitions)</td></tr>
 <tr><td>g</td>
 <td>Your "A/UX User" partition (if present), regardless of its order on the disk</td></tr>
 <tr><td>h</td>
 <td>Additional non-A/UX partitions (usually user HFS(+) partitions)</td></tr>
</table>
</ol>

<p>So, for example the following is what Drive Setup created on my PowerBook 
(FireWire):
<p><table border=1 cellpadding=5>
<tr><td><b>MacOS</b></td><td><b>OF/OSX</b></td><td><b>NetBSD</b></td> 
  <td><b>Comment</b></td><td><b>Apple Partition Map type</b></td>
  <td><b>disklabel fstype</b></td></tr>

<tr><td><br></td>        <td>0</td>  <td><br></td>    
  <td>bootloader</td>               <td><br></td>
  <td><br></td></tr>

<tr><td><br></td>        <td>1</td>  <td><br></td>    
  <td>Partition map</td>             <td>Apple_partition_map Apple</td>
  <td>unknown</td></tr>

<tr><td><br></td>        <td>2</td>  <td><br></td>    
  <td>MacOS driver</td>             <td>Apple_Driver43*Macintosh</td>
  <td>unknown</td></tr>

<tr><td><br></td>        <td>3</td>  <td><br></td>    
  <td>MacOS driver</td>             <td>Apple_Driver43*Macintosh</td>
  <td>unknown</td></tr>

<tr><td><br></td>        <td>4</td>  <td><br></td>    
  <td>MacOS driver</td>             <td>Apple_Driver_ATA*Macintosh</td>
  <td>unknown</td></tr>

<tr><td><br></td>        <td>5</td>  <td><br></td>    
  <td>MacOS driver</td>             <td>Apple_Driver_ATA*Macintosh</td>
  <td>unknown</td></tr>

<tr><td><br></td>        <td>6</td>  <td><br></td>    
  <td>MacOS driver</td>             <td>Apple_FWDriver Macintosh</td>
  <td>unknown</td></tr>

<tr><td><br></td>        <td>7</td>  <td><br></td>    
  <td>MacOS driver</td>             <td>Apple_Driver_IOKit Macintosh</td>
  <td>unknown</td></tr>

<tr><td><br></td>        <td>8</td>  <td><br></td>    
  <td>MacOS driver</td>             <td>Apple_Patches Patch Partition</td>
  <td>unknown</td></tr>

<tr><td>Untitled</td>   <td>9</td>  <td>d</td>    
  <td>MacOS 9 boot partition</td>   <td>Apple_HFS untitled</td>
  <td>HFS</td></tr>

<tr><td>Untitled 2</td> <td>10</td> <td>e</td>    
  <td>MacOS X boot partition</td>   <td>Apple_HFS untitled 2</td>
  <td>HFS</td></tr>

<tr><td>Untitled 3</td> <td>11</td> <td>f</td>    
  <td>MS-DOS <a href="#msdos">shared partition</a></td>  
                                    <td>Apple_HFS untitled 3</td>
  <td>HFS</td></tr>

<tr><td><br></td>        <td>12</td> <td>a</td>      
  <td>NetBSD boot partition</td>    <td>Apple_UNIX_SVR2 A/UX Root</td>
  <td>4.2BSD</td></tr>

<tr><td><br></td>        <td>13</td> <td>b</td>      
  <td>NetBSD swap</td>              <td>Apple_UNIX_SVR2 Swap</td>
  <td>swap</td></tr>

<tr><td><br></td>        <td>14</td> <td>g</td>      
  <td>unused disk space</td>        <td>Apple_Free Extra</td>
  <td>unknown</td></tr>

<tr><td><br></td>        <td><br></td> <td>c</td>      
  <td>NetBSD whole disk</td>         <td><br></td>
  <td>unused</td></tr>
</table>

<p>After installation, one of the HFS partitions, "Untitled" (which is
partition 9 to Open Firmware, and partition d to NetBSD) has 
<tt>ofwboot.xcf</tt>, and one of the A/UX partitions (which is partition 12
to Open Firmware, and partition a to NetBSD) has my NetBSD kernel, so I use 
the following command to boot:
<pre>boot hd:9,ofwboot.xcf hd:12</pre>

<hr>

<table width="100%"><tr><td>
  <table><tr><td>
    <a href="../../"><img
        src="../../images/NetBSD-flag.gif" border="0"
        width="91" height="42" alt=""></a>
  </td><td>
    <a href="../../"><img
        src="../../images/empty.gif" border="0"
        width="1" height="1" alt="NetBSD ">Home Page</a>
  </td></tr></table>
</td><td>
  <table><tr><td>
    <a href="../../Ports/"><img
        src="../../images/NetBSD-flag.gif" border="0"
        width="91" height="42" alt=""></a>
  </td><td> 
    <a href="../../Ports/"><img
        src="../../images/empty.gif" border="0"
        width="1" height="1" alt="NetBSD ">Supported Architectures</a>
  </td></tr></table>
</td></tr></table>

<hr>
<address>
  <small>
  www@NetBSD.org<br>
  $NetBSD: partitioning.html,v 1.14 2003/07/23 16:32:23 keihan Exp $<br>
  <a href="../../Misc/disclaimer.html">Copyright &copy; 1998-2003
    The NetBSD Foundation, Inc.  ALL RIGHTS RESERVED.</a>
  </small>
</address>

</body>
</html>
