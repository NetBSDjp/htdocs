-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1


		 NetBSD Security Advisory 2006-016
		 =================================

Topic:		IPv6 socket options can crash the system

Version:	NetBSD-current:	source prior to May 23, 2006
		NetBSD 3.0:	affected
		NetBSD 2.1:     affected
		NetBSD 2.0.*:   affected
		NetBSD 2.0:     affected

Severity:	Any local user can crash the system

Fixed:		NetBSD-current:		May 23, 2006
		NetBSD-3-0 branch:	May 24, 2006
						(3.0.1 will include the fix)
		NetBSD-3   branch:	May 24, 2006
		NetBSD-2-1 branch:      May 24, 2006
						(2.1.1 will include the fix)
		NetBSD-2-0 branch:      May 24, 2006
						(2.0.4 will include the fix)
		NetBSD-2 branch:        May 24, 2006

Abstract
========

Insufficient validation when parsing IPv6 socket options can lead to a
system crash.  This can be triggered by a local non-privileged user.

Technical Details
=================

IPv6 sockets can be used with IPv4-mapped addresses, and thus IPv4
packets may be sent and delivered through an IPv6 socket.

When sending an IPv6 packet, the NetBSD kernel needs to call the
ip6_savecontrol() function in order to process the SO_TIMESTAMP socket
option.  This function should process options for IPv6 packets only,
but wasn't checking for IPv4-mapped sockets. If such a socket had this
option set, it would traverse the mbuf chain by later calling
ip6_pullexthdr(), causing a panic.

Either net.inet6.ip6.v6only sysctl MIB (global) or IPV6_V6ONLY socket
option (per-socket) need to be 0 (zero) for this code path to occur.

Solutions and Workarounds
=========================

By default on NetBSD net.inet6.ip6.v6only is set to 1 (disabled).
However, any user can set IPV6_V6ONLY on their own sockets.

The only workaround available is to rebuild a kernel with
"options BIND_V6ONLY".

For all NetBSD versions, you need to obtain fixed kernel sources,
rebuild and install the new kernel, and reboot the system.

The fixed source may be obtained from the NetBSD CVS repository.

The following instructions briefly summarise how to upgrade your
kernel.  In these instructions, replace:

  ARCH     with your architecture (from uname -m), and 
  KERNCONF with the name of your kernel configuration file.

To update from CVS, re-build, and re-install the kernel:

        # cd src
        # cvs update -d -P sys/netinet6/ip6_input.c
	# ./build.sh kernel=KERNCONF
	# mv /netbsd /netbsd.old
	# cp sys/arch/ARCH/compile/obj/KERNCONF/netbsd /netbsd
	# shutdown -r now

For more information on how to do this, see:

   http://www.NetBSD.org/guide/en/chap-kernel.html


Thanks To
=========

Christian Biere for finding the problem.
JINMEI Tatuya from the KAME project for the fix.
Rui Paulo for implementing the fixes.

Revision History
================

	2006-06-08	Initial release

More Information
================

Advisories may be updated as new information becomes available.
The most recent version of this advisory (PGP signed) can be found at 
  ftp://ftp.NetBSD.org/pub/NetBSD/security/advisories/NetBSD-SA2006-016.txt.asc

Information about NetBSD and NetBSD security can be found at
http://www.NetBSD.org/ and http://www.NetBSD.org/Security/.


Copyright 2006, The NetBSD Foundation, Inc.  All Rights Reserved.
Redistribution permitted only in full, unmodified form.

$NetBSD: NetBSD-SA2006-016.txt,v 1.2 2006/06/08 16:21:43 adrianp Exp $

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.3 (NetBSD)

iQCVAwUBRIhPHz5Ru2/4N2IFAQKlHAP/Qk4xp1No/NASozQZgFpTIobWpJzgsu7/
XJuJt4nsfeSsJuISTq5wOy6nYZcGrSji8JsAkJttSzvAQsnHFxhgd2lBIAUlmmOS
SvnMLOmKpOZjn4pqdeJBlRPOJSnMNPYLZ2lD8smrRcMtvwjAA2E1y27iwM8wKEkh
uR16rsZVkZ8=
=vsfj
-----END PGP SIGNATURE-----
