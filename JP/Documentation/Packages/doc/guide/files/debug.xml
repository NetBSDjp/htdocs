<!-- $NetBSD: debug.xml,v 1.7 2007/08/15 06:33:44 rillig Exp $ -->
<!-- Based on english version: -->
<!-- NetBSD: debug.xml,v 1.7 2007/08/15 06:33:44 rillig Exp   -->

<chapter id="debug">
  <title>デバッグ</title>

  <para>パッケージを作成する時に落ちいりやすい間違いをチェックし、パッケージを動作
  させるための手順があります。これは基本的には前のセクションで説明したことと
  同じですが、デバッグを助けるための方法を追加しています。</para>

  <itemizedlist>
    <listitem>
      <para><varname>PKG_DEVELOPER=yes</varname> を &mk.conf; で設定しておいてください</para>
    </listitem>

    <listitem>
      <para><filename role="pkg">pkgtools/url2pkg</filename>をインストールし、
      デバッグ対象のパッケージ用にディレクトリーを作ってそこに移動してから、
      <command>url2pkg</command> を実行します。</para>

      <screen>&cprompt; <userinput>mkdir /usr/pkgsrc/<replaceable>category</replaceable>/<replaceable>examplepkg</replaceable></userinput>
&cprompt; <userinput>cd /usr/pkgsrc/<replaceable>category</replaceable>/<replaceable>examplepkg</replaceable></userinput>
&cprompt; <userinput>url2pkg http://www.example.com/path/to/distfile.tar.gz</userinput></screen>
    </listitem>

    <listitem>
      <para><filename>Makefile</filename>に、必要な編集を加えます。</para>
    </listitem>

    <listitem>
      <para><filename>DESCR</filename>の内容を書きます</para>
    </listitem>

    <listitem>
      <para><command>make configure</command> を実行します。</para>
    </listitem>

    <listitem>
      <para>ドキュメンテーション、
      およびconfigureの段階でわかった依存関係をすべて、
      パッケージの<filename>Makefile</filename>に書き加えます。</para>
    </listitem>

    <listitem>
      <para>以下を繰り返しおこなって、パッケージを作り上げます</para>

      <screen>&cprompt; <userinput>make</userinput>
&cprompt; <userinput>pkgvi ${WRKSRC}/some/file/that/does/not/compile</userinput>
&cprompt; <userinput>mkpatches</userinput>
&cprompt; <userinput>patchdiff</userinput>
&cprompt; <userinput>mv ${WRKDIR}/.newpatches/* patches</userinput>
&cprompt; <userinput>make mps</userinput>
&cprompt; <userinput>make clean</userinput></screen>

      <para>root以外のユーザーで作業をおこなうと、改変すべきでないファイルは改変され
      ません。特に、構築の段階以外では。
      <command>mkpatches</command>,
      <command>patchdiff</command> および <command>pkgvi</command>
      は、<filename role="pkg">pkgtools/pkgdiff</filename> パッケージに入っています。</para>
    </listitem>

    <listitem>
      <para>必要なら<filename>Makefile</filename>を修正してください。
      <xref linkend="components.Makefile"/>を参考にしてください。</para>
    </listitem>

    <listitem>
      <para><filename>PLIST</filename>を作成します:</para>

      <screen>&rprompt; <userinput>make install</userinput>
&rprompt; <userinput>make print-PLIST &gt;PLIST</userinput>
&rprompt; <userinput>make deinstall</userinput>
&rprompt; <userinput>make install</userinput>
&rprompt; <userinput>make deinstall</userinput></screen>

      <para>これは通常、<username>root</username>で実行する必要があります。
      残ったままのファイルがないか調べます:</para>

      <screen>&rprompt; <userinput>make print-PLIST</userinput></screen>

      <para>もし、なにかファイルが見つかれば、それらは<filename>PLIST</filename>に不足しているので、追加
      してください。</para>
    </listitem>

    <listitem>
      <para>これで<filename>PLIST</filename>の修正ができました。
      パッケージを再度インストールして、バイナリーパッケージを作ります:</para>

      <screen>&rprompt; <userinput>make reinstall</userinput>
&rprompt; <userinput>make package</userinput></screen>
    </listitem>

    <listitem>
      <para>インストールしたパッケージを削除します:</para>

      <screen>&rprompt; <userinput>pkg_delete <replaceable>examplepkg</replaceable></userinput></screen>
    </listitem>

    <listitem>
      <para>上記の <command>make print-PLIST</command> コマンドを繰り返します。
      今度は何も見つからないはずです:</para>

      <screen>&rprompt; <userinput>make print-PLIST</userinput></screen>
    </listitem>

    <listitem>
      <para>バイナリーパッケージを再インストールします:</para>

      <screen>&rprompt; <userinput>pkg_add .../<replaceable>examplepkg</replaceable>.tgz</userinput></screen>
    </listitem>

    <listitem>
      <para>遊んでみてください。すべてが機能することを確認してください。</para>
    </listitem>

    <listitem>
      <para><filename
      role="pkg">pkgtools/pkglint</filename>に含まれる<command>pkglint</command>を実行し、
      報告される問題を修正してください。</para>

      <screen>&rprompt; <userinput>pkglint</userinput></screen>
    </listitem>

    <listitem>
      <para>提出してください(もし cvs アクセス可能であればコミットしてください)。<xref
      linkend="submit"/>が参考になります。</para>
    </listitem>
  </itemizedlist>
</chapter>
