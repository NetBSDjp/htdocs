<!-- $NetBSD: options.xml,v 1.22 2007/08/15 06:33:45 rillig Exp $ -->
<!-- Based on english version: -->
<!-- NetBSD: options.xml,v 1.22 2007/08/15 06:33:45 rillig Exp   -->

<!-- based on: pkgsrc/mk/bsd.options.mk 1.56 -->

<chapter id="options">
<title>オプションの扱い</title>

<para>多くのパッケージは、対応する機能の組合せを変えて構築することができます。
<filename>bsd.options.mk</filename> は pkgsrc における枠組のひとつで、
このようなオプションに応じて異なるパッケージ構築方法の判断を、
汎用的に処理するものです。この枠組のなかで、利用者は、
どのようなオプションの組合せを組み込んでパッケージを構築するかを厳密に指定したり、
大域的な標準状態のオプションの組合せを適用したりすることができます。</para>


<sect1 id="global-default-options">
<title>標準の大域的なオプション</title>

<para>標準の大域的なオプションは、
<varname>PKG_DEFAULT_OPTIONS</varname> に列挙します。この値は、
そのオプションに対応しているパッケージすべてに組み込むオプションを並べたものです。
この変数は &mk.conf; で設定するようにします。</para>

</sect1>


<sect1 id="converting-to-options">
<title>パッケージを変換して <filename>bsd.options.mk</filename> を使うようにする</title>

<para>以下に掲げるのは、<filename>bsd.options.mk</filename>
を架空の ``wibble'' パッケージでどのように使うかを示したものです。
パッケージの <filename>Makefile</filename> に直接書くか、
別のファイル <filename>options.mk</filename> に書いて
<filename>Makefile</filename> からインクルードするか、
どちらかの方法をとります。</para>

<programlisting>
PKG_OPTIONS_VAR=                PKG_OPTIONS.wibble
PKG_SUPPORTED_OPTIONS=          wibble-foo ldap
PKG_OPTIONS_OPTIONAL_GROUPS=    database
PKG_OPTIONS_GROUP.database=     mysql pgsql
PKG_SUGGESTED_OPTIONS=          wibble-foo
PKG_OPTIONS_LEGACY_VARS+=       WIBBLE_USE_OPENLDAP:ldap
PKG_OPTIONS_LEGACY_OPTS+=       foo:wibble-foo

.include "../../mk/bsd.prefs.mk"

# this package was previously named wibble2
.if defined(PKG_OPTIONS.wibble2)
PKG_LEGACY_OPTIONS+=            ${PKG_OPTIONS.wibble2}
PKG_OPTIONS_DEPRECATED_WARNINGS+= \
        "Deprecated variable PKG_OPTIONS.wibble2 used, use ${PKG_OPTIONS_VAR} instead."
.endif

.include "../../mk/bsd.options.mk"

# Package-specific option-handling

###
### FOO support
###
.if !empty(PKG_OPTIONS:Mwibble-foo)
CONFIGURE_ARGS+=    --enable-foo
.endif

###
### LDAP support
###
.if !empty(PKG_OPTIONS:Mldap)
.  include "../../databases/openldap-client/buildlink3.mk"
CONFIGURE_ARGS+=    --enable-ldap=${BUILDLINK_PREFIX.openldap-client}
.endif

###
### database support
###
.if !empty(PKG_OPTIONS:Mmysql)
.  include "../../mk/mysql.buildlink3.mk"
.endif
.if !empty(PKG_OPTIONS:Mpgsql)
.  include "../../mk/pgsql.buildlink3.mk"
.endif
</programlisting>

<para>最初の節には、
このパッケージがどの構築オプションに対応しているかに関する情報があり、
標準状態を設定する必要があるオプションについてはその設定をしています。</para>

<orderedlist>

<listitem><para><varname>PKG_OPTIONS_VAR</varname> は、
&man.make.1; 変数の名前で、
利用者はその名前の変数を設定して標準のオプションを上書きすることができます。
この変数名は PKG_OPTIONS.<replaceable>pkgbase</replaceable> のように設定します。
オプションの処理をする段階では
<varname>PKGBASE</varname> は定義されていないので、
PKG_OPTIONS.${PKGBASE} と定義してはいけません。</para></listitem>

<listitem><para><varname>PKG_SUPPORTED_OPTIONS</varname>
は、このパッケージが対応している構築オプションを並べたリストです。</para></listitem>

<listitem><para><varname>PKG_OPTIONS_OPTIONAL_GROUPS</varname> は、
互いに排他的なオプションからなるグループの名前を並べたリストです。
各グループに含まれるオプションは、
<varname>PKG_OPTIONS_GROUP.<replaceable>groupname</replaceable></varname> に列挙します。
ここでは、各グループのオプションのうちもっとも特徴的な設定を先頭に書きます。
各グループに含まれるオプションは、自動的に
<varname>PKG_SUPPORTED_OPTIONS</varname> に追加されます。</para></listitem>

<listitem><para><varname>PKG_OPTIONS_REQUIRED_GROUPS</varname> は、
<varname>PKG_OPTIONS_OPTIONAL_GROUPS</varname> に似ていますが、
グループに含まれるオプションをどれも選ばなかった場合には、
パッケージの構築に失敗する点が異なります。</para></listitem>

<listitem><para><varname>PKG_OPTIONS_NONEMPTY_SETS</varname> は、
オプションの集合の名前を並べたリストです。
各集合からは、少なくともひとつのオプションを設定する必要があります。
各集合に含まれるオプションは、
<varname>PKG_OPTIONS_SET.<replaceable>setname</replaceable></varname> に列挙します。
各集合に含まれるオプションは、自動的に
<varname>PKG_SUPPORTED_OPTIONS</varname> に追加されます。
集合に含まれるオプションをひとつも設定しなかった場合、パッケージの構築に失敗します。</para></listitem>

<listitem><para><varname>PKG_SUGGESTED_OPTIONS</varname> は、
標準状態で有効となる構築オプションを並べたリストです。</para></listitem>

<listitem><para><varname>PKG_OPTIONS_LEGACY_VARS</varname> は、
旧式の &mk.conf; 変数を同等のオプションに対応づけた
<quote><replaceable>USE_VARIABLE</replaceable>:<replaceable>option</replaceable></quote>
という組合せを並べたリストです。
この組合せは、旧式の変数の大域的なリストを残すために、
<quote>+=</quote> を使って追加するようにします。
利用者が旧式の変数を使った場合には、警告が出ます。</para></listitem>

<listitem><para><varname>PKG_OPTIONS_LEGACY_OPTS</varname> は、
名前が変更されたオプションを新しいものに対応づけた
<quote><replaceable>old-option</replaceable>:<replaceable>new-option</replaceable></quote>
という組合せを並べたリストです。
この組合せは、旧名のオプションの大域的なリストを残すために、
<quote>+=</quote> を使って追加するようにします。
利用者が旧名のオプションを使った場合には、警告が出ます。</para></listitem>

<listitem><para><varname>PKG_LEGACY_OPTIONS</varname> は、
廃止された変数用のオプションを並べたリストです。
これは、<varname>PKG_OPTIONS_LEGACY_VARS</varname> と
<varname>PKG_OPTIONS_LEGACY_OPTS</varname> のどちらでも対処できない場合、
たとえば <varname>PKG_OPTIONS_VAR</varname> の名前が変更された場合などに使うものです。</para></listitem>

<listitem><para><varname>PKG_OPTIONS_DEPRECATED_WARNINGS</varname> は、
廃止された変数やオプションが使われたことと、その代替として何を使うかについての、
警告を並べたリストです。</para></listitem>

</orderedlist>

<para>パッケージ側では <varname>PKG_DEFAULT_OPTIONS</varname> や、
<varname>PKG_OPTIONS_VAR</varname> による変数名を変えてはいけません。
これらはもっぱら利用者が設定するためのものです。
オプションの標準設定を提案する場合は
<varname>PKG_SUGGESTED_OPTIONS</varname> を使います。</para>

<para><varname>PKG_OPTIONS_VAR</varname> は、
<filename>bsd.options.mk</filename> をインクルードする前に定義する必要があります。
<varname>PKG_SUPPORTED_OPTIONS</varname>,
<varname>PKG_OPTIONS_OPTIONAL_GROUPS</varname>,
<varname>PKG_OPTIONS_REQUIRED_GROUPS</varname> のいずれも定義されていない場合は
(実行対象のプラットフォームが、
プラットフォーム固有のオプションのどれにも対応していない場合に、
これらの影響を受ける可能性があるため)、 <varname>PKG_OPTIONS</varname> は空のリストに設定され、
パッケージがオプションの枠組を使わないように保護されます。</para>

<para><filename>bsd.options.mk</filename> がインクルードされた後、
変数 <varname>PKG_OPTIONS</varname> は、
選択された構築オプションを並べたリスト
(非対応あるいは廃止されたオプションは適切に除去されています)
を値として持っています。</para>

<para>残りの節では、各オプション固有の処理をしています。
あるオプションが <varname>PKG_OPTIONS</varname> のリストに含まれているかどうかの確認は、
以下のようにするのが正しい方法です。</para>

<programlisting>
.if !empty(PKG_OPTIONS:M<replaceable>option</replaceable>)
</programlisting>

</sect1>

<sect1 id="option-names">
<title>オプション名</title>

<para>異なるパッケージに類似の機能を追加するオプション
(あるライブラリーにオプションで対応するなど) は、
その機能に対応した全パッケージの間で共通の名前 (そのライブラリーの名前など) を使うべきです。
同じ意味のオプションをもつパッケージがすでに存在する場合は、
それと同じ名前を使ってください。</para>

<para>ひとつのパッケージに固有の機能を追加するオプションで、
他の (無関連の) パッケージが同じ (または類似の) オプション機能をもちそうにない場合は、
冒頭に <varname><replaceable>pkgname</replaceable>-</varname>
をつけたオプション名を使うようにします。</para>

<para>一群の関連パッケージの間で、
それらに固有のオプション機能を共有している場合は、
<quote>主たる</quote>パッケージ名を冒頭につけた形にします
(たとえば <varname>djbware-errno-hack</varname>)。</para>

<para>新しいオプションを追加する場合は、
<filename>mk/defaults/options.description</filename> にそのオプションの行を追加します。
行は、タブで区切られた二つのフィールドからなります。
最初のフィールドはオプション名、
二つ目はその説明です。この説明は、完全な文章 (大文字ではじまり、ピリオドで終わる)
で、このオプションで何ができるかを説明します。たとえば、<quote>Enable ispell
support.</quote> とします。このファイルはオプション名でソートします。</para>

</sect1>

</chapter>
