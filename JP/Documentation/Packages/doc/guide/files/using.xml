<!-- $NetBSD: using.xml,v 1.36 2009/05/28 09:29:30 wiz Exp $ -->
<!-- Based on english version: -->
<!-- NetBSD: using.xml,v 1.36 2009/05/28 09:29:30 wiz Exp   -->

<chapter id="using"> <?dbhtml filename="using.html"?>
<title>pkgsrc を使う</title>

<para>基本的に、pkgsrc には二通りの使い方があります。
一つ目の使い方は、パッケージ用のツールだけをインストールして、
他の人が用意したバイナリーパッケージを使うものです。
これは、pkgsrc のうち <quote>pkg</quote> に相当します。
二つ目の使い方は、pkgsrc の <quote>src</quote> もインストールするものです。
こうすると、自分でパッケージを構築することができますし、
他の人が用意したバイナリーパッケージを使うこともできます。</para>

<sect1 id="using-pkg">
  <title>バイナリーパッケージを使う</title>

  <para><ulink url="ftp://ftp.NetBSD.org/">ftp.NetBSD.org</ulink>
  サーバーとそのミラーサイトには、バイナリーパッケージを揃えて置いてあり、
  すぐにインストールして使える状態になっています。このバイナリーパッケージは、
  以下のような、標準のディレクトリーの設定を使って構築されています。</para>

  <itemizedlist>
  <listitem><para><varname>LOCALBASE</varname> は <filename>/usr/pkg</filename> で、ここにほとんどのファイルがインストールされます。</para></listitem>
  <listitem><para>設定ファイルは <filename>/usr/pkg/etc</filename> です。</para></listitem>
  <listitem><para><varname>VARBASE</varname> は <filename>/var</filename> で、インストール後に変更することのあるファイルはここにインストールされます。</para></listitem>
  </itemizedlist>

  <para>何らかの理由 (root 権限がないなど) でこの各ディレクトリーが使えない場合は、
  このバイナリーパッケージを使うことはできないので、
  パッケージ用ツールを自分で構築する必要があります。これについては<xref
  linkend="bootstrapping-pkgsrc" />に説明があります。</para>

  <sect2 id="finding-binary-packages">
    <title>バイナリーパッケージの配布場所</title>

    <para>バイナリーパッケージをインストールするためには、
    まず、バイナリーパッケージがどこで入手できるか知っている必要があります。
    最初に調べる場所は、pkgsrc の主たる FTP サーバーの <ulink
    url="ftp://ftp.NetBSD.org/pub/pkgsrc/packages/"><filename>/pub/pkgsrc/packages</filename></ulink>
    ディレクトリーです。</para>

    <para>このディレクトリーには、複数のプラットフォーム用の
    バイナリーパッケージがあります。
    最初に、お使いのオペレーティングシステムのディレクトリーを選んでください。
    (バージョン番号がついているディレクトリーは、
    歴史的な理由で残っているだけですので、無視してください。)
    次に、ハードウェアアーキテクチャーを選び、
    その次に、OS のバージョンと pkgsrc の<quote>バージョン</quote>の組合せを選びます。</para>

    <para>多くの場合、このディレクトリーには、
    パッケージ管理ツールが入った <filename>bootstrap.tar.gz</filename>
    というファイルがあります。このファイルがない場合は、
    お使いのオペレーティングシステムにパッケージ管理ツールがもともとあるのでしょう。
    このファイルをダウンロードして <filename>/</filename> ディレクトリーに展開します。
    展開すると、<filename>/usr/pkg</filename> (この下には、
    バイナリーパッケージ管理用のツールがある) および <filename>/var/db/pkg</filename>
    (インストールされたパッケージのデータベース用) の各ディレクトリーが作られます。</para>
  </sect2>

  <sect2 id="installing-binary-packages">
    <title>バイナリーパッケージをインストールする</title>

    <para>前節で説明したディレクトリーには、
    <filename>All</filename> というサブディレクトリーがあり、
    当該プラットフォーム向けのバイナリーパッケージがすべて置かれています。
    ただし、FTP または CDROM (利用しているメディアによって異なります)
    経由での配布ができないパッケージと、
    脆弱性があるため考えなしにインストールするのは危険と判断されたパッケージは、
    除かれています。</para>

    <para>パッケージを FTP または HTTP サーバーから直接インストールするには、
    Bourne シェルと互換のシェルで、以下のコマンドを実行します (最初に
    <command>su</command> して root になっておくことを忘れずに)。</para>

<screen>
&rprompt; <userinput>PATH="/usr/pkg/sbin:$PATH"</userinput>
&rprompt; <userinput>PKG_PATH="ftp://ftp.NetBSD.org/pub/pkgsrc/packages/<replaceable>OPSYS</replaceable>/<replaceable>ARCH</replaceable>/<replaceable>VERSIONS</replaceable>/All"</userinput>
&rprompt; <userinput>export PATH PKG_PATH</userinput>
</screen>

    <para>CDROM, DVD または NFS でマウントされた置き場所からインストールする場合などは、
    URL のかわりに、ローカルのパスを使うこともできます。
    複数の置き場所からパッケージをインストールしたい場合は、
    それらをセミコロンで区切って <varname>PKG_PATH</varname>
    に設定することができます。</para>

    <para>以上の準備ができれば、
    パッケージのインストールは非常に簡単です。</para>

<screen>
&rprompt; <userinput>pkg_add openoffice2</userinput>
&rprompt; <userinput>pkg_add kde-3.5.7</userinput>
&rprompt; <userinput>pkg_add ap2-php5-*</userinput>
</screen>

    <para>なお、インストールしようとするパッケージを実行するために必要となるパッケージも、
    すべて一緒にインストールされますが、
    この必要なパッケージも同じ置き場所に用意されていると仮定されます
    (訳註: 必要なパッケージがすべて揃うように PKG_PATH を設定する必要があるということ)。</para>

    <para>前述のとおり、脆弱性があるとわかっているパッケージは
    <filename>All</filename> サブディレクトリーには置いてありません。
    脆弱性のあるパッケージに多数のパッケージが依存していたりすると、
    非常に面倒だったりするので、これらは削除はされません。
    そのかわり、<filename>vulnerable</filename> サブディレクトリーに移動されます。
    このため、このディレクトリーも <varname>PKG_PATH</varname>
    変数に加えておくことが必要になることがあります。ただし、
    <command>pkg_admin audit</command> を定期的に
    (特に、パッケージを新たにインストールした後には) 実行して、
    脆弱性の影響がある構成となっているかどうかを確認するようにしてください。</para>

    <para>パッケージをインストールした後に、<varname>PATH</varname>に
    <filename>/usr/pkg/bin</filename> と <filename>/usr/pkg/sbin</filename> が含まれている事を確
    認してください。これで、インストールされたプログラムを実際に使い始めること
    ができます。</para>
  </sect2>

  <sect2 id="using.pkg_delete">
    <title>パッケージをアンインストールする</title>

    <para>パッケージをアンインストールする方法は、そのパッケージを、
    ソースコードからインストールしたかバイナリーパッケージからインストールしたかにかかわらず同じです。
    どちらの方法でインストールされたかは、<command>pkg_delete</command> コマンドは一切関知しません。
    パッケージの削除は、<command>pkg_delete
    <replaceable>package-name</replaceable></command> を実行するだけでおこなうことができます。
    パッケージ名はバージョン番号をつけてもつけなくてもかまいません。
    一連のパッケージをアンインストールするために、
    たとえば <literal>*emacs*</literal> のようにワイルドカードを使うこともできます。
    この場合、ワイルドカードが
    <literal>pkg_delete</literal> に渡る前にシェルに展開されないようにするため、
    ワイルドカードはかならずクォートするようにします。</para>

    <para><option>-r</option> オプションは非常に強力です。これを使うと、
    指定したパッケージに依存しているパッケージをすべて削除してから、
    指定したパッケージそのものを削除します。たとえば、

    <screen>
&rprompt; <userinput>pkg_delete -r jpeg</userinput>
    </screen>

    は、jpeg および jpeg を使うすべてのパッケージを削除します。これにより、
    jpeg パッケージをアップグレードすることが可能になります。</para>

  </sect2>

  <sect2 id="using.pkg_info">
    <title>インストールされているパッケージの情報を得る</title>

    <para><command>pkg_info</command> は、インストールされているパッケージや、
    バイナリーパッケージのファイルに関する情報を表示します。</para>

  </sect2>

  <sect2 id="vulnerabilities">
    <title>インストール済パッケージの脆弱性チェック</title>

    <para>
      NetBSD セキュリティーオフィサーとパッケージグループでは、
      pkgsrc に含まれる (あるいは含まれていた) パッケージの既知の脆弱性のリストを
      保守しています。このリストは、 NetBSD FTP サイトの
      <ulink url="ftp://ftp.NetBSD.org/pub/pkgsrc/distfiles/vulnerabilities"/>
      から入手できます
    </para>

    <para>
      <command>pkg_admin fetch-pkg-vulnerabilities</command> を使うと、
      このリストを自動的にダウンロードし、
      システムにインストールされているパッケージすべてについて
      セキュリティー検証をすることができます。
    </para>

    <para>
      このセキュリティー検証は、ふたつの部分からできています。
      ひとつめの段階は <command>pkg_admin fetch-pkg-vulnerabilities</command> で、
      NetBSD FTP サイトから
      脆弱性のリストをダウンロードするものです。 ふたつめは
      <command>pkg_admin audit</command> で、インストールされているパッケージに脆弱性が
      ないかどうか検証するものです。脆弱性のあるパッケージがあった場合、
      次のように出力してくれます:
    </para>

    <screen>Package samba-2.0.9 has a local-root-shell vulnerability, see
    http://www.samba.org/samba/whatsnew/macroexploit.html</screen>

    <para>
      <ulink url="ftp://ftp.NetBSD.org/pub/pkgsrc/distfiles/vulnerabilities">vulnerabilities</ulink>
      ファイルを毎日ダウンロードして、常に最新の状態にしておきたいという方もいらっしゃることでしょう。
      root ユーザーの &man.crontab.5; エントリーを適切に書いておけば、そういうこともできます。
      たとえば、
      <screen>
# vulnerabilities ファイルをダウンロード
0 3 * * * /usr/sbin/pkg_admin fetch-pkg-vulnerabilities >/dev/null 2>&1
      </screen>
      というエントリーを書けば、毎日午前 3 時に vulnerability リストを更新することになります。
      この例は一日一回ですが、もっと頻繁に更新することもできます。

      さらに、パッケージの検証を daily security script でおこないたい方もいらっしゃるでしょう。
      これは、以下のような行を <filename>/etc/security.local</filename>
      に書いておけば実現できます。
      <screen>
/usr/sbin/pkg_admin audit
      <screen>
    </para>
  </sect2>

  <sect2 id="pkg_versions">
    <title>インストール済パッケージのより新しいバージョンが pkgsrc にあるかどうか調べる</title>
    <para>
      インストール済パッケージが最新かどうかを確認するには、
      <filename role="pkg">pkgtools/lintpkgsrc</filename> をインストールして、
      <command>lintpkgsrc</command> に <quote>-i</quote> を付けて実行します。たとえば以下のようになります。
    </para>
    <screen>
&cprompt; <userinput>lintpkgsrc -i</userinput>
...
Version mismatch: 'tcsh' 6.09.00 vs 6.10.00
    </screen>
    <para>このようになった場合、パッケージを更新し、そのパッケージに依存しているパッケージをすべて再構築するために、
    <command>make update</command> を使うことができます。
    </para>
  </sect2>

  <sect2 id="using.pkg_admin">
    <title>その他の管理用機能</title>

    <para><command>pkg_admin</command> は、パッケージシステムにおける、
    各種の管理用機能を実行します。</para>

  </sect2>

  <sect2 id="a-word-of-warning">
    <title>警告</title>

    <para>&man.pkg.add.1; マニュアルページで警告されている、自分自身で作ったものでないバイナリー
    パッケージをインストールすることが孕む危険性、無思慮にこのようなファイルを
    インストールすることにより、あなたのシステムにセキュリティーホールが生じる
    事についてよく注意してください。</para>

    <para>もちろん、パッケージ、パッケージの構築用のコンパイラー、
    その他、呼び出されるすべてのツールのソースコードを完全に読んで理解したわけではない場合は、
    ソースからインストールしたパッケージにもすべて、
    同じ警告があてはまります。</para>

  </sect2>
</sect1>

<sect1 id="building-packages-from-source">
  <title>ソースからパッケージを構築する</title>

  <para>pkgsrc を入手すると、 <filename>pkgsrc</filename> ディレクトリーには、
  カテゴリー別に整理されたパッケージ一式が含まれます。
  オンラインでパッケージの索引を見られますし、また、 <filename>pkgsrc</filename>
  ディレクトリーで <command>make readme</command> してローカルで <filename>README.html</filename>
  を作って、 <filename
  role="pkg">www/lynx</filename> や <filename
  role="pkg">www/firefox</filename> などの好みの
  web ブラウザーで見られるようにすることもできます。</para>

  <para>パッケージのインストール先の<emphasis>プレフィックス</emphasis>は、
  デフォルトでは <filename>/usr/pkg</filename> です。これを変えたい場合は、
  &mk.conf; で <varname>LOCALBASE</varname>
  を設定してください。一つのシステム内で複数の
  <varname>LOCALBASE</varname> を定義して使い分けるようなことはしないでください
  (chroot 環境内は除く)。 </para>

  <para>以下、本章では、パッケージがすでに pkgsrc に含まれていると仮定
  しています。もし、そうでなければ、<xref linkend="developers-guide"/>で、
  パッケージを新たに作る方法をご覧ください。</para>

  <sect2 id="requirements">
    <title>必要なもの</title>

    <para>ソースからパッケージを構築するためには、機能する C
    コンパイラーが必要です。NetBSD の場合は、
    <quote>comp</quote> および <quote>text</quote>
    配布物一式をインストールしておく必要があります。X11関連のパッケージを
    構築する場合は、さらに<quote>xbase</quote>および<quote>xcomp</quote>
    配布物一式も必要です。</para>
    <!-- FIXME: what about installing x11/XFree86-*? -->
  </sect2>


  <sect2 id="fetching-distfiles">
    <title>配布ファイルの取得</title>

    <para>パッケージを構築するうえで最初にすることは、配布ファイル (未変更のソース)
    のダウンロードです。配布ファイルがまだダウンロードされていない場合、
    pkgsrc は自動的に配布ファイルを取得します。</para>

    <para><filename>distfiles</filename> ディレクトリー
    に必要なファイルが
    すでに存在していれば、インターネットに接続する必要はありません。
    CD-ROMなどにdistfilesがある場合には、CD-ROMを <filename>/cdrom</filename> にmountし、
    <screen>DISTDIR=/cdrom/pkgsrc/distfiles</screen>
    を &mk.conf;
    に加えて、使うことができます。</para>

    <para>標準状態では、人気のあるパッケージを置いているサーバー
    (たとえば SourceForge.net のミラー) に過大な負荷をかけないようにするため、
    配布サイトのリストの順序はランダムに入れ換えられます。
    このため、別の distfile を取得する必要が生ずるたびに、
    すべてのミラーからの取得を、新たな (ランダムな) 順序で試みます。
    この機能は、<varname>MASTER_SORT_RANDOM=NO</varname>
    を設定して止めることができます (<varname>PKG_DEVELOPER</varname>
    が設定されている場合は、すでに無効化されています)。</para>

    <para>主要な配布サイトをあなたのところに近いサイトで上書きす
    ることができます。
    変数をひとつかふたつ設定すると、
    マスターサイトにアクセスする順序を変えることができます。
    <varname>MASTER_SORT</varname> には、
    ドメインの接尾辞を空白で区切ったリストが含まれます。
    <varname>MASTER_SORT_REGEX</varname> はこれより柔軟なもので、
    正規表現を空白で区切ったリストが含まれます。
    これは <varname>MASTER_SORT</varname> より高い優先度を持ちます。
    <filename>pkgsrc/mk/defaults/mk.conf</filename>の例を参照してください。これにより、帯域幅
    と時間が節約できるかもしれません。</para>

    <para>これらの設定は、シェルの環境変数でも変更できますし、その設定を今後も有効に
    したければ、
    &mk.conf;
    ファイルにその定義を書き加えておくこともできます。</para>

    <para>
      パッケージが他のパッケージ(例えば <filename role="pkg">meta-pkgs/kde3</filename> など)
      に依存している場合、
      ダウンロードとコンパイルを交互に繰り返すことがあります。
      最初に必要なすべてのソースを確実にダウンロードするには、
      次のコマンドを使用します:
      <screen>&cprompt; <userinput>make fetch-list | sh</userinput></screen>
      このコマンドは必要なファイルを取ってきて<filename>distfiles</filename> ディレクトリー
      に保存するためのシェルコマンドを出力、実行します。必要なファイルを手動で
      ダウンロードするという方法もあります。
    </para>

  </sect2>

  <sect2 id="how-to-build-and-install">
    <title>構築とインストール方法</title>

    <para>
      ソフトウェアがダウンロードされると、パッチが適用された上で、
      コンパイルされます。それにかかる時間はあなたのコンピューターによりますし、
      そのソフトウェアが依存している他のパッケージの数とそれらのコンパイルに
      かかる時間にもよります。
    </para>

    <note><para>bootstrap または pkgsrc を NetBSD 以外のシステムで使う場合は、
    この手引きで例示されている <quote>make</quote> ではなく
    pkgsrc の <command>bmake</command> コマンドを使ってください。</para></note>

    <para>たとえば、パッケージの各構成要素を構築するには、シェルプロンプトで</para>

    <screen>
&cprompt; <userinput>cd misc/figlet</userinput>
&cprompt; <userinput>make</userinput>
    </screen>

    <para>とします。</para>

    <para>次は新たにコンパイルされたプログラムを、
    実際にあなたのシステムにインストールします。
    インストールしようとしているパッケージのディレクトリーにいる間に

    <screen>
&cprompt; <userinput>make install</userinput>
    </screen>

    と入力してください。</para>

    <para>パッケージをシステムにインストールするには root 権限が必要なことがあります。
    ただし、pkgsrc には<emphasis>必要な時のみ  su する</emphasis>機能があり、
    実際のインストール時にのみ root になることができます。</para>

    <para>そのソフトウェアは今まさにインストールされ、
    使用できるようにセットアップされたことになります。
    もうこれ以上コンパイル後の作業ファイルは必要とされないので、

    <screen>
&cprompt; <userinput>make clean</userinput>
    </screen>

    と入力し作業ディレクトリー内のファイルを削除してしまってもかまいません。
    もし、プログラムをコンパイルするときに、
    依存関係により他のパッケージがコンパイル/インストールされたならば、
    それらも次のコマンドにより、きちんと削除することができます。</para>

    <screen>
&cprompt; <userinput>make clean-depends</userinput>
    </screen>

    <para>figlet ユーティリティーを例にあげると、<xref linkend="logs"/>のように構築することに
    より、システムにインストールすることができます。</para>

    <para>プログラムはパッケージツリーのデフォルトルート- <filename>/usr/pkg</filename>にインストール
    されます。もし、このディレクトリーが趣味にあわないのであれば、環境変数
    <varname>LOCALBASE</varname>
    を設定してください。この値はパッケージツリーのルートとして使用さ
    れます。例えば、<filename>/usr/local</filename>を使う場合、
    <varname>LOCALBASE=/usr/local</varname> と設定してください。
    なお、これにはパッケージ専用のディレクトリーを使い、他のプログ
    ラムと共有させないようにします(つまり、 <varname>LOCALBASE=/usr</varname> などとしてはいけませ
    ん)。また、<varname>LOCALBASE</varname>ツリー内には、独自のファイルやディレクトリー
    (<filename>src/</filename>,
    <filename>obj/</filename>, <filename>pkgsrc/</filename>
    のようなもの)は一切追加しないようにしてください。これは、パッ
    ケージシステムがインストールするプログラムなどのファイルが、そこにインストー
    ルされているかもしれない別のファイルと衝突することがないようにするためです。</para>

    <para>いくつかのパッケージは、構築時にいくつかのコンフィギュレーションオプション
    を変えるために&mk.conf;を参照します。デフォルトの設定項目については、
    <filename>pkgsrc/mk/defaults/mk.conf</filename>をのぞいてみてください。<varname>LOCALBASE</varname>
    といっ
    た環境変数は、pkgsrc使用時に毎回使えるように&mk.conf;で設定しておくこと
    ができます。</para>

    <para>時々、 パッケージの構築やインストールの際に、<quote>水面下</quote>で何が起きているかを
    見たいことがあります。これは、デバッグのためなのかもしれませんし、好奇心が
    高じたものかもしれません。このような用途に使うための変数がいくつも用意され
    ています。</para>

    <orderedlist>
      <listitem>
	<para>&man.make.1;コマンドを
	<varname>PKG_DEBUG_LEVEL=2</varname>付きで呼び出すと、大量の情報が表示さ
	れるようになります。たとえば、</para>

	<screen><userinput>make patch PKG_DEBUG_LEVEL=2</userinput></screen>

	<para>は、<quote>patch</quote>の段階および、そこに至るまでに呼び出されるコマンドをすべて表示し
	ます。</para>
      </listitem>

      <listitem>
	<para>特定の&man.make.1;定義の値を知りたい場合は、
	show-varターゲットとともに、
	<varname>VARNAME</varname>定義を使います。たとえば、
	&man.make.1;変数
	<varname>LOCALBASE</varname>の展開結果を表示するには、以下のようにします。</para>

	<screen>
&cprompt; <userinput>make show-var VARNAME=LOCALBASE</userinput>
/usr/pkg
&cprompt;
	</screen>

      </listitem>
    </orderedlist>

    <para>自分で作った(次章参照)、手動でpkgsrc/packagesに置いた、またはリモートFTPサー
    バーに置かれたバイナリーパッケージをインストール
    したい場合は、"bin-install"ターゲットを使うことができます。このターゲットは、
    - もし可能ならば - &man.pkg.add.1;を使ってバイナリーパッケージをインストールするほ
    か、<command>make package</command>をおこないます。検索先リモートFTPサーバーのリストは
    <varname>BINPKG_SITES</varname>変数に保持され、デフォルトはftp.NetBSD.orgです。&man.pkg.add.1;に与え
    るべきフラグはすべて、<varname>BIN_INSTALL_FLAGS</varname>変数で保持することができます。詳細は
    <filename>pkgsrc/mk/defaults/mk.conf</filename>をご覧ください。</para>

    <para>最後に警告: 標準でない<varname>LOCALBASE</varname>
    の設定をしたシステムの場合は、
    各パッケージのインストール前にこれらを設定するようにしてください。複数のディ
    レクトリーを同じ目的用に分散して使うことはできないからです。そのようなこと
    をすると、pkgsrcはインストール済みのパッケージを正しく検出することができず、
    無惨に失敗することになるでしょう。また、コンパイル済バイナリーパッケージは、
    通常はデフォルトの<varname>LOCALBASE</varname>である
    <filename>/usr/pkg</filename>を使って構築されているので、標準で
    ない<varname>LOCALBASE</varname>を使っている場合は、とにかくコンパイル済バイナリーパッケージを
    インストールしては<emphasis>いけません</emphasis>。</para>
  </sect2>
</sect1>
</chapter>
